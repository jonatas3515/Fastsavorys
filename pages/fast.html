<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fast Savory's | Delivery</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Error handlers para debug iOS (tela branca)
    window._debugErrors = [];
    window.addEventListener('error', function (e) {
      var msg = '[GLOBAL ERROR] ' + e.message + ' at ' + e.filename + ':' + e.lineno;
      console.error(msg);
      window._debugErrors.push(msg);
      // Mostra erro visualmente em iOS para debug
      if (window._debugErrors.length <= 3) {
        var div = document.createElement('div');
        div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:10px;z-index:99999;font-size:12px;';
        div.textContent = msg;
        document.body && document.body.appendChild(div);
      }
    });
    window.addEventListener('unhandledrejection', function (e) {
      var msg = '[PROMISE ERROR] ' + (e.reason ? (e.reason.message || e.reason) : 'unknown');
      console.error(msg);
      window._debugErrors.push(msg);
    });

    // Helper para compatibilidade iOS com Datas
    window.safeDate = function (value) {
      if (value === undefined || value === null) return new Date();
      if (value instanceof Date) return value;
      if (typeof value === 'string') {
        // Corrige formato "YYYY-MM-DD HH:mm" para "YYYY-MM-DDTHH:mm" (ISO 8601)
        if (value.includes(' ') && value.includes(':') && !value.includes('T')) {
          value = value.replace(' ', 'T');
        }
      }
      return new Date(value);
    };

    // Service Worker: desregistrar em ambiente local para evitar cache antigo
    (function () {
      try {
        var hostname = location.hostname;
        var isLocal = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1';
        var isPrivateIP = hostname.indexOf('192.168.') === 0 || hostname.indexOf('10.') === 0 ||
          (hostname.indexOf('172.') === 0 && parseInt(hostname.split('.')[1]) >= 16 && parseInt(hostname.split('.')[1]) <= 31);
        if ((isLocal || isPrivateIP) && 'serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function (regs) {
            regs.forEach(function (reg) {
              reg.unregister();
              console.log('[SW] Desregistrado automaticamente em ambiente local');
            });
          }).catch(function (e) { console.log('[SW] Erro ao desregistrar:', e); });
          // Limpar caches antigos
          if ('caches' in window) {
            caches.keys().then(function (names) {
              names.forEach(function (name) { caches.delete(name); });
              if (names.length) console.log('[CACHE] Limpo automaticamente em ambiente local');
            }).catch(function (e) { console.log('[CACHE] Erro ao limpar:', e); });
          }
        }
      } catch (e) {
        console.log('[SW/CACHE] Erro geral:', e);
      }
    })();
  </script>
  <link rel="stylesheet" href="../assets/css/styles.css" />
  <style>
    .fs-accent {
      background: linear-gradient(135deg, #f59e0b, #ef4444, #f472b6);
    }

    .fs-chip {
      background: #fde68a;
      color: #7c2d12
    }

    input,
    select,
    textarea {
      color: #111 !important;
    }

    /* Hide scrollbar for carousel */
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Line clamp for text truncation */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body class="bg-white overflow-hidden">
  <!-- Welcome Screen with Gradient Background -->
  <div id="welcomeScreen" class="fixed inset-0 z-[100] overflow-hidden"
    style="background: linear-gradient(135deg, #9e0b5a 0%, #7a0945 25%, #5a0733 50%, #1f2937 75%, #000000 100%);">

    <!-- Mobile layout (sem absolute para n√£o sobrepor) -->
    <div class="sm:hidden flex flex-col h-full p-4">
      <div class="text-center pt-2">
        <h1 class="text-lg font-bold text-white drop-shadow-lg">
          Bem-vindo √† <span class="text-yellow-400">FastSavory's</span>
        </h1>
        <p class="text-xs text-white mt-1 drop-shadow-lg">
          Fa√ßa agora mesmo a sua encomenda!
        </p>
      </div>
      <div class="flex-1 flex items-center justify-center py-2">
        <img src="../assets/img/capa-logo.png" alt="Fast Savory's"
          class="max-w-full max-h-[55vh] object-contain drop-shadow-2xl" />
      </div>
      <div class="text-center pb-6">
        <button id="enterStoreBtnMobile"
          class="px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-black font-bold text-base rounded-full shadow-2xl animate-pulse">
          üõí Fazer Pedido
        </button>
      </div>
    </div>

    <!-- Desktop/Tablet: Text at top-left, Image centered -->
    <div class="hidden sm:block absolute inset-0 overflow-hidden">
      <!-- Text at top-left margin -->
      <div class="absolute top-8 left-8 md:top-12 md:left-12 z-10 max-w-2xl">
        <h1 class="text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-bold text-white drop-shadow-lg">
          Bem-vindo √† <span class="text-yellow-400" style="-webkit-text-stroke: 1px black;">FastSavory's</span>
        </h1>
        <p class="text-xl md:text-2xl text-white drop-shadow-lg" style="margin-top: 1rem; margin-bottom: 3rem;">
          Fa√ßa agora mesmo a sua encomenda!
        </p>
        <button id="enterStoreBtn"
          class="px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-black font-bold text-lg rounded-full shadow-2xl transform hover:scale-105 transition-all duration-300">
          üõí Fazer Pedido
        </button>
      </div>
      <!-- Image centered on screen -->
      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <img src="../assets/img/capa-logo.png" alt="Fast Savory's" class="object-contain drop-shadow-2xl"
          style="max-width: 50vw; max-height: 80vh; width: auto; height: auto;" />
      </div>

    </div>

    <!-- Testimonials Column (Desktop only - right side, outside desktop container) -->
    <div id="testimonialsColumn"
      class="hidden lg:block fixed top-8 right-4 lg:right-6 2xl:right-8 z-[101] w-56 lg:w-64 2xl:w-72">
      <h3 class="text-base font-bold text-white mb-3 drop-shadow-lg">‚≠ê Avalia√ß√µes dos Clientes</h3>
      <div id="testimonialsContainer" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1 scrollbar-thin">
        <!-- Testimonials will be loaded here -->
        <div class="text-white/60 text-sm italic text-center py-4">Carregando...</div>
      </div>
    </div>
  </div>






  <!-- Rating Modal (Public - for customers) -->
  <div id="ratingModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <!-- Gradient Background like welcome screen -->
    <div class="absolute inset-0 bg-gradient-to-br from-rose-900 via-purple-900 to-rose-800"></div>

    <div class="relative min-h-screen flex flex-col items-center justify-center px-4 py-8">
      <!-- Logo -->
      <!-- Logo - reduced size for better mobile experience -->
      <img src="../assets/img/fast-logo.png" alt="Fast Savory's"
        class="h-12 sm:h-16 mb-4 object-contain drop-shadow-lg" />

      <!-- Rating Card -->
      <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full border-2 border-rose-200 my-8">
        <h2 class="text-xl font-bold text-gray-800 text-center mb-2">‚≠ê Avalie sua Experi√™ncia</h2>
        <p id="ratingOrderCode" class="text-center text-rose-600 font-medium mb-4">FAST-0000</p>

        <!-- Rating Message -->
        <div id="ratingMessage" class="hidden mb-4 p-3 rounded-lg text-sm text-center"></div>

        <!-- Rating Form -->
        <div id="ratingForm">
          <!-- Client Name -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Seu Nome *</label>
            <input id="ratingClientName" type="text" required
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-rose-500 focus:ring-2 focus:ring-rose-200"
              placeholder="Digite seu nome" />
          </div>

          <!-- Star Rating -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Sua Nota *</label>
            <input type="hidden" id="ratingValue" value="0" />
            <div id="starRating" class="flex justify-center gap-2">
              <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition"
                data-star="1">‚òÜ</button>
              <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition"
                data-star="2">‚òÜ</button>
              <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition"
                data-star="3">‚òÜ</button>
              <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition"
                data-star="4">‚òÜ</button>
              <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition"
                data-star="5">‚òÜ</button>
            </div>
          </div>

          <!-- Comment -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Seu Coment√°rio *</label>
            <textarea id="ratingComment" rows="4" required maxlength="500"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-rose-500 focus:ring-2 focus:ring-rose-200 resize-none"
              placeholder="Conte como foi sua experi√™ncia..."></textarea>
            <p class="text-xs text-gray-400 mt-1 text-right"><span id="ratingCharCount">0</span>/500</p>
          </div>

          <!-- Submit Button -->
          <button id="submitRatingBtn" type="button" disabled
            class="w-full py-4 rounded-xl font-bold text-lg text-white bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg mb-4">
            Enviar Avalia√ß√£o
          </button>
        </div>

        <!-- Already Rated State -->
        <div id="ratingAlreadyDone" class="hidden text-center py-6">
          <p class="text-2xl mb-2">‚úÖ</p>
          <p class="text-lg font-semibold text-gray-800 mb-2">Voc√™ j√° avaliou este pedido!</p>
          <p id="existingRatingStars" class="text-3xl text-yellow-400 mb-2">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</p>
          <p id="existingRatingComment" class="text-gray-600 text-sm italic">"Coment√°rio anterior"</p>
        </div>

        <!-- Thank You State -->
        <div id="ratingThankYou" class="hidden text-center py-6">
          <p class="text-4xl mb-3">üéâ</p>
          <p class="text-xl font-bold text-green-600 mb-2">Obrigado!</p>
          <p class="text-gray-600">Sua avalia√ß√£o ser√° analisada pela nossa equipe e poder√° aparecer em nosso site em
            breve.</p>
          <button onclick="closeRatingModal()"
            class="mt-4 px-6 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg">
            Fechar
          </button>
        </div>
      </div>

      <!-- Close Button -->
      <button id="closeRatingModalBtn" onclick="closeRatingModal()"
        class="mt-4 text-white/90 hover:text-yellow-300 transition text-sm bg-black/30 px-4 py-2 rounded-full">
        ‚úï Fechar
      </button>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Entrar</h2>
      <form id="loginForm" class="space-y-4">
        <div class="text-center">
          <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Login</label>
          <input type="text" id="loginUser"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400 text-gray-900 placeholder-gray-400 text-center"
            required>
        </div>
        <div class="text-center">
          <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Senha</label>
          <div class="relative">
            <input type="password" id="loginPass"
              class="w-full pr-10 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400 text-gray-900 placeholder-gray-400 text-center"
              required>
            <button type="button" id="toggleLoginPass"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="flex items-center justify-center gap-2">
          <input type="checkbox" id="rememberUser" class="w-4 h-4 rounded border-gray-300">
          <label for="rememberUser" class="text-sm text-gray-600">Lembrar meu usu√°rio</label>
        </div>
        <div id="loginError" class="hidden text-center p-3 rounded-lg bg-red-100 text-red-700 text-sm"></div>
        <button type="submit"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium text-center">Entrar</button>
        <button type="button" id="goToPublic"
          class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg font-medium text-center">Ir para
          Loja</button>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <header class="text-white shadow-lg" style="background:#000">
      <div class="container mx-auto px-3 py-3">
        <!-- Desktop: Logo + Nav Buttons + Logout all in one line -->
        <div class="hidden sm:flex items-center justify-between gap-4">
          <img src="../assets/img/fast-logo.png" alt="Fast Savory's" class="h-12 object-contain" />
          <div class="flex flex-wrap items-center gap-2">
            <button id="showProductsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Produtos</button>
            <button id="showClientsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Clientes</button>
            <button id="showPromotionsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Promo√ß√µes</button>
            <button id="showReportsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Relat√≥rios</button>
            <button id="showRatingsPanelFast"
              class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg text-xs">‚≠ê Avalia√ß√µes</button>
            <button id="showOrdersPanelFast"
              class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg text-xs">üìã Pedidos</button>
            <button id="showConfigPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Config</button>
            <button id="showBannerPanelFast"
              class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-xs">üì¢ Banner</button>
            <button id="closeStoreToday"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs">Fechar</button>
            <button id="goToStore" class="bg-rose-200 hover:bg-rose-300 text-black px-3 py-2 rounded-lg text-xs">Ver
              Loja</button>
            <button id="logoutBtn"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs">Sair</button>
          </div>
        </div>

        <!-- Mobile: Logo + Logout on top, buttons below -->
        <div class="sm:hidden">
          <div class="flex items-center justify-between mb-3">
            <img src="../assets/img/fast-logo.png" alt="Fast Savory's" class="h-10 object-contain" />
            <button id="logoutBtnMobile"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs">Sair</button>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <button id="showProductsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Produtos</button>
            <button id="showClientsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Clientes</button>
            <button id="showPromotionsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Promo√ß√µes</button>
            <button id="showReportsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Relat√≥rios</button>
            <button id="showRatingsPanelFastMobile"
              class="bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-2 rounded-lg text-xs text-center">‚≠ê
              Avalia√ß√µes</button>
            <button id="showOrdersPanelFastMobile"
              class="bg-orange-600 hover:bg-orange-700 text-white px-2 py-2 rounded-lg text-xs text-center">üìã
              Pedidos</button>
            <button id="showConfigPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Config</button>
            <button id="showBannerPanelFastMobile"
              class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-2 rounded-lg text-xs text-center">üì¢
              Banner</button>
            <button id="closeStoreTodayMobile"
              class="bg-red-600 hover:bg-red-700 text-white px-2 py-2 rounded-lg text-xs text-center">Fechar</button>
            <button id="goToStoreMobile"
              class="col-span-3 bg-rose-200 hover:bg-rose-300 text-black px-2 py-2 rounded-lg text-xs text-center">Ver
              Loja</button>
          </div>
        </div>
      </div>
    </header>


    <main id="productsPanelFast"
      class="container mx-auto px-2 sm:px-4 py-4 sm:py-6 text-gray-800 hidden overflow-x-hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
        <div class="space-y-4 max-w-full overflow-hidden">
          <div class="bg-white rounded-xl shadow p-3 sm:p-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Adicionar Produto</h3>
            <form id="productForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                <input id="productName" class="w-full px-3 py-2 border rounded-lg" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                <textarea id="productDescription" class="w-full px-3 py-2 border rounded-lg" rows="3"
                  required></textarea>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo (R$)</label>
                  <input type="number" id="productPrice" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                    required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                  <select id="productCategory" class="w-full px-3 py-2 border rounded-lg" required>
                    <option value="salgados">Salgados</option>
                    <option value="mini">Mini-Salgados</option>
                    <option value="kits">Kits Festa</option>
                    <option value="bolos">Bolos</option>
                    <option value="bebidas">Bebidas</option>
                    <option value="adicionais">Adicionais</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Imagem</label>
                <input type="file" id="productImage" accept="image/*" class="w-full" />
              </div>

              <!-- Disponibilidade (Sazonalidade + Indispon√≠vel hoje) -->
              <div class="border-t pt-4 mt-2">
                <h5 class="text-sm font-medium text-gray-700 mb-3">üìÖ Disponibilidade</h5>
                <div class="grid grid-cols-2 gap-3 mb-3">
                  <div>
                    <label class="text-xs text-gray-600">Dispon√≠vel a partir de</label>
                    <input type="date" id="productStartDate" class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Dispon√≠vel at√©</label>
                    <input type="date" id="productEndDate" class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                </div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="productUnavailableToday" class="w-4 h-4 text-rose-600">
                  <span class="text-sm text-gray-700">Indispon√≠vel hoje</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">Deixe as datas vazias para disponibilidade cont√≠nua.</p>
              </div>

              <!-- Promo√ß√£o -->
              <div class="border-t pt-4 mt-2">
                <h5 class="text-sm font-medium text-gray-700 mb-3">üè∑Ô∏è Promo√ß√£o</h5>
                <label class="flex items-center gap-2 cursor-pointer mb-3">
                  <input type="checkbox" id="productPromoActive" class="w-4 h-4 text-rose-600">
                  <span class="text-sm text-gray-700">Produto em promo√ß√£o</span>
                </label>
                <div id="promoDetailsFields" class="hidden grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-xs text-gray-600">Tipo de desconto</label>
                    <select id="productPromoType" class="w-full px-2 py-1 border rounded text-sm">
                      <option value="percent">% Percentual</option>
                      <option value="value">R$ Valor fixo</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Valor do desconto</label>
                    <input type="number" id="productPromoValue" step="0.01" placeholder="0"
                      class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                </div>
              </div>

              <!-- Encomenda -->
              <div class="border-t pt-4 mt-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="productIsEncomenda" class="w-4 h-4 text-rose-600">
                  <span class="text-sm text-gray-700">üìÖ T√≠pico de encomenda (exige agendamento)</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">Ex.: Kits festa, bolos personalizados.</p>
              </div>

              <!-- Flavor Selection (Mini-Salgados only) -->
              <div id="flavorSelectionSection" class="border-t pt-4 mt-2 hidden">
                <h5 class="text-sm font-medium text-gray-700 mb-3">üçΩÔ∏è Sele√ß√£o de Sabores (Mini-Salgados)</h5>
                <label class="flex items-center gap-2 cursor-pointer mb-3">
                  <input type="checkbox" id="flavorSelectionEnabled" class="w-4 h-4 text-rose-600">
                  <span class="text-sm text-gray-700">Cliente escolhe sabores?</span>
                </label>
                <div id="flavorSelectionDetails" class="hidden space-y-3 pl-4 border-l-2 border-rose-200">
                  <div>
                    <label class="text-xs text-gray-600">Quantos sabores o cliente pode escolher?</label>
                    <input type="number" id="flavorSelectionMax" min="1" max="20" value="3"
                      class="w-20 px-2 py-1 border rounded text-sm">
                  </div>
                  <div>
                    <label class="text-xs text-gray-600 block mb-2">Sabores dispon√≠veis para este produto:</label>
                    <div id="flavorSelectionFlavors" class="space-y-1 max-h-40 overflow-y-auto">
                      <!-- Rendered dynamically -->
                    </div>
                  </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Se ativado, o cliente poder√° escolher os sabores no momento da
                  compra.</p>
              </div>

              <button type="submit"
                class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Salvar
                Produto</button>
            </form>
          </div>
        </div>

        <!-- RIGHT COLUMN: Products List -->
        <div class="max-w-full overflow-hidden">
          <div class="bg-white rounded-xl shadow p-3 sm:p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Produtos Cadastrados</h3>
            <div class="flex flex-wrap gap-2 mb-3">
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900" data-filter="all">Todas</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="salgados">Salgados</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900" data-filter="mini">Mini</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900" data-filter="kits">Kits</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="bolos">Bolos</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="adicionais">Adicionais</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="bebidas">Bebidas</button>
              <button class="admin-filter px-3 py-1 rounded bg-gray-200 text-gray-700"
                data-filter="hidden">Ocultos</button>
              <button class="admin-filter px-3 py-1 rounded bg-blue-100 text-blue-800" data-filter="seasonal">üìÖ
                Sazonais</button>
              <button class="admin-filter px-3 py-1 rounded bg-red-100 text-red-800" data-filter="unavailable">‚ùå
                Indispon√≠veis</button>
            </div>
            <div id="productsList" class="space-y-4 max-h-[70vh] overflow-y-auto"></div>
          </div>
        </div>
      </div>

      <!-- Product Options Management Section -->
      <div class="mt-6 bg-white rounded-xl shadow p-3 sm:p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è Op√ß√µes de Personaliza√ß√£o</h3>
        <p class="text-sm text-gray-600 mb-4">Gerencie as op√ß√µes dispon√≠veis nos modais de Kits Festa, Bolos e
          Mini-Salgados.</p>

        <!-- Options Tabs -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button class="options-tab px-3 py-2 rounded-lg bg-rose-600 text-white text-sm font-medium"
            data-type="cakeMass">üç∞ Massas</button>
          <button class="options-tab px-3 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium"
            data-type="filling">üéÇ Recheios</button>
          <button class="options-tab px-3 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium"
            data-type="salgados">ü•ü Salgados</button>
          <button class="options-tab px-3 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium"
            data-type="miniSalgadosFlavors">üçΩÔ∏è Mini-Salgados</button>
        </div>

        <!-- Add New Option Form -->
        <div class="flex gap-2 mb-4">
          <input type="text" id="newOptionName" placeholder="Nome da nova op√ß√£o..."
            class="flex-1 px-3 py-2 border rounded-lg text-sm">
          <button id="addNewOptionBtn"
            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">+
            Adicionar</button>
        </div>

        <!-- Inline Message -->
        <div id="optionsMessage" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

        <!-- Options List -->
        <div id="optionsListContainer" class="space-y-2 max-h-64 overflow-y-auto">
          <p class="text-gray-500 text-sm">Carregando op√ß√µes...</p>
        </div>
      </div>
    </main>


    <!-- Admin Content - Configura√ß√µes (Usu√°rios + Taxas) -->
    <main id="configPanelFast" class="container mx-auto px-4 py-6 hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Se√ß√£o de Usu√°rios -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üë§ Gerenciar Usu√°rios</h2>
          <form id="userForm" class="space-y-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usu√°rio</label>
              <input id="userName" class="w-full px-3 py-2 border rounded-lg" placeholder="Digite o nome de usu√°rio"
                required />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                <div class="relative">
                  <input type="password" id="userPass" class="w-full pr-10 px-3 py-2 border rounded-lg"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                  <button type="button" id="toggleUserPass"
                    class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">üëÅÔ∏è</button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Papel</label>
                <select id="userRole" class="w-full px-3 py-2 border rounded-lg">
                  <option value="admin">Admin</option>
                  <option value="gerente">Gerente</option>
                  <option value="garcom">Gar√ßom</option>
                  <option value="caixa">Caixa</option>
                </select>
              </div>
            </div>
            <button type="submit" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
              Salvar Usu√°rio
            </button>
          </form>
          <h3 class="font-semibold text-gray-800 mb-3">Usu√°rios Cadastrados</h3>
          <div id="usersList" class="space-y-3 max-h-64 overflow-y-auto"></div>
        </div>

        <!-- Se√ß√£o de Hor√°rio de Atendimento (Moved to Left Column - New Position) -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üïê Hor√°rio de Atendimento</h2>
          <div class="space-y-3" id="businessHoursContainer">
            <!-- Renderizado via JavaScript -->
          </div>
          <button type="button" id="saveBusinessHours"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium mt-4">
            üíæ Salvar Hor√°rios
          </button>
          <p class="text-xs text-gray-500 mt-2 text-center">O hor√°rio de abertura aparecer√° automaticamente no site.</p>
        </div>

        <!-- Se√ß√£o de Taxas de Entrega -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üöö Taxas de Entrega</h2>
          <div class="space-y-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
              <input type="text" id="feeNeighborhoodFastPanel" class="w-full px-3 py-2 border rounded-lg"
                placeholder="Nome do Bairro" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor da Taxa (R$)</label>
                <input type="number" step="0.01" id="feeValueFastPanel" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="0.00" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">A partir de (R$)</label>
                <input type="number" step="0.01" id="feeMinValueFastPanel" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="15.00" />
              </div>
            </div>
            <button type="button" id="addFeeFastPanel"
              class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
              Adicionar/Atualizar Taxa
            </button>
          </div>

          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-gray-800">Bairros Cadastrados</h3>
            <button type="button" id="batchUpdateMin" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
              üîÑ Atualizar "A partir de" em massa
            </button>
          </div>

          <div id="feesListFastPanel"
            class="divide-y max-h-[500px] overflow-y-auto mb-4 border rounded-lg p-2 bg-gray-50"></div>

          <button type="button" id="saveAllFeesFastPanel"
            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-lg">
            üíæ Salvar Todas as Taxas
          </button>
        </div>
      </div>

      <!-- Se√ß√£o de Taxas de Cart√£o -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üí≥ Taxas de Cart√£o</h2>
        <div class="grid grid-cols-1 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cart√£o 1x (%)</label>
            <input type="number" id="cardFee1x" step="0.1" min="0" max="100" class="w-full px-3 py-2 border rounded-lg"
              placeholder="5.00" />
          </div>
        </div>
        <button type="button" id="saveCardFees"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
          üíæ Salvar Taxas de Cart√£o
        </button>
        <p class="text-xs text-gray-500 mt-2 text-center">As taxas ser√£o aplicadas automaticamente no checkout.</p>
      </div>



      <!-- Se√ß√£o de Entregadores -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üèçÔ∏è Entregadores</h2>
        <form id="courierForm" class="space-y-4 mb-6">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
              <input type="text" id="courierName" class="w-full px-3 py-2 border rounded-lg"
                placeholder="Nome do entregador" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
              <input type="tel" id="courierPhone" class="w-full px-3 py-2 border rounded-lg"
                placeholder="(73) 99999-9999">
            </div>
          </div>
          <input type="hidden" id="courierEditId" value="">
          <button type="submit" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
            Adicionar Entregador
          </button>
        </form>
        <h3 class="font-semibold text-gray-800 mb-3">Entregadores Cadastrados</h3>
        <div id="couriersList" class="space-y-2 max-h-48 overflow-y-auto">
          <p class="text-gray-400 text-sm text-center py-4">Nenhum entregador cadastrado</p>
        </div>
      </div>

      <!-- Se√ß√£o de Toggle de Delivery -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üöö Controle de Entregas</h2>
        <div class="flex items-center justify-between mb-4 p-4 bg-gray-50 rounded-lg">
          <div>
            <span class="text-gray-800 font-semibold">Delivery Habilitado</span>
            <p class="text-xs text-gray-500">Quando desativado, apenas retirada na loja.</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="deliveryEnabled" class="sr-only peer" checked>
            <div
              class="w-14 h-7 bg-gray-300 peer-focus:ring-2 peer-focus:ring-rose-300 rounded-full peer peer-checked:bg-green-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-7 shadow-inner">
            </div>
          </label>
        </div>
        <div id="deliveryDisabledReasonBox" class="hidden mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da suspens√£o</label>
          <input type="text" id="deliveryDisabledReason"
            class="w-full px-3 py-2 border rounded-lg border-orange-300 bg-orange-50"
            placeholder="Ex: Mau tempo, falta de motoboy, alta demanda..." />
          <p class="text-xs text-orange-600 mt-1">Este motivo ser√° exibido para os clientes.</p>
        </div>
        <div class="mt-4 border-t pt-4">
          <h4 class="font-semibold text-gray-800 mb-3">‚è±Ô∏è Estimativas de Tempo</h4>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Preparo (min)</label>
              <div class="flex gap-2">
                <input type="number" id="prepTimeMin" placeholder="Min" class="w-full px-2 py-1 border rounded" min="0">
                <input type="number" id="prepTimeMax" placeholder="Max" class="w-full px-2 py-1 border rounded" min="0">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Entrega (min)</label>
              <div class="flex gap-2">
                <input type="number" id="deliveryTimeMin" placeholder="Min" class="w-full px-2 py-1 border rounded"
                  min="0">
                <input type="number" id="deliveryTimeMax" placeholder="Max" class="w-full px-2 py-1 border rounded"
                  min="0">
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">Essas estimativas aparecer√£o no cabe√ßalho da loja.</p>
        </div>
        <div class="mt-4 border-t pt-4">
          <h4 class="font-semibold text-gray-800 mb-3">üìä Controle de Capacidade</h4>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Capacidade simult√¢nea</label>
              <input type="number" id="maxConcurrentOrders" placeholder="10" class="w-full px-2 py-1 border rounded"
                min="1">
              <p class="text-xs text-gray-400 mt-1">Pedidos em preparo ao mesmo tempo</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Acr√©scimo (min)</label>
              <input type="number" id="highDemandExtraTime" placeholder="15" class="w-full px-2 py-1 border rounded"
                min="0">
              <p class="text-xs text-gray-400 mt-1">Tempo extra em alta demanda</p>
            </div>
          </div>
        </div>
        <button type="button" id="saveDeliverySettings"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium mt-4">
          üíæ Salvar Configura√ß√£o de Entrega
        </button>
      </div>

      <!-- Se√ß√£o de Mensagens Autom√°ticas -->
      <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üí¨ Mensagens Autom√°ticas</h2>
        <div class="space-y-4">
          <p class="text-sm text-gray-500">Configure as mensagens enviadas via WhatsApp para cada status.</p>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Status</label>
              <select id="templateStatusSelect" class="w-full px-3 py-2 border rounded-lg">
                <option value="recebido">üÜï Recebido</option>
                <option value="em_preparo">üç≥ Em Preparo</option>
                <option value="pronto">‚úÖ Pronto</option>
                <option value="saiu_entrega">üöö Saiu para Entrega</option>
                <option value="entregue">‚úîÔ∏è Entregue</option>
                <option value="cancelado">‚ùå Cancelado</option>
              </select>
            </div>
            <div class="flex items-end">
              <button type="button" id="resetTemplate" class="text-sm text-rose-600 hover:text-rose-800 mb-3">Restaurar
                Padr√£o</button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Template da Mensagem</label>
            <div class="text-xs text-gray-500 mb-2 bg-gray-50 p-2 rounded">
              <strong>Vari√°veis:</strong> {{nome}}, {{pedido}}, {{total}}, {{itens}}, {{motivo}}
            </div>
            <textarea id="templateContent" rows="5" class="w-full px-3 py-2 border rounded-lg text-sm font-mono"
              placeholder="Ol√° {{nome}}, seu pedido..."></textarea>
          </div>

          <button type="button" id="saveTemplate"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
            üíæ Salvar Template
          </button>
        </div>
      </div>
  </div>
  </main>

  <!-- Admin Content - Clients -->
  <main id="clientsPanelFast" class="container mx-auto px-4 py-6 hidden">
    <div class="grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Cliente</h3>
          <form id="clientForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
              <input id="clientName" class="w-full px-3 py-2 border rounded-lg" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Data de Nascimento *</label>
              <input type="date" id="clientBirthdate" class="w-full px-3 py-2 border rounded-lg" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
              <input id="clientPhone" class="w-full px-3 py-2 border rounded-lg" placeholder="(00) 00000-0000"
                required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
              <input type="email" id="clientEmail" class="w-full px-3 py-2 border rounded-lg"
                placeholder="cliente@email.com" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
              <input id="clientAddress" class="w-full px-3 py-2 border rounded-lg" placeholder="Rua, n√∫mero, bairro" />
            </div>
            <div class="bg-blue-50 p-3 rounded-lg">
              <p class="text-xs text-blue-800">
                <strong>LGPD:</strong> Ao se cadastrar, voc√™ concorda com o uso de seus dados para promo√ß√µes, contato
                e registro de pedidos.
                Seus dados ser√£o armazenados com seguran√ßa e poder√£o ser exclu√≠dos a qualquer momento mediante
                solicita√ß√£o.
              </p>
            </div>
            <button type="submit"
              class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Cadastrar
              Cliente</button>
          </form>
        </div>
      </div>
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Clientes Cadastrados</h3>

          <!-- Filtros de Clientes -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
            <div>
              <input type="text" id="clientSearch" placeholder="Buscar nome/telefone..."
                class="w-full px-3 py-2 border rounded-lg text-sm">
            </div>
            <div>
              <select id="filterNameInitial" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="">Inicial: Todas</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="G">G</option>
                <option value="H">H</option>
                <option value="I">I</option>
                <option value="J">J</option>
                <option value="K">K</option>
                <option value="L">L</option>
                <option value="M">M</option>
                <option value="N">N</option>
                <option value="O">O</option>
                <option value="P">P</option>
                <option value="Q">Q</option>
                <option value="R">R</option>
                <option value="S">S</option>
                <option value="T">T</option>
                <option value="U">U</option>
                <option value="V">V</option>
                <option value="W">W</option>
                <option value="X">X</option>
                <option value="Y">Y</option>
                <option value="Z">Z</option>
              </select>
            </div>
            <div>
              <select id="filterBirthMonth" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="">Anivers√°rio: Todos</option>
                <option value="01">Janeiro</option>
                <option value="02">Fevereiro</option>
                <option value="03">Mar√ßo</option>
                <option value="04">Abril</option>
                <option value="05">Maio</option>
                <option value="06">Junho</option>
                <option value="07">Julho</option>
                <option value="08">Agosto</option>
                <option value="09">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
                <option value="no-date">Sem data</option>
              </select>
            </div>
            <div>
              <button id="clearClientFilters"
                class="w-full px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium">
                üîÑ Limpar Filtros
              </button>
            </div>
          </div>

          <div id="clientsList" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Admin Content - Promotions -->
  <main id="promotionsPanelFast" class="container mx-auto px-4 py-6 hidden">
    <div class="grid lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Promo√ß√µes por Produto</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Produto</label>
            <select id="promotionProduct" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Escolha um produto...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Desconto</label>
            <select id="promotionType" class="w-full px-3 py-2 border rounded-lg">
              <option value="percentage">Percentual (%)</option>
              <option value="fixed">Valor Fixo (R$)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Valor do Desconto</label>
            <input type="number" id="promotionValue" step="0.01" class="w-full px-3 py-2 border rounded-lg"
              placeholder="0.00" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o da Promo√ß√£o</label>
            <input type="text" id="promotionDescription" class="w-full px-3 py-2 border rounded-lg"
              placeholder="Ex: Promo√ß√£o de ver√£o" />
          </div>
          <button type="button" id="savePromotion"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Salvar
            Promo√ß√£o</button>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Descontos por Cliente</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Cliente</label>
            <select id="clientDiscountSelect" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Escolha um cliente...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Desconto de Fidelidade (%)</label>
            <input type="number" id="clientDiscountValue" step="0.01" min="0" max="100"
              class="w-full px-3 py-2 border rounded-lg" placeholder="0" />
          </div>
          <button type="button" id="saveClientDiscount"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Salvar
            Desconto</button>
        </div>
        <div class="mt-6">
          <h4 class="font-semibold text-gray-800 mb-3">Promo√ß√µes Ativas</h4>
          <div id="promotionsList" class="space-y-2"></div>
        </div>
        <div class="mt-6">
          <h4 class="font-semibold text-gray-800 mb-3">üéØ Descontos por Cliente</h4>
          <div id="clientDiscountsList" class="space-y-2 max-h-60 overflow-y-auto">
            <p class="text-sm text-gray-500">Nenhum desconto ativo</p>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Discounts Configuration Grid -->
    <div class="mt-6 grid lg:grid-cols-2 gap-6">
      <!-- Special Discount Configuration (Left) -->
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">‚≠ê Desconto Fidelidade</h3>

        <!-- Status Card -->
        <div id="specialDiscountStatus" class="mb-4 p-3 rounded-lg bg-gray-100 border-l-4 border-gray-400">
          <p class="text-sm text-gray-600 font-medium">Carregando configura√ß√£o...</p>
        </div>

        <div class="space-y-4">
          <p class="text-sm text-gray-600">Desconto autom√°tico baseado na fidelidade do cliente.</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">M√≠nimo de Pedidos (Pagos)</label>
              <input type="number" id="specialDiscountMinOrders" class="w-full px-3 py-2 border rounded-lg"
                placeholder="Ex: 10">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">M√≠nimo Valor Pedido (R$)</label>
              <input type="number" step="0.01" id="specialDiscountMinVal" class="w-full px-3 py-2 border rounded-lg"
                placeholder="Ex: 50.00">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Desconto</label>
              <select id="specialDiscountType" class="w-full px-3 py-2 border rounded-lg">
                <option value="percentage">% Porcentagem</option>
                <option value="fixed">R$ Fixo</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Valor do Desconto</label>
              <input type="number" step="0.01" id="specialDiscountValue" class="w-full px-3 py-2 border rounded-lg"
                placeholder="Ex: 10">
            </div>
          </div>
          <div class="flex gap-2">
            <button id="saveSpecialDiscountConfig"
              class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-medium">Salvar
              Configura√ß√£o</button>
            <div id="specialDiscountMsg" class="text-sm text-gray-600 flex items-center"></div>
          </div>
        </div>
      </div>

      <!-- Birthday Discount Configuration (Right) -->
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">üéÇ Desconto de Anivers√°rio</h3>

        <!-- Status Card -->
        <div id="birthdayDiscountStatus" class="mb-4 p-3 rounded-lg bg-gray-100 border-l-4 border-gray-400">
          <p class="text-sm text-gray-600 font-medium">Carregando configura√ß√£o...</p>
        </div>

        <div class="space-y-4">
          <p class="text-sm text-gray-600">Desconto especial no dia do anivers√°rio do cliente. Uso √∫nico por ano.</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Desconto</label>
              <select id="birthdayDiscountType" class="w-full px-3 py-2 border rounded-lg">
                <option value="percentage">% Porcentagem</option>
                <option value="fixed">R$ Fixo</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Valor do Desconto</label>
              <input type="number" step="0.01" id="birthdayDiscountValue" class="w-full px-3 py-2 border rounded-lg"
                placeholder="Ex: 10">
            </div>
          </div>
          <div class="flex gap-2">
            <button id="saveBirthdayDiscountConfig"
              class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-medium">Salvar
              Configura√ß√£o</button>
            <div id="birthdayDiscountMsg" class="text-sm text-gray-600 flex items-center"></div>
          </div>
          <p class="text-xs text-gray-500 mt-2">üí° Este desconto acumula com qualquer outro desconto.</p>
        </div>
      </div>
    </div>

    <!-- Cupons de Desconto Section -->
    <div class="mt-6 bg-white rounded-xl shadow p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">üéüÔ∏è Cupons de Desconto</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div id="couponFormContainer">
            <input type="hidden" id="editingCouponId" value="" />
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo do Cupom</label>
              <input type="text" id="couponCode" class="w-full px-3 py-2 border rounded-lg uppercase"
                placeholder="EX: PROMO10" />
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                <select id="couponType" class="w-full px-3 py-2 border rounded-lg">
                  <option value="percentage">% Percentual</option>
                  <option value="fixed">R$ Fixo</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor</label>
                <input type="number" id="couponValue" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="0.00" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">M√≠nimo Pedido (R$)</label>
                <input type="number" id="couponMinOrder" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="0.00" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Validade</label>
                <input type="date" id="couponExpiry" class="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Limite Valor (R$)</label>
                <input type="number" id="couponMaxValue" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="Ex: 100.00" />
                <p class="text-xs text-gray-500 mt-1">Limite total de desconto</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Limite Usos</label>
                <input type="number" id="couponMaxUsage" step="1" min="0" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="Ex: 20" />
                <p class="text-xs text-gray-500 mt-1">N¬∫ de utiliza√ß√µes</p>
              </div>
            </div>
            <div class="flex gap-2 mt-4">
              <button type="button" id="saveCoupon"
                class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
                Criar Cupom
              </button>
              <button type="button" id="cancelEditCoupon"
                class="hidden flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-lg font-medium">
                Cancelar
              </button>
            </div>
          </div>
        </div>
        <div>
          <h4 class="font-semibold text-gray-800 mb-3">‚úÖ Cupons Ativos</h4>
          <div id="couponsList" class="space-y-2 max-h-48 overflow-y-auto"></div>

          <h4 class="font-semibold text-gray-800 mb-3 mt-6">‚ùå Cupons Inativos</h4>
          <div id="inactiveCouponsList" class="space-y-2 max-h-32 overflow-y-auto text-sm"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Banner de Propaganda Admin Panel -->
  <main id="bannerPanelFast" class="hidden container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl mx-auto">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">üì¢ Banner de Propaganda</h2>

      <div id="bannerAdminMessage" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

      <div class="space-y-6">
        <!-- Enable Toggle -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <label class="font-medium text-gray-800">Exibir Banner</label>
            <p class="text-sm text-gray-500">Se desativado, nenhum banner aparece (nem fallback)</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="bannerEnabled" class="sr-only peer" checked>
            <div
              class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600">
            </div>
          </label>
        </div>

        <!-- Image Upload -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Imagem do Banner</label>
          <p class="text-xs text-gray-500 mb-2">üìê Dimens√µes recomendadas: 728√ó90 (desktop) ou 320√ó50 (mobile)</p>
          <div class="flex gap-3">
            <input type="text" id="bannerImageUrl" class="flex-1 px-3 py-2 border rounded-lg text-sm"
              placeholder="URL da imagem ou fa√ßa upload">
            <label
              class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg cursor-pointer text-sm font-medium">
              Upload
              <input type="file" id="bannerImageUpload" accept="image/*" class="hidden">
            </label>
          </div>
          <div id="bannerImagePreview" class="mt-3 hidden">
            <img id="bannerPreviewImg" src="" alt="Preview" class="max-h-24 rounded-lg border">
          </div>
        </div>

        <!-- Link URL -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Link de Destino (opcional)</label>
          <input type="url" id="bannerLinkUrl" class="w-full px-3 py-2 border rounded-lg text-sm"
            placeholder="https://exemplo.com ou deixe vazio">
        </div>

        <!-- Alt Text -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Texto Alternativo</label>
          <input type="text" id="bannerAltText" class="w-full px-3 py-2 border rounded-lg text-sm"
            placeholder="Anuncie aqui" value="Anuncie aqui">
        </div>

        <!-- Save Button -->
        <button id="saveBannerConfig"
          class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium text-lg">
          üíæ Salvar Configura√ß√£o
        </button>
      </div>

      <!-- Preview Section -->
      <div class="mt-6 pt-6 border-t">
        <h3 class="font-bold text-gray-800 mb-3">Preview do Banner</h3>
        <div id="bannerLivePreview" class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-4 text-center">
          <p class="text-purple-600 font-medium">Anuncie aqui</p>
          <p class="text-xs text-gray-500 mt-1">Configure uma imagem para substituir este placeholder</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Ratings (Avalia√ß√µes) Panel -->
  <main id="ratingsPanelFast" class="hidden container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">‚≠ê Avalia√ß√µes dos Clientes</h2>

      <!-- Status Filter Tabs -->
      <div class="flex flex-wrap gap-2 mb-3">
        <button onclick="RatingsModule.setStatusFilter('all')" data-filter="all"
          class="rating-filter-btn px-4 py-2 bg-rose-600 text-white rounded-lg text-sm font-medium transition">Todas</button>
        <button onclick="RatingsModule.setStatusFilter('pending')" data-filter="pending"
          class="rating-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition hover:bg-gray-300">‚è≥
          Pendentes</button>
        <button onclick="RatingsModule.setStatusFilter('published')" data-filter="published"
          class="rating-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition hover:bg-gray-300">‚úì
          Publicadas</button>
        <button onclick="RatingsModule.setStatusFilter('archived')" data-filter="archived"
          class="rating-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition hover:bg-gray-300">Arquivadas</button>
      </div>

      <!-- Star Filter (quick filter for high ratings to publish) -->
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <span class="text-xs text-gray-500">Filtrar por nota:</span>
        <button onclick="RatingsModule.setStarFilter(0)" data-stars="0"
          class="star-filter-btn px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs hover:bg-gray-200 ring-2 ring-rose-500">Todas</button>
        <button onclick="RatingsModule.setStarFilter(5)" data-stars="5"
          class="star-filter-btn px-2 py-1 bg-yellow-50 text-yellow-700 rounded text-xs hover:bg-yellow-100">‚≠ê5</button>
        <button onclick="RatingsModule.setStarFilter(4)" data-stars="4"
          class="star-filter-btn px-2 py-1 bg-yellow-50 text-yellow-700 rounded text-xs hover:bg-yellow-100">‚≠ê4+</button>
        <button onclick="RatingsModule.setStarFilter(3)" data-stars="3"
          class="star-filter-btn px-2 py-1 bg-yellow-50 text-yellow-700 rounded text-xs hover:bg-yellow-100">‚≠ê3+</button>
      </div>

      <!-- Inline Message Area -->
      <div id="ratingsMessage" class="hidden mb-4 p-3 rounded-lg text-sm text-center"></div>

      <!-- Ratings List -->
      <div id="ratingsList" class="space-y-4 max-h-[70vh] overflow-y-auto">
        <div class="text-center py-12 text-gray-500">
          <p class="text-4xl mb-2">‚≠ê</p>
          <p>Carregando avalia√ß√µes...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Reports Panel -->
  <main id="reportsPanelFast" class="hidden container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Relat√≥rios</h2>

      <!-- Period Filter -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo</label>
        <div class="flex flex-wrap gap-2">
          <button id="reportPeriodMonth"
            class="px-4 py-2 bg-rose-600 text-white rounded-lg text-sm font-medium">Mensal</button>
          <button id="reportPeriodSemester"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Semestral</button>
          <button id="reportPeriodYear"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Anual</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- Client Ranking -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">üèÜ Ranking de Clientes</h3>
          <p class="text-sm text-gray-600 mb-4">Clientes que mais gastaram no per√≠odo selecionado:</p>
          <div id="clientRankingList" class="space-y-2 max-h-80 overflow-y-auto">
            <div class="text-center py-8 text-gray-500">
              <p class="text-4xl mb-2">üìà</p>
              <p>Nenhum pedido registrado ainda.</p>
              <p class="text-xs mt-2">Os pedidos ser√£o registrados no Supabase para an√°lise.</p>
            </div>
          </div>
        </div>

        <!-- Order History -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Hist√≥rico de Pedidos</h3>
          <div class="mb-4">
            <input type="text" id="orderSearchClient" placeholder="Buscar por cliente..."
              class="w-full px-3 py-2 border rounded-lg text-sm" />
          </div>
          <div id="orderHistoryList" class="space-y-2 max-h-80 overflow-y-auto">
            <div class="text-center py-8 text-gray-500">
              <p class="text-4xl mb-2">üõí</p>
              <p>Nenhum pedido registrado ainda.</p>
              <p class="text-xs mt-2">Os pedidos enviados via WhatsApp ser√£o salvos aqui.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section (2 Columns) -->
      <div class="mt-6 grid lg:grid-cols-2 gap-6">
        <!-- Top Products -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">üî• Produtos Mais Pedidos</h3>
          <div id="topProductsList" class="grid grid-cols-2 gap-3">
            <div class="text-center py-6 text-gray-500 col-span-full">
              <p class="text-4xl mb-2">üçΩÔ∏è</p>
              <p>Aguardando dados de pedidos...</p>
            </div>
          </div>
        </div>

        <!-- Neighborhood Orders Chart -->
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex flex-wrap items-center justify-between mb-4 gap-2">
            <h3 class="text-lg font-semibold text-gray-800">üó∫Ô∏è Pedidos por Bairro</h3>
            <div class="flex gap-2">
              <select id="neighborhoodFilterYear" class="text-xs border rounded p-1">
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
              </select>
              <select id="neighborhoodFilterPeriod" class="text-xs border rounded p-1">
                <option value="all">Todo o ano</option>
                <option value="1">1¬∫ Semestre</option>
                <option value="2">2¬∫ Semestre</option>
                <option value="jan">Janeiro</option>
                <option value="feb">Fevereiro</option>
                <option value="mar">Mar√ßo</option>
                <option value="apr">Abril</option>
                <option value="may">Maio</option>
                <option value="jun">Junho</option>
                <option value="jul">Julho</option>
                <option value="aug">Agosto</option>
                <option value="sep">Setembro</option>
                <option value="oct">Outubro</option>
                <option value="nov">Novembro</option>
                <option value="dec">Dezembro</option>
              </select>
            </div>
          </div>
          <div id="neighborhoodChartContainer" class="space-y-2">
            <div class="text-center py-6 text-gray-500">
              <p class="text-4xl mb-2">üìç</p>
              <p>Aguardando dados de pedidos...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-green-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-green-700" id="totalRevenueCard">R$ 0,00</p>
          <p class="text-xs text-green-600">Faturamento Total</p>
        </div>
        <div class="bg-blue-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-blue-700" id="totalOrdersCard">0</p>
          <p class="text-xs text-blue-600">Total de Pedidos</p>
        </div>
        <div class="bg-purple-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-purple-700" id="avgOrderCard">R$ 0,00</p>
          <p class="text-xs text-purple-600">Ticket M√©dio</p>
        </div>
        <div class="bg-orange-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-orange-700" id="uniqueClientsCard">0</p>
          <p class="text-xs text-orange-600">Clientes √önicos</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Orders Management Panel -->
  <main id="ordersPanelFast" class="hidden container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Painel de Pedidos</h2>

      <!-- Dashboard KPIs -->
      <div id="ordersDashboard" class="mb-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200">
            <p class="text-xs text-green-600 font-medium mb-1">üí∞ Faturamento</p>
            <p class="text-xl font-bold text-green-700" id="kpiFaturamento">R$ 0,00</p>
            <p class="text-xs text-green-500" id="kpiFaturamentoLabel">no per√≠odo</p>
          </div>
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
            <p class="text-xs text-blue-600 font-medium mb-1">üì¶ Pedidos</p>
            <p class="text-xl font-bold text-blue-700" id="kpiTotalPedidos">0</p>
            <p class="text-xs text-blue-500" id="kpiPedidosLabel">no per√≠odo</p>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200">
            <p class="text-xs text-purple-600 font-medium mb-1">üéØ Ticket M√©dio</p>
            <p class="text-xl font-bold text-purple-700" id="kpiTicketMedio">R$ 0,00</p>
            <p class="text-xs text-purple-500">por pedido</p>
          </div>
          <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200">
            <p class="text-xs text-orange-600 font-medium mb-1">üèÜ Pedido Recorde</p>
            <p class="text-xl font-bold text-orange-700" id="kpiMaiorPedido">R$ 0,00</p>
            <p class="text-xs text-orange-500">maior valor</p>
          </div>
        </div>
      </div>

      <div class="grid xl:grid-cols-2 gap-6 mb-6">
        <!-- Filters -->
        <div class="grid md:grid-cols-3 gap-4 h-fit">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
            <select id="ordersFilterDate" class="w-full px-3 py-2 border rounded-lg">
              <option value="today">Hoje</option>
              <option value="yesterday">Ontem</option>
              <option value="week">√öltima semana</option>
              <option value="month">Este m√™s</option>
              <option value="all">Todos</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="ordersFilterStatus" class="w-full px-3 py-2 border rounded-lg">
              <option value="all">Todos</option>
              <option value="pending">üÜï Recebido</option>
              <option value="accepted">‚úÖ Aceito (Aguard. Pgto)</option>
              <option value="preparing">üç≥ Em Preparo</option>
              <option value="confirmed">‚úÖ Pronto</option>
              <option value="out_for_delivery">üöö Saiu p/ Entrega</option>
              <option value="delivered">‚úîÔ∏è Entregue</option>
              <option value="cancelled">‚ùå Cancelado</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="refreshOrders"
              class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
              üîÑ Atualizar
            </button>
          </div>
        </div>

        <!-- Excluir Pedidos por C√≥digo -->
        <div class="bg-amber-50 border border-amber-300 rounded-lg p-4 h-fit">
          <h4 class="font-semibold text-amber-800 mb-2">üóëÔ∏è Excluir Pedidos</h4>
          <p class="text-sm text-amber-700 mb-3">
            Digite o c√≥digo do pedido que deseja excluir (ex: FAST-0001).
            Para excluir v√°rios, separe por v√≠rgula.
          </p>
          <div class="flex gap-2 items-center flex-wrap">
            <input type="text" id="orderCodesToDelete" placeholder="FAST-0001, FAST-0002, ..."
              class="flex-1 min-w-[200px] px-3 py-2 border border-amber-300 rounded-lg text-sm" />
            <button id="confirmDeleteOrdersBtn"
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap">
              üóëÔ∏è Excluir
            </button>
          </div>
          <div id="deleteOrdersResult" class="mt-2 text-sm font-medium"></div>
        </div>
      </div>

      <!-- Stats Summary -->
      <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-6">
        <div class="bg-blue-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-blue-700" id="ordersCountNew">0</p>
          <p class="text-xs text-blue-600">Novos</p>
        </div>
        <div class="bg-yellow-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-yellow-700" id="ordersCountPreparing">0</p>
          <p class="text-xs text-yellow-600">Preparando</p>
        </div>
        <div class="bg-green-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-green-700" id="ordersCountReady">0</p>
          <p class="text-xs text-green-600">Prontos</p>
        </div>
        <div class="bg-orange-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-orange-700" id="ordersCountDelivery">0</p>
          <p class="text-xs text-orange-600">Em Entrega</p>
        </div>
        <div class="bg-gray-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-gray-700" id="ordersCountDelivered">0</p>
          <p class="text-xs text-gray-600">Entregues</p>
        </div>
        <div class="bg-red-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-red-700" id="ordersCountCanceled">0</p>
          <p class="text-xs text-red-600">Cancelados</p>
        </div>
      </div>

      <!-- Orders List -->
      <div id="ordersListContainer" class="space-y-4">
        <div class="text-center py-12 text-gray-500">
          <p class="text-5xl mb-3">üì¶</p>
          <p class="font-medium">Nenhum pedido encontrado</p>
          <p class="text-sm">Os pedidos aparecer√£o aqui quando forem feitos.</p>
        </div>
      </div>
    </div>
  </main>
  </div>

  <!-- Public Store -->
  <div id="publicStore" class="hidden">
    <header class="text-white shadow" style="background:#000">
      <div class="container mx-auto px-3 sm:px-4 py-3 sm:py-4">
        <!-- Mobile: Logo, Phone, Buttons in one line -->
        <div class="sm:hidden flex items-center justify-between gap-2">
          <div class="flex items-center cursor-pointer" id="publicStoreLogo">
            <img src="../assets/img/fast-logo.png" alt="Fast Savory's"
              class="h-10 object-contain hover:opacity-80 transition-opacity" />
          </div>
          <div class="text-xs text-white font-bold">üìû 73 99936-6554</div>
          <div class="flex items-center gap-2">
            <button id="adminLoginBtn"
              class="bg-rose-200 hover:bg-rose-300 text-black px-2 py-2 rounded-lg text-xs font-medium">Entrar</button>
            <button id="cartBtn"
              class="relative bg-white/20 hover:bg-white/30 px-2 py-2 rounded-lg min-w-[40px] min-h-[40px] flex items-center justify-center">
              <span class="text-lg">üõí</span>
              <span id="cartCount"
                class="absolute -top-1 -right-1 bg-yellow-300 text-black text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
            </button>
          </div>
        </div>

        <!-- Desktop: Original layout -->
        <div class="hidden sm:flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center cursor-pointer" id="publicStoreLogoDesktop">
            <img src="../assets/img/fast-logo.png" alt="Fast Savory's"
              class="h-14 md:h-16 object-contain hover:opacity-80 transition-opacity" />
          </div>
          <div class="flex flex-1 text-center flex-col">
            <div class="text-base md:text-lg text-white leading-tight font-bold">FastSavory's</div>
            <div class="text-sm text-white leading-tight">üìû 73 99936-6554</div>
            <div class="hidden md:block text-xs text-white leading-tight truncate max-w-[300px] lg:max-w-none mx-auto">
              üìç Rua Palmeiras, 105, Novo Prado, Itamaraju-BA</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="backToAdminBtn"
              class="hidden bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg text-xs">Edi√ß√£o</button>
            <button id="adminLoginBtnDesktop"
              class="bg-rose-200 hover:bg-rose-300 text-black px-3 py-2 rounded-lg text-sm font-medium">Entrar</button>
            <button id="cartBtnDesktop"
              class="relative bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center">
              <span class="text-xl">üõí</span>
              <span id="cartCountDesktop"
                class="absolute -top-2 -right-2 bg-yellow-300 text-black text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <nav class="shadow-sm sticky top-0 z-10 bg-white">
      <div class="container mx-auto px-3 sm:px-4">
        <div id="openNotice" class="text-sm py-2 px-3 rounded-lg my-2 text-center"></div>
        <div id="deliveryStatusBanner" class="hidden text-sm py-2 px-3 rounded-lg mb-2 text-center"></div>

        <div class="flex justify-center mb-2">
          <button id="openTrackingModalBtn" type="button"
            class="text-xs sm:text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded-lg font-medium w-full sm:w-auto">
            üîé Acompanhar pedido
          </button>
        </div>

        <!-- Mobile: Grid 3 columns -->
        <div class="sm:hidden grid grid-cols-3 gap-2 py-3">
          <button class="category-tab active px-2 py-2 rounded-lg text-white font-medium text-xs bg-red-600 text-center"
            data-category="salgados">ü•ü Salgados</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="mini">üßÅ Mini</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="kits">üéÅ Kits Festa</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="bolos">üéÇ Bolos</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="bebidas">ü•§ Bebidas</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="adicionais">‚ûï Extras</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-pink-200 text-pink-900 font-medium text-xs text-center"
            data-category="favoritos">‚ù§Ô∏è Favoritos</button>
          <button class="filter-tab px-2 py-2 rounded-lg bg-yellow-200 text-yellow-900 font-medium text-xs text-center"
            data-filter="promo">üè∑Ô∏è Promo√ß√µes</button>
          <button class="filter-tab px-2 py-2 rounded-lg bg-purple-200 text-purple-900 font-medium text-xs text-center"
            data-filter="encomenda">üìÖ Encomendas</button>
          <a href="https://pedidos.site/pedidoimperioburguerepizzas" target="_blank"
            class="col-span-3 px-2 py-2 rounded-lg bg-orange-500 text-white font-medium text-xs flex items-center justify-center gap-2">
            <img src="../assets/img/imperio-burguer-icon.png" alt="Imp√©rio" class="h-5 w-5 rounded-full object-cover" />
            Lanches e Pizzas
          </a>
        </div>

        <!-- Desktop: Flex row with standardized buttons -->
        <div class="hidden sm:flex flex-wrap gap-2 py-3 justify-center">
          <button
            class="category-tab active px-4 py-2 rounded-lg text-white font-medium text-sm bg-red-600 min-w-[130px] text-center"
            data-category="salgados">ü•ü Salgados</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="mini">üßÅ Mini</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="kits">üéÅ Kits Festa</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="bolos">üéÇ Bolos</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="bebidas">ü•§ Bebidas</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="adicionais">‚ûï Extras</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-pink-200 text-pink-900 font-medium text-sm hover:bg-pink-300 min-w-[130px] text-center"
            data-category="favoritos">‚ù§Ô∏è Favoritos</button>
          <button
            class="filter-tab px-4 py-2 rounded-lg bg-yellow-200 text-yellow-900 font-medium text-sm hover:bg-yellow-300 min-w-[130px] text-center"
            data-filter="promo">üè∑Ô∏è Promo√ß√µes</button>
          <button
            class="filter-tab px-4 py-2 rounded-lg bg-purple-200 text-purple-900 font-medium text-sm hover:bg-purple-300 min-w-[130px] text-center"
            data-filter="encomenda">üìÖ Encomendas</button>
          <a href="https://pedidos.site/pedidoimperioburguerepizzas" target="_blank"
            class="px-4 py-2 rounded-lg bg-orange-500 text-white font-medium text-sm hover:bg-orange-600 min-w-[130px] flex items-center justify-center gap-2">
            <img src="../assets/img/imperio-burguer-icon.png" alt="Imp√©rio" class="h-5 w-5 rounded-full object-cover" />
            Lanches e Pizzas
          </a>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-3 sm:px-4 py-4 sm:py-6">
      <!-- Bot√£o Pedir de Novo (atalho r√°pido) -->
      <!-- Bot√£o Pedir de Novo (removido) -->

      <!-- Se√ß√£o de √öltimos Pedidos (para clientes que retornam) -->
      <div id="recentOrdersSection" class="mb-6 hidden"></div>

      <!-- Se√ß√£o de Promo√ß√µes do Dia -->
      <div id="promosSection" class="mb-6 hidden">
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 border border-yellow-200">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-gray-800 flex items-center">
              <span class="mr-2">üè∑Ô∏è</span> Promo√ß√µes do Dia
            </h2>
            <span
              class="text-xs bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full font-semibold animate-pulse">OFERTAS</span>
          </div>
          <div id="promosContainer" class="flex gap-3 overflow-x-auto pt-2 pb-2 snap-x snap-mandatory scrollbar-hide"
            style="scroll-behavior: smooth;"></div>
        </div>
      </div>

      <!-- Se√ß√£o Mais Pedidos -->
      <div id="topProductsSection" class="mb-6 hidden">
        <div class="bg-gradient-to-r from-rose-50 to-pink-50 rounded-xl p-4 border border-rose-200">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-gray-800 flex items-center">
              <span class="mr-2">üî•</span> Mais Pedidos
            </h2>
            <span class="text-xs bg-rose-500 text-white px-2 py-1 rounded-full font-semibold">TOP</span>
          </div>
          <div id="topProductsContainer" class="grid grid-cols-2 gap-3">
            <!-- Top products will be rendered here -->
          </div>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4 sm:gap-6">
        <div class="lg:col-span-2 space-y-12">
          <!-- Salgados Section -->
          <section id="salgados" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">ü•ü</span> Salgados
            </h2>
            <div id="salgadosContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Mini-Salgados Section -->
          <section id="mini" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">üßÅ</span> Mini-Salgados
            </h2>
            <div id="miniContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Kits Festa Section -->
          <section id="kits" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">üéÅ</span> Kits Festa
            </h2>
            <div id="kitsContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Bolos Section -->
          <section id="bolos" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">üéÇ</span> Bolos
            </h2>
            <div id="bolosContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Bebidas Section -->
          <section id="bebidas" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">ü•§</span> Bebidas
            </h2>
            <div id="bebidasContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Adicionais Section -->
          <section id="adicionais" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">‚ûï</span> Adicionais
            </h2>
            <div id="adicionaisContainer" class="grid md:grid-cols-3 gap-4"></div>
          </section>

          <!-- Favoritos Section -->
          <section id="favoritos" class="category-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">‚ù§Ô∏è</span> Seus Favoritos
            </h2>
            <div id="favoritosContainer" class="grid md:grid-cols-2 gap-4">
              <p class="text-gray-500 text-center py-8 col-span-2">Voc√™ ainda n√£o marcou nenhum item como favorito.
              </p>
            </div>
          </section>
        </div>
        <div class="lg:block hidden">
          <div class="bg-white rounded-xl shadow p-6 sticky top-24">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">üõí</span> Seu Pedido
            </h3>
            <div id="cartItems" class="space-y-3 mb-4 min-h-[100px]">
              <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
            </div>
            <div class="border-t pt-4">
              <div class="flex justify-between items-center mb-4"><span
                  class="font-semibold text-gray-800">Total:</span><span id="cartTotal"
                  class="text-xl text-rose-600 font-bold">R$ 0,00</span></div>
              <button id="checkoutBtn"
                class="w-full bg-rose-600 hover:bg-rose-700 text-black py-3 rounded-lg font-semibold transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                disabled>Finalizar Pedido</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-6 mt-12">
      <div class="container mx-auto px-4 text-center">
        <p class="text-sm mb-2">¬© 2026 FastSavory's. Todos os direitos reservados.</p>
        <p class="text-xs text-gray-400">
          Desenvolvido por
          <a href="https://i.im.ge/2025/12/20/BSwhSJ.JNC.png" target="_blank"
            class="text-blue-400 hover:text-blue-300 underline">
            <img src="https://i.im.ge/2025/12/20/BSwhSJ.JNC.png" alt="Desenvolvedor"
              class="inline-block h-4 w-4 align-middle" />
          </a>
        </p>
      </div>
    </footer>
  </div>

  <!-- Floating Cart Button (Mobile Only) -->
  <div id="floatingCartButton"
    class="fixed lg:hidden hidden bg-rose-600 hover:bg-rose-700 text-white rounded-full shadow-lg items-center px-4 py-3 space-x-2 cursor-pointer transition-all duration-300 active:scale-95"
    style="z-index: 9999; bottom: 1rem; right: 1rem;"
    onclick="this.style.display='none'; document.getElementById('cartModal').classList.remove('hidden')">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
      </path>
    </svg>
    <span id="floatingCartCount"
      class="bg-white text-rose-600 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">0</span>
    <span id="floatingCartTotal" class="font-semibold text-sm">R$ 0,00</span>
  </div>

  <!-- Mobile Cart Modal -->
  <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden lg:hidden">
    <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-xl p-6 max-h-[80vh] overflow-y-auto text-gray-800">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Seu Pedido</h3><button id="closeCartModal"
          class="text-gray-500 hover:text-gray-700"><span class="text-2xl">√ó</span></button>
      </div>
      <div id="mobileCartItems" class="space-y-3 mb-4">
        <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
      </div>
      <!-- Upsell suggestions -->
      <div id="upsellSection" class="hidden mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
        <p class="text-xs text-blue-700 font-semibold mb-2">üí° Combina com seu pedido:</p>
        <div id="upsellContainer" class="grid grid-cols-2 gap-2"></div>
      </div>
      <div class="border-t pt-4">
        <div class="flex justify-between items-center mb-4"><span class="font-semibold text-gray-800">Total:</span><span
            id="mobileCartTotal" class="text-xl text-rose-600 font-bold">R$ 0,00</span></div>
        <button id="mobileCheckoutBtn"
          class="w-full bg-rose-600 hover:bg-rose-700 text-black py-3 rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled>Finalizar Pedido</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o de exclus√£o de pedidos -->
  <div id="deleteOrdersModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 text-gray-800">
      <h3 class="text-xl font-bold text-amber-700 mb-4">‚ö†Ô∏è Confirmar Exclus√£o de Pedidos</h3>
      <p id="deleteOrdersModalText" class="text-gray-700 mb-4"></p>
      <div class="flex gap-3 justify-end">
        <button id="cancelDeleteOrdersModalBtn"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">Cancelar</button>
        <button id="confirmDeleteOrdersModalBtn"
          class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o de exclus√£o de cliente -->
  <div id="deleteClientModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 text-gray-800">
      <h3 class="text-xl font-bold text-amber-700 mb-4">‚ö†Ô∏è Confirmar Exclus√£o de Cliente</h3>
      <div id="deleteClientModalText" class="text-gray-700 mb-4"></div>
      <div class="flex gap-3 justify-end">
        <button id="cancelDeleteClientModalBtn"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">Cancelar</button>
        <button id="confirmDeleteClientModalBtn"
          class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">Excluir Cliente</button>
      </div>
    </div>
  </div>

  <!-- Public Ad Banner (Fixed Bottom) -->
  <div id="adBannerPublic" class="fixed bottom-0 left-0 right-0 z-[55] hidden">
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg">
      <div class="container mx-auto px-3 py-2 relative">
        <!-- Close Button -->
        <button id="closeBannerBtn"
          class="absolute top-1 right-1 sm:top-2 sm:right-2 z-10 bg-white/90 hover:bg-white text-gray-800 rounded-full w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center shadow-lg font-bold text-lg"
          aria-label="Fechar banner">
          ‚úï
        </button>

        <!-- Banner Content (Image or Fallback) -->
        <a id="adBannerLink" href="#" target="_blank" rel="noopener noreferrer" class="block">
          <!-- Image Banner -->
          <img id="adBannerImage" src="" alt=""
            class="hidden mx-auto max-h-[60px] sm:max-h-[80px] md:max-h-[90px] object-contain rounded">

          <!-- Fallback Banner -->
          <div id="adBannerFallback" class="text-center py-2">
            <p class="text-white font-bold text-sm sm:text-base">üì¢ Anuncie aqui</p>
            <p class="text-white/80 text-xs">Entre em contato para divulgar sua marca</p>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal"
    class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-start justify-center overflow-y-auto pt-4 pb-20 sm:py-10">
    <div class="bg-white rounded-xl p-4 sm:p-6 max-w-md w-full mx-auto shadow-2xl relative my-auto">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Finalizar Pedido</h3>

      <!-- Dados do Cliente - Primeiro -->
      <div class="mb-6">
        <h4 class="font-semibold text-gray-800 mb-3">Seus Dados</h4>
        <div class="space-y-3">
          <input id="customerName" placeholder="Seu nome completo" class="w-full px-3 py-2 border rounded-lg">
          <input id="customerPhone" placeholder="Seu telefone (WhatsApp)" class="w-full px-3 py-2 border rounded-lg">

          <!-- √Årea de busca e endere√ßos do cliente -->
          <div id="customerSearchArea" class="hidden">
            <div class="bg-green-50 border border-green-200 p-3 rounded-lg mb-3">
              <p class="text-sm text-green-800 font-medium">üìç Cliente encontrado!</p>
              <p id="foundCustomerInfo" class="text-sm text-green-700"></p>

              <!-- Endere√ßos salvos (m√∫ltiplos) -->
              <div id="savedAddressSection" class="mt-3 hidden">
                <div class="bg-white border rounded-lg p-3">
                  <p class="text-sm font-medium text-gray-800 mb-2">üìç Seus endere√ßos salvos:</p>
                  <select id="savedAddressSelect" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <option value="">Selecione um endere√ßo...</option>
                    <!-- Options will be populated by JS -->
                  </select>
                  <div class="flex gap-2">
                    <button type="button" id="confirmSavedAddress"
                      class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-medium">‚úì
                      Usar selecionado</button>
                    <button type="button" id="useDifferentAddress"
                      class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg text-sm font-medium">Outro
                      endere√ßo</button>
                  </div>
                </div>
              </div>

              <!-- Se n√£o tem endere√ßo salvo -->
              <div id="noAddressSection" class="mt-2 hidden">
                <p class="text-sm text-orange-600">Nenhum endere√ßo cadastrado.</p>
              </div>
            </div>
          </div>

          <div id="addressForm" class="space-y-3 hidden">
            <h5 class="font-medium text-gray-800">Endere√ßo de Entrega</h5>
            <div>
              <label class="text-xs text-gray-600 mb-1 block">Identifica√ß√£o (opcional)</label>
              <select id="addressLabel" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="Casa">üè† Casa</option>
                <option value="Trabalho">üíº Trabalho</option>
                <option value="Outro">üìç Outro</option>
              </select>
            </div>
            <input id="street" placeholder="Nome da rua" class="w-full px-3 py-2 border rounded-lg">
            <input id="number" placeholder="N√∫mero da casa" class="w-full px-3 py-2 border rounded-lg">
            <input id="neighborhood" placeholder="Bairro" class="w-full px-3 py-2 border rounded-lg">
            <input id="reference" placeholder="Ponto de refer√™ncia (opcional)"
              class="w-full px-3 py-2 border rounded-lg">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="saveAddressCheckbox" class="w-4 h-4 text-rose-600" checked>
              <span class="text-sm text-gray-700">Salvar este endere√ßo para pr√≥ximos pedidos</span>
            </label>
          </div>

          <!-- Termos de Uso -->
          <div class="mt-3">
            <label class="flex items-start gap-2 cursor-pointer">
              <input type="checkbox" id="acceptTermsCheckbox" class="w-4 h-4 text-rose-600 mt-1">
              <span class="text-sm text-gray-700">
                Aceito os <a href="#" onclick="openTermsModal(); return false;"
                  class="text-rose-600 hover:underline font-medium">Termos de Uso</a>
                do aplicativo.
              </span>
            </label>
          </div>

          <div class="bg-blue-50 p-3 rounded-lg mt-3">
            <p class="text-xs text-blue-800">
              <strong>LGPD:</strong> Seus dados ser√£o usados apenas para contato sobre este pedido e para participar de
              promo√ß√µes.
              Ao confirmar, voc√™ concorda com nossa pol√≠tica de privacidade.
            </p>
          </div>
        </div>
      </div>

      <!-- √öltimos Pedidos (Recompra R√°pida) -->
      <div id="lastOrdersSection" class="mb-6 hidden">
        <h4 class="font-semibold text-gray-800 mb-3">üîÑ Repetir pedido anterior</h4>
        <div id="lastOrdersList" class="space-y-2 max-h-40 overflow-y-auto"></div>
      </div>

      <!-- Forma de Pagamento -->
      <div class="mb-6">
        <h4 class="font-semibold text-gray-800 mb-3">Forma de Pagamento</h4>
        <div class="space-y-2 text-gray-800">
          <label class="flex items-center">
            <input type="radio" name="payment" value="dinheiro" class="mr-2">
            <span>üíµ Dinheiro</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="payment" value="pix" class="mr-2">
            <span>üì± PIX</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="payment" value="cartao1x" class="mr-2">
            <span>üí≥ Cart√£o 1x (<span id="cardFeeLabel1x">+5%</span>)</span>
          </label>
        </div>
      </div>

      <div id="moneyChangeBox" class="mb-6 hidden">
        <h4 class="font-semibold text-gray-800 mb-3">Troco para quanto?</h4>
        <input type="number" step="0.01" id="moneyChangeValue" placeholder="Ex.: 50.00"
          class="w-full px-3 py-2 border rounded-lg">
      </div>

      <div class="mb-6 text-gray-800">
        <h4 id="deliveryTitle" class="font-semibold text-gray-800 mb-3">Entrega</h4>
        <div class="space-y-2">
          <label class="flex items-center">
            <input type="radio" name="delivery" value="retirada" class="mr-2" checked>
            <span>üè™ Retirada na loja</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="delivery" value="entrega" class="mr-2">
            <span>üöö Entrega</span>
          </label>
        </div>
        <div class="mt-3 p-3 rounded-md bg-yellow-100 border border-yellow-300 text-yellow-900 text-sm font-semibold">
          Consulte o valor da taxa de entrega antes de finalizar o pedido.</div>
      </div>

      <div id="orderDateBox" class="mb-6 hidden">
        <div class="p-3 rounded-md bg-blue-100 border border-blue-300 text-blue-900 text-sm font-semibold mb-2">Fora do
          hor√°rio, aceitamos encomendas. At√© 07:00, pode agendar para hoje. A partir de 07:01, apenas para o pr√≥ximo
          dia.</div>
        <label class="block text-sm font-semibold text-gray-800 mb-2">Data da encomenda</label>
        <input type="date" id="orderDate" class="w-full px-3 py-2 border rounded-lg" />

        <label class="block text-sm font-semibold text-gray-800 mb-2 mt-4">Hor√°rio desejado</label>
        <input type="time" id="orderTimeSlot" class="w-full px-3 py-2 border rounded-lg" />
        <p id="orderTimeHint" class="text-xs text-gray-500 mt-1">Informe o hor√°rio exato da entrega/retirada.</p>
      </div>

      <div id="encomendaWarning" class="mb-6 hidden">
        <div class="p-3 rounded-md bg-yellow-100 border border-yellow-400 text-yellow-900 text-sm">
          <strong>‚ö†Ô∏è Encomenda:</strong> Estamos fora do hor√°rio. Informe a data e o hor√°rio desejado.
        </div>
      </div>

      <div id="couponBox" class="mb-6">
        <h4 class="font-semibold text-gray-800 mb-3">Cupom de desconto</h4>
        <div class="flex gap-2">
          <input id="couponInput" placeholder="Ex: PROMO10" class="flex-1 px-3 py-2 border rounded-lg uppercase" />
          <button id="applyCouponBtn" type="button"
            class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-medium">Aplicar</button>
          <button id="removeCouponBtn" type="button"
            class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium">Remover</button>
        </div>
        <div id="couponMessage" class="hidden mt-2 text-sm"></div>
      </div>

      <div class="mb-6 p-4 bg-gray-50 rounded-lg text-gray-800">
        <h4 class="font-semibold text-gray-800 mb-2">Resumo do Pedido</h4>
        <div id="checkoutItems" class="space-y-1 text-sm">
          <!-- Items will be loaded here -->
        </div>
        <div class="border-t mt-2 pt-2">
          <div id="deliveryFeeRowFast" class="flex justify-between text-sm mb-1 hidden"><span>Taxa de
              entrega:</span><span id="checkoutDeliveryFeeFast">R$ 0,00</span></div>
          <div id="cardFeeRowFast" class="flex justify-between text-sm mb-1 hidden"><span>Taxa cart√£o:</span><span
              id="checkoutCardFeeFast">R$ 0,00</span></div>
          <div class="flex justify-between font-semibold">
            <span>Total:</span>
            <span id="checkoutTotal">R$ 0,00</span>
          </div>
        </div>
      </div>

      <div id="validationWarnings" class="mb-4 space-y-2 hidden">
        <!-- Warnings will appear here -->
      </div>

      <div id="loyaltyInfoBox" class="mb-4 hidden">
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <p id="loyaltyInfoText" class="text-sm text-blue-900"></p>
        </div>
      </div>

      <div class="flex gap-3">
        <button id="cancelCheckout"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-medium">Cancelar</button>
        <button id="confirmOrder"
          class="flex-1 bg-rose-600 hover:bg-rose-700 text-black py-2 rounded-lg font-medium">Confirmar Pedido</button>
      </div>
    </div>
  </div>

  <div id="trackingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto text-gray-800">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800">Acompanhar pedido</h3>
        <button id="closeTrackingModalBtn" class="text-gray-500 hover:text-gray-700"><span
            class="text-2xl">√ó</span></button>
      </div>

      <div class="space-y-3 mb-4">
        <input id="trackingOrderCode" placeholder="C√≥digo do pedido (ex: FAST-0001)"
          class="w-full px-3 py-2 border rounded-lg uppercase">
        <input id="trackingPhone" placeholder="Telefone (WhatsApp)" class="w-full px-3 py-2 border rounded-lg">
        <button id="trackOrderBtn" type="button"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-semibold">Buscar pedido</button>
        <div id="trackingMessage" class="hidden text-sm"></div>
      </div>

      <div id="trackingResult" class="hidden">
        <div class="bg-gray-50 border rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700"><strong>C√≥digo:</strong> <span id="trackingCodeLabel"></span></p>
          <p class="text-sm text-gray-700"><strong>Status:</strong> <span id="trackingStatusLabel"></span></p>
          <p class="text-sm text-gray-700"><strong>Estimativa:</strong> <span id="trackingEstimateLabel"></span></p>
        </div>
        <div id="trackingTimeline" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Terms of Use Modal -->
  <div id="termsModal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[85vh] overflow-y-auto shadow-2xl">
      <div class="sticky top-0 bg-white p-4 border-b z-10">
        <h3 class="text-xl font-bold text-gray-800 text-center">üìú Termos de Uso</h3>
        <p class="text-xs text-gray-500 text-center mt-1">FastSavory's - Delivery de Alimentos</p>
      </div>
      <div class="p-6 text-gray-700 space-y-5 text-sm leading-relaxed">

        <section>
          <h4 class="font-bold text-gray-900 mb-2">1. Defini√ß√µes</h4>
          <ul class="list-disc pl-5 space-y-1 text-xs">
            <li><strong>Aplicativo:</strong> plataforma digital da FastSavory's para pedidos de alimentos (entrega e
              retirada).</li>
            <li><strong>Usu√°rio/Cliente:</strong> pessoa f√≠sica cadastrada que utiliza o Aplicativo.</li>
            <li><strong>Pedido:</strong> solicita√ß√£o de compra realizada pelo Usu√°rio.</li>
            <li><strong>Entrega:</strong> servi√ßo de deslocamento at√© o endere√ßo informado.</li>
            <li><strong>Retirada:</strong> op√ß√£o em que o Usu√°rio busca o Pedido na loja.</li>
          </ul>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">2. Objeto e Aceite</h4>
          <p>Ao se cadastrar ou utilizar o Aplicativo, o Usu√°rio declara ter lido, compreendido e aceitado integralmente
            estes Termos.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">3. Cadastro e Conta</h4>
          <p>O Usu√°rio deve fornecer dados verdadeiros e ser maior de 18 anos. A FastSavory's pode recusar cadastro ou
            encerrar contas em casos de fraude ou viola√ß√£o.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">4. Funcionamento (Delivery e Retirada)</h4>
          <ul class="list-disc pl-5 space-y-1 text-xs">
            <li><strong>Entrega:</strong> enviado ao endere√ßo informado, mediante taxa quando aplic√°vel.</li>
            <li><strong>Retirada:</strong> buscar diretamente na loja no prazo informado.</li>
          </ul>
          <p class="mt-2 text-xs">Hor√°rios, √°rea de entrega, valores e disponibilidade s√£o definidos pela loja.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">5. Pedidos e Entrega</h4>
          <p>O tempo de entrega √© estimado e pode variar. Na entrega, o Usu√°rio deve informar endere√ßo correto e estar
            dispon√≠vel para receber. Na retirada, comparecer dentro do prazo.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">6. Pagamentos</h4>
          <p>Pagamentos por cart√£o, PIX ou dinheiro. O valor final inclui taxas quando aplic√°vel. Dados de cart√£o s√£o
            tratados conforme normas de seguran√ßa.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">7. Promo√ß√µes e Cupons</h4>
          <p>Cupons e promo√ß√µes t√™m regras espec√≠ficas (validade, limite de uso, valor m√≠nimo). A FastSavory's pode
            alterar ou encerrar promo√ß√µes a qualquer momento.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">8. Cancelamentos e Reembolsos</h4>
          <p>Cancelamentos s√£o aceitos conforme est√°gio do pedido. Pedidos em preparo ou entrega podem n√£o ser
            cancel√°veis. Problemas devem ser reportados pelos canais oficiais.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">9. Responsabilidades</h4>
          <p>O Usu√°rio deve conferir o pedido, guardar alimentos corretamente e n√£o praticar condutas abusivas. A
            FastSavory's mant√©m o Aplicativo funcionando de forma est√°vel.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">10. Uso Adequado</h4>
          <p>√â vedado uso il√≠cito, contornar sistemas de seguran√ßa ou criar m√∫ltiplas contas para obter benef√≠cios
            indevidos.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">11. Prote√ß√£o de Dados (LGPD)</h4>
          <p>Dados pessoais s√£o tratados conforme a Lei 13.709/2018. Usados para processamento de pedidos, comunica√ß√£o
            e, com consentimento, marketing. O titular pode solicitar acesso, corre√ß√£o ou exclus√£o.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">12. Geolocaliza√ß√£o</h4>
          <p>Quando autorizado, dados de localiza√ß√£o s√£o usados para estimar prazos e otimizar a experi√™ncia. Pode ser
            gerenciado nas configura√ß√µes do dispositivo.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">13. Propriedade Intelectual</h4>
          <p>Todos os direitos do Aplicativo pertencem √† FastSavory's. Reprodu√ß√£o ou uso n√£o autorizado √© proibido.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">14. Atendimento</h4>
          <p><strong>Telefones:</strong> (73) 99936-6554 / (73) 99934-8552<br>
            <strong>E-mail:</strong> contato@nevesecosta.com.br
          </p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">15. Altera√ß√µes</h4>
          <p>A FastSavory's pode alterar estes Termos. O uso continuado ap√≥s altera√ß√µes implica concord√¢ncia.</p>
        </section>

        <section>
          <h4 class="font-bold text-gray-900 mb-2">16. Legisla√ß√£o e Foro</h4>
          <p>Regido pelas leis do Brasil, CDC e LGPD. Foro: Comarca de Itamaraju/BA, sem preju√≠zo do direito do
            consumidor.</p>
        </section>

      </div>
      <div class="sticky bottom-0 bg-white p-4 border-t">
        <button onclick="closeTermsModal()"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-semibold text-lg">
          Entendi
        </button>
      </div>
    </div>
  </div>

  <!-- Birthday Registration Modal -->
  <div id="birthdayModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-gray-800">
      <!-- Step 1: Ask if want to register -->
      <div id="birthdayStep1">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">üéÇ Cadastro de Anivers√°rio</h3>
        <p class="text-sm text-gray-600 mb-6 text-center">
          Deseja cadastrar sua data de nascimento e participar de promo√ß√µes futuras?
        </p>
        <div class="flex gap-3">
          <button type="button" id="birthdayYes"
            class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-medium">
            ‚úì Sim, Cadastrar
          </button>
          <button type="button" id="birthdayNo"
            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium">
            N√£o, Enviar Pedido
          </button>
        </div>
      </div>

      <!-- Step 2: Date picker -->
      <div id="birthdayStep2" class="hidden">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">üéÇ Data de Nascimento</h3>
        <p class="text-sm text-gray-600 mb-4 text-center">
          Informe sua data de nascimento:
        </p>
        <input type="date" id="birthdayDateInput" class="w-full px-3 py-3 border rounded-lg text-center text-lg mb-4">
        <button type="button" id="saveBirthdaySend"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-medium">
          Salvar e Enviar Pedido
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Product Options Modal (Kits/Bolos) -->
  <div id="customOptionsModal"
    class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-gray-800 mb-4" id="customOptionsTitle">Personalizar Produto</h3>

      <!-- Product Info -->
      <div id="customOptionsProduct" class="mb-4 p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-800" id="customOptionsProductName"></p>
        <p class="text-rose-600 font-bold" id="customOptionsProductPrice"></p>
      </div>

      <!-- Cake Mass Selection -->
      <div id="cakeMassSection" class="mb-4">
        <label class="block font-semibold text-gray-800 mb-2">üç∞ Escolha a massa do bolo: <span
            class="text-xs text-gray-500">(obrigat√≥rio)</span></label>
        <div class="space-y-2">
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="cakeMass" value="Massa Branca" class="mr-3 text-rose-600">
            <span>Massa Branca</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="cakeMass" value="Massa de Chocolate" class="mr-3 text-rose-600">
            <span>Massa de Chocolate</span>
          </label>
        </div>
      </div>

      <!-- Filling Selection -->
      <div id="fillingSection" class="mb-4">
        <label class="block font-semibold text-gray-800 mb-2">üéÇ Escolha o sabor do recheio: <span
            class="text-xs text-gray-500">(obrigat√≥rio)</span></label>
        <div class="space-y-2">
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="filling" value="Ninho" class="mr-3 text-rose-600">
            <span>Ninho</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="filling" value="Beijinho" class="mr-3 text-rose-600">
            <span>Beijinho</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="filling" value="Chocolate" class="mr-3 text-rose-600">
            <span>Chocolate</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="filling" value="Chocolate com C√¥co" class="mr-3 text-rose-600">
            <span>Chocolate com C√¥co</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="filling" value="Ninho com C√¥co" class="mr-3 text-rose-600">
            <span>Ninho com C√¥co</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="radio" name="filling" value="Ninho com Chocolate" class="mr-3 text-rose-600">
            <span>Ninho com Chocolate</span>
          </label>
        </div>
      </div>

      <!-- Salgados Selection (Kits only) -->
      <div id="salgadosSection" class="mb-4 hidden">
        <label class="block font-semibold text-gray-800 mb-2">ü•ü Escolha os salgados: <span
            class="text-xs text-gray-500">(at√© 4 sabores)</span></label>
        <p id="salgadosCounter" class="text-xs text-rose-600 mb-2">Selecionados: 0/4</p>
        <div class="space-y-2">
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="salgados" value="Coxinha" class="mr-3 text-rose-600 salgado-checkbox">
            <span>Coxinha</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="salgados" value="Bolinha de Carne" class="mr-3 text-rose-600 salgado-checkbox">
            <span>Bolinha de Carne</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="salgados" value="Cazulo de Presunto e Queijo"
              class="mr-3 text-rose-600 salgado-checkbox">
            <span>Cazulo de Presunto e Queijo</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="salgados" value="Quibe" class="mr-3 text-rose-600 salgado-checkbox">
            <span>Quibe</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="salgados" value="Bolinha de Queijo"
              class="mr-3 text-rose-600 salgado-checkbox">
            <span>Bolinha de Queijo</span>
          </label>
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="salgados" value="Enroladinho de Salsicha"
              class="mr-3 text-rose-600 salgado-checkbox">
            <span>Enroladinho de Salsicha</span>
          </label>
        </div>
      </div>

      <!-- Validation Message -->
      <div id="customOptionsError"
        class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

      <!-- Buttons -->
      <div class="flex gap-3">
        <button type="button" onclick="closeCustomOptionsModal()"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium">Cancelar</button>
        <button type="button" onclick="confirmCustomOptions()"
          class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-medium">Adicionar ao
          Carrinho</button>
      </div>
    </div>
  </div>

  <!-- Mini-Salgados Flavor Selection Modal -->
  <div id="miniSalgadosModal"
    class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-gray-800 mb-4">üçΩÔ∏è Escolha os Sabores</h3>

      <!-- Product Info -->
      <div class="mb-4 p-3 bg-gray-50 rounded-lg">
        <p class="font-semibold text-gray-800" id="miniProductName"></p>
        <p class="text-rose-600 font-bold" id="miniProductPrice"></p>
      </div>

      <!-- Flavor Selection -->
      <div class="mb-4">
        <label class="block font-semibold text-gray-800 mb-2">Escolha os sabores:
          <span id="miniFlavorLimit" class="text-xs text-gray-500">(at√© 3)</span>
        </label>
        <p id="miniFlavorCounter" class="text-xs text-rose-600 mb-2">Selecionados: 0/3</p>
        <div id="miniFlavorsContainer" class="space-y-2 max-h-64 overflow-y-auto">
          <!-- Rendered dynamically -->
        </div>
      </div>

      <!-- Validation Message -->
      <div id="miniSalgadosError"
        class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

      <!-- Buttons -->
      <div class="flex gap-3">
        <button type="button" onclick="closeMiniSalgadosModal()"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium">Cancelar</button>
        <button type="button" onclick="confirmMiniSalgados()"
          class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-medium">Adicionar ao
          Carrinho</button>
      </div>
    </div>
  </div>

  <!-- Product Delete Confirmation Modal (Inline) -->
  <div id="deleteProductModal"
    class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
      <h3 class="text-lg font-bold text-gray-800 mb-3">‚ö†Ô∏è Confirmar Exclus√£o</h3>
      <p class="text-gray-600 mb-4">Excluir o produto <strong id="deleteProductName"></strong>?</p>
      <div class="flex gap-3">
        <button type="button" onclick="cancelDeleteProduct()"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-medium">Cancelar</button>
        <button type="button" onclick="confirmDeleteProduct()"
          class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium">Excluir</button>
      </div>
    </div>
  </div>
  <script>
    // Configura√ß√£o do Supabase
    const supabaseUrl = 'https://vqjyjdllapqbqpylshkw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanlqZGxsYXBxYnFweWxzaGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MzgyNDUsImV4cCI6MjA4MjAxNDI0NX0.tfTR9YnM5l0do7FJfxML6i05KTSrMInQMqFrWXx6aAU';

    // Inicializar Supabase apenas uma vez
    if (typeof window.supabaseClient === 'undefined') {
      window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    }

    let products = [];
    let cart = [];
    let cartTotal = 0;
    let isAdmin = false;
    let editingProductId = null;
    let editingClientId = undefined;
    let users = [];
    let currentUserRole = null;
    let clients = [];
    let couriers = []; // Entregadores
    let promotions = [];
    let clientDiscounts = {};
    let currentSpecialDiscount = null;
    let currentSelectedClient = null;
    let coupons = [];

    let appliedCoupon = null;

    // Store configuration
    let storeConfig = {
      card_fee_1x: 5,
      card_fee_2x: 5,
      delivery_enabled: true,
      delivery_disabled_reason: '',
      max_concurrent_orders: 10,
      high_demand_extra_time: 15
    };
    let businessHours = [];

    // ========================================
    // OFFLINE SYNC QUEUE SERVICE
    // ========================================
    const OfflineSyncService = {
      QUEUE_KEY: 'fastOfflineQueue',

      isOnline: function () {
        return navigator.onLine;
      },

      getQueue: function () {
        try {
          return JSON.parse(localStorage.getItem(this.QUEUE_KEY) || '[]');
        } catch (e) {
          return [];
        }
      },

      addToQueue: function (type, data) {
        try {
          const queue = this.getQueue();
          queue.push({
            id: Date.now(),
            type: type, // 'order', 'status_update', 'rating'
            data: data,
            created_at: new Date().toISOString(),
            retries: 0
          });
          localStorage.setItem(this.QUEUE_KEY, JSON.stringify(queue));
          console.log('[OfflineSync] Added to queue:', type);
          return true;
        } catch (e) {
          console.error('[OfflineSync] Error adding to queue:', e);
          return false;
        }
      },

      removeFromQueue: function (itemId) {
        try {
          const queue = this.getQueue().filter(item => item.id !== itemId);
          localStorage.setItem(this.QUEUE_KEY, JSON.stringify(queue));
        } catch (e) {
          console.error('[OfflineSync] Error removing from queue:', e);
        }
      },

      syncAll: async function () {
        if (!this.isOnline()) {
          console.log('[OfflineSync] Still offline, skipping sync');
          return;
        }

        const queue = this.getQueue();
        if (queue.length === 0) return;

        console.log(`[OfflineSync] Syncing ${queue.length} items...`);

        for (const item of queue) {
          try {
            let success = false;

            if (item.type === 'order') {
              const { error } = await window.supabaseClient
                .from('fast_orders')
                .insert(item.data);
              success = !error;
            } else if (item.type === 'status_update') {
              const { error } = await window.supabaseClient
                .from('fast_orders')
                .update({ status: item.data.status })
                .eq('id', item.data.order_id);
              success = !error;
            } else if (item.type === 'rating') {
              const { error } = await window.supabaseClient
                .from('fast_orders')
                .update({ rating: item.data.rating, rating_comment: item.data.comment })
                .eq('id', item.data.order_id);
              success = !error;
            }

            if (success) {
              this.removeFromQueue(item.id);
              console.log(`[OfflineSync] Synced item ${item.id}`);
            } else {
              item.retries++;
              if (item.retries >= 3) {
                this.removeFromQueue(item.id);
                console.warn(`[OfflineSync] Removed item ${item.id} after 3 retries`);
              }
            }
          } catch (e) {
            console.error(`[OfflineSync] Error syncing item ${item.id}:`, e);
          }
        }
      },

      getPendingCount: function () {
        return this.getQueue().length;
      },

      showPendingBadge: function () {
        const count = this.getPendingCount();
        const badge = document.getElementById('offlinePendingBadge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      }
    };

    // Listen for online/offline events
    window.addEventListener('online', () => {
      console.log('[OfflineSync] Back online, starting sync...');
      OfflineSyncService.syncAll();
    });

    window.addEventListener('offline', () => {
      console.log('[OfflineSync] Gone offline');
    });

    // Periodic sync attempt (every 30 seconds)
    setInterval(() => {
      if (OfflineSyncService.isOnline() && OfflineSyncService.getPendingCount() > 0) {
        OfflineSyncService.syncAll();
      }
    }, 30000);

    // ========================================
    // ORDER HISTORY SERVICE (localStorage + Supabase)
    // ========================================
    const OrderHistoryService = {
      getKey: (phone) => phone ? `fastOrders_${phone.replace(/\D/g, '')}` : 'fastOrders_anon',

      getOrders: function (phone) {
        try {
          const key = this.getKey(phone);
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error('[OrderHistory] Erro ao ler:', e);
          return [];
        }
      },

      saveOrder: function (phone, order) {
        try {
          const key = this.getKey(phone);
          const orders = this.getOrders(phone);
          orders.unshift(order); // Adiciona no in√≠cio
          // Mant√©m apenas √∫ltimos 2 pedidos
          localStorage.setItem(key, JSON.stringify(orders.slice(0, 2)));
        } catch (e) {
          console.error('[OrderHistory] Erro ao salvar:', e);
        }
      },

      migrateToPhone: function (phone) {
        try {
          const anonOrders = this.getOrders(null);
          if (anonOrders.length > 0) {
            const phoneOrders = this.getOrders(phone);
            const merged = [...anonOrders, ...phoneOrders].slice(0, 2);
            localStorage.setItem(this.getKey(phone), JSON.stringify(merged));
            localStorage.removeItem('fastOrders_anon');
          }
        } catch (e) { }
      }
    };

    // ========================================
    // FAVORITES SERVICE (localStorage)
    // ========================================
    const FavoritesService = {
      getKey: (phone) => phone ? `fastFavorites_${phone.replace(/\D/g, '')}` : 'fastFavorites_anon',

      getFavorites: function (phone) {
        try {
          const key = this.getKey(phone);
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          return [];
        }
      },

      isFavorite: function (phone, productId) {
        return this.getFavorites(phone).includes(productId);
      },

      toggle: function (phone, productId) {
        try {
          const key = this.getKey(phone);
          let favorites = this.getFavorites(phone);
          const index = favorites.indexOf(productId);
          if (index > -1) {
            favorites.splice(index, 1);
          } else {
            favorites.push(productId);
          }
          localStorage.setItem(key, JSON.stringify(favorites));
          return index === -1; // Returns true if now favorite
        } catch (e) {
          return false;
        }
      },

      migrateToPhone: function (phone) {
        try {
          const anonFavs = this.getFavorites(null);
          if (anonFavs.length > 0) {
            const phoneFavs = this.getFavorites(phone);
            const merged = [...new Set([...anonFavs, ...phoneFavs])];
            localStorage.setItem(this.getKey(phone), JSON.stringify(merged));
            localStorage.removeItem('fastFavorites_anon');
          }
        } catch (e) { }
      }
    };

    // ========================================
    // SPECIAL DISCOUNT SERVICE (Fidelidade Avan√ßada)
    // ========================================
    const SpecialDiscountService = {
      config: null,

      getConfig: async function () {
        if (this.config) return this.config;
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_special_discounts')
            .select('*')
            .eq('store_id', 1)
            .maybeSingle();

          if (data) {
            this.config = data;
          } else {
            // Default config if none in DB
            this.config = {
              min_orders: 10,
              discount_type: 'percentage',
              discount_value: 10,
              min_order_value: 0,
              active: true
            };
          }
          return this.config;
        } catch (e) {
          console.error('[SpecialDiscount] Erro ao carregar config:', e);
          // Return default on error
          return {
            min_orders: 10,
            discount_type: 'percentage',
            discount_value: 10,
            min_order_value: 0,
            active: false // disable if error
          };
        }
      },

      saveConfig: async function (config) {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_special_discounts')
            .upsert({
              store_id: 1,
              ...config,
              updated_at: new Date().toISOString()
            }, { onConflict: 'store_id' })
            .select();

          if (error) throw error;
          this.config = data[0];
          return true;
        } catch (e) {
          console.error('[SpecialDiscount] Erro ao salvar config:', e);
          return false;
        }
      },

      getValidOrderCount: async function (phone) {
        if (!phone) return 0;
        const phoneDigits = phone.replace(/\D/g, '');
        try {
          const { count, error } = await window.supabaseClient
            .from('fast_orders')
            .select('*', { count: 'exact', head: true })
            .eq('client_phone', phoneDigits)
            .eq('status', 'delivered');

          if (error) throw error;
          return count || 0;
        } catch (e) {
          console.error('[SpecialDiscount] Erro ao contar pedidos:', e);
          return 0;
        }
      }
    };

    // ========================================
    // BIRTHDAY DISCOUNT SERVICE
    // ========================================
    const BirthdayDiscountService = {
      config: null,

      getConfig: async function () {
        if (this.config) return this.config;
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_birthday_discount')
            .select('*')
            .maybeSingle();

          if (data) {
            this.config = data;
          } else {
            this.config = { discount_type: 'percentage', discount_value: 10, active: true };
          }
          return this.config;
        } catch (e) {
          console.error('[BirthdayDiscount] Erro ao carregar config:', e);
          return { discount_type: 'percentage', discount_value: 10, active: false };
        }
      },

      saveConfig: async function (config) {
        try {
          // Delete existing and insert new
          await window.supabaseClient.from('fast_birthday_discount').delete().neq('id', 0);
          const { data, error } = await window.supabaseClient
            .from('fast_birthday_discount')
            .insert(config)
            .select()
            .single();

          if (error) throw error;
          this.config = data;
          return true;
        } catch (e) {
          console.error('[BirthdayDiscount] Erro ao salvar config:', e);
          return false;
        }
      },

      hasUsedThisYear: async function (phone) {
        if (!phone) return false;
        const phoneDigits = phone.replace(/\D/g, '');
        const currentYear = new Date().getFullYear();
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_birthday_usage')
            .select('id')
            .eq('phone', phoneDigits)
            .eq('year', currentYear)
            .maybeSingle();

          return !!data;
        } catch (e) {
          console.error('[BirthdayDiscount] Erro ao verificar uso:', e);
          return false;
        }
      },

      markUsed: async function (phone, orderId) {
        if (!phone) return false;
        const phoneDigits = phone.replace(/\D/g, '');
        const currentYear = new Date().getFullYear();
        try {
          const { error } = await window.supabaseClient
            .from('fast_birthday_usage')
            .insert({ phone: phoneDigits, year: currentYear, order_id: orderId });

          if (error) throw error;
          return true;
        } catch (e) {
          console.error('[BirthdayDiscount] Erro ao marcar uso:', e);
          return false;
        }
      }
    };

    // ========================================
    // CLIENT DISCOUNTS SERVICE (Supabase sync)
    // ========================================
    const ClientDiscountsService = {
      cache: null,

      load: async function () {
        if (this.cache) return this.cache;
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_client_discounts')
            .select('*');

          if (error) throw error;

          this.cache = {};
          (data || []).forEach(d => {
            this.cache[d.phone] = d.discount_percentage;
          });
          console.log('Descontos por cliente carregados:', Object.keys(this.cache).length);
          return this.cache;
        } catch (e) {
          console.error('[ClientDiscounts] Erro ao carregar:', e);
          // Fallback to localStorage
          const saved = localStorage.getItem('fastClientDiscounts');
          this.cache = saved ? JSON.parse(saved) : {};
          return this.cache;
        }
      },

      save: async function (phone, discountPercentage) {
        if (!phone) return false;
        const phoneDigits = phone.replace(/\D/g, '');
        try {
          if (discountPercentage > 0) {
            const { error } = await window.supabaseClient
              .from('fast_client_discounts')
              .upsert({
                phone: phoneDigits,
                discount_percentage: discountPercentage,
                updated_at: new Date().toISOString()
              }, { onConflict: 'phone' });

            if (error) throw error;
            if (this.cache) this.cache[phoneDigits] = discountPercentage;
          } else {
            // Delete if 0
            await window.supabaseClient
              .from('fast_client_discounts')
              .delete()
              .eq('phone', phoneDigits);

            if (this.cache) delete this.cache[phoneDigits];
          }
          // Also update localStorage for fallback
          localStorage.setItem('fastClientDiscounts', JSON.stringify(this.cache || {}));
          return true;
        } catch (e) {
          console.error('[ClientDiscounts] Erro ao salvar:', e);
          return false;
        }
      },

      get: function (phone) {
        if (!phone) return 0;
        const phoneDigits = phone.replace(/\D/g, '');
        return this.cache?.[phoneDigits] || 0;
      }
    };

    // ========================================
    // COUPON USAGE SERVICE (single use per phone)
    // ========================================
    const CouponUsageService = {
      hasUsed: async function (phone, couponCode) {
        if (!phone || !couponCode) return false;
        const phoneDigits = phone.replace(/\D/g, '');
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_coupon_usage')
            .select('id')
            .eq('phone', phoneDigits)
            .eq('coupon_code', couponCode.toUpperCase())
            .maybeSingle();

          return !!data;
        } catch (e) {
          console.error('[CouponUsage] Erro ao verificar:', e);
          return false;
        }
      },

      markUsed: async function (phone, couponCode, orderId) {
        if (!phone || !couponCode) return false;
        const phoneDigits = phone.replace(/\D/g, '');
        try {
          const { error } = await window.supabaseClient
            .from('fast_coupon_usage')
            .insert({
              phone: phoneDigits,
              coupon_code: couponCode.toUpperCase(),
              order_id: orderId
            });

          if (error && error.code !== '23505') throw error; // Ignore duplicate error
          return true;
        } catch (e) {
          console.error('[CouponUsage] Erro ao marcar:', e);
          return false;
        }
      }
    };

    // ========================================
    // PRODUCT OPTIONS MODULE (Dynamic Options)
    // Manages customization options for Kits/Bolos/Mini-Salgados
    // ========================================
    const ProductOptionsModule = {
      // State - cached options by type
      options: {
        cakeMass: [],
        filling: [],
        salgados: [],
        miniSalgadosFlavors: []
      },
      loaded: false,

      // Default options (used for migration if Supabase is empty)
      defaults: {
        cakeMass: [
          { name: 'Massa Branca', visible: true, sort_order: 1 },
          { name: 'Massa de Chocolate', visible: true, sort_order: 2 }
        ],
        filling: [
          { name: 'Ninho', visible: true, sort_order: 1 },
          { name: 'Beijinho', visible: true, sort_order: 2 },
          { name: 'Chocolate', visible: true, sort_order: 3 },
          { name: 'Chocolate com C√¥co', visible: true, sort_order: 4 },
          { name: 'Ninho com C√¥co', visible: true, sort_order: 5 },
          { name: 'Ninho com Chocolate', visible: true, sort_order: 6 }
        ],
        salgados: [
          { name: 'Coxinha', visible: true, sort_order: 1 },
          { name: 'Bolinha de Carne', visible: true, sort_order: 2 },
          { name: 'Cazulo de Presunto e Queijo', visible: true, sort_order: 3 },
          { name: 'Quibe', visible: true, sort_order: 4 },
          { name: 'Bolinha de Queijo', visible: true, sort_order: 5 },
          { name: 'Enroladinho de Salsicha', visible: true, sort_order: 6 }
        ],
        miniSalgadosFlavors: [
          { name: 'Coxinha', visible: true, sort_order: 1 },
          { name: 'Enroladinho', visible: true, sort_order: 2 },
          { name: 'Quibe', visible: true, sort_order: 3 },
          { name: 'Bolinha de Carne', visible: true, sort_order: 4 },
          { name: 'Bolinha de Queijo', visible: true, sort_order: 5 },
          { name: 'Risole de Carne', visible: true, sort_order: 6 },
          { name: 'Risole de Queijo', visible: true, sort_order: 7 }
        ]
      },

      // Load all options from Supabase (with localStorage fallback)
      load: async function () {
        try {
          console.log('[ProductOptions] Carregando op√ß√µes do Supabase...');
          const { data, error } = await window.supabaseClient
            .from('fast_product_options')
            .select('*')
            .order('sort_order', { ascending: true });

          if (error) throw error;

          if (data && data.length > 0) {
            // Group by type
            this.options = { cakeMass: [], filling: [], salgados: [], miniSalgadosFlavors: [] };
            data.forEach(opt => {
              if (this.options[opt.type]) {
                this.options[opt.type].push(opt);
              }
            });
            console.log('[ProductOptions] Op√ß√µes carregadas:', Object.keys(this.options).map(k => `${k}: ${this.options[k].length}`).join(', '));
          } else {
            // Supabase table empty - seed with defaults
            console.log('[ProductOptions] Tabela vazia, populando com padr√µes...');
            await this.seedDefaults();
          }

          // Cache locally
          localStorage.setItem('fastProductOptions', JSON.stringify(this.options));
          this.loaded = true;
          return this.options;
        } catch (e) {
          console.warn('[ProductOptions] Erro ao carregar do Supabase, usando cache local:', e);
          // Fallback to localStorage
          const cached = localStorage.getItem('fastProductOptions');
          if (cached) {
            this.options = JSON.parse(cached);
          } else {
            // Use hardcoded defaults
            this.options = JSON.parse(JSON.stringify(this.defaults));
            this.options.cakeMass.forEach((o, i) => o.id = -(i + 1));
            this.options.filling.forEach((o, i) => o.id = -(i + 100));
            this.options.salgados.forEach((o, i) => o.id = -(i + 200));
            this.options.miniSalgadosFlavors.forEach((o, i) => o.id = -(i + 300));
          }
          this.loaded = true;
          return this.options;
        }
      },

      // Seed default options to Supabase
      seedDefaults: async function () {
        try {
          const inserts = [];
          Object.keys(this.defaults).forEach(type => {
            this.defaults[type].forEach(opt => {
              inserts.push({ type, name: opt.name, visible: opt.visible, sort_order: opt.sort_order });
            });
          });

          const { data, error } = await window.supabaseClient
            .from('fast_product_options')
            .insert(inserts)
            .select();

          if (error) throw error;

          // Reload after seeding
          return await this.load();
        } catch (e) {
          console.error('[ProductOptions] Erro ao popular padr√µes:', e);
        }
      },

      // Get visible options by type
      getVisible: function (type) {
        return (this.options[type] || []).filter(o => o.visible);
      },

      // Get all options by type
      getAll: function (type) {
        return this.options[type] || [];
      },

      // Add new option
      add: async function (type, name) {
        try {
          const maxOrder = Math.max(0, ...this.options[type].map(o => o.sort_order || 0));
          const { data, error } = await window.supabaseClient
            .from('fast_product_options')
            .insert({ type, name, visible: true, sort_order: maxOrder + 1 })
            .select()
            .single();

          if (error) throw error;

          this.options[type].push(data);
          localStorage.setItem('fastProductOptions', JSON.stringify(this.options));
          return { success: true, data };
        } catch (e) {
          console.error('[ProductOptions] Erro ao adicionar:', e);
          return { success: false, error: e.message };
        }
      },

      // Update option
      update: async function (id, updates) {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_product_options')
            .update({ ...updates, updated_at: new Date().toISOString() })
            .eq('id', id)
            .select()
            .single();

          if (error) throw error;

          // Update local cache
          Object.keys(this.options).forEach(type => {
            const idx = this.options[type].findIndex(o => o.id === id);
            if (idx !== -1) {
              this.options[type][idx] = { ...this.options[type][idx], ...data };
            }
          });
          localStorage.setItem('fastProductOptions', JSON.stringify(this.options));
          return { success: true, data };
        } catch (e) {
          console.error('[ProductOptions] Erro ao atualizar:', e);
          return { success: false, error: e.message };
        }
      },

      // Toggle visibility
      toggleVisibility: async function (id) {
        let opt = null;
        Object.keys(this.options).forEach(type => {
          const found = this.options[type].find(o => o.id === id);
          if (found) opt = found;
        });
        if (!opt) return { success: false, error: 'Op√ß√£o n√£o encontrada' };

        return await this.update(id, { visible: !opt.visible });
      },

      // Delete option
      delete: async function (id) {
        try {
          const { error } = await window.supabaseClient
            .from('fast_product_options')
            .delete()
            .eq('id', id);

          if (error) throw error;

          // Remove from local cache
          Object.keys(this.options).forEach(type => {
            this.options[type] = this.options[type].filter(o => o.id !== id);
          });
          localStorage.setItem('fastProductOptions', JSON.stringify(this.options));

          // Clean up products that reference this option
          await this.cleanupProductReferences(id);

          return { success: true };
        } catch (e) {
          console.error('[ProductOptions] Erro ao excluir:', e);
          return { success: false, error: e.message };
        }
      },

      // Clean up product flavor references when an option is deleted
      cleanupProductReferences: async function (deletedOptionId) {
        try {
          // Find products with flavorSelection referencing this ID
          const { data: prods } = await window.supabaseClient
            .from('fast_products')
            .select('id, flavor_selection')
            .not('flavor_selection', 'is', null);

          if (!prods || prods.length === 0) return;

          for (const p of prods) {
            if (p.flavor_selection && Array.isArray(p.flavor_selection.availableFlavors)) {
              const newFlavors = p.flavor_selection.availableFlavors.filter(fid => fid !== deletedOptionId);
              if (newFlavors.length !== p.flavor_selection.availableFlavors.length) {
                await window.supabaseClient
                  .from('fast_products')
                  .update({ flavor_selection: { ...p.flavor_selection, availableFlavors: newFlavors } })
                  .eq('id', p.id);
              }
            }
          }
        } catch (e) {
          console.warn('[ProductOptions] Erro ao limpar refer√™ncias:', e);
        }
      },

      // Reorder options
      reorder: async function (type, orderedIds) {
        try {
          for (let i = 0; i < orderedIds.length; i++) {
            await window.supabaseClient
              .from('fast_product_options')
              .update({ sort_order: i + 1 })
              .eq('id', orderedIds[i]);
          }
          await this.load(); // Reload to sync
          return { success: true };
        } catch (e) {
          console.error('[ProductOptions] Erro ao reordenar:', e);
          return { success: false, error: e.message };
        }
      }
    };

    // ========================================
    // RATINGS MODULE - FastSavory's (M√≥dulo Centralizado)
    // Todas as fun√ß√µes de avalia√ß√£o consolidadas aqui
    // ========================================
    const RatingsModule = {
      // State
      cache: null,
      adminData: [],
      adminFilter: 'all',
      adminStarFilter: 0, // 0 = all, 1-5 = specific star

      // ========================================
      // DATABASE OPERATIONS
      // ========================================

      // Check if rating already exists for order_code + phone
      checkExists: async function (orderCode, phone) {
        try {
          const phoneDigits = (phone || '').replace(/\D/g, '');
          const { data, error } = await window.supabaseClient
            .from('fast_ratings')
            .select('id, rating, comment')
            .eq('order_code', orderCode)
            .eq('phone', phoneDigits)
            .limit(1);

          if (error) throw error;
          return data && data.length > 0 ? data[0] : null;
        } catch (e) {
          console.warn('[Ratings] Erro ao verificar exist√™ncia:', e);
          return null;
        }
      },

      // Submit a new rating (from customer)
      submit: async function (data) {
        try {
          const phoneDigits = (data.phone || '').replace(/\D/g, '');

          // Check for duplicate
          const existing = await this.checkExists(data.orderCode, phoneDigits);
          if (existing) {
            console.log('[Ratings] Avalia√ß√£o j√° existe para este pedido');
            return { success: false, duplicate: true, existing };
          }

          // Get user agent for tracking
          const userAgent = navigator.userAgent || 'unknown';

          const { error } = await window.supabaseClient
            .from('fast_ratings')
            .insert({
              order_code: data.orderCode,
              phone: phoneDigits,
              client_name: data.clientName,
              rating: data.rating,
              comment: data.comment,
              status: 'pending',
              user_agent: userAgent
            });

          if (error) throw error;
          console.log('[Ratings] Avalia√ß√£o salva com sucesso');
          return { success: true };
        } catch (e) {
          console.error('[Ratings] Erro ao salvar:', e);
          return { success: false, error: e };
        }
      },

      // Load all ratings for admin
      loadAll: async function () {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_ratings')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) throw error;
          this.adminData = data || [];
          return this.adminData;
        } catch (e) {
          console.error('[Ratings] Erro ao carregar:', e);
          this.adminData = [];
          return [];
        }
      },

      // Load only published ratings (for landing page)
      loadPublished: async function () {
        // Always try to fetch fresh data first
        try {
          console.log('[Ratings] Buscando avalia√ß√µes publicadas (fresh)...');
          const { data, error } = await window.supabaseClient
            .from('fast_ratings')
            .select('*')
            .eq('status', 'published')
            .order('published_at', { ascending: false })
            .limit(4);

          if (error) throw error;
          this.cache = data || [];
          // Update cache only after successful fetch
          localStorage.setItem('fastPublishedRatings', JSON.stringify(this.cache));
          console.log('[Ratings] Dados frescos carregados:', this.cache.length);
          return this.cache;
        } catch (e) {
          console.warn('[Ratings] Erro ao carregar publicados, usando cache:', e);
          const cached = localStorage.getItem('fastPublishedRatings');
          return cached ? JSON.parse(cached) : [];
        }
      },

      // ========================================
      // ADMIN ACTIONS
      // ========================================

      publish: async function (id) {
        try {
          console.log('[Ratings] Publicando avalia√ß√£o ID:', id);
          const { data, error } = await window.supabaseClient
            .from('fast_ratings')
            .update({ status: 'published', published_at: new Date().toISOString() })
            .eq('id', id)
            .select();

          if (error) {
            console.error('[Ratings] Erro Supabase ao publicar:', error);
            throw error;
          }
          console.log('[Ratings] Resultado da publica√ß√£o:', data);
          // Update local data
          const item = this.adminData.find(r => r.id === id);
          if (item) {
            item.status = 'published';
            item.published_at = new Date().toISOString();
          }
          return true;
        } catch (e) {
          console.error('[Ratings] Erro ao publicar:', e);
          return false;
        }
      },

      archive: async function (id) {
        try {
          const { error } = await window.supabaseClient
            .from('fast_ratings')
            .update({ status: 'archived' })
            .eq('id', id);

          if (error) throw error;
          // Update local data
          const item = this.adminData.find(r => r.id === id);
          if (item) item.status = 'archived';
          return true;
        } catch (e) {
          console.error('[Ratings] Erro ao arquivar:', e);
          return false;
        }
      },

      reply: async function (id, replyText) {
        try {
          const { error } = await window.supabaseClient
            .from('fast_ratings')
            .update({ admin_reply: replyText })
            .eq('id', id);

          if (error) throw error;
          // Update local data
          const item = this.adminData.find(r => r.id === id);
          if (item) item.admin_reply = replyText;
          return true;
        } catch (e) {
          console.error('[Ratings] Erro ao responder:', e);
          return false;
        }
      },

      // ========================================
      // UI HELPERS
      // ========================================

      formatDate: function (dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('pt-BR') + ' √†s ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      },

      formatStars: function (rating) {
        return '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
      },

      // ========================================
      // PUBLIC LANDING RENDERING
      // ========================================

      renderPublicRatings: function (ratings, container) {
        if (!container) return;

        if (!ratings || ratings.length === 0) {
          container.innerHTML = `
            <div class="text-white/60 text-sm italic text-center py-4">
              <p>Seja o primeiro a avaliar!</p>
            </div>
          `;
          return;
        }

        container.innerHTML = ratings.map(r => {
          const stars = this.formatStars(r.rating);
          const truncatedComment = r.comment && r.comment.length > 80
            ? r.comment.substring(0, 80) + '...'
            : (r.comment || '');

          return `
            <div class="bg-white/95 backdrop-blur-sm rounded-lg p-3 shadow-lg border border-white/20">
              <div class="flex items-center justify-between mb-1">
                <p class="font-semibold text-gray-800 text-xs truncate max-w-[100px]">${r.client_name || 'Cliente'}</p>
                <p class="text-yellow-500 text-xs">${stars}</p>
              </div>
              <p class="text-gray-600 text-xs leading-relaxed line-clamp-2">"${truncatedComment}"</p>
              ${r.admin_reply ? `
                <div class="mt-1 pt-1 border-t border-gray-200">
                  <p class="text-xs text-rose-600 italic truncate">üí¨ ${r.admin_reply}</p>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      },

      // ========================================
      // ADMIN PANEL RENDERING
      // ========================================

      renderAdminRatings: function () {
        const list = document.getElementById('ratingsList');
        if (!list) {
          console.warn('[Ratings] ratingsList container n√£o encontrado');
          return;
        }

        let filtered = this.adminData;

        // Status filter
        if (this.adminFilter !== 'all') {
          filtered = filtered.filter(r => r.status === this.adminFilter);
        }

        // Star filter
        if (this.adminStarFilter > 0) {
          filtered = filtered.filter(r => r.rating >= this.adminStarFilter);
        }

        if (filtered.length === 0) {
          list.innerHTML = `
            <div class="text-center py-12 text-gray-500">
              <p class="text-4xl mb-2">‚≠ê</p>
              <p>Nenhuma avalia√ß√£o ${this.adminFilter === 'all' ? '' : 'com este filtro '}encontrada.</p>
            </div>
          `;
          return;
        }

        list.innerHTML = filtered.map(r => {
          const stars = this.formatStars(r.rating);
          const statusBadge = r.status === 'published'
            ? '<span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">‚úì Publicado</span>'
            : r.status === 'archived'
              ? '<span class="px-2 py-0.5 bg-gray-200 text-gray-600 text-xs rounded-full">Arquivado</span>'
              : '<span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full">‚è≥ Pendente</span>';

          const dateFormatted = this.formatDate(r.created_at);
          const ratingBadge = `<span class="px-2 py-0.5 bg-yellow-50 text-yellow-700 text-xs rounded-full font-medium">${r.rating}‚≠ê</span>`;

          return `
            <div class="p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition" data-rating-id="${r.id}">
              <div class="flex justify-between items-start mb-2 flex-wrap gap-2">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <p class="font-semibold text-gray-800">${r.client_name || 'An√¥nimo'}</p>
                    ${ratingBadge}
                  </div>
                  <p class="text-yellow-500 text-lg">${stars}</p>
                  ${r.order_code ? `<p class="text-xs text-gray-500">üì¶ Pedido: ${r.order_code}</p>` : ''}
                </div>
                <div class="text-right flex flex-col items-end gap-1">
                  ${statusBadge}
                  <p class="text-xs text-gray-400">${dateFormatted}</p>
                </div>
              </div>
              <p class="text-gray-700 text-sm mb-3 whitespace-pre-wrap">${r.comment || 'Sem coment√°rio'}</p>
              ${r.admin_reply ? `
                <div class="text-xs text-blue-600 bg-blue-50 p-2 rounded mb-3">
                  üí¨ <strong>Sua resposta:</strong> ${r.admin_reply}
                </div>
              ` : ''}
              <div class="flex flex-wrap gap-2">
                ${r.status === 'pending' ? `
                  <button onclick="RatingsModule.handlePublish(${r.id})" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs rounded-lg transition">‚úì Publicar</button>
                  <button onclick="RatingsModule.handleArchive(${r.id})" class="px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded-lg transition">Arquivar</button>
                ` : ''}
                ${r.status === 'published' ? `
                  <button onclick="RatingsModule.handleArchive(${r.id})" class="px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded-lg transition">Arquivar</button>
                ` : ''}
                ${!r.admin_reply ? `
                  <button onclick="RatingsModule.toggleReplyInput(${r.id})" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg transition">üí¨ Responder</button>
                ` : ''}
              </div>
              <!-- Inline Reply Input -->
              <div id="replyInput_${r.id}" class="hidden mt-3 flex gap-2">
                <input type="text" id="replyText_${r.id}" placeholder="Digite sua resposta..." class="flex-1 px-3 py-2 border rounded-lg text-sm" />
                <button onclick="RatingsModule.sendReply(${r.id})" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs rounded-lg">Enviar</button>
                <button onclick="RatingsModule.toggleReplyInput(${r.id})" class="px-3 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 text-xs rounded-lg">Cancelar</button>
              </div>
            </div>
          `;
        }).join('');
      },

      // ========================================
      // ADMIN EVENT HANDLERS
      // ========================================

      handlePublish: async function (id) {
        const success = await this.publish(id);
        if (success) {
          this.showMessage('‚úÖ Avalia√ß√£o publicada!', 'success');
          this.renderAdminRatings(); // Re-render only, data already updated
        } else {
          this.showMessage('‚ùå Erro ao publicar.', 'error');
        }
      },

      handleArchive: async function (id) {
        const success = await this.archive(id);
        if (success) {
          this.showMessage('‚úÖ Avalia√ß√£o arquivada.', 'success');
          this.renderAdminRatings();
        } else {
          this.showMessage('‚ùå Erro ao arquivar.', 'error');
        }
      },

      handleReply: function (id) {
        // Legacy - kept for compatibility
        this.toggleReplyInput(id);
      },

      toggleReplyInput: function (id) {
        const container = document.getElementById(`replyInput_${id}`);
        if (container) {
          container.classList.toggle('hidden');
          if (!container.classList.contains('hidden')) {
            const input = document.getElementById(`replyText_${id}`);
            if (input) input.focus();
          }
        }
      },

      sendReply: async function (id) {
        const input = document.getElementById(`replyText_${id}`);
        if (!input) return;

        const replyText = input.value.trim();
        if (!replyText) {
          this.showMessage('Digite uma resposta.', 'error');
          return;
        }

        const success = await this.reply(id, replyText);
        if (success) {
          this.showMessage('‚úÖ Resposta enviada!', 'success');
          this.renderAdminRatings();
        } else {
          this.showMessage('‚ùå Erro ao responder.', 'error');
        }
      },

      submitReply: async function (id, replyText) {
        const success = await this.reply(id, replyText);
        if (success) {
          this.showMessage('‚úÖ Resposta enviada!', 'success');
          this.renderAdminRatings();
        } else {
          this.showMessage('‚ùå Erro ao responder.', 'error');
        }
      },

      setStatusFilter: function (filter) {
        this.adminFilter = filter;
        // Update button styles
        document.querySelectorAll('.rating-filter-btn').forEach(btn => {
          btn.classList.toggle('bg-rose-600', btn.dataset.filter === filter);
          btn.classList.toggle('text-white', btn.dataset.filter === filter);
          btn.classList.toggle('bg-gray-200', btn.dataset.filter !== filter);
          btn.classList.toggle('text-gray-700', btn.dataset.filter !== filter);
        });
        this.renderAdminRatings();
      },

      setStarFilter: function (stars) {
        this.adminStarFilter = stars;
        // Update star filter buttons
        document.querySelectorAll('.star-filter-btn').forEach(btn => {
          const btnStars = parseInt(btn.dataset.stars, 10);
          btn.classList.toggle('ring-2', btnStars === stars);
          btn.classList.toggle('ring-rose-500', btnStars === stars);
        });
        this.renderAdminRatings();
      },

      showMessage: function (text, type) {
        const msg = document.getElementById('ratingsMessage');
        if (!msg) return;
        msg.textContent = text;
        msg.className = 'mb-4 p-3 rounded-lg text-sm text-center';
        if (type === 'success') msg.classList.add('bg-green-100', 'text-green-700');
        else if (type === 'error') msg.classList.add('bg-red-100', 'text-red-700');
        else msg.classList.add('bg-blue-100', 'text-blue-700');
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 3000);
      },

      // ========================================
      // INITIALIZATION (Safe - with try/catch)
      // ========================================

      initPublicRatings: async function () {
        const container = document.getElementById('testimonialsContainer');
        if (!container) {
          console.log('[Ratings] Container de testimonials n√£o encontrado - OK se n√£o estiver na landing');
          return;
        }

        try {
          console.log('[Ratings] Carregando avalia√ß√µes publicadas...');
          const ratings = await this.loadPublished();
          console.log('[Ratings] Avalia√ß√µes publicadas:', ratings.length);
          this.renderPublicRatings(ratings, container);
        } catch (e) {
          console.error('[Ratings] Erro ao inicializar p√∫blicas:', e);
          container.innerHTML = `
            <div class="text-white/40 text-sm italic text-center py-4">
              <p>Avalia√ß√µes em breve...</p>
            </div>
          `;
        }
      },

      initAdminPanel: async function () {
        const panel = document.getElementById('ratingsPanelFast');
        const list = document.getElementById('ratingsList');

        if (!panel || !list) {
          console.warn('[Ratings] Painel admin n√£o encontrado');
          return;
        }

        try {
          console.log('[Ratings] Carregando avalia√ß√µes para admin...');
          await this.loadAll();
          console.log('[Ratings] Total de avalia√ß√µes:', this.adminData.length);
          this.renderAdminRatings();
        } catch (e) {
          console.error('[Ratings] Erro ao carregar admin:', e);
          list.innerHTML = `
            <div class="text-center py-12 text-red-500">
              <p class="text-4xl mb-2">‚ö†Ô∏è</p>
              <p>Erro ao carregar avalia√ß√µes.</p>
              <p class="text-xs mt-2">${e.message || 'Tente novamente'}</p>
            </div>
          `;
        }
      }
    };

    // Alias for backward compatibility
    const RatingsService = RatingsModule;

    // Global function aliases for onclick handlers
    function loadPublicRatings() { return RatingsModule.initPublicRatings(); }
    function loadRatings() { return RatingsModule.initAdminPanel(); }
    function renderRatings() { return RatingsModule.renderAdminRatings(); }
    function publishRating(id) { return RatingsModule.handlePublish(id); }
    function archiveRating(id) { return RatingsModule.handleArchive(id); }
    function promptReplyRating(id) { return RatingsModule.handleReply(id); }
    function showRatingsMessage(text, type) { return RatingsModule.showMessage(text, type); }

    // ========================================
    // ADDRESS SERVICE (m√∫ltiplos endere√ßos por cliente)
    // ========================================
    const AddressService = {
      getKey: (phone) => phone ? `fastAddresses_${phone.replace(/\D/g, '')}` : 'fastAddresses_anon',

      load: function (phone) {
        try {
          const key = this.getKey(phone);
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error('[AddressService] Erro ao carregar:', e);
          return [];
        }
      },

      save: function (phone, address) {
        try {
          const key = this.getKey(phone);
          let addresses = this.load(phone);

          // Check if address already exists (same street, number, neighborhood)
          const exists = addresses.some(a =>
            a.street === address.street &&
            a.number === address.number &&
            a.neighborhood === address.neighborhood
          );

          if (!exists) {
            address.id = Date.now().toString();
            addresses.push(address);
            localStorage.setItem(key, JSON.stringify(addresses.slice(-5))); // max 5 addresses
          }
          return !exists;
        } catch (e) {
          console.error('[AddressService] Erro ao salvar:', e);
          return false;
        }
      },

      remove: function (phone, addressId) {
        try {
          const key = this.getKey(phone);
          let addresses = this.load(phone);
          addresses = addresses.filter(a => a.id !== addressId);
          localStorage.setItem(key, JSON.stringify(addresses));
        } catch (e) {
          console.error('[AddressService] Erro ao remover:', e);
        }
      }
    };

    // ========================================
    // NEIGHBORHOOD NORMALIZATION (para alias de bairro)
    // ========================================
    function normalizeNeighborhood(name) {
      if (!name) return '';
      return name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // remove acentos
        .replace(/[^a-z0-9 ]/g, '')
        .trim();
    }

    // Aliases de bairro (mapeamento para c√°lculo de taxa)
    let deliveryAliases = {};

    function getCanonicalNeighborhood(name) {
      const normalized = normalizeNeighborhood(name);
      for (const [canonical, aliases] of Object.entries(deliveryAliases)) {
        if (aliases.some(alias => normalizeNeighborhood(alias) === normalized)) {
          return canonical;
        }
      }
      return name; // retorna original se n√£o encontrar alias
    }

    // Telefone atual do cliente (para favoritos/hist√≥rico)
    let currentClientPhone = localStorage.getItem('fastLastPhone') || '';

    // ========================================
    // GLOBAL HISTORY FUNCTIONS
    // ========================================

    // Salvar pedido no hist√≥rico (chamado ao confirmar pedido)
    function saveOrderToHistory(phone, orderSummary) {
      console.log('[History] Tentando salvar pedido:', { phone, itemsCount: orderSummary?.items?.length });
      if (!phone || !orderSummary || !Array.isArray(orderSummary.items)) {
        console.warn('[History] Dados inv√°lidos para salvar:', { phone: !!phone, orderSummary: !!orderSummary, items: Array.isArray(orderSummary?.items) });
        return;
      }
      try {
        const key = `fastOrders_${phone.replace(/\D/g, '')}`;
        const existing = localStorage.getItem(key);
        const list = existing ? JSON.parse(existing) : [];
        const entry = {
          id: Date.now().toString(),
          createdAt: new Date().toISOString(),
          items: orderSummary.items.map(i => ({
            productId: i.productId || i.id || null,
            name: i.name,
            price: Number(i.price) || 0,
            quantity: Number(i.quantity) || 1,
            category: i.category || null
          })),
          total: Number(orderSummary.total) || 0,
          isEncomenda: !!orderSummary.isEncomenda,
          deliveryType: orderSummary.deliveryType || 'retirada',
          neighborhood: orderSummary.neighborhood || '',
          encomendaDate: orderSummary.encomendaDate || null,
          encomendaSlot: orderSummary.encomendaSlot || null
        };
        list.unshift(entry);
        localStorage.setItem(key, JSON.stringify(list.slice(0, 10)));
        localStorage.setItem('fastLastPhone', phone);
        currentClientPhone = phone;
        console.log('[History] Pedido salvo com sucesso! Key:', key, 'Total de pedidos:', list.length);
      } catch (e) {
        console.error('[History] Falha ao salvar:', e);
      }
    }

    // Carregar hist√≥rico pelo telefone
    function loadOrderHistory(phone) {
      if (!phone) return [];
      try {
        const key = `fastOrders_${phone.replace(/\D/g, '')}`;
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('[History] Falha ao carregar:', e);
        return [];
      }
    }

    // Renderizar "√öltimos Pedidos" na loja p√∫blica
    function renderRecentOrders() {
      const phone = localStorage.getItem('fastLastPhone');
      const container = document.getElementById('recentOrdersSection');
      const repeatSection = document.getElementById('repeatLastOrderSection');
      if (!container) return;

      if (!phone) {
        container.classList.add('hidden');
        repeatSection?.classList.add('hidden');
        return;
      }

      const history = loadOrderHistory(phone);
      if (!history.length) {
        container.classList.add('hidden');
        repeatSection?.classList.add('hidden');
        return;
      }

      // Mostrar bot√£o "Pedir de novo" se tiver hist√≥rico
      repeatSection?.classList.remove('hidden');

      container.classList.remove('hidden');

      // Build order cards
      const orderCards = history.slice(0, 2).map((order, idx) => {
        const resumo = order.items.slice(0, 2).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const more = order.items.length > 2 ? ` +${order.items.length - 2}` : '';
        const data = safeDate(order.createdAt).toLocaleDateString('pt-BR');
        const total = (order.total || 0).toFixed(2).replace('.', ',');
        return `
          <div class="w-full sm:flex-1 p-3 rounded-lg bg-white border border-rose-200 shadow-sm">
            <div class="flex flex-col h-full">
              <div class="flex-1 min-w-0 mb-2">
                <p class="text-xs text-gray-500 mb-1">${data}</p>
                <p class="text-sm text-gray-800 line-clamp-2">${resumo}${more}</p>
              </div>
              <div class="flex items-center justify-between gap-2">
                <p class="text-base font-bold text-rose-600">R$ ${total}</p>
                <button onclick="repeatOrderFromHistory(${idx})" 
                  class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium whitespace-nowrap flex items-center gap-1 shadow-sm">
                  üîÑ Repetir
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="bg-gradient-to-r from-rose-50 to-orange-50 rounded-xl p-4 border border-rose-100 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-gray-800 flex items-center">
              <span class="mr-2">üîÑ</span> Pe√ßa novamente
            </h2>
            <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded-full">Ol√° de volta! üëã</span>
          </div>
          <!-- Mobile: Vertical stack -->
          <div class="sm:hidden flex flex-col gap-3 pb-2">
            ${orderCards}
          </div>
          <!-- Desktop: Vertical stack -->
          <div class="hidden sm:flex sm:flex-col gap-2">
            ${orderCards}
          </div>
        </div>
      `;
    }

    // Repetir pedido do hist√≥rico (vers√£o para loja p√∫blica)
    function repeatOrderFromHistory(orderIndex) {
      const phone = localStorage.getItem('fastLastPhone');
      const history = loadOrderHistory(phone);
      const order = history[orderIndex];
      if (!order) return;

      cart = [];
      let unavailable = [];

      order.items.forEach(item => {
        const product = products.find(p => p.id === item.productId && p.visible !== false) ||
          products.find(p => p.name === item.name && p.visible !== false);
        if (product) {
          cart.push({
            id: product.id,
            name: product.name,
            description: product.description || '',
            price: product.price,
            quantity: item.quantity
          });
        } else {
          unavailable.push(item.name);
        }
      });

      updateCart();

      if (unavailable.length > 0) {
        alert(`‚ö†Ô∏è Alguns itens n√£o est√£o mais dispon√≠veis:\n${unavailable.join(', ')}`);
      }

      showInlineMessage('publicStore', '‚úÖ Itens carregados no carrinho!', 'success');
    }

    document.addEventListener('DOMContentLoaded', async function () {
      console.log('[INIT] DOMContentLoaded iniciado');
      try {
        // Verificar se Supabase est√° dispon√≠vel
        if (!window.supabaseClient) {
          console.error('[INIT] Supabase client n√£o dispon√≠vel - usando dados locais');
        }

        // Load all data in parallel for faster page load
        // Fun√ß√µes s√≠ncronas s√£o wrappadas em Promise.resolve()
        await Promise.all([
          seedDefaultUsers().catch(function (e) { console.error('[INIT] seedDefaultUsers erro:', e); }),
          loadProducts().catch(function (e) { console.error('[INIT] loadProducts erro:', e); }),
          loadClients().catch(function (e) { console.error('[INIT] loadClients erro:', e); }),
          Promise.resolve().then(function () { loadPromotions(); }).catch(function (e) { console.error('[INIT] loadPromotions erro:', e); }),
          loadCoupons().catch(function (e) { console.error('[INIT] loadCoupons erro:', e); }),
          loadStoreConfig().catch(function (e) { console.error('[INIT] loadStoreConfig erro:', e); }),
          loadBusinessHours().catch(function (e) { console.error('[INIT] loadBusinessHours erro:', e); }),
          ProductOptionsModule.load().catch(function (e) { console.error('[INIT] ProductOptionsModule erro:', e); })
        ]);

        console.log('[INIT] Dados carregados, mostrando painel');

        // Now show the appropriate panel
        if (sessionStorage.getItem('fastAdmin') === '1') {
          isAdmin = true;
          showAdminPanel();
        } else {
          showPublicStore();
        }

        try {
          const params = new URLSearchParams(window.location.search);
          const checkout = params.get('checkout');
          const sessionId = params.get('session_id');
          if (checkout === 'success' && sessionId) {
            console.log('[Stripe] Retorno do Checkout detectado. Sincronizando pagamento...', sessionId);
            const baseUrl = (typeof getStripeServerBaseUrl === 'function') ? getStripeServerBaseUrl() : '';
            let syncedOrderId = null;
            if (!baseUrl) {
              console.warn('[Stripe] Stripe server URL n√£o configurada para sync (ok em produ√ß√£o se webhook estiver ativo).');
            } else {
              const resp = await fetch(baseUrl + '/sync-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
              });
              const data = await resp.json().catch(function () { return {}; });
              if (!resp.ok) {
                console.warn('[Stripe] Falha ao sincronizar Checkout:', data);
              } else {
                console.log('[Stripe] Sincroniza√ß√£o conclu√≠da:', data);
                syncedOrderId = data.orderId;
                try { loadDashboardOrders(); } catch (e) { }
              }
            }

            // Redirecionar para WhatsApp ap√≥s pagamento bem-sucedido
            if (syncedOrderId) {
              const waMessage = `Ol√°! Acabei de realizar o pagamento do pedido #${syncedOrderId} pelo cart√£o. Aguardo confirma√ß√£o!`;
              const waUrl = `https://wa.me/5573999366554?text=${encodeURIComponent(waMessage)}`;

              // Limpar URL params e redirecionar para WhatsApp
              window.history.replaceState({}, document.title, window.location.pathname);

              // Mostrar confirma√ß√£o e abrir WhatsApp
              alert('‚úÖ Pagamento confirmado!\n\nVoc√™ ser√° redirecionado para o WhatsApp para confirmar seu pedido.');
              window.open(waUrl, '_blank');
            }
          }
        } catch (e) {
          console.warn('[Stripe] Erro ao sincronizar pagamento no retorno do Checkout:', e);
        }
        console.log('[INIT] Painel exibido com sucesso');

        // Deep-link: auto-open tracking modal if ?track=FAST-xxxx&phone=...
        try {
          const params = new URLSearchParams(window.location.search);
          const trackCode = params.get('track');
          const trackPhone = params.get('phone');
          if (trackCode && trackPhone) {
            openTrackingModal();
            const codeEl = document.getElementById('trackingOrderCode');
            const phoneEl = document.getElementById('trackingPhone');
            if (codeEl) codeEl.value = String(trackCode).toUpperCase();
            if (phoneEl) phoneEl.value = normalizePhoneDigits(trackPhone);
            setTimeout(() => handleTrackOrder(), 300);
          }
        } catch (e) { console.warn('[Tracking] Deep-link error:', e); }

        // Deep-link: auto-open rating modal if ?rate=FAST-xxxx&phone=... or #rating hash
        try {
          const params = new URLSearchParams(window.location.search);
          const rateCode = params.get('rate');
          const ratePhone = params.get('phone');

          // Check for hash #rating to force modal open
          if (window.location.hash === '#rating' || rateCode && ratePhone) {
            setTimeout(() => {
              if (rateCode && ratePhone) {
                initRatingModal(rateCode, ratePhone);
              } else {
                // If only hash is present, show a message or open empty modal
                console.log('[Rating] Hash #rating detectado, mas sem par√¢metros');
              }
            }, 500);
          }
        } catch (e) { console.warn('[Rating] Deep-link error:', e); }

        // Load public testimonials for landing page
        try { loadPublicRatings(); } catch (e) { console.warn('[Ratings] Failed to load:', e); }

        // Initialize Options Admin UI (for products panel)
        try { OptionsAdminUI.init(); } catch (e) { console.warn('[OptionsAdmin] Failed to init:', e); }

        // Initialize Flavor Selection UI (for product form)
        try { FlavorSelectionUI.init(); } catch (e) { console.warn('[FlavorSelection] Failed to init:', e); }

      } catch (e) {
        console.error('[INIT] Erro cr√≠tico na inicializa√ß√£o:', e);
        // Tentar mostrar a loja p√∫blica mesmo com erro
        try { showPublicStore(); } catch (e2) { console.error('[INIT] Falha ao mostrar loja:', e2); }
      }
    });

    async function seedDefaultUsers() {
      try {
        // Try to load from Supabase first
        const { data, error } = await window.supabaseClient
          .from('fast_users')
          .select('*');

        if (error) throw error;

        if (data && data.length > 0) {
          users = data;
        } else {
          // Seed default admin if table is empty
          users = [{ username: 'fast', password: 'fast123', role: 'admin' }];
          await window.supabaseClient.from('fast_users').upsert(users[0], { onConflict: 'username' });
        }
        // Keep localStorage as cache
        localStorage.setItem('fastUsers', JSON.stringify(users));
      } catch (error) {
        console.error('Erro ao carregar usu√°rios do Supabase:', error);
        // Fallback to localStorage
        const saved = localStorage.getItem('fastUsers');
        if (saved) { users = JSON.parse(saved); }
        else { users = [{ username: 'fast', password: 'fast123', role: 'admin' }]; localStorage.setItem('fastUsers', JSON.stringify(users)); }
      }
    }

    async function saveUsers() {
      // Always save to localStorage first (instant)
      localStorage.setItem('fastUsers', JSON.stringify(users));

      // Then sync with Supabase
      try {
        if (window.supabaseClient) {
          // Clear and re-insert for simplicity
          await window.supabaseClient.from('fast_users').delete().neq('id', 0);
          for (const user of users) {
            await window.supabaseClient.from('fast_users').upsert(
              { username: user.username, password: user.password, role: user.role },
              { onConflict: 'username' }
            );
          }
          console.log('Usu√°rios sincronizados com Supabase');
        }
      } catch (error) {
        console.error('Erro ao salvar usu√°rios no Supabase:', error);
      }
    }
    function renderUsers() {
      const box = document.getElementById('usersList'); if (!box) return;
      box.innerHTML = users.map((u, i) => `
        <div class='p-3 border rounded-lg'>
          <div id='userView${i}' class='flex flex-col sm:flex-row sm:items-center justify-between gap-2'>
            <div>
              <p class='font-medium text-gray-800'>${u.username}</p>
              <p class='text-xs text-gray-600'>Papel: ${u.role}</p>
            </div>
            <div class='flex gap-2'>
              <button class='flex-1 sm:flex-none px-2 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs' onclick='showEditUserForm(${i})'>Editar</button>
              <button class='flex-1 sm:flex-none px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs' onclick='deleteUser(${i})'>Excluir</button>
            </div>
          </div>
          <div id='userEditForm${i}' class='hidden mt-3 p-3 bg-gray-50 rounded-lg'>
            <div class='space-y-3'>
              <div>
                <label class='block text-xs font-medium text-gray-700 mb-1'>Nome de usu√°rio</label>
                <input type='text' id='editUsername${i}' value='${u.username}' class='w-full px-2 py-1 border rounded text-sm' />
              </div>
              <div>
                <label class='block text-xs font-medium text-gray-700 mb-1'>Nova senha (vazio = manter)</label>
                <input type='password' id='editPassword${i}' class='w-full px-2 py-1 border rounded text-sm' placeholder='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' />
              </div>
              <div>
                <label class='block text-xs font-medium text-gray-700 mb-1'>Papel</label>
                <select id='editRole${i}' class='w-full px-2 py-1 border rounded text-sm'>
                  <option value='admin' ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                  <option value='gerente' ${u.role === 'gerente' ? 'selected' : ''}>Gerente</option>
                  <option value='garcom' ${u.role === 'garcom' ? 'selected' : ''}>Gar√ßom</option>
                  <option value='caixa' ${u.role === 'caixa' ? 'selected' : ''}>Caixa</option>
                </select>
              </div>
              <div id='editUserMsg${i}' class='text-xs hidden'></div>
              <div class='flex gap-2'>
                <button class='flex-1 px-2 py-1 rounded bg-gray-300 hover:bg-gray-400 text-gray-800 text-xs' onclick='cancelEditUser(${i})'>Cancelar</button>
                <button class='flex-1 px-2 py-1 rounded bg-green-500 hover:bg-green-600 text-white text-xs' onclick='saveEditUser(${i})'>Salvar</button>
              </div>
            </div>
          </div>
        </div>`).join('');
    }

    function showEditUserForm(i) {
      document.getElementById('userView' + i).classList.add('hidden');
      document.getElementById('userEditForm' + i).classList.remove('hidden');
    }

    function cancelEditUser(i) {
      document.getElementById('userView' + i).classList.remove('hidden');
      document.getElementById('userEditForm' + i).classList.add('hidden');
      // Reset values
      document.getElementById('editUsername' + i).value = users[i].username;
      document.getElementById('editPassword' + i).value = '';
    }

    function saveEditUser(i) {
      const newUsername = document.getElementById('editUsername' + i).value.trim();
      const newPassword = document.getElementById('editPassword' + i).value;
      const newRole = document.getElementById('editRole' + i).value;
      const msgBox = document.getElementById('editUserMsg' + i);

      if (!newUsername) {
        msgBox.textContent = '‚ùå Nome de usu√°rio n√£o pode ser vazio';
        msgBox.className = 'text-xs text-red-600';
        msgBox.classList.remove('hidden');
        return;
      }

      // Check duplicate username
      if (newUsername !== users[i].username && users.some(u => u.username === newUsername)) {
        msgBox.textContent = '‚ùå Este nome de usu√°rio j√° existe!';
        msgBox.className = 'text-xs text-red-600';
        msgBox.classList.remove('hidden');
        return;
      }

      // Impedir remo√ß√£o do √∫ltimo admin
      if (users[i].role === 'admin' && newRole !== 'admin' && users.filter(u => u.role === 'admin').length === 1) {
        msgBox.textContent = '‚ùå Mantenha ao menos um administrador!';
        msgBox.className = 'text-xs text-red-600';
        msgBox.classList.remove('hidden');
        return;
      }

      users[i].username = newUsername;
      if (newPassword) users[i].password = newPassword;
      users[i].role = newRole;

      saveUsers();
      renderUsers();

      // Show success message
      showInlineMessage('usersList', '‚úÖ Usu√°rio atualizado com sucesso!', 'success');
    }

    function editUser(i) { showEditUserForm(i); } // Compatibility alias

    function changeUserPassword(i) { editUser(i); } // Mant√©m compatibilidade
    function deleteUser(i) { if (users[i].role === 'admin' && users.filter(u => u.role === 'admin').length === 1) { alert('Mantenha ao menos um administrador.'); return; } if (confirm('Excluir usu√°rio ' + users[i].username + '?')) { users.splice(i, 1); saveUsers(); renderUsers(); } }

    // Client Management Functions
    async function loadClients() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_clients')
          .select('*');

        if (error) throw error;
        clients = data || [];
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        // Fallback para localStorage
        const saved = localStorage.getItem('fastClients');
        if (saved) { clients = JSON.parse(saved); }
        else { clients = []; }
      }
    }

    async function saveClients() {
      try {
        // Sincroniza com Supabase
        for (const client of clients) {
          const { error } = await window.supabaseClient
            .from('fast_clients')
            .upsert(client, { onConflict: 'phone' });

          if (error) throw error;
        }

        // Mant√©m backup no localStorage
        localStorage.setItem('fastClients', JSON.stringify(clients));
      } catch (error) {
        console.error('Erro ao salvar clientes:', error);
        // Fallback para localStorage
        localStorage.setItem('fastClients', JSON.stringify(clients));
      }
    }

    // ========================================
    // COURIER (ENTREGADOR) MANAGEMENT
    // ========================================
    async function loadCouriers() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_couriers')
          .select('*')
          .order('name');
        if (error) throw error;
        couriers = data || [];
      } catch (e) {
        console.warn('[Couriers] Erro ao carregar do Supabase:', e);
        const saved = localStorage.getItem('fastCouriers');
        couriers = saved ? JSON.parse(saved) : [];
      }
      renderCouriersList();
    }

    async function saveCourier(courier) {
      try {
        const { error } = await window.supabaseClient
          .from('fast_couriers')
          .upsert(courier, { onConflict: 'id' });
        if (error) throw error;
      } catch (e) {
        console.warn('[Couriers] Erro ao salvar no Supabase:', e);
      }
      localStorage.setItem('fastCouriers', JSON.stringify(couriers));
    }

    async function deleteCourier(courierId) {
      try {
        await window.supabaseClient
          .from('fast_couriers')
          .update({ active: false })
          .eq('id', courierId);
      } catch (e) {
        console.warn('[Couriers] Erro ao desativar:', e);
      }
      couriers = couriers.filter(c => c.id !== courierId);
      localStorage.setItem('fastCouriers', JSON.stringify(couriers));
      renderCouriersList();
    }

    function renderCouriersList() {
      const container = document.getElementById('couriersList');
      if (!container) return;

      const activeCouriers = couriers.filter(c => c.active !== false);

      if (activeCouriers.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Nenhum entregador cadastrado</p>';
        return;
      }

      container.innerHTML = activeCouriers.map(c => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border">
          <div class="flex items-center gap-2">
            <span class="text-lg">üèçÔ∏è</span>
            <div>
              <p class="font-medium text-gray-800 text-sm">${c.name}</p>
              <p class="text-xs text-gray-500">${c.phone || 'Sem telefone'}</p>
            </div>
          </div>
          <div class="flex gap-1">
            <button onclick="editCourier(${c.id})" class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1">‚úèÔ∏è</button>
            <button onclick="confirmDeleteCourier(${c.id})" class="text-red-600 hover:text-red-800 text-xs px-2 py-1">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function editCourier(courierId) {
      const courier = couriers.find(c => c.id === courierId);
      if (!courier) return;
      document.getElementById('courierName').value = courier.name;
      document.getElementById('courierPhone').value = courier.phone || '';
      document.getElementById('courierEditId').value = courierId;
    }

    function confirmDeleteCourier(courierId) {
      const courier = couriers.find(c => c.id === courierId);
      if (confirm(`Deseja remover o entregador "${courier?.name}"?`)) {
        deleteCourier(courierId);
      }
    }

    function getActiveCouriers() {
      return couriers.filter(c => c.active !== false);
    }

    // Courier form handler
    document.getElementById('courierForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('courierName').value.trim();
      const phone = document.getElementById('courierPhone').value.trim();
      const editId = document.getElementById('courierEditId').value;

      if (!name) {
        alert('Informe o nome do entregador.');
        return;
      }

      if (editId) {
        // Editar existente
        const idx = couriers.findIndex(c => c.id === parseInt(editId));
        if (idx !== -1) {
          couriers[idx].name = name;
          couriers[idx].phone = phone;
          await saveCourier(couriers[idx]);
        }
      } else {
        // Novo entregador
        const newCourier = {
          id: Date.now(),
          name,
          phone,
          active: true
        };
        couriers.push(newCourier);
        await saveCourier(newCourier);
      }

      // Reset form
      document.getElementById('courierForm').reset();
      document.getElementById('courierEditId').value = '';
      renderCouriersList();
      showInlineMessage('configPanelFast', '‚úÖ Entregador salvo!', 'success');
    });

    // Fun√ß√£o para buscar cliente ‚Äì SOMENTE POR TELEFONE V√ÅLIDO
    function searchClient(name, phone) {
      // Normaliza telefone: mant√©m apenas d√≠gitos
      const normalizedPhone = (phone || '').replace(/\D/g, '');

      // Sem telefone v√°lido (11 d√≠gitos), n√£o h√° busca autom√°tica
      if (normalizedPhone.length !== 11) {
        return null;
      }

      // Busca exata por telefone (√∫nico crit√©rio para autoidentificar cliente)
      const exactPhone = clients.find(c => c.phone === normalizedPhone);
      return exactPhone || null;
    }

    // Fun√ß√£o para renderizar endere√ßos do cliente
    function renderClientAddresses(client) {
      const addressesDiv = document.getElementById('customerAddresses');
      if (!addressesDiv || !client) return;

      const addresses = client.addresses || [];
      if (addresses.length === 0) {
        addressesDiv.innerHTML = '<p class="text-sm text-gray-600">Nenhum endere√ßo cadastrado.</p>';
        return;
      }

      addressesDiv.innerHTML = addresses.map((addr, index) => `
        <div class="bg-white border border-gray-200 p-2 rounded flex justify-between items-center">
          <div class="flex-1">
            <p class="text-sm font-medium">${addr.street}, ${addr.number}</p>
            <p class="text-xs text-gray-600">${addr.neighborhood}</p>
            ${addr.reference ? `<p class="text-xs text-gray-500">Ref: ${addr.reference}</p>` : ''}
          </div>
          <div class="flex gap-2">
            <button onclick="selectAddress(${index})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">Usar</button>
            <button onclick="deleteAddress(${index})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">Excluir</button>
          </div>
        </div>
      `).join('');
    }

    // Fun√ß√£o para selecionar endere√ßo
    function selectAddress(index) {
      if (!currentSelectedClient) return;

      const address = currentSelectedClient.addresses[index];
      document.getElementById('street').value = address.street;
      document.getElementById('number').value = address.number;
      document.getElementById('neighborhood').value = address.neighborhood;
      document.getElementById('reference').value = address.reference || '';

      // Mostra o formul√°rio de endere√ßo com os dados preenchidos
      document.getElementById('addressForm').classList.remove('hidden');
    }

    // Fun√ß√£o para excluir endere√ßo
    function deleteAddress(index) {
      if (!currentSelectedClient) return;

      if (confirm('Deseja excluir este endere√ßo?')) {
        currentSelectedClient.addresses.splice(index, 1);

        // Encontra e atualiza o cliente no array principal
        const clientIndex = clients.findIndex(c => c.phone === currentSelectedClient.phone);
        if (clientIndex !== -1) {
          clients[clientIndex] = currentSelectedClient;
          saveClients();
          renderClientAddresses(currentSelectedClient);
        }
      }
    }

    // Fun√ß√£o para salvar novo endere√ßo
    function saveNewAddress() {
      if (!currentSelectedClient) return;

      const street = document.getElementById('street').value.trim();
      const number = document.getElementById('number').value.trim();
      const neighborhood = document.getElementById('neighborhood').value.trim();
      const reference = document.getElementById('reference').value.trim();

      if (!street || !number || !neighborhood) {
        alert('Preencha rua, n√∫mero e bairro.');
        return;
      }

      if (!currentSelectedClient.addresses) {
        currentSelectedClient.addresses = [];
      }

      currentSelectedClient.addresses.push({ street, number, neighborhood, reference });

      // Encontra e atualiza o cliente no array principal
      const clientIndex = clients.findIndex(c => c.phone === currentSelectedClient.phone);
      if (clientIndex !== -1) {
        clients[clientIndex] = currentSelectedClient;
        saveClients();
        renderClientAddresses(currentSelectedClient);
      }

      // Limpa o formul√°rio
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';

      alert('Endere√ßo salvo com sucesso!');
    }
    // Vari√°veis globais para filtros de clientes
    let currentNameInitial = '';
    let currentBirthMonth = '';

    function renderClients(searchTerm = '') {
      const box = document.getElementById('clientsList'); if (!box) return;

      // Filtra por texto de busca (nome/telefone)
      let filtered = clients.filter(c =>
        c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.phone.includes(searchTerm)
      );

      // Filtra por inicial do nome
      if (currentNameInitial) {
        filtered = filtered.filter(c => {
          const firstName = (c.name || '').trim().toUpperCase();
          return firstName.startsWith(currentNameInitial);
        });
      }

      // Filtra por m√™s de anivers√°rio
      if (currentBirthMonth) {
        if (currentBirthMonth === 'no-date') {
          filtered = filtered.filter(c => !c.birthdate);
        } else {
          filtered = filtered.filter(c => {
            if (!c.birthdate) return false;
            let month = '';
            if (c.birthdate.includes('/')) {
              const parts = c.birthdate.split('/');
              month = parts[1];
            } else if (c.birthdate.includes('-')) {
              const parts = c.birthdate.split('-');
              month = parts[1];
            }
            return month === currentBirthMonth;
          });
        }
      }

      // Renderiza a lista filtrada
      box.innerHTML = filtered.length ? filtered.map((c, i) => {
        // Encontra o √≠ndice original no array clients para as fun√ß√µes edit/delete
        const originalIndex = clients.findIndex(client => client.phone === c.phone);
        return `
        <div class='flex items-center justify-between p-4 border rounded-lg'>
          <div class='flex-1'>
            <p class='font-medium text-gray-800'>${c.name}</p>
            <p class='text-sm text-gray-600'>üì± ${c.phone}</p>
            ${c.email ? `<p class='text-sm text-gray-600'>üìß ${c.email}</p>` : ''}
            ${c.address ? `<p class='text-sm text-gray-600'>üìç ${c.address}</p>` : ''}
            <p class='text-xs text-gray-500'>üéÇ ${c.birthdate ? c.birthdate.split('-').reverse().join('/') : 'N√£o informado'}</p>
            ${clientDiscounts[c.phone] ? `<p class='text-xs text-green-600 font-semibold'>Desconto: ${clientDiscounts[c.phone]}%</p>` : ''}
          </div>
          <div class='flex gap-2'>
            <button class='px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-sm' onclick='editClient(${originalIndex})'>Editar</button>
            <button class='px-3 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-sm' onclick='deleteClient(${originalIndex})'>Excluir</button>
          </div>
        </div>`;
      }).join('') : '<p class="text-gray-500 text-center py-8">Nenhum cliente encontrado com os filtros aplicados.</p>';
    }
    function editClient(i) {
      const c = clients[i];
      document.getElementById('clientName').value = c.name;
      document.getElementById('clientBirthdate').value = c.birthdate;
      document.getElementById('clientPhone').value = c.phone;
      document.getElementById('clientEmail').value = c.email || '';
      document.getElementById('clientAddress').value = c.address || '';
      editingClientId = i;
    }
    // Vari√°vel para armazenar cliente pendente de exclus√£o
    let clientToDelete = null;
    let clientToDeleteIndex = null;

    function deleteClient(i) {
      const client = clients[i];
      if (!client) return;

      clientToDelete = client;
      clientToDeleteIndex = i;

      // Conta pedidos do cliente
      const ordersCount = orders.filter(o => o.client_phone === client.phone).length;

      // Monta texto do modal
      const deleteClientModalText = document.getElementById('deleteClientModalText');
      deleteClientModalText.innerHTML = `
        <p><strong>Nome:</strong> ${client.name || 'Cliente'}</p>
        <p><strong>Telefone:</strong> ${client.phone}</p>
        ${client.birthdate ? `<p><strong>Anivers√°rio:</strong> ${client.birthdate}</p>` : ''}
        <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-sm">
          ‚ö†Ô∏è Este cliente possui <strong>${ordersCount} pedido(s)</strong> no hist√≥rico.
          ${ordersCount > 0 ? '<br>Os pedidos N√ÉO ser√£o exclu√≠dos, apenas o cadastro do cliente.' : ''}
        </div>
        <p class="mt-3">Deseja realmente excluir este cliente?</p>
      `;

      // Abre o modal
      document.getElementById('deleteClientModal').classList.remove('hidden');
    }

    // Executa exclus√£o de cliente ap√≥s confirma√ß√£o no modal
    async function executeDeleteClient() {
      if (!clientToDelete) return;

      const deleteClientModal = document.getElementById('deleteClientModal');
      deleteClientModal.classList.add('hidden');

      try {
        // Exclui do Supabase
        const { error } = await window.supabaseClient
          .from('fast_clients')
          .delete()
          .eq('phone', clientToDelete.phone);

        if (error) throw error;

        // Remove da lista local
        const phone = clientToDelete.phone;
        clients = clients.filter(c => c.phone !== phone);
        delete clientDiscounts[phone];

        // Salva no localStorage como backup
        saveClients();
        saveClientDiscounts();

        // Recarrega lista
        renderClients();

        // Limpa vari√°veis
        clientToDelete = null;
        clientToDeleteIndex = null;

        // Feedback visual
        showInlineMessage('clientsPanelFast', '‚úÖ Cliente exclu√≠do com sucesso!', 'success');

      } catch (error) {
        console.error('Erro ao excluir cliente:', error);

        // Mesmo com erro no Supabase, tenta excluir localmente
        if (clientToDeleteIndex !== null && clients[clientToDeleteIndex]) {
          const phone = clients[clientToDeleteIndex].phone;
          clients.splice(clientToDeleteIndex, 1);
          delete clientDiscounts[phone];
          saveClients();
          saveClientDiscounts();
          renderClients();
        }

        clientToDelete = null;
        clientToDeleteIndex = null;

        showInlineMessage('clientsPanelFast', `‚ö†Ô∏è Cliente removido localmente. Erro no servidor: ${error.message}`, 'warning');
      }
    }

    // Event listeners para modal de exclus√£o de cliente
    document.getElementById('cancelDeleteClientModalBtn')?.addEventListener('click', () => {
      document.getElementById('deleteClientModal').classList.add('hidden');
      clientToDelete = null;
      clientToDeleteIndex = null;
    });

    document.getElementById('confirmDeleteClientModalBtn')?.addEventListener('click', executeDeleteClient);

    // Fechar modal ao clicar fora
    document.getElementById('deleteClientModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'deleteClientModal') {
        e.target.classList.add('hidden');
        clientToDelete = null;
        clientToDeleteIndex = null;
      }
    });
    document.addEventListener('submit', (e) => {
      if (e.target && e.target.id === 'clientForm') {
        e.preventDefault();
        const name = document.getElementById('clientName').value.trim();
        const birthdate = document.getElementById('clientBirthdate').value;
        const phone = document.getElementById('clientPhone').value.trim();
        const email = document.getElementById('clientEmail').value.trim();
        const address = document.getElementById('clientAddress').value.trim();

        // Check for duplicate
        const duplicate = clients.find(c =>
          c.name.toLowerCase() === name.toLowerCase() && c.phone === phone
        );
        if (duplicate && editingClientId !== undefined) {
          alert('Cadastro j√° existente para este nome e telefone.');
          return;
        }

        if (editingClientId !== undefined) {
          const oldPhone = clients[editingClientId].phone;
          clients[editingClientId] = { name, birthdate, phone, email, address };
          // Migrate discount if phone changed
          if (oldPhone !== phone && clientDiscounts[oldPhone]) {
            clientDiscounts[phone] = clientDiscounts[oldPhone];
            delete clientDiscounts[oldPhone];
            saveClientDiscounts();
          }
          editingClientId = undefined;
        } else {
          clients.push({ name, birthdate, phone, email, address });
        }
        saveClients();
        renderClients();
        e.target.reset();
        alert('Cliente salvo com sucesso!');
      }
    });

    // =============================================
    // ORDER MANAGEMENT AND REPORTS
    // =============================================
    let orders = [];
    let currentReportPeriod = 'month'; // month, semester, year

    // =============================================
    // BIRTHDAY DISCOUNT SYSTEM (10% - once per year)
    // =============================================

    function isTodayBirthday(birthdate) {
      if (!birthdate) return false;

      const today = new Date();
      const todayStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      // Parse birthdate (handles YYYY-MM-DD format)
      const parts = birthdate.split('-');
      if (parts.length !== 3) return false;

      const birthMonthDay = `${parts[1]}-${parts[2]}`;

      // Check if today matches birthday
      if (birthMonthDay === todayStr) return true;

      // If store is closed today, check if yesterday was birthday (extend promo)
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = `${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;

      // Check if yesterday was birthday AND store was closed yesterday
      if (birthMonthDay === yesterdayStr) {
        // Check if store was closed yesterday (Sunday or manually closed)
        const yesterdayDay = yesterday.getDay();
        if (yesterdayDay === 0) return true; // Sunday - extend to Monday
      }

      return false;
    }

    async function checkBirthdayDiscountUsed(phone) {
      if (!phone) return true; // No phone = can't verify

      const currentYear = new Date().getFullYear();

      try {
        const { data, error } = await window.supabaseClient
          .from('fast_birthday_discount_usage')
          .select('id')
          .eq('client_phone', phone)
          .eq('usage_year', currentYear)
          .single();

        if (error && error.code !== 'PGRST116') throw error; // PGRST116 = not found

        return !!data; // Returns true if already used this year
      } catch (error) {
        console.error('Erro ao verificar uso de desconto de anivers√°rio:', error);
        // Fallback to localStorage
        const usageKey = `birthdayDiscount_${phone}_${currentYear}`;
        return localStorage.getItem(usageKey) === 'used';
      }
    }

    async function recordBirthdayDiscountUsage(phone, discountAmount, orderId) {
      if (!phone) return;

      const currentYear = new Date().getFullYear();

      try {
        await window.supabaseClient
          .from('fast_birthday_discount_usage')
          .insert([{
            client_phone: phone,
            usage_year: currentYear,
            discount_applied: discountAmount,
            order_id: orderId
          }]);
        console.log('Uso de desconto de anivers√°rio registrado:', phone);
      } catch (error) {
        console.error('Erro ao registrar uso de desconto de anivers√°rio:', error);
        // Fallback to localStorage
        const usageKey = `birthdayDiscount_${phone}_${currentYear}`;
        localStorage.setItem(usageKey, 'used');
      }
    }

    async function saveOrderToSupabase(orderData) {
      try {
        const { error } = await window.supabaseClient
          .from('fast_orders')
          .insert([orderData]);

        if (error) throw error;
        console.log('Pedido salvo com sucesso:', orderData.id);
      } catch (error) {
        console.error('Erro ao salvar pedido:', error);
        // Save locally as fallback
        const localOrders = JSON.parse(localStorage.getItem('fastOrders') || '[]');
        localOrders.push(orderData);
        localStorage.setItem('fastOrders', JSON.stringify(localOrders));
      }
    }

    async function loadOrders() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_orders')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;
        orders = data || [];

        // Merge with local fallback orders
        const localOrders = JSON.parse(localStorage.getItem('fastOrders') || '[]');
        if (localOrders.length > 0) {
          orders = [...orders, ...localOrders.filter(lo => !orders.find(o => o.id === lo.id))];
        }
      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        orders = JSON.parse(localStorage.getItem('fastOrders') || '[]');
      }
    }

    function getOrdersInPeriod(period) {
      const now = new Date();
      let startDate;

      switch (period) {
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case 'semester':
          startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          break;
        default:
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      }

      return orders.filter(o => safeDate(o.created_at || o.id) >= startDate);
    }

    function calculateClientRanking(periodOrders) {
      // Filtra apenas pedidos pagos/entregues/prontos (exclui pendentes e cancelados)
      const validOrders = periodOrders.filter(order => {
        const status = (order.status || '').toLowerCase();
        return status.includes('paid') || status.includes('delivered') || status.includes('confirmed') ||
          status.includes('pago') || status.includes('entregue') || status.includes('pronto') ||
          status === 'preparing' || status === 'out_for_delivery';
      });

      const clientTotals = {};

      validOrders.forEach(order => {
        const key = order.client_phone || order.client_name;
        if (!clientTotals[key]) {
          clientTotals[key] = {
            name: order.client_name,
            phone: order.client_phone,
            total: 0,
            orderCount: 0
          };
        }
        clientTotals[key].total += parseFloat(order.total || 0);
        clientTotals[key].orderCount++;
      });

      return Object.values(clientTotals)
        .sort((a, b) => b.total - a.total)
        .slice(0, 10);
    }

    function calculateTopProducts(periodOrders) {
      const productCounts = {};

      periodOrders.forEach(order => {
        const items = typeof order.items === 'string' ? JSON.parse(order.items) : (order.items || []);
        items.forEach(item => {
          if (!productCounts[item.name]) {
            productCounts[item.name] = { name: item.name, quantity: 0, revenue: 0 };
          }
          productCounts[item.name].quantity += item.quantity || 1;
          productCounts[item.name].revenue += (item.price || 0) * (item.quantity || 1);
        });
      });

      return Object.values(productCounts)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 8);
    }

    function calculateNeighborhoodStats(periodOrders) {
      const neighborhoodCounts = {};

      periodOrders.forEach(order => {
        let neighborhood = null;

        // Extract neighborhood from address if delivery
        if (order.address) {
          const addr = typeof order.address === 'string' ? JSON.parse(order.address) : order.address;
          neighborhood = addr.neighborhood || addr.bairro;
        }

        if (neighborhood) {
          const key = neighborhood.toLowerCase().trim();
          if (!neighborhoodCounts[key]) {
            neighborhoodCounts[key] = { name: neighborhood, count: 0, total: 0 };
          }
          neighborhoodCounts[key].count++;
          neighborhoodCounts[key].total += parseFloat(order.total || 0);
        }
      });

      return Object.values(neighborhoodCounts)
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);
    }

    function renderReportsData() {
      const periodOrders = getOrdersInPeriod(currentReportPeriod);

      // Client Ranking
      const ranking = calculateClientRanking(periodOrders);
      const rankingList = document.getElementById('clientRankingList');
      if (rankingList) {
        if (ranking.length > 0) {
          rankingList.innerHTML = ranking.map((c, i) => `
            <div class="flex items-center justify-between p-2 ${i < 3 ? 'bg-yellow-50 border border-yellow-200' : 'bg-white border'} rounded-lg">
              <div class="flex items-center gap-3">
                <span class="text-lg font-bold ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-orange-400' : 'text-gray-600'}">${i + 1}¬∫</span>
                <div>
                  <p class="font-medium text-gray-800 text-sm">${c.name}</p>
                  <p class="text-xs text-gray-500">${c.orderCount} pedidos</p>
                </div>
              </div>
              <span class="font-bold text-green-600">R$ ${c.total.toFixed(2).replace('.', ',')}</span>
            </div>
          `).join('');
        } else {
          rankingList.innerHTML = `<div class="text-center py-8 text-gray-500"><p class="text-4xl mb-2">üìà</p><p>Nenhum pedido no per√≠odo.</p></div>`;
        }
      }

      // Order History
      const historyList = document.getElementById('orderHistoryList');
      if (historyList) {
        if (periodOrders.length > 0) {
          historyList.innerHTML = periodOrders.slice(0, 20).map(o => {
            const date = safeDate(o.created_at || o.id).toLocaleDateString('pt-BR');
            const items = typeof o.items === 'string' ? JSON.parse(o.items) : (o.items || []);
            return `
              <div class="p-2 bg-white border rounded-lg">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-medium text-gray-800 text-sm">${o.client_name}</p>
                    <p class="text-xs text-gray-500">${date} | ${items.length} itens</p>
                  </div>
                  <span class="font-bold text-green-600 text-sm">R$ ${parseFloat(o.total || 0).toFixed(2).replace('.', ',')}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          historyList.innerHTML = `<div class="text-center py-8 text-gray-500"><p class="text-4xl mb-2">üõí</p><p>Nenhum pedido no per√≠odo.</p></div>`;
        }
      }

      // Top Products
      const topProducts = calculateTopProducts(periodOrders);
      const topProductsList = document.getElementById('topProductsList');
      if (topProductsList) {
        if (topProducts.length > 0) {
          topProductsList.innerHTML = topProducts.map((p, i) => `
            <div class="bg-white border rounded-lg p-3 text-center">
              <p class="text-2xl mb-1">${i < 3 ? 'üî•' : 'üì¶'}</p>
              <p class="font-medium text-gray-800 text-sm truncate">${p.name}</p>
              <p class="text-xs text-gray-500">${p.quantity}x vendidos</p>
              <p class="text-xs text-green-600 font-bold">R$ ${p.revenue.toFixed(2).replace('.', ',')}</p>
            </div>
          `).join('');
        } else {
          topProductsList.innerHTML = `<div class="text-center py-6 text-gray-500 col-span-full"><p class="text-4xl mb-2">üçΩÔ∏è</p><p>Sem dados de produtos.</p></div>`;
        }
      }

      // Neighborhood Chart
      const neighborhoodStats = calculateNeighborhoodStats(periodOrders);
      const neighborhoodContainer = document.getElementById('neighborhoodChartContainer');
      if (neighborhoodContainer) {
        if (neighborhoodStats.length > 0) {
          const maxCount = Math.max(...neighborhoodStats.map(n => n.count));
          neighborhoodContainer.innerHTML = neighborhoodStats.map((n, i) => {
            const percentage = (n.count / maxCount) * 100;
            const colors = ['bg-rose-500', 'bg-rose-400', 'bg-rose-300', 'bg-pink-400', 'bg-pink-300'];
            const bgColor = colors[Math.min(i, colors.length - 1)];
            return `
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-sm font-medium text-gray-700 truncate capitalize">${n.name}</div>
                <div class="flex-1 bg-gray-200 rounded-full h-6 relative overflow-hidden">
                  <div class="${bgColor} h-full rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                  <span class="absolute inset-0 flex items-center justify-center text-xs font-bold ${percentage > 50 ? 'text-white' : 'text-gray-700'}">${n.count} pedidos</span>
                </div>
                <div class="w-20 text-right text-xs text-green-600 font-bold">R$ ${n.total.toFixed(2).replace('.', ',')}</div>
              </div>
            `;
          }).join('');
        } else {
          neighborhoodContainer.innerHTML = `<div class="text-center py-6 text-gray-500"><p class="text-4xl mb-2">üìç</p><p>Nenhum pedido com entrega no per√≠odo.</p></div>`;
        }
      }

      // Summary Cards
      // Filtrar apenas pedidos pagos/entregues para faturamento (excluir pending/accepted)
      const paidOrders = periodOrders.filter(o => {
        const status = (o.status || '').toLowerCase();
        return status === 'delivered' || status === 'confirmed' ||
          status === 'preparing' || status === 'out_for_delivery' ||
          o.payment_status === 'paid' || o.payment_status === 'paid_full';
      });
      const totalRevenue = paidOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
      const totalOrders = periodOrders.length;
      const avgOrder = paidOrders.length > 0 ? totalRevenue / paidOrders.length : 0;
      const uniqueClients = new Set(periodOrders.map(o => o.client_phone || o.client_name)).size;

      document.getElementById('totalRevenueCard').textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
      document.getElementById('totalOrdersCard').textContent = totalOrders;
      document.getElementById('avgOrderCard').textContent = `R$ ${avgOrder.toFixed(2).replace('.', ',')}`;
      document.getElementById('uniqueClientsCard').textContent = uniqueClients;
    }

    // Period filter buttons
    document.getElementById('reportPeriodMonth')?.addEventListener('click', () => {
      currentReportPeriod = 'month';
      updatePeriodButtons();
      renderReportsData();
    });
    document.getElementById('reportPeriodSemester')?.addEventListener('click', () => {
      currentReportPeriod = 'semester';
      updatePeriodButtons();
      renderReportsData();
    });
    document.getElementById('reportPeriodYear')?.addEventListener('click', () => {
      currentReportPeriod = 'year';
      updatePeriodButtons();
      renderReportsData();
    });

    function updatePeriodButtons() {
      const buttons = {
        'reportPeriodMonth': 'month',
        'reportPeriodSemester': 'semester',
        'reportPeriodYear': 'year'
      };
      Object.entries(buttons).forEach(([id, period]) => {
        const btn = document.getElementById(id);
        if (btn) {
          if (currentReportPeriod === period) {
            btn.classList.remove('bg-gray-200', 'text-gray-700');
            btn.classList.add('bg-rose-600', 'text-white');
          } else {
            btn.classList.remove('bg-rose-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
          }
        }
      });
    }

    // Search order history
    document.getElementById('orderSearchClient')?.addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase().trim();
      const periodOrders = getOrdersInPeriod(currentReportPeriod);
      const filtered = search ? periodOrders.filter(o =>
        o.client_name?.toLowerCase().includes(search) ||
        o.client_phone?.includes(search)
      ) : periodOrders;

      const historyList = document.getElementById('orderHistoryList');
      if (historyList && filtered.length > 0) {
        historyList.innerHTML = filtered.slice(0, 20).map(o => {
          const date = safeDate(o.created_at || o.id).toLocaleDateString('pt-BR');
          const items = typeof o.items === 'string' ? JSON.parse(o.items) : (o.items || []);
          return `
            <div class="p-2 bg-white border rounded-lg">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium text-gray-800 text-sm">${o.client_name}</p>
                  <p class="text-xs text-gray-500">${date} | ${items.length} itens</p>
                </div>
                <span class="font-bold text-green-600 text-sm">R$ ${parseFloat(o.total || 0).toFixed(2).replace('.', ',')}</span>
              </div>
            </div>
          `;
        }).join('');
      } else if (historyList) {
        historyList.innerHTML = `<div class="text-center py-8 text-gray-500"><p>Nenhum resultado encontrado.</p></div>`;
      }
    });

    // ========== STORE CONFIG MANAGEMENT ==========

    async function loadStoreConfig() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_store_config')
          .select('*')
          .eq('id', 1)
          .single();

        if (error) throw error;
        if (data) {
          storeConfig = {
            card_fee_1x: parseFloat(data.card_fee_1x) || 5,
            card_fee_2x: parseFloat(data.card_fee_2x) || 10,
            delivery_enabled: data.delivery_enabled !== false,
            delivery_disabled_reason: data.delivery_disabled_reason || '',
            prep_time_min: parseInt(data.prep_time_min) || 0,
            prep_time_max: parseInt(data.prep_time_max) || 0,
            delivery_time_min: parseInt(data.delivery_time_min) || 0,
            delivery_time_max: parseInt(data.delivery_time_max) || 0,
          };
          storeConfig.card_fee_2x = storeConfig.card_fee_1x;
          localStorage.setItem('fastStoreConfig', JSON.stringify(storeConfig));
          console.log('Configura√ß√µes carregadas do Supabase');
        }
      } catch (error) {
        console.log('Carregando config do localStorage:', error.message);
        try {
          const saved = localStorage.getItem('fastStoreConfig');
          if (saved) {
            const parsed = JSON.parse(saved);
            storeConfig = { ...storeConfig, ...parsed };
            storeConfig.card_fee_2x = storeConfig.card_fee_1x;
          }
        } catch (e) {
          console.log('Using default store config');
        }
      }

      // Update UI if elements exist
      const fee1x = document.getElementById('cardFee1x');
      const deliveryEnabled = document.getElementById('deliveryEnabled');
      const reasonBox = document.getElementById('deliveryDisabledReasonBox');
      const reasonInput = document.getElementById('deliveryDisabledReason');

      if (fee1x) fee1x.value = storeConfig.card_fee_1x;
      if (deliveryEnabled) {
        deliveryEnabled.checked = storeConfig.delivery_enabled;
        if (reasonBox) reasonBox.classList.toggle('hidden', storeConfig.delivery_enabled);
        if (reasonInput) reasonInput.value = storeConfig.delivery_disabled_reason || '';
      }
      // Time Inputs
      if (document.getElementById('prepTimeMin')) document.getElementById('prepTimeMin').value = storeConfig.prep_time_min || '';
      if (document.getElementById('prepTimeMax')) document.getElementById('prepTimeMax').value = storeConfig.prep_time_max || '';
      if (document.getElementById('deliveryTimeMin')) document.getElementById('deliveryTimeMin').value = storeConfig.delivery_time_min || '';
      if (document.getElementById('deliveryTimeMax')) document.getElementById('deliveryTimeMax').value = storeConfig.delivery_time_max || '';

      // Update card fee labels in checkout
      updateCardFeeLabels();
    }

    function updateCardFeeLabels() {
      const label1x = document.getElementById('cardFeeLabel1x');
      if (label1x) label1x.textContent = `+${storeConfig.card_fee_1x}%`;
    }

    async function saveStoreConfig() {
      try {
        // Always save to localStorage as backup
        localStorage.setItem('fastStoreConfig', JSON.stringify(storeConfig));

        // Sync to Supabase
        const { error } = await window.supabaseClient
          .from('fast_store_config')
          .upsert({
            id: 1,
            card_fee_1x: storeConfig.card_fee_1x,
            card_fee_2x: storeConfig.card_fee_2x,
            delivery_enabled: storeConfig.delivery_enabled,
            delivery_disabled_reason: storeConfig.delivery_disabled_reason,
            prep_time_min: storeConfig.prep_time_min || 0,
            prep_time_max: storeConfig.prep_time_max || 0,
            delivery_time_min: storeConfig.delivery_time_min || 0,
            delivery_time_max: storeConfig.delivery_time_max || 0,
            updated_at: new Date().toISOString()
          });

        if (error) throw error;
        console.log('Configura√ß√µes salvas no Supabase');
        return true;
      } catch (error) {
        console.error('Erro ao salvar configura√ß√µes no Supabase (salvo localmente):', error);
        return true; // Return true because localStorage save succeeded
      }
    }

    async function loadBusinessHours() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_business_hours')
          .select('*')
          .order('day_of_week', { ascending: true });

        if (error) throw error;
        if (data && data.length > 0) {
          businessHours = data;
        } else {
          // Use defaults
          businessHours = [
            { day_of_week: 0, day_name: 'Domingo', is_open: false, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 1, day_name: 'Segunda', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 2, day_name: 'Ter√ßa', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 3, day_name: 'Quarta', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 4, day_name: 'Quinta', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 5, day_name: 'Sexta', is_open: true, open_time: '14:00', close_time: '19:30' },
            { day_of_week: 6, day_name: 'S√°bado', is_open: true, open_time: '14:00', close_time: '18:00' }
          ];
        }
      } catch (error) {
        console.log('Using default business hours:', error.message);
        businessHours = [
          { day_of_week: 0, day_name: 'Domingo', is_open: false, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 1, day_name: 'Segunda', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 2, day_name: 'Ter√ßa', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 3, day_name: 'Quarta', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 4, day_name: 'Quinta', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 5, day_name: 'Sexta', is_open: true, open_time: '14:00', close_time: '19:30' },
          { day_of_week: 6, day_name: 'S√°bado', is_open: true, open_time: '14:00', close_time: '18:00' }
        ];
      }
      renderBusinessHoursAdmin();
    }

    function renderBusinessHoursAdmin() {
      const container = document.getElementById('businessHoursContainer');
      if (!container) return;

      container.innerHTML = businessHours.map(day => `
        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg flex-wrap">
          <label class="flex items-center min-w-[100px]">
            <input type="checkbox" class="mr-2 w-4 h-4" 
              data-day="${day.day_of_week}" 
              ${day.is_open ? 'checked' : ''}
              onchange="toggleDayOpen(${day.day_of_week}, this.checked)">
            <span class="text-sm font-medium ${day.is_open ? 'text-gray-800' : 'text-gray-400'}">${day.day_name}</span>
          </label>
          <div class="flex items-center gap-1 ${day.is_open ? '' : 'opacity-40'}">
            <input type="time" id="open_${day.day_of_week}" value="${day.open_time}" 
              class="px-2 py-1 border rounded text-sm w-24" ${day.is_open ? '' : 'disabled'}>
            <span class="text-gray-500">√†s</span>
            <input type="time" id="close_${day.day_of_week}" value="${day.close_time}" 
              class="px-2 py-1 border rounded text-sm w-24" ${day.is_open ? '' : 'disabled'}>
          </div>
        </div>
      `).join('');
    }

    function toggleDayOpen(dayOfWeek, isOpen) {
      const day = businessHours.find(d => d.day_of_week === dayOfWeek);
      if (day) {
        day.is_open = isOpen;
        renderBusinessHoursAdmin();
      }
    }

    async function saveBusinessHours() {
      try {
        // Read values from UI
        businessHours.forEach(day => {
          const openInput = document.getElementById(`open_${day.day_of_week}`);
          const closeInput = document.getElementById(`close_${day.day_of_week}`);
          if (openInput) day.open_time = openInput.value;
          if (closeInput) day.close_time = closeInput.value;
        });

        // Save to Supabase
        for (const day of businessHours) {
          const { error } = await window.supabaseClient
            .from('fast_business_hours')
            .upsert({
              day_of_week: day.day_of_week,
              day_name: day.day_name,
              is_open: day.is_open,
              open_time: day.open_time,
              close_time: day.close_time
            }, { onConflict: 'day_of_week' });

          if (error) throw error;
        }
        return true;
      } catch (error) {
        console.error('Erro ao salvar hor√°rios:', error);
        return false;
      }
    }

    // Promotion Management Functions (Supabase-synced)
    async function loadPromotions() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_promotions')
          .select('*')
          .eq('active', true);

        if (error) throw error;

        // Map database fields to app format
        promotions = (data || []).map(p => ({
          id: p.id,
          productId: p.product_id,
          productName: p.product_name,
          type: p.discount_type,
          value: parseFloat(p.value),
          description: p.description
        }));
        console.log('Promo√ß√µes carregadas do Supabase:', promotions.length);
      } catch (e) {
        console.warn('Erro ao carregar promo√ß√µes do Supabase, usando localStorage:', e);
        const saved = localStorage.getItem('fastPromotions');
        if (saved) { promotions = JSON.parse(saved); }
        else { promotions = []; }
      }

      // Load client discounts from Supabase (sync across devices)
      try {
        const loadedDiscounts = await ClientDiscountsService.load();
        if (loadedDiscounts && Object.keys(loadedDiscounts).length > 0) {
          clientDiscounts = loadedDiscounts;
          saveClientDiscounts(); // Update localStorage as fallback
        } else {
          // Fallback to localStorage
          const discountsSaved = localStorage.getItem('fastClientDiscounts');
          if (discountsSaved) { clientDiscounts = JSON.parse(discountsSaved); }
          else { clientDiscounts = {}; }
        }
      } catch (e) {
        console.warn('[ClientDiscounts] Erro ao carregar do Supabase:', e);
        const discountsSaved = localStorage.getItem('fastClientDiscounts');
        if (discountsSaved) { clientDiscounts = JSON.parse(discountsSaved); }
        else { clientDiscounts = {}; saveClientDiscounts(); }
      }
    }

    async function savePromotions() {
      // Keep localStorage as fallback
      localStorage.setItem('fastPromotions', JSON.stringify(promotions));

      // Sync to Supabase (will be implemented when called)
      console.log('Promo√ß√µes salvas localmente. Ser√£o sincronizadas ao adicionar/remover.');
    }

    async function addPromotionToSupabase(promo) {
      try {
        // First, delete any existing promotion for this product
        await window.supabaseClient
          .from('fast_promotions')
          .delete()
          .eq('product_id', promo.productId);

        // Then insert the new promotion
        const { data, error } = await window.supabaseClient
          .from('fast_promotions')
          .insert({
            product_id: promo.productId,
            product_name: promo.productName,
            discount_type: promo.type,
            value: promo.value,
            description: promo.description,
            active: true
          })
          .select()
          .single();

        if (error) throw error;
        return data;
      } catch (e) {
        console.error('Erro ao salvar promo√ß√£o no Supabase:', e);
        return null;
      }
    }

    async function deletePromotionFromSupabase(productId) {
      try {
        const { error } = await window.supabaseClient
          .from('fast_promotions')
          .delete()
          .eq('product_id', productId);

        if (error) throw error;
        return true;
      } catch (e) {
        console.error('Erro ao remover promo√ß√£o do Supabase:', e);
        return false;
      }
    }

    function saveClientDiscounts() { localStorage.setItem('fastClientDiscounts', JSON.stringify(clientDiscounts)); }
    function renderPromotions() {
      const box = document.getElementById('promotionsList'); if (!box) return;
      box.innerHTML = promotions.length ? promotions.map((p, i) => `
        <div class='p-3 border rounded-lg'>
          <div class='flex justify-between items-start'>
            <div>
              <p class='font-medium text-gray-800'>${p.productName}</p>
              <p class='text-sm text-gray-600'>${p.description}</p>
              <p class='text-sm font-semibold text-green-600'>
                ${p.type === 'percentage' ? p.value + '%' : 'R$ ' + p.value.toFixed(2)} de desconto
              </p>
            </div>
            <button class='px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-sm' onclick='deletePromotion(${i})'>Remover</button>
          </div>
        </div>`).join('') : '<p class="text-gray-500 text-sm">Nenhuma promo√ß√£o ativa.</p>';

      // Also render client discounts
      renderClientDiscounts();
    }

    function renderClientDiscounts() {
      const box = document.getElementById('clientDiscountsList');
      if (!box) return;

      const discountEntries = Object.entries(clientDiscounts).filter(([phone, discount]) => discount > 0);

      if (discountEntries.length === 0) {
        box.innerHTML = '<p class="text-sm text-gray-500">Nenhum desconto ativo</p>';
        return;
      }

      box.innerHTML = discountEntries.map(([phone, discount]) => {
        // Find client name
        const client = clients.find(c => c.phone === phone || c.phone?.replace(/\D/g, '') === phone.replace(/\D/g, ''));
        const clientName = client ? client.name : phone;

        return `
          <div class='p-3 border rounded-lg bg-blue-50'>
            <div class='flex justify-between items-center'>
              <div>
                <p class='font-medium text-gray-800'>${clientName}</p>
                <p class='text-xs text-gray-500'>${phone}</p>
                <p class='text-sm font-semibold text-blue-600'>${discount}% de desconto</p>
              </div>
              <div class='flex gap-1'>
                <button class='px-2 py-1 rounded bg-yellow-500 hover:bg-yellow-600 text-white text-xs' onclick='editClientDiscount("${phone}", ${discount})'>Editar</button>
                <button class='px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs' onclick='removeClientDiscount("${phone}")'>Remover</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function editClientDiscount(phone, currentDiscount) {
      // Populate the form with current values for editing
      const select = document.getElementById('clientDiscountSelect');
      const input = document.getElementById('clientDiscountValue');
      if (select) select.value = phone;
      if (input) input.value = currentDiscount;
      // Scroll to form
      document.getElementById('clientDiscountSelect')?.scrollIntoView({ behavior: 'smooth' });
    }

    async function removeClientDiscount(phone) {
      if (confirm('Remover desconto deste cliente?')) {
        delete clientDiscounts[phone];
        saveClientDiscounts();
        await ClientDiscountsService.save(phone, 0);
        renderClientDiscounts();
        showInlineMessage('promotionsPanelFast', '‚úÖ Desconto removido!', 'success');
      }
    }
    async function deletePromotion(i) {
      if (confirm('Remover esta promo√ß√£o?')) {
        const promo = promotions[i];
        promotions.splice(i, 1);
        savePromotions();
        renderPromotions();
        updatePromotionProductSelect();
        loadProductsPublic(); // Refresh public store

        // Sync to Supabase
        if (promo && promo.productId) {
          await deletePromotionFromSupabase(promo.productId);
        }
      }
    }
    function updatePromotionProductSelect() {
      const select = document.getElementById('promotionProduct'); if (!select) return;
      select.innerHTML = '<option value="">Escolha um produto...</option>' +
        products.filter(p => p.visible !== false).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    function updateClientDiscountSelect() {
      const select = document.getElementById('clientDiscountSelect'); if (!select) return;
      select.innerHTML = '<option value="">Escolha um cliente...</option>' +
        clients.map(c => `<option value="${c.phone}">${c.name} - ${c.phone}</option>`).join('');
    }
    document.getElementById('savePromotion')?.addEventListener('click', async () => {
      const productId = parseInt(document.getElementById('promotionProduct').value);
      const type = document.getElementById('promotionType').value;
      const value = parseFloat(document.getElementById('promotionValue').value);
      const description = document.getElementById('promotionDescription').value.trim();

      if (!productId || !value || !description) {
        showInlineMessage('promotionsPanelFast', '‚ö†Ô∏è Preencha todos os campos da promo√ß√£o.', 'error');
        return;
      }

      const product = products.find(p => p.id === productId);
      if (!product) return;

      // Remove existing promotion for this product (local and Supabase)
      promotions = promotions.filter(p => p.productId !== productId);
      await deletePromotionFromSupabase(productId);

      const newPromo = {
        productId,
        productName: product.name,
        type,
        value,
        description
      };

      promotions.push(newPromo);
      savePromotions();

      // Sync to Supabase
      const saved = await addPromotionToSupabase(newPromo);
      if (saved) {
        showInlineMessage('promotionsPanelFast', '‚úÖ Promo√ß√£o salva e sincronizada!', 'success');
      } else {
        showInlineMessage('promotionsPanelFast', '‚ö†Ô∏è Promo√ß√£o salva localmente. Erro ao sincronizar.', 'error');
      }

      renderPromotions();
      loadProductsPublic(); // Refresh public store with new promotion

      // Reset form
      document.getElementById('promotionProduct').value = '';
      document.getElementById('promotionValue').value = '';
      document.getElementById('promotionDescription').value = '';
    });
    document.getElementById('saveClientDiscount')?.addEventListener('click', async () => {
      const phone = document.getElementById('clientDiscountSelect').value;
      const discount = parseFloat(document.getElementById('clientDiscountValue').value) || 0;

      if (!phone) {
        showInlineMessage('promotionsPanelFast', '‚ö†Ô∏è Selecione um cliente.', 'error');
        return;
      }

      if (discount < 0 || discount > 100) {
        showInlineMessage('promotionsPanelFast', '‚ö†Ô∏è Desconto deve estar entre 0% e 100%.', 'error');
        return;
      }

      if (discount > 0) {
        clientDiscounts[phone] = discount;
      } else {
        delete clientDiscounts[phone];
      }

      saveClientDiscounts();
      // Also sync to Supabase for cross-device access
      await ClientDiscountsService.save(phone, discount);
      renderClients();
      showInlineMessage('promotionsPanelFast', '‚úÖ Desconto salvo com sucesso!', 'success');

      document.getElementById('clientDiscountValue').value = '';
    });
    document.getElementById('clientSearch')?.addEventListener('input', (e) => {
      renderClients(e.target.value);
    });

    // Filtros de clientes - inicial do nome
    document.getElementById('filterNameInitial')?.addEventListener('change', (e) => {
      currentNameInitial = e.target.value;
      const searchTerm = document.getElementById('clientSearch')?.value || '';
      renderClients(searchTerm);
    });

    // Filtros de clientes - m√™s de anivers√°rio
    document.getElementById('filterBirthMonth')?.addEventListener('change', (e) => {
      currentBirthMonth = e.target.value;
      const searchTerm = document.getElementById('clientSearch')?.value || '';
      renderClients(searchTerm);
    });

    // Limpar filtros de clientes
    document.getElementById('clearClientFilters')?.addEventListener('click', () => {
      currentNameInitial = '';
      currentBirthMonth = '';
      const filterNameInitialSelect = document.getElementById('filterNameInitial');
      const filterBirthMonthSelect = document.getElementById('filterBirthMonth');
      const clientSearchInput = document.getElementById('clientSearch');
      if (filterNameInitialSelect) filterNameInitialSelect.value = '';
      if (filterBirthMonthSelect) filterBirthMonthSelect.value = '';
      if (clientSearchInput) clientSearchInput.value = '';
      renderClients();
    });

    // =================== COUPON MANAGEMENT ===================
    async function loadCoupons() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_coupons')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Map Supabase columns to JS format
        coupons = (data || []).map(c => ({
          id: c.id,
          code: c.code,
          type: c.discount_type,
          value: parseFloat(c.value),
          minOrder: parseFloat(c.min_order) || 0,
          maxValue: c.max_discount_value ? parseFloat(c.max_discount_value) : null,
          maxUsage: c.max_usage_count,
          currentUsage: c.current_usage_count || 0,
          currentTotal: parseFloat(c.current_discount_total) || 0,
          expiry: c.expiry_date,
          active: c.active !== false
        }));

        // Sync to localStorage
        localStorage.setItem('fastCoupons', JSON.stringify(coupons));
      } catch (error) {
        console.error('Erro ao carregar cupons do Supabase:', error);
        // Fallback to localStorage
        const saved = localStorage.getItem('fastCoupons');
        if (saved) { coupons = JSON.parse(saved); }
        else { coupons = []; }
      }
    }

    async function saveCoupons() {
      // Always save to localStorage first
      localStorage.setItem('fastCoupons', JSON.stringify(coupons));

      // Sync to Supabase
      try {
        for (const c of coupons) {
          const couponData = {
            code: c.code,
            discount_type: c.type,
            value: c.value,
            min_order: c.minOrder || 0,
            max_discount_value: c.maxValue || null,
            max_usage_count: c.maxUsage || null,
            current_usage_count: c.currentUsage || 0,
            current_discount_total: c.currentTotal || 0,
            expiry_date: c.expiry || null,
            active: c.active !== false
          };

          if (c.id) {
            // Update existing
            await window.supabaseClient
              .from('fast_coupons')
              .update(couponData)
              .eq('id', c.id);
          } else {
            // Insert new
            const { data } = await window.supabaseClient
              .from('fast_coupons')
              .insert([couponData])
              .select();
            if (data && data[0]) {
              c.id = data[0].id;
            }
          }
        }
      } catch (error) {
        console.error('Erro ao salvar cupons no Supabase:', error);
      }
    }

    async function deleteCouponFromSupabase(couponId) {
      if (!couponId) return;
      try {
        await window.supabaseClient
          .from('fast_coupons')
          .delete()
          .eq('id', couponId);
      } catch (error) {
        console.error('Erro ao excluir cupom do Supabase:', error);
      }
    }

    function isCouponExhausted(c) {
      // Check if exhausted by usage count
      if (c.maxUsage && c.currentUsage >= c.maxUsage) return true;
      // Check if exhausted by total discount value
      if (c.maxValue && c.currentTotal >= c.maxValue) return true;
      return false;
    }

    function isCouponExpired(c) {
      if (!c.expiry) return false;
      const today = formatYYYYMMDD(getBrasiliaDate());
      return c.expiry < today;
    }

    function renderCoupons() {
      const activeBox = document.getElementById('couponsList');
      const inactiveBox = document.getElementById('inactiveCouponsList');
      if (!activeBox) return;

      // Separate active and inactive coupons
      const activeCoupons = coupons.filter(c => c.active !== false && !isCouponExhausted(c) && !isCouponExpired(c));
      const inactiveCoupons = coupons.filter(c => c.active === false || isCouponExhausted(c) || isCouponExpired(c));

      // Render active coupons
      activeBox.innerHTML = activeCoupons.length ? activeCoupons.map((c, i) => {
        const originalIndex = coupons.indexOf(c);
        const usageInfo = c.maxUsage ? `${c.currentUsage || 0}/${c.maxUsage} usos` : '';
        const valueInfo = c.maxValue ? `R$ ${(c.currentTotal || 0).toFixed(2)}/${c.maxValue.toFixed(2)}` : '';
        const limitsInfo = [usageInfo, valueInfo].filter(x => x).join(' ‚Ä¢ ');
        return `
        <div class='p-3 border rounded-lg bg-gradient-to-r from-purple-50 to-pink-50'>
          <div class='flex justify-between items-start'>
            <div>
              <p class='font-bold text-purple-700 text-lg'>${c.code}</p>
              <p class='text-sm text-gray-600'>
                ${c.type === 'percentage' ? c.value + '%' : 'R$ ' + c.value.toFixed(2).replace('.', ',')} de desconto
              </p>
              ${c.minOrder > 0 ? `<p class='text-xs text-gray-500'>M√≠nimo: R$ ${c.minOrder.toFixed(2).replace('.', ',')}</p>` : ''}
              ${c.expiry ? `<p class='text-xs text-gray-500'>V√°lido at√©: ${safeDate(c.expiry).toLocaleDateString('pt-BR')}</p>` : ''}
              ${limitsInfo ? `<p class='text-xs text-blue-600'>${limitsInfo}</p>` : ''}
            </div>
            <div class='flex flex-col gap-1'>
              <button class='px-2 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs' onclick='editCoupon(${originalIndex})'>Editar</button>
              <button class='px-2 py-1 rounded bg-orange-500 hover:bg-orange-600 text-white text-xs' onclick='inactivateCoupon(${originalIndex})'>Inativar</button>
            </div>
          </div>
        </div>`}).join('') : '<p class="text-gray-500 text-sm">Nenhum cupom ativo.</p>';

      // Render inactive coupons
      if (inactiveBox) {
        inactiveBox.innerHTML = inactiveCoupons.length ? inactiveCoupons.map((c) => {
          const originalIndex = coupons.indexOf(c);
          const reason = isCouponExhausted(c) ? '(Esgotado)' : isCouponExpired(c) ? '(Vencido)' : '(Inativo)';
          return `
          <div class='p-2 border rounded-lg bg-gray-100 opacity-70'>
            <div class='flex justify-between items-center'>
              <div>
                <span class='font-medium text-gray-600'>${c.code}</span>
                <span class='text-xs text-red-500 ml-2'>${reason}</span>
              </div>
              <button class='px-2 py-1 rounded bg-green-500 hover:bg-green-600 text-white text-xs' onclick='reactivateCoupon(${originalIndex})'>Reativar</button>
            </div>
          </div>`}).join('') : '<p class="text-gray-400 text-xs">Nenhum cupom inativo.</p>';
      }
    }

    function editCoupon(i) {
      const c = coupons[i];
      document.getElementById('editingCouponId').value = i;
      document.getElementById('couponCode').value = c.code;
      document.getElementById('couponType').value = c.type;
      document.getElementById('couponValue').value = c.value;
      document.getElementById('couponMinOrder').value = c.minOrder || '';
      document.getElementById('couponExpiry').value = c.expiry || '';
      document.getElementById('couponMaxValue').value = c.maxValue || '';
      document.getElementById('couponMaxUsage').value = c.maxUsage || '';
      document.getElementById('couponCode').disabled = true; // Can't change code
      document.getElementById('saveCoupon').textContent = 'Salvar Altera√ß√µes';
      document.getElementById('cancelEditCoupon').classList.remove('hidden');
    }

    function cancelEditCoupon() {
      document.getElementById('editingCouponId').value = '';
      document.getElementById('couponCode').disabled = false;
      document.getElementById('saveCoupon').textContent = 'Criar Cupom';
      document.getElementById('cancelEditCoupon').classList.add('hidden');
      resetCouponForm();
    }

    function resetCouponForm() {
      document.getElementById('couponCode').value = '';
      document.getElementById('couponValue').value = '';
      document.getElementById('couponMinOrder').value = '';
      document.getElementById('couponExpiry').value = '';
      document.getElementById('couponMaxValue').value = '';
      document.getElementById('couponMaxUsage').value = '';
    }

    function inactivateCoupon(i) {
      coupons[i].active = false;
      saveCoupons();
      renderCoupons();
      showInlineMessage('couponsList', 'üî¥ Cupom inativado!', 'success');
    }

    function reactivateCoupon(i) {
      coupons[i].active = true;
      // Reset usage if reactivating
      coupons[i].currentUsage = 0;
      coupons[i].currentTotal = 0;
      saveCoupons();
      renderCoupons();
      showInlineMessage('couponsList', 'üü¢ Cupom reativado!', 'success');
    }

    document.getElementById('cancelEditCoupon')?.addEventListener('click', cancelEditCoupon);

    document.getElementById('saveCoupon')?.addEventListener('click', () => {
      const editingId = document.getElementById('editingCouponId').value;
      const code = document.getElementById('couponCode').value.trim().toUpperCase();
      const type = document.getElementById('couponType').value;
      const value = parseFloat(document.getElementById('couponValue').value) || 0;
      const minOrder = parseFloat(document.getElementById('couponMinOrder').value) || 0;
      const expiry = document.getElementById('couponExpiry').value;
      const maxValue = parseFloat(document.getElementById('couponMaxValue').value) || null;
      const maxUsage = parseInt(document.getElementById('couponMaxUsage').value) || null;

      if (!code || value <= 0) {
        showInlineMessage('couponsList', '‚ùå Preencha c√≥digo e valor do cupom.', 'error');
        return;
      }

      if (editingId !== '') {
        // Editing existing coupon
        const i = parseInt(editingId);
        coupons[i].type = type;
        coupons[i].value = value;
        coupons[i].minOrder = minOrder;
        coupons[i].expiry = expiry;
        coupons[i].maxValue = maxValue;
        coupons[i].maxUsage = maxUsage;
        saveCoupons();
        renderCoupons();
        showInlineMessage('couponsList', '‚úÖ Cupom atualizado!', 'success');
        cancelEditCoupon();
      } else {
        // Creating new coupon
        if (coupons.some(c => c.code === code)) {
          showInlineMessage('couponsList', '‚ùå Este c√≥digo de cupom j√° existe!', 'error');
          return;
        }
        coupons.push({
          code, type, value, minOrder, expiry, maxValue, maxUsage,
          currentUsage: 0, currentTotal: 0, active: true,
          createdAt: new Date().toISOString()
        });
        saveCoupons();
        renderCoupons();
        showInlineMessage('couponsList', '‚úÖ Cupom criado com sucesso!', 'success');
        resetCouponForm();
      }
    });
    document.addEventListener('submit', (e) => {
      if (e.target && e.target.id === 'userForm') {
        e.preventDefault();
        const username = document.getElementById('userName').value.trim();
        const password = document.getElementById('userPass').value;
        const role = document.getElementById('userRole').value;
        if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) { alert('Usu√°rio j√° existe.'); return; }
        users.push({ username, password, role }); saveUsers(); renderUsers(); e.target.reset();
      }
    });

    document.getElementById('loginForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const u = document.getElementById('loginUser').value.trim().toLowerCase();
      const p = document.getElementById('loginPass').value;
      const rememberUser = document.getElementById('rememberUser').checked;
      const loginError = document.getElementById('loginError');

      // Hide previous error
      loginError.classList.add('hidden');

      const found = users.find(x => x.username.toLowerCase() === u && x.password === p);
      if (found) {
        // Save username if checkbox is checked
        if (rememberUser) {
          localStorage.setItem('fastRememberedUser', u);
        } else {
          localStorage.removeItem('fastRememberedUser');
        }
        isAdmin = true;
        sessionStorage.setItem('fastAdmin', '1');
        sessionStorage.setItem('fastRole', found.role);
        currentUserRole = found.role;
        showAdminPanel();
      } else {
        // Show inline error instead of alert
        loginError.textContent = '‚ùå Login ou senha incorretos!';
        loginError.classList.remove('hidden');
      }
    });
    document.getElementById('goToPublic')?.addEventListener('click', () => showPublicStore());
    document.getElementById('goToStore')?.addEventListener('click', () => showPublicStore());
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    if (adminLoginBtn) { adminLoginBtn.addEventListener('click', () => showLoginModal()); }
    document.getElementById('logoutBtn')?.addEventListener('click', () => { isAdmin = false; sessionStorage.removeItem('fastAdmin'); sessionStorage.removeItem('fastRole'); showLoginModal(); });

    function hideAllAdminPanels() {
      // Esconde todos os pain√©is do admin
      ['adminPanel', 'productsPanelFast', 'configPanelFast', 'clientsPanelFast',
        'promotionsPanelFast', 'reportsPanelFast', 'ordersPanelFast', 'ratingsPanelFast', 'bannerPanelFast'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add('hidden');
        });
    }

    function showLoginModal() {
      hideAllAdminPanels();
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('publicStore').classList.add('hidden');

      // Esconder carrinho na tela de login
      document.getElementById('cartBtn')?.classList.add('hidden');
      document.getElementById('cartBtnDesktop')?.classList.add('hidden');
      const floatingBtn = document.getElementById('floatingCartButton');
      if (floatingBtn) {
        floatingBtn.classList.add('hidden');
        floatingBtn.style.display = 'none';
      }
      document.getElementById('cartModal')?.classList.add('hidden');

      const f = document.getElementById('loginForm'); if (f) { f.reset(); }
      const loginError = document.getElementById('loginError');
      if (loginError) loginError.classList.add('hidden');
      // Restore remembered username
      const rememberedUser = localStorage.getItem('fastRememberedUser');
      if (rememberedUser) {
        document.getElementById('loginUser').value = rememberedUser;
        document.getElementById('rememberUser').checked = true;
      }
    }
    function showAdminPanel() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('publicStore').classList.add('hidden');

      // Esconder carrinho no painel admin
      document.getElementById('cartBtn')?.classList.add('hidden');
      document.getElementById('cartBtnDesktop')?.classList.add('hidden');
      document.getElementById('floatingCartButton')?.classList.add('hidden');
      document.getElementById('cartModal')?.classList.add('hidden');

      const role = currentUserRole || sessionStorage.getItem('fastRole') || 'admin';
      // Bloquear apenas 'caixa' de acessar admin
      if (role === 'caixa') {
        alert('Sem acesso ao painel administrativo para este perfil.');
        showPublicStore();
        return;
      }
      // Ocultar gest√£o de usu√°rios para n√£o-admin
      const usersCard = document.getElementById('usersList')?.parentElement;
      if (usersCard) usersCard.style.display = (role === 'admin') ? 'block' : 'none';
      loadProductsAdmin();
      renderUsers();

      // Mostrar aba de Pedidos automaticamente ap√≥s login
      showPanel('ordersPanelFast');
      loadDashboardOrders();
    }
    function showPublicStore() {
      hideAllAdminPanels();
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('publicStore').classList.remove('hidden');

      // Mostrar carrinho na loja p√∫blica
      document.getElementById('cartBtn')?.classList.remove('hidden');
      document.getElementById('cartBtnDesktop')?.classList.remove('hidden');

      // For√ßar atualiza√ß√£o e exibi√ß√£o do FAB ao mostrar a loja
      updateCart();

      // Initialize ad banner
      BannerModule.init();

      // Se tem itens no carrinho, mostrar FAB explicitamente
      const floatingBtn = document.getElementById('floatingCartButton');
      if (floatingBtn && cart.length > 0) {
        floatingBtn.classList.remove('hidden');
        floatingBtn.style.display = 'flex';
      }

      // Toggle header buttons
      const isLogged = sessionStorage.getItem('fastAdmin') === '1';
      const role = sessionStorage.getItem('fastRole');
      const backBtn = document.getElementById('backToAdminBtn');
      const enterBtn = document.getElementById('adminLoginBtn');
      const feesBtn = document.getElementById('openFeesFast');
      if (backBtn && enterBtn) {
        if (isLogged && role !== 'caixa') { backBtn.classList.remove('hidden'); enterBtn.classList.add('hidden'); }
        else { backBtn.classList.add('hidden'); enterBtn.classList.remove('hidden'); }
      }
      if (feesBtn) { if (isLogged && role !== 'caixa') { feesBtn.classList.remove('hidden'); } else { feesBtn.classList.add('hidden'); } }
      if (backBtn) { backBtn.onclick = () => showAdminPanel(); }
      updateOpenNotice();
      loadProductsPublic();
    }

    function updateOpenNotice() {
      const el = document.getElementById('openNotice'); if (!el) return;
      const brasilia = getBrasiliaDate();
      const today = brasilia.toDateString();
      const manuallyClosed = localStorage.getItem('fastManuallyClosed');

      // Check if we're within normal operating hours using businessHours
      const d = brasilia.getDay();
      const h = brasilia.getHours();
      const m = brasilia.getMinutes();
      const timeNow = h + m / 60;

      // Determine if we're in normal operating hours using config
      let isNormallyOpen = false;
      const todayHours = businessHours.find(bh => bh.day_of_week === d);
      if (todayHours && todayHours.is_open) {
        const [openH, openM] = (todayHours.open_time || '14:00').split(':').map(Number);
        const [closeH, closeM] = (todayHours.close_time || '18:00').split(':').map(Number);
        const openTime = openH + openM / 60;
        const closeTime = closeH + closeM / 60;
        isNormallyOpen = timeNow >= openTime && timeNow < closeTime;
      }

      // Generate hours display string from config
      const hoursStr = generateHoursDisplayString();

      if (manuallyClosed === today && isNormallyOpen) {
        // Show manual closed message only during normal hours
        el.innerHTML = '<strong class="text-2xl">üö´ FECHADO HOJE</strong><br>Loja fechada manualmente. Voltamos amanh√£!';
        el.className = 'text-base py-3 px-4 rounded-lg my-2 text-red-900 font-semibold text-center';
      } else if (isFastOpen()) {
        el.innerHTML = `<strong class="block text-lg">Aberto</strong><span class="block text-sm">${hoursStr}</span>`;
        el.className = 'text-base py-3 px-4 rounded-lg my-2 bg-green-600/20 text-green-900 font-semibold text-center';
      } else {
        el.innerHTML = '<strong class="text-2xl">‚ö†Ô∏è ESTAMOS FECHADOS</strong><br>Aceitamos encomendas com 1 dia de anteced√™ncia (50% de entrada).';
        el.className = 'text-base py-3 px-4 rounded-lg my-2 text-red-900 font-semibold text-center';
      }
    }

    function generateHoursDisplayString() {
      if (!businessHours || businessHours.length === 0) {
        return 'Seg‚ÄìQui e S√°b 14h‚Äì18h, Sexta 14h‚Äì19h30';
      }

      const openDays = businessHours.filter(d => d.is_open);
      if (openDays.length === 0) return 'Fechado';

      // Group by similar hours
      const groups = [];
      let currentGroup = null;

      openDays.forEach(day => {
        const hours = `${day.open_time.replace(':00', 'h').replace(':', 'h')}‚Äì${day.close_time.replace(':00', 'h').replace(':', 'h')}`;
        if (currentGroup && currentGroup.hours === hours) {
          currentGroup.days.push(day.day_name);
        } else {
          currentGroup = { hours, days: [day.day_name] };
          groups.push(currentGroup);
        }
      });

      return groups.map(g => {
        const dayStr = g.days.length > 2
          ? `${g.days[0].substr(0, 3)}‚Äì${g.days[g.days.length - 1].substr(0, 3)}`
          : g.days.map(d => d.substr(0, 3)).join(', ');
        return `${dayStr} ${g.hours}`;
      }).join(', ');
    }

    // Helper function to get current time in Bras√≠lia timezone (UTC-3)
    // Using manual offset for iOS Safari compatibility (toLocaleString timeZone not supported in older Safari)
    function getBrasiliaDate() {
      const now = new Date();
      // Bras√≠lia is UTC-3 (no daylight saving since 2019)
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const brasiliaOffset = -3 * 60 * 60000; // UTC-3 in milliseconds
      const brasiliaDate = new Date(utc + brasiliaOffset);
      return brasiliaDate;
    }

    function formatYYYYMMDD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function getMinEncomendaDateYYYYMMDD() {
      const brasilia = getBrasiliaDate();
      const mins = brasilia.getHours() * 60 + brasilia.getMinutes();
      const cutoff = 7 * 60;
      const d = new Date(brasilia.getTime());
      if (mins > cutoff) d.setDate(d.getDate() + 1);
      d.setHours(0, 0, 0, 0);
      return formatYYYYMMDD(d);
    }

    function isFastOpen() {
      // Verificar se a loja foi fechada manualmente hoje
      const brasilia = getBrasiliaDate();
      const today = brasilia.toDateString();
      const manuallyClosed = localStorage.getItem('fastManuallyClosed');
      if (manuallyClosed === today) return false;

      const d = brasilia.getDay();
      const h = brasilia.getHours();
      const m = brasilia.getMinutes();
      const timeNow = h + m / 60;

      // Check configurable business hours
      const todayHours = businessHours.find(bh => bh.day_of_week === d);
      if (todayHours) {
        if (!todayHours.is_open) return false;

        // Parse open/close times
        const [openH, openM] = (todayHours.open_time || '14:00').split(':').map(Number);
        const [closeH, closeM] = (todayHours.close_time || '18:00').split(':').map(Number);
        const openTime = openH + openM / 60;
        const closeTime = closeH + closeM / 60;

        return timeNow >= openTime && timeNow < closeTime;
      }

      // Fallback to defaults if no config
      if (d === 0) return false; // domingo fechado
      if (d === 5) return timeNow >= 14 && timeNow < 19.5; // sexta at√© 19h30
      return timeNow >= 14 && timeNow < 18; // seg-qui e s√°b
    }

    /**
     * Verifica se o pedido pode ser realizado no hor√°rio escolhido
     * Entre 07:00 e 14:00, s√≥ libera se:
     * - Houver pelo menos um bolo no carrinho, OU
     * - O total do pedido for >= R$ 30,00
     * 
     * @param {string} timeSlot - Hor√°rio no formato "HH:MM" (ex: "07:30", "14:00")
     * @param {number} cartTotal - Total do carrinho em reais
     * @param {Array} cartItems - Array com os itens do carrinho
     * @returns {Object} { allowed: boolean, reason: string }
     */
    function isOrderAllowedAtTime(timeSlot, cartTotal, cartItems) {
      // Normaliza o hor√°rio para compara√ß√£o (remove ":")
      const normalizedTime = (timeSlot || '').replace(/:/g, '');
      const timeAsNumber = parseInt(normalizedTime, 10) || 0;

      // Fora do per√≠odo restrito (antes das 07:00 ou ap√≥s 14:00), sempre permite
      if (timeAsNumber < 700 || timeAsNumber >= 1400) {
        return { allowed: true, reason: '' };
      }

      // Est√° entre 07:00 e 14:00 - aplicar regras especiais
      const hasCake = cartItems.some(item => {
        // Buscar produto original para obter categoria
        const product = products.find(p => p.id === item.id);
        const productName = (item.name || '').toLowerCase();
        const productCategory = (product?.category || '').toLowerCase();
        // Verifica se √© bolo pela categoria ou pelo nome
        return productCategory === 'bolos' || productName.includes('bolo');
      });

      const meetsMinimumValue = cartTotal >= 30.00;

      if (hasCake || meetsMinimumValue) {
        return { allowed: true, reason: '' };
      }

      // N√£o atende nenhum dos crit√©rios
      return {
        allowed: false,
        reason: 'Entre 7h e 14h, s√≥ aceitamos pedidos de bolos ou pedidos acima de R$ 30,00.'
      };
    }

    /**
     * Gera c√≥digo de pedido no formato FAST-0001
     * @param {string|number} orderIdOrSeq - ID do pedido (timestamp) ou n√∫mero sequencial
     * @returns {string} C√≥digo formatado (ex: "FAST-0001")
     */
    function formatOrderCode(orderIdOrSeq) {
      if (!orderIdOrSeq) return 'FAST-0000';

      // Se j√° √© um c√≥digo FAST-XXXX, retorna como est√°
      if (String(orderIdOrSeq).startsWith('FAST-')) return orderIdOrSeq;

      // Se √© um n√∫mero sequencial pequeno (< 100000), usa diretamente
      const num = parseInt(orderIdOrSeq, 10);
      if (!isNaN(num) && num < 100000) {
        return `FAST-${String(num).padStart(4, '0')}`;
      }

      // Fallback: pega os √∫ltimos 4 d√≠gitos do ID (timestamp)
      const numericId = String(orderIdOrSeq).slice(-4);
      const paddedId = numericId.padStart(4, '0');
      return `FAST-${paddedId}`;
    }

    /**
     * Busca o pr√≥ximo n√∫mero sequencial de pedido do Supabase
     * @returns {Promise<number>} Pr√≥ximo n√∫mero sequencial
     */
    async function getNextOrderSequence() {
      try {
        // Tenta buscar o maior order_sequence existente
        const { data, error } = await window.supabaseClient
          .from('fast_orders')
          .select('order_sequence')
          .not('order_sequence', 'is', null)
          .order('order_sequence', { ascending: false })
          .limit(1);

        if (error) throw error;

        const lastSeq = (data && data.length > 0 && data[0].order_sequence) ? data[0].order_sequence : 0;
        return lastSeq + 1;
      } catch (e) {
        console.warn('[OrderSequence] Erro ao buscar sequ√™ncia, usando fallback:', e);
        // Fallback: usa contagem total de pedidos + 1
        try {
          const { count, error: countError } = await window.supabaseClient
            .from('fast_orders')
            .select('*', { count: 'exact', head: true });

          if (countError) throw countError;
          return (count || 0) + 1;
        } catch (e2) {
          // √öltimo fallback: usa timestamp reduzido
          return Math.floor(Date.now() / 1000) % 10000;
        }
      }
    }

    /**
     * Gera c√≥digo de pedido sequencial formatado (FAST-0001, FAST-0002...)
     * @returns {Promise<{sequence: number, code: string}>}
     */
    async function generateOrderCode() {
      const sequence = await getNextOrderSequence();
      const code = formatOrderCode(sequence);
      return { sequence, code };
    }

    // Using character range instead of \p{Diacritic} for iOS/Safari compatibility
    function norm(s) { return (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, ' ').trim(); }
    function isFastDeliveryAllowed(nei) {
      const n = norm(nei);
      const allowed = ['novo prado', 'sao domingos', 'cristo redentor', 'cidade baixa', 'santo antonio', 'varzea alegre', 'centro'];
      return allowed.includes(n);
    }


    // ========== PRODUCTS - SUPABASE INTEGRATION ==========

    async function loadProducts() {
      try {
        // Tentar carregar do Supabase primeiro
        const { data, error } = await window.supabaseClient
          .from('fast_products')
          .select('*')
          .order('id', { ascending: true });

        if (error) throw error;

        if (data && data.length > 0) {
          // Map snake_case from Supabase to camelCase for local use
          products = data.map(p => ({
            ...p,
            startDate: p.start_date,
            endDate: p.end_date,
            unavailableToday: p.unavailable_today,
            isEncomenda: p.is_encomenda,
            flavor_selection: p.flavor_selection
          }));
          console.log('Produtos carregados do Supabase:', products.length);
        } else {
          // Se n√£o h√° produtos no Supabase, usar defaults e salvar
          await seedDefaultProducts();
        }
      } catch (error) {
        console.error('Erro ao carregar produtos do Supabase:', error);
        // Fallback para localStorage
        const saved = localStorage.getItem('fastProducts');
        if (saved) {
          products = JSON.parse(saved);
          console.log('Produtos carregados do localStorage (fallback)');
        } else {
          await seedDefaultProducts();
        }
      }
      // Sempre manter backup local
      localStorage.setItem('fastProducts', JSON.stringify(products));
    }

    async function seedDefaultProducts() {
      products = [
        { id: 1, name: 'Coxinha de frango', description: 'Tradicional', price: 4.00, category: 'salgados', image: null, emoji: 'ü•ü', visible: true },
        { id: 2, name: 'Enroladinho', description: 'Presunto e queijo', price: 4.00, category: 'salgados', image: null, emoji: 'üå≠', visible: true },
        { id: 3, name: 'Risole de carne', description: 'Recheado de carne', price: 4.50, category: 'salgados', image: null, emoji: 'ü•ü', visible: true },
        { id: 4, name: 'Risole de queijo e presunto', description: 'Cremoso', price: 4.50, category: 'salgados', image: null, emoji: 'ü•ü', visible: true },
        { id: 5, name: 'Mini coxinha', description: 'Bandeja 25 un', price: 15.00, category: 'mini', image: null, emoji: 'ü•ü', visible: true },
        { id: 6, name: 'Quibe', description: 'Bandeja 25 un', price: 18.00, category: 'mini', image: null, emoji: 'ü•ü', visible: true },
        { id: 7, name: 'Enroladinho mini', description: 'Bandeja 25 un', price: 15.00, category: 'mini', image: null, emoji: 'üå≠', visible: true },
        { id: 8, name: 'Bolinho de carne', description: 'Bandeja 25 un', price: 18.00, category: 'mini', image: null, emoji: 'ü•ü', visible: true },
        { id: 9, name: 'Bolinha de queijo', description: 'Bandeja 25 un', price: 18.00, category: 'mini', image: null, emoji: 'üßÄ', visible: true },
        { id: 10, name: 'Pepsi 1L', description: 'Refrigerante', price: 8.00, category: 'bebidas', image: null, emoji: 'ü•§', visible: true },
        { id: 11, name: 'Coca-Cola 1L', description: 'Refrigerante', price: 9.00, category: 'bebidas', image: null, emoji: 'ü•§', visible: true },
        { id: 12, name: 'Coca-Cola lata 350ml', description: 'Lata 350ml', price: 6.00, category: 'bebidas', image: null, emoji: 'ü•§', visible: true },
        { id: 13, name: 'Pepsi lata 350ml', description: 'Lata 350ml', price: 5.50, category: 'bebidas', image: null, emoji: 'ü•§', visible: true },
        { id: 14, name: 'Guaran√° 1L', description: 'Refrigerante', price: 8.00, category: 'bebidas', image: null, emoji: 'ü•§', visible: true },
      ];
      await saveProductsToSupabase();
    }

    async function saveProducts() {
      // Salvar localmente primeiro (r√°pido)
      localStorage.setItem('fastProducts', JSON.stringify(products));
      // Depois sincronizar com Supabase (ass√≠ncrono)
      await saveProductsToSupabase();
    }

    async function saveProductsToSupabase() {
      try {
        // Upsert todos os produtos
        for (const product of products) {
          const { error } = await window.supabaseClient
            .from('fast_products')
            .upsert({
              id: product.id,
              name: product.name,
              description: product.description,
              price: product.price,
              category: product.category,
              image: product.image,
              emoji: product.emoji,
              visible: product.visible,
              start_date: product.startDate || null,
              end_date: product.endDate || null,
              unavailable_today: product.unavailableToday || false,
              promo: product.promo || null,
              is_encomenda: product.isEncomenda || false,
              flavor_selection: product.flavor_selection || null
            }, { onConflict: 'id' });

          if (error) {
            console.error('Erro ao salvar produto:', product.name, error);
          }
        }
        console.log('Produtos sincronizados com Supabase');
      } catch (error) {
        console.error('Erro ao sincronizar produtos com Supabase:', error);
      }
    }

    // ========================================
    // IMAGE COMPRESSION SERVICE
    // ========================================
    async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
      return new Promise((resolve, reject) => {
        // Se n√£o for imagem, retornar o arquivo original
        if (!file.type.startsWith('image/')) {
          resolve(file);
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            // Calcular novas dimens√µes mantendo aspect ratio
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }

            // Criar canvas para redimensionar
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Converter para blob
            canvas.toBlob(
              (blob) => {
                if (blob) {
                  const compressedFile = new File([blob], file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                  });

                  const originalSize = (file.size / 1024).toFixed(1);
                  const newSize = (compressedFile.size / 1024).toFixed(1);
                  console.log(`[ImageCompress] ${originalSize}KB -> ${newSize}KB (${Math.round((1 - compressedFile.size / file.size) * 100)}% redu√ß√£o)`);

                  resolve(compressedFile);
                } else {
                  resolve(file); // Fallback para original
                }
              },
              'image/jpeg',
              quality
            );
          };
          img.onerror = () => resolve(file);
          img.src = e.target.result;
        };
        reader.onerror = () => resolve(file);
        reader.readAsDataURL(file);
      });
    }

    // Upload de imagem para Supabase Storage (com compress√£o)
    async function uploadImageToStorage(file) {
      try {
        // Comprimir imagem antes do upload
        const compressedFile = await compressImage(file, 800, 800, 0.8);

        const fileExt = 'jpg'; // Sempre JPEG ap√≥s compress√£o
        const fileName = `product_${Date.now()}.${fileExt}`;
        const filePath = `products/${fileName}`;

        const { data, error } = await window.supabaseClient.storage
          .from('fast-images')
          .upload(filePath, compressedFile, {
            cacheControl: '3600',
            upsert: false,
            contentType: 'image/jpeg'
          });

        if (error) throw error;

        // Retornar URL p√∫blica da imagem
        const { data: urlData } = window.supabaseClient.storage
          .from('fast-images')
          .getPublicUrl(filePath);

        console.log('Imagem enviada:', urlData.publicUrl);
        return urlData.publicUrl;
      } catch (error) {
        console.error('Erro ao enviar imagem:', error);
        // Fallback: retornar base64 se o upload falhar
        return null;
      }
    }


    document.getElementById('productForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('productName').value.trim();
      const description = document.getElementById('productDescription').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value || '0');
      const category = document.getElementById('productCategory').value;
      const imageFile = document.getElementById('productImage').files[0];


      let imageUrl = null;

      if (imageFile) {
        // Tentar upload para Supabase Storage
        const uploadedUrl = await uploadImageToStorage(imageFile);
        if (uploadedUrl) {
          imageUrl = uploadedUrl;
        } else {
          // N√£o usar base64 para evitar estouro do localStorage
          alert('‚ö†Ô∏è N√£o foi poss√≠vel enviar a imagem. Verifique se o bucket "fast-images" foi criado no Supabase Storage!\n\nO produto ser√° salvo sem imagem.');
          imageUrl = null;
        }
      }

      await saveProduct(name, description, price, category, imageUrl);
    });

    async function saveProduct(name, description, price, category, image) {
      const emojiMap = { salgados: 'ü•ü', mini: 'üßÅ', kits: 'üéÅ', bolos: 'üéÇ', adicionais: '‚ûï', bebidas: 'ü•§' };
      const emoji = emojiMap[category] || 'ü•ü';

      // Campos de disponibilidade
      const startDate = document.getElementById('productStartDate').value || null;
      const endDate = document.getElementById('productEndDate').value || null;
      const unavailableToday = document.getElementById('productUnavailableToday').checked;

      // Campos de promo√ß√£o
      const promoActive = document.getElementById('productPromoActive').checked;
      const promo = {
        active: promoActive,
        type: document.getElementById('productPromoType').value || 'percent',
        value: parseFloat(document.getElementById('productPromoValue').value) || 0
      };

      // Encomenda
      const isEncomenda = document.getElementById('productIsEncomenda').checked;

      // Flavor Selection (Mini-Salgados)
      let flavorSelection = null;
      if (category === 'mini' && document.getElementById('flavorSelectionEnabled')?.checked) {
        const maxFlavors = parseInt(document.getElementById('flavorSelectionMax')?.value) || 3;
        const availableFlavors = Array.from(document.querySelectorAll('.flavor-checkbox:checked'))
          .map(cb => parseInt(cb.value));

        if (availableFlavors.length > 0 && maxFlavors > 0) {
          flavorSelection = {
            enabled: true,
            maxFlavors: Math.min(maxFlavors, availableFlavors.length),
            availableFlavors: availableFlavors
          };
        }
      }

      if (editingProductId) {
        const i = products.findIndex(p => p.id === editingProductId);
        if (i !== -1) {
          products[i] = {
            ...products[i],
            name, description, price, category,
            image: image || products[i].image,
            emoji, startDate, endDate, unavailableToday,
            promo, isEncomenda, flavor_selection: flavorSelection
          };
        }
        editingProductId = null;
      } else {
        products.push({
          id: Date.now(), name, description, price, category,
          image, emoji, visible: true, startDate, endDate, unavailableToday,
          promo, isEncomenda, flavor_selection: flavorSelection
        });
      }

      await saveProducts();
      loadProductsAdmin();
      loadProductsPublic();
      document.getElementById('productForm').reset();
      showInlineMessage('productsPanelFast', '‚úÖ Produto salvo com sucesso!', 'success');
    }
    let adminFilter = 'all';
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('admin-filter')) {
        adminFilter = e.target.getAttribute('data-filter');
        loadProductsAdmin();
      }
    });
    function loadProductsAdmin() {
      const c = document.getElementById('productsList');
      const role = currentUserRole || sessionStorage.getItem('fastRole') || 'admin';
      const filtered = products.filter(p => {
        const isVisible = (p.visible !== false);
        if (adminFilter === 'hidden') return !isVisible;
        if (adminFilter === 'seasonal') return p.startDate && p.endDate;
        if (adminFilter === 'unavailable') return p.unavailableToday;
        if (adminFilter === 'all') return true;
        return p.category === adminFilter;
      });
      c.innerHTML = filtered.map(p => {
        const isVisible = (p.visible !== false);
        // Badges de disponibilidade
        let badges = [];
        if (p.startDate && p.endDate) {
          const start = safeDate(p.startDate).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          const end = safeDate(p.endDate).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          badges.push(`<span class='text-xs bg-blue-100 text-blue-800 px-1 rounded ml-1'>üìÖ ${start}-${end}</span>`);
        }
        if (p.unavailableToday) {
          badges.push(`<span class='text-xs bg-red-100 text-red-800 px-1 rounded ml-1'>‚ùå Indispon√≠vel</span>`);
        }
        const badgesHtml = badges.join('');

        return `<div class='p-3 border rounded-lg ${isVisible ? '' : 'opacity-60'}'>
      <!-- Product Info Row -->
      <div class='flex items-start gap-3 mb-3'>
        ${p.image ? `<img src='${p.image}' class='w-12 h-12 sm:w-14 sm:h-14 object-cover rounded flex-shrink-0'>` : `<span class='text-2xl sm:text-3xl'>${p.emoji}</span>`}
        <div class='flex-1 min-w-0'>
          <h4 class='font-semibold text-gray-800 text-sm truncate'>${p.name}</h4>
          <p class='text-xs text-gray-700 truncate'>${p.description || ''}</p>
          <p class='text-sm font-medium text-gray-900'>R$ ${p.price.toFixed(2).replace('.', ',')}</p>
          <div class='flex flex-wrap items-center gap-1 mt-1'>
            <span class='text-xs fs-chip px-2 py-0.5 rounded'>${p.category}${isVisible ? '' : ' ‚Ä¢ oculto'}</span>
            ${badgesHtml}
          </div>
        </div>
      </div>
      <!-- Action Buttons Row -->
      <div class='grid grid-cols-3 gap-2'>
        ${(role === 'admin' || role === 'gerente') ? `<button class='bg-rose-600 hover:bg-rose-700 text-white px-2 py-2 rounded text-xs' onclick='editProduct(${p.id})'>Editar</button>` : '<div></div>'}
        ${(role === 'admin' || role === 'gerente' || role === 'garcom') ? `<button class='bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-2 rounded text-xs' onclick='toggleVisibility(${p.id})'>${isVisible ? 'Ocultar' : 'Mostrar'}</button>` : '<div></div>'}
        ${(role === 'admin' || role === 'gerente') ? `<button class='bg-red-500 hover:bg-red-600 text-white px-2 py-2 rounded text-xs' onclick='deleteProduct(${p.id})'>Excluir</button>` : '<div></div>'}
      </div>
    </div>`}).join('');
    }
    function toggleVisibility(id) { const i = products.findIndex(p => p.id === id); if (i !== -1) { products[i].visible = !products[i].visible; saveProducts(); loadProductsAdmin(); loadProductsPublic(); } }
    function editProduct(id) {
      const p = products.find(x => x.id === id);
      if (p) {
        document.getElementById('productName').value = p.name;
        document.getElementById('productDescription').value = p.description;
        document.getElementById('productPrice').value = p.price;
        document.getElementById('productCategory').value = p.category;
        // Campos de disponibilidade
        document.getElementById('productStartDate').value = p.startDate || '';
        document.getElementById('productEndDate').value = p.endDate || '';
        document.getElementById('productUnavailableToday').checked = !!p.unavailableToday;
        // Campos de promo√ß√£o
        const promoActive = p.promo?.active || false;
        document.getElementById('productPromoActive').checked = promoActive;
        document.getElementById('productPromoType').value = p.promo?.type || 'percent';
        document.getElementById('productPromoValue').value = p.promo?.value || '';
        document.getElementById('promoDetailsFields').classList.toggle('hidden', !promoActive);
        // Encomenda
        document.getElementById('productIsEncomenda').checked = !!p.isEncomenda;
        editingProductId = id;
        // Scroll to form
        document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // ========================================
    // PRODUCT DELETE - INLINE CONFIRMATION
    // ========================================
    let pendingDeleteProductId = null;

    function deleteProduct(id) {
      const product = products.find(p => p.id === id);
      pendingDeleteProductId = id;
      document.getElementById('deleteProductName').textContent = product?.name || 'este produto';
      document.getElementById('deleteProductModal').classList.remove('hidden');
    }

    function cancelDeleteProduct() {
      pendingDeleteProductId = null;
      document.getElementById('deleteProductModal').classList.add('hidden');
    }

    async function confirmDeleteProduct() {
      if (pendingDeleteProductId) {
        // Delete from Supabase first
        try {
          const { error } = await window.supabaseClient
            .from('fast_products')
            .delete()
            .eq('id', pendingDeleteProductId);

          if (error) {
            console.error('Erro ao excluir produto do Supabase:', error);
          } else {
            console.log('Produto exclu√≠do do Supabase:', pendingDeleteProductId);
          }
        } catch (e) {
          console.error('Erro ao excluir produto:', e);
        }

        // Remove from local array
        products = products.filter(p => p.id !== pendingDeleteProductId);

        // Update localStorage
        localStorage.setItem('fastProducts', JSON.stringify(products));

        // Reload UI
        loadProductsAdmin();
        loadProductsPublic();
      }
      pendingDeleteProductId = null;
      document.getElementById('deleteProductModal').classList.add('hidden');
    }

    // ========================================
    // CUSTOM PRODUCT OPTIONS MODAL (Kits/Bolos)
    // ========================================
    let pendingCustomProduct = null;

    function openCustomOptionsModal(id, name, description, price, category) {
      pendingCustomProduct = { id, name, description, price, category };

      // Set product info
      document.getElementById('customOptionsProductName').textContent = name;
      document.getElementById('customOptionsProductPrice').textContent = `R$ ${price.toFixed(2).replace('.', ',')}`;

      // Configure modal based on category
      if (category === 'kits') {
        document.getElementById('customOptionsTitle').textContent = 'üéâ Personalizar Kit Festa';
        document.getElementById('salgadosSection').classList.remove('hidden');
      } else {
        document.getElementById('customOptionsTitle').textContent = 'üéÇ Personalizar Bolo';
        document.getElementById('salgadosSection').classList.add('hidden');
      }

      // Render dynamic options from ProductOptionsModule
      renderDynamicCakeMassOptions();
      renderDynamicFillingOptions();
      renderDynamicSalgadosOptions();

      // Reset form
      document.getElementById('customOptionsError').classList.add('hidden');
      updateSalgadosCounter();

      document.getElementById('customOptionsModal').classList.remove('hidden');
    }

    function renderDynamicCakeMassOptions() {
      const container = document.querySelector('#cakeMassSection .space-y-2');
      if (!container) return;

      const options = ProductOptionsModule.getVisible('cakeMass');
      if (options.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma op√ß√£o dispon√≠vel</p>';
        return;
      }

      container.innerHTML = options.map(opt => `
        <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
          <input type="radio" name="cakeMass" value="${opt.name}" class="mr-3 text-rose-600">
          <span>${opt.name}</span>
        </label>
      `).join('');
    }

    function renderDynamicFillingOptions() {
      const container = document.querySelector('#fillingSection .space-y-2');
      if (!container) return;

      const options = ProductOptionsModule.getVisible('filling');
      if (options.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma op√ß√£o dispon√≠vel</p>';
        return;
      }

      container.innerHTML = options.map(opt => `
        <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
          <input type="radio" name="filling" value="${opt.name}" class="mr-3 text-rose-600">
          <span>${opt.name}</span>
        </label>
      `).join('');
    }

    function renderDynamicSalgadosOptions() {
      const container = document.querySelector('#salgadosSection .space-y-2');
      if (!container) return;

      const options = ProductOptionsModule.getVisible('salgados');
      if (options.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma op√ß√£o dispon√≠vel</p>';
        return;
      }

      container.innerHTML = options.map(opt => `
        <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
          <input type="checkbox" name="salgados" value="${opt.name}" class="mr-3 text-rose-600 salgado-checkbox">
          <span>${opt.name}</span>
        </label>
      `).join('');
    }

    // ========================================
    // OPTIONS ADMIN UI FUNCTIONS
    // ========================================
    const OptionsAdminUI = {
      currentType: 'cakeMass',
      pendingDeleteId: null,

      init: function () {
        // Tab switching
        document.querySelectorAll('.options-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            this.switchTab(tab.dataset.type);
          });
        });

        // Add new option
        document.getElementById('addNewOptionBtn')?.addEventListener('click', () => this.handleAdd());

        // Initial render
        this.render();
      },

      switchTab: function (type) {
        this.currentType = type;
        // Update tab styles
        document.querySelectorAll('.options-tab').forEach(tab => {
          if (tab.dataset.type === type) {
            tab.classList.remove('bg-gray-200', 'text-gray-700');
            tab.classList.add('bg-rose-600', 'text-white');
          } else {
            tab.classList.remove('bg-rose-600', 'text-white');
            tab.classList.add('bg-gray-200', 'text-gray-700');
          }
        });
        this.render();
      },

      render: function () {
        const container = document.getElementById('optionsListContainer');
        if (!container) return;

        const options = ProductOptionsModule.getAll(this.currentType);

        if (options.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Nenhuma op√ß√£o cadastrada nesta categoria.</p>';
          return;
        }

        container.innerHTML = options.map(opt => `
          <div class="flex items-center justify-between p-3 border rounded-lg ${opt.visible ? 'bg-white' : 'bg-gray-100 opacity-60'}" data-option-id="${opt.id}">
            <div class="flex items-center gap-3 flex-1">
              <span id="optName_${opt.id}" class="${opt.visible ? 'text-gray-800' : 'text-gray-500 line-through'}">${opt.name}</span>
              ${!opt.visible ? '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">Oculto</span>' : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="OptionsAdminUI.showEditForm(${opt.id}, '${opt.name.replace(/'/g, "\\'")}')" class="px-3 py-1 text-sm rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200">
                ‚úèÔ∏è Editar
              </button>
              <button onclick="OptionsAdminUI.toggleVisibility(${opt.id})" class="px-3 py-1 text-sm rounded-lg ${opt.visible ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                ${opt.visible ? 'üëÅÔ∏è Ocultar' : 'üëÅÔ∏è Mostrar'}
              </button>
              <button onclick="OptionsAdminUI.confirmDelete(${opt.id}, '${opt.name.replace(/'/g, "\\'")}')" class="px-3 py-1 text-sm rounded-lg bg-red-100 text-red-700 hover:bg-red-200">
                üóëÔ∏è
              </button>
            </div>
          </div>
          <div id="editForm_${opt.id}" class="hidden p-3 bg-blue-50 border border-blue-200 rounded-lg mt-1">
            <div class="flex gap-2 items-center">
              <input type="text" id="editInput_${opt.id}" value="${opt.name}" class="flex-1 px-3 py-2 border rounded-lg text-sm">
              <button onclick="OptionsAdminUI.saveEdit(${opt.id})" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">Salvar</button>
              <button onclick="OptionsAdminUI.cancelEdit(${opt.id})" class="px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancelar</button>
            </div>
          </div>
          <div id="deleteConfirm_${opt.id}" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg mt-1">
            <p class="text-sm text-red-700 mb-2">‚ö†Ô∏è Excluir "${opt.name}"? Esta op√ß√£o deixar√° de aparecer para clientes.</p>
            <div class="flex gap-2">
              <button onclick="OptionsAdminUI.handleDelete(${opt.id})" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">Confirmar</button>
              <button onclick="OptionsAdminUI.cancelDelete(${opt.id})" class="px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancelar</button>
            </div>
          </div>
        `).join('');
      },

      showMessage: function (text, type) {
        const el = document.getElementById('optionsMessage');
        if (!el) return;
        el.textContent = text;
        el.className = 'mb-4 p-3 rounded-lg text-sm';
        if (type === 'success') el.classList.add('bg-green-100', 'text-green-700');
        else if (type === 'error') el.classList.add('bg-red-100', 'text-red-700');
        else el.classList.add('bg-blue-100', 'text-blue-700');
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 3000);
      },

      handleAdd: async function () {
        const input = document.getElementById('newOptionName');
        const name = input?.value?.trim();
        if (!name) {
          this.showMessage('Digite o nome da op√ß√£o.', 'error');
          return;
        }

        const result = await ProductOptionsModule.add(this.currentType, name);
        if (result.success) {
          input.value = '';
          this.showMessage(`"${name}" adicionado com sucesso!`, 'success');
          this.render();
        } else {
          this.showMessage(`Erro ao adicionar: ${result.error}`, 'error');
        }
      },

      toggleVisibility: async function (id) {
        const result = await ProductOptionsModule.toggleVisibility(id);
        if (result.success) {
          this.showMessage('Visibilidade alterada!', 'success');
          this.render();
        } else {
          this.showMessage(`Erro: ${result.error}`, 'error');
        }
      },

      showEditForm: function (id, currentName) {
        // Hide other edit/delete forms
        document.querySelectorAll('[id^="editForm_"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('[id^="deleteConfirm_"]').forEach(el => el.classList.add('hidden'));
        // Show this edit form
        const form = document.getElementById(`editForm_${id}`);
        if (form) {
          form.classList.remove('hidden');
          const input = document.getElementById(`editInput_${id}`);
          if (input) {
            input.value = currentName;
            input.focus();
          }
        }
      },

      cancelEdit: function (id) {
        const form = document.getElementById(`editForm_${id}`);
        if (form) form.classList.add('hidden');
      },

      saveEdit: async function (id) {
        const input = document.getElementById(`editInput_${id}`);
        const newName = input?.value?.trim();
        if (!newName) {
          this.showMessage('Nome n√£o pode estar vazio.', 'error');
          return;
        }

        const result = await ProductOptionsModule.update(id, { name: newName });
        if (result.success) {
          this.showMessage('Nome atualizado!', 'success');
          this.render();
        } else {
          this.showMessage(`Erro ao atualizar: ${result.error}`, 'error');
        }
      },

      confirmDelete: function (id, name) {
        // Hide any other confirm dialogs
        document.querySelectorAll('[id^="deleteConfirm_"]').forEach(el => el.classList.add('hidden'));
        // Show this one
        const confirmEl = document.getElementById(`deleteConfirm_${id}`);
        if (confirmEl) confirmEl.classList.remove('hidden');
        this.pendingDeleteId = id;
      },

      cancelDelete: function (id) {
        const confirmEl = document.getElementById(`deleteConfirm_${id}`);
        if (confirmEl) confirmEl.classList.add('hidden');
        this.pendingDeleteId = null;
      },

      handleDelete: async function (id) {
        const result = await ProductOptionsModule.delete(id);
        if (result.success) {
          this.showMessage('Op√ß√£o exclu√≠da!', 'success');
          this.render();
        } else {
          this.showMessage(`Erro ao excluir: ${result.error}`, 'error');
        }
        this.pendingDeleteId = null;
      }
    };

    // ========================================
    // FLAVOR SELECTION UI (Product Form)
    // ========================================
    const FlavorSelectionUI = {
      init: function () {
        // Listen for category changes
        document.getElementById('productCategory')?.addEventListener('change', (e) => {
          this.toggleSectionVisibility(e.target.value);
        });

        // Listen for enabled checkbox toggle
        document.getElementById('flavorSelectionEnabled')?.addEventListener('change', (e) => {
          this.toggleDetailsVisibility(e.target.checked);
        });
      },

      toggleSectionVisibility: function (category) {
        const section = document.getElementById('flavorSelectionSection');
        if (!section) return;

        if (category === 'mini') {
          section.classList.remove('hidden');
          this.renderAvailableFlavors();
        } else {
          section.classList.add('hidden');
        }
      },

      toggleDetailsVisibility: function (enabled) {
        const details = document.getElementById('flavorSelectionDetails');
        if (details) {
          details.classList.toggle('hidden', !enabled);
        }
      },

      renderAvailableFlavors: function (selectedIds = []) {
        const container = document.getElementById('flavorSelectionFlavors');
        if (!container) return;

        const flavors = ProductOptionsModule.getVisible('miniSalgadosFlavors');
        if (flavors.length === 0) {
          container.innerHTML = '<p class="text-xs text-gray-500">Nenhum sabor cadastrado. Adicione sabores na se√ß√£o "Op√ß√µes de Personaliza√ß√£o".</p>';
          return;
        }

        container.innerHTML = flavors.map(f => `
          <label class="flex items-center gap-2 cursor-pointer text-sm">
            <input type="checkbox" value="${f.id}" class="flavor-checkbox text-rose-600" ${selectedIds.includes(f.id) ? 'checked' : ''}>
            <span>${f.name}</span>
          </label>
        `).join('');
      },

      loadForProduct: function (product) {
        const section = document.getElementById('flavorSelectionSection');
        const enabledCb = document.getElementById('flavorSelectionEnabled');
        const maxInput = document.getElementById('flavorSelectionMax');

        // Show section only for mini category
        if (product.category === 'mini') {
          section?.classList.remove('hidden');

          if (product.flavor_selection && product.flavor_selection.enabled) {
            enabledCb && (enabledCb.checked = true);
            maxInput && (maxInput.value = product.flavor_selection.maxFlavors || 3);
            this.toggleDetailsVisibility(true);
            this.renderAvailableFlavors(product.flavor_selection.availableFlavors || []);
          } else {
            enabledCb && (enabledCb.checked = false);
            maxInput && (maxInput.value = 3);
            this.toggleDetailsVisibility(false);
            this.renderAvailableFlavors([]);
          }
        } else {
          section?.classList.add('hidden');
        }
      },

      reset: function () {
        document.getElementById('flavorSelectionSection')?.classList.add('hidden');
        document.getElementById('flavorSelectionEnabled') && (document.getElementById('flavorSelectionEnabled').checked = false);
        document.getElementById('flavorSelectionMax') && (document.getElementById('flavorSelectionMax').value = 3);
        this.toggleDetailsVisibility(false);
      }
    };

    // ========================================
    // MINI-SALGADOS MODAL (Public - Flavor Selection)
    // ========================================
    let pendingMiniProduct = null;
    let miniMaxFlavors = 3;

    function openMiniSalgadosModal(product) {
      pendingMiniProduct = product;
      const fs = product.flavor_selection;
      miniMaxFlavors = fs?.maxFlavors || 3;

      // Check for promotion and calculate discounted price
      const promotion = promotions.find(p => p.productId === product.id);
      let displayPrice = product.price;
      if (promotion) {
        if (promotion.type === 'percentage') {
          displayPrice = product.price * (1 - promotion.value / 100);
        } else {
          displayPrice = product.price - promotion.value;
        }
      }
      pendingMiniProduct.displayPrice = displayPrice;

      // Set product info
      document.getElementById('miniProductName').textContent = product.name;
      document.getElementById('miniProductPrice').textContent = `R$ ${displayPrice.toFixed(2).replace('.', ',')}`;
      document.getElementById('miniFlavorLimit').textContent = `(at√© ${miniMaxFlavors})`;
      document.getElementById('miniFlavorCounter').textContent = `Selecionados: 0/${miniMaxFlavors}`;

      // Render available flavors
      const container = document.getElementById('miniFlavorsContainer');
      const allFlavors = ProductOptionsModule.getVisible('miniSalgadosFlavors');
      const availableIds = fs?.availableFlavors || allFlavors.map(f => f.id);

      const flavors = allFlavors.filter(f => availableIds.includes(f.id));

      if (flavors.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Nenhum sabor dispon√≠vel para este produto.</p>';
      } else {
        container.innerHTML = flavors.map(f => `
          <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" name="miniFlavor" value="${f.name}" class="mr-3 text-rose-600 mini-flavor-checkbox">
            <span>${f.name}</span>
          </label>
        `).join('');
      }

      document.getElementById('miniSalgadosError').classList.add('hidden');
      document.getElementById('miniSalgadosModal').classList.remove('hidden');
    }

    function closeMiniSalgadosModal() {
      pendingMiniProduct = null;
      document.getElementById('miniSalgadosModal').classList.add('hidden');
    }

    function updateMiniFlavorCounter() {
      const checked = document.querySelectorAll('.mini-flavor-checkbox:checked').length;
      const counter = document.getElementById('miniFlavorCounter');
      if (counter) {
        counter.textContent = `Selecionados: ${checked}/${miniMaxFlavors}`;
        counter.classList.toggle('text-red-600', checked > miniMaxFlavors);
        counter.classList.toggle('text-rose-600', checked <= miniMaxFlavors);
      }
    }

    // Limit mini-salgados flavor selections
    document.addEventListener('change', function (e) {
      if (e.target.classList.contains('mini-flavor-checkbox')) {
        const checked = document.querySelectorAll('.mini-flavor-checkbox:checked').length;
        if (checked > miniMaxFlavors) {
          e.target.checked = false;
          const errorEl = document.getElementById('miniSalgadosError');
          if (errorEl) {
            errorEl.textContent = `Voc√™ pode escolher no m√°ximo ${miniMaxFlavors} sabores.`;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 3000);
          }
        }
        updateMiniFlavorCounter();
      }
    });

    function confirmMiniSalgados() {
      if (!pendingMiniProduct) return;

      const selectedFlavors = Array.from(document.querySelectorAll('.mini-flavor-checkbox:checked'))
        .map(cb => cb.value);

      const errorEl = document.getElementById('miniSalgadosError');

      if (selectedFlavors.length === 0) {
        errorEl.textContent = 'Selecione pelo menos um sabor.';
        errorEl.classList.remove('hidden');
        return;
      }

      if (selectedFlavors.length > miniMaxFlavors) {
        errorEl.textContent = `Selecione no m√°ximo ${miniMaxFlavors} sabores.`;
        errorEl.classList.remove('hidden');
        return;
      }

      // Build note with selected flavors
      const note = `Sabores: ${selectedFlavors.join(', ')}`;

      // Add to cart
      const existingIndex = cart.findIndex(item =>
        item.id === pendingMiniProduct.id && item.note === note
      );

      if (existingIndex !== -1) {
        cart[existingIndex].quantity++;
      } else {
        cart.push({
          id: pendingMiniProduct.id,
          name: pendingMiniProduct.name,
          description: pendingMiniProduct.description || '',
          price: pendingMiniProduct.displayPrice || pendingMiniProduct.price,
          quantity: 1,
          note: note,
          customOptions: { flavors: selectedFlavors }
        });
      }

      updateCart();
      closeMiniSalgadosModal();
    }

    function closeCustomOptionsModal() {
      pendingCustomProduct = null;
      document.getElementById('customOptionsModal').classList.add('hidden');
    }

    function updateSalgadosCounter() {
      const checked = document.querySelectorAll('.salgado-checkbox:checked').length;
      const counter = document.getElementById('salgadosCounter');
      if (counter) {
        counter.textContent = `Selecionados: ${checked}/4`;
        counter.classList.toggle('text-red-600', checked > 4);
        counter.classList.toggle('text-rose-600', checked <= 4);
      }
    }

    // Limit salgados to 4 selections
    document.addEventListener('change', function (e) {
      if (e.target.classList.contains('salgado-checkbox')) {
        const checked = document.querySelectorAll('.salgado-checkbox:checked').length;
        if (checked > 4) {
          e.target.checked = false;
          const errorEl = document.getElementById('customOptionsError');
          if (errorEl) {
            errorEl.textContent = 'Voc√™ pode escolher no m√°ximo 4 sabores de salgados.';
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 3000);
          }
        }
        updateSalgadosCounter();
      }
    });

    function confirmCustomOptions() {
      if (!pendingCustomProduct) return;

      const { id, name, description, price, category } = pendingCustomProduct;
      const errorEl = document.getElementById('customOptionsError');

      // Validate selections
      const cakeMass = document.querySelector('input[name="cakeMass"]:checked')?.value;
      const filling = document.querySelector('input[name="filling"]:checked')?.value;

      if (!cakeMass) {
        errorEl.textContent = 'Selecione a massa do bolo.';
        errorEl.classList.remove('hidden');
        return;
      }

      if (!filling) {
        errorEl.textContent = 'Selecione o sabor do recheio.';
        errorEl.classList.remove('hidden');
        return;
      }

      // For kits, check salgados
      let salgados = [];
      if (category === 'kits') {
        salgados = Array.from(document.querySelectorAll('.salgado-checkbox:checked')).map(c => c.value);
        if (salgados.length === 0) {
          errorEl.textContent = 'Selecione pelo menos 1 sabor de salgado.';
          errorEl.classList.remove('hidden');
          return;
        }
      }

      // Build customization note
      let customNote = `Massa: ${cakeMass} | Recheio: ${filling}`;
      if (salgados.length > 0) {
        customNote += ` | Salgados: ${salgados.join(', ')}`;
      }

      // Add to cart with customization
      const cartItem = {
        id,
        name,
        description,
        price,
        quantity: 1,
        note: customNote,
        customOptions: {
          cakeMass,
          filling,
          salgados
        }
      };

      // Check if same product with same options exists
      const existing = cart.find(i => i.id === id && i.note === customNote);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push(cartItem);
      }

      updateCart();
      closeCustomOptionsModal();
      // Visual feedback already provided by cart update
    }

    // ========================================
    // PRODUCT AVAILABILITY CHECK (Seasonal + Unavailable)
    // ========================================
    function isProductAvailableToday(product) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Indispon√≠vel hoje (flag manual)
      if (product.unavailableToday) return false;

      // Sazonalidade (per√≠odo definido)
      if (product.startDate && product.endDate) {
        const start = safeDate(product.startDate);
        const end = safeDate(product.endDate);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
        if (today < start || today > end) return false;
      }

      // Visibilidade normal
      if (product.visible === false) return false;

      return true;
    }

    function loadProductsPublic() {
      const map = {
        salgados: document.getElementById('salgadosContainer'),
        mini: document.getElementById('miniContainer'),
        kits: document.getElementById('kitsContainer'),
        bolos: document.getElementById('bolosContainer'),
        adicionais: document.getElementById('adicionaisContainer'),
        bebidas: document.getElementById('bebidasContainer')
      };

      Object.values(map).forEach(el => { if (el) el.innerHTML = ''; });
      products.filter(p => isProductAvailableToday(p)).forEach(product => {
        const isAdditional = product.category === 'adicionais';
        const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
        const heartIcon = isFav ? '‚ù§Ô∏è' : 'ü§ç';

        // Check for promotion from promotions table
        const promotion = promotions.find(p => p.productId === product.id);
        let displayPrice = product.price;
        let priceHtml = '';
        let promoBadge = '';
        let borderClass = '';

        if (promotion) {
          // Apply promotion discount
          if (promotion.type === 'percentage') {
            displayPrice = product.price * (1 - promotion.value / 100);
            promoBadge = `<span class='absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full shadow'>-${promotion.value}%</span>`;
          } else {
            displayPrice = product.price - promotion.value;
            promoBadge = `<span class='absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full shadow'>-R$${promotion.value}</span>`;
          }
          priceHtml = `<span class='line-through text-gray-400 text-sm mr-1'>R$ ${product.price.toFixed(2).replace('.', ',')}</span><span class='text-rose-600 font-bold'>R$ ${displayPrice.toFixed(2).replace('.', ',')}</span>`;
          borderClass = 'border-yellow-400 border-2';
        } else {
          priceHtml = `<span class='text-rose-600 ${isAdditional ? "text-sm" : "text-lg"} font-bold'>R$ ${product.price.toFixed(2).replace('.', ',')}</span>`;
        }

        const html = `<div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border ${borderClass} relative'>
          ${promoBadge}
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='${isAdditional ? "text-2xl" : "text-3xl"} mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800 ${isAdditional ? 'text-sm' : ''}'>${product.name}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1 hover:scale-110 transition-transform' data-id='${product.id}' title='Favorito'>${heartIcon}</button>
          </div>
          <div class='flex items-center justify-between'>
            ${priceHtml}
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' data-id='${product.id}' data-name='${product.name}' data-description='${product.description}' data-price='${displayPrice}' data-category='${product.category}'>Adicionar</button>
          </div>
        </div>`;
        map[product.category].innerHTML += html;
      });
      // Carregar se√ß√£o de favoritos
      loadFavoritosSection();
      // Carregar √∫ltimos pedidos para clientes que retornam
      renderRecentOrders();
      // Carregar promo√ß√µes do dia
      renderPromosSection();
      // Carregar produtos mais pedidos (ass√≠ncrono)
      renderTopProductsSection();
    }

    function loadFavoritosSection() {
      const container = document.getElementById('favoritosContainer');
      if (!container) return;

      const favIds = FavoritesService.getFavorites(currentClientPhone);
      const favProducts = products.filter(p => favIds.includes(p.id) && isProductAvailableToday(p));

      if (favProducts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-2">Voc√™ ainda n√£o marcou nenhum item como favorito. Toque no ü§ç para adicionar!</p>';
        return;
      }

      container.innerHTML = favProducts.map(product => {
        const priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
        return `<div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border border-pink-200'>
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='text-3xl mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800'>${product.name}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1 hover:scale-110 transition-transform' data-id='${product.id}' title='Remover dos favoritos'>‚ù§Ô∏è</button>
          </div>
          <div class='flex items-center justify-between'>
            <span class='text-rose-600 text-lg font-bold'>${priceDisplay}</span>
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' data-id='${product.id}' data-name='${product.name}' data-description='${product.description}' data-price='${product.price}'>Adicionar</button>
          </div>
        </div>`;
      }).join('');
    }

    // Render promotions section in public store
    function renderPromosSection() {
      const section = document.getElementById('promosSection');
      const container = document.getElementById('promosContainer');
      if (!section || !container) return;

      // Filter products with active promotions from the promotions table
      const promoProductIds = promotions.map(p => p.productId);
      const promoProducts = products.filter(p =>
        promoProductIds.includes(p.id) &&
        isProductAvailableToday(p) &&
        p.visible !== false
      );

      if (promoProducts.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');

      container.innerHTML = promoProducts.map(product => {
        const promotion = promotions.find(p => p.productId === product.id);
        const originalPrice = product.price;
        let discountedPrice = originalPrice;
        let discountBadge = '';

        if (promotion) {
          if (promotion.type === 'percentage') {
            discountedPrice = originalPrice * (1 - promotion.value / 100);
            discountBadge = `-${promotion.value}%`;
          } else {
            discountedPrice = originalPrice - promotion.value;
            discountBadge = `-R$${promotion.value.toFixed(0)}`;
          }
        }

        const originalDisplay = `R$ ${originalPrice.toFixed(2).replace('.', ',')}`;
        const discountedDisplay = `R$ ${discountedPrice.toFixed(2).replace('.', ',')}`;
        const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
        const heartIcon = isFav ? '‚ù§Ô∏è' : 'ü§ç';

        return `
          <div class="flex-shrink-0 w-[200px] bg-white rounded-xl shadow-sm border border-yellow-200 p-3 snap-start relative overflow-visible mt-3">
            <div class="absolute -top-3 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow">${discountBadge}</div>
            <div class="flex items-center mb-2">
              ${product.image ? `<img src="${product.image}" class="w-12 h-12 object-cover rounded mr-2">` : `<span class="text-2xl mr-2">${product.emoji}</span>`}
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-800 text-sm truncate">${product.name}</h3>
              </div>
            </div>
            <div class="flex items-center justify-between gap-2">
              <div class="flex flex-col">
                <span class="text-xs text-gray-400 line-through">${originalDisplay}</span>
                <span class="text-rose-600 text-base font-bold">${discountedDisplay}</span>
              </div>
              <button class="add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-2 py-1 rounded-lg text-xs font-medium" 
                data-id="${product.id}" data-name="${product.name}" data-description="${product.description}" data-price="${discountedPrice}">
                +
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Calcular e renderizar produtos mais pedidos
    async function renderTopProductsSection() {
      const section = document.getElementById('topProductsSection');
      const container = document.getElementById('topProductsContainer');
      if (!section || !container) return;

      try {
        // Buscar pedidos dos √∫ltimos 30 dias para calcular ranking
        const now = new Date();
        const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30).toISOString();

        const { data: orders, error } = await window.supabaseClient
          .from('fast_orders')
          .select('items')
          .gte('created_at', startDate)
          .neq('status', 'cancelled');

        if (error) throw error;

        // Contabilizar produtos pedidos
        const productCounts = {};
        (orders || []).forEach(order => {
          (order.items || []).forEach(item => {
            const productId = item.id;
            if (productId) {
              productCounts[productId] = (productCounts[productId] || 0) + (item.quantity || 1);
            }
          });
        });

        // Ordenar por quantidade e pegar top 5
        const topProductIds = Object.entries(productCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 4)
          .map(([id]) => parseInt(id, 10) || id);

        // Buscar dados dos produtos
        const topProducts = topProductIds
          .map(id => products.find(p => p.id === id || p.id === String(id)))
          .filter(p => p && p.visible !== false && isProductAvailableToday(p));

        if (topProducts.length < 3) {
          section.classList.add('hidden');
          return;
        }

        section.classList.remove('hidden');

        container.innerHTML = topProducts.map((product, index) => {
          const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£'];
          const medal = medals[index] || '';
          const priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
          const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
          const heartIcon = isFav ? '‚ù§Ô∏è' : 'ü§ç';

          return `
            <div class="bg-white rounded-xl shadow-sm border border-rose-200 p-3 relative">
              <div class="absolute -top-2 -left-2 text-2xl">${medal}</div>
              <div class="flex items-center mb-2">
                ${product.image ? `<img src="${product.image}" class="w-12 h-12 object-cover rounded mr-2">` : `<span class="text-2xl mr-2">${product.emoji}</span>`}
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-gray-800 text-sm truncate">${product.name}</h3>
                </div>
              </div>
              <div class="flex items-center justify-between gap-2">
                <span class="text-rose-600 text-base font-bold">${priceDisplay}</span>
                <button class="add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-2 py-1 rounded-lg text-xs font-medium" 
                  data-id="${product.id}" data-name="${product.name}" data-description="${product.description}" data-price="${product.price}">
                  +
                </button>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.warn('[TopProducts] Erro ao carregar:', e);
        section.classList.add('hidden');
      }
    }

    function loadFilteredProducts(filter) {
      // Get all category containers
      const categories = ['salgados', 'mini', 'kits', 'bolos', 'bebidas', 'adicionais'];
      const containers = {};
      categories.forEach(cat => {
        const el = document.getElementById(`${cat}Container`);
        if (el) containers[cat] = el;
      });

      // Show all category sections
      document.querySelectorAll('.category-section').forEach(section => {
        if (section.id !== 'favoritos') {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });

      // Clear all containers
      Object.values(containers).forEach(c => c.innerHTML = '');

      // Filter products
      const filtered = products.filter(p => {
        if (!isProductAvailableToday(p)) return false;
        if (filter === 'promo') return p.promo?.active === true;
        if (filter === 'encomenda') return p.isEncomenda === true || p.category === 'kits';
        return true;
      });

      if (filtered.length === 0) {
        Object.values(containers)[0].innerHTML = `<p class='text-gray-500 text-center py-8 col-span-2'>Nenhum produto encontrado para este filtro.</p>`;
        return;
      }

      // Render filtered products
      filtered.forEach(product => {
        const container = containers[product.category];
        if (!container) return;

        const isAdditional = product.category === 'adicionais';
        const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
        const heartIcon = isFav ? '‚ù§Ô∏è' : 'ü§ç';

        // Promo price calculation
        let priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
        let promoBadge = '';

        if (product.promo?.active && product.promo?.value > 0) {
          let finalPrice = product.price;
          if (product.promo.type === 'percent') {
            finalPrice = product.price * (1 - product.promo.value / 100);
            promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded'>-${product.promo.value}%</span>`;
          } else {
            finalPrice = product.price - product.promo.value;
            promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded'>-R$${product.promo.value}</span>`;
          }
          priceDisplay = `<span class='line-through text-gray-400 text-sm'>R$ ${product.price.toFixed(2).replace('.', ',')}</span> <span class='text-rose-600 font-bold'>R$ ${finalPrice.toFixed(2).replace('.', ',')}</span>`;
        }

        const html = `<div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border ${product.promo?.active ? 'border-yellow-400' : ''}'>
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='${isAdditional ? "text-2xl" : "text-3xl"} mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800 ${isAdditional ? 'text-sm' : ''}'>${product.name} ${promoBadge}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1 hover:scale-110 transition-transform' data-id='${product.id}' title='Favorito'>${heartIcon}</button>
          </div>
          <div class='flex items-center justify-between'>
            <span class='${isAdditional ? "text-sm" : "text-lg"}'>${priceDisplay}</span>
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' data-id='${product.id}' data-name='${product.name}' data-description='${product.description}' data-price='${product.price}'>Adicionar</button>
          </div>
        </div>`;
        container.innerHTML += html;
      });
    }

    function createProductCard(product, isAdditional = false) {
      let priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
      let promoBadge = '';
      let cardBorder = '';

      if (product.promo?.active && product.promo?.value > 0) {
        let finalPrice = product.price;
        if (product.promo.type === 'percent') {
          finalPrice = product.price * (1 - product.promo.value / 100);
          promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded ml-2'>-${product.promo.value}%</span>`;
        } else {
          finalPrice = product.price - product.promo.value;
          promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded ml-2'>-R$${product.promo.value}</span>`;
        }
        priceDisplay = `<span class='line-through text-gray-400 text-sm'>R$ ${product.price.toFixed(2).replace('.', ',')}</span> <span class='text-rose-600 font-bold'>R$ ${finalPrice.toFixed(2).replace('.', ',')}</span>`;
        cardBorder = 'border-yellow-400';
      }

      const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
      const heartIcon = isFav ? '‚ù§Ô∏è' : 'ü§ç';

      return `
        <div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border ${cardBorder}'>
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='${isAdditional ? "text-2xl" : "text-3xl"} mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800 ${isAdditional ? 'text-sm' : ''}'>${product.name} ${promoBadge}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1' data-id='${product.id}'>${heartIcon}</button>
          </div>
          <div class='flex items-center justify-between'>
            <span class='text-rose-600 ${isAdditional ? "text-sm" : "text-lg"} font-bold'>${priceDisplay}</span>
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' 
              data-id='${product.id}' 
              data-name='${product.name}' 
              data-description='${product.description}' 
              data-price='${product.price}'>
              Adicionar
            </button>
          </div>
        </div>`;
    }

    // Admin: Toggle promo fields
    document.getElementById('productPromoActive')?.addEventListener('change', (e) => {
      document.getElementById('promoDetailsFields').classList.toggle('hidden', !e.target.checked);
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('category-tab')) {
        const cat = e.target.dataset.category;
        document.querySelectorAll('.category-tab').forEach(t => {
          t.classList.remove('bg-red-600', 'bg-pink-300', 'text-white', 'active');
          t.classList.add('bg-red-300', 'text-red-900');
          // Reset pink tabs
          if (t.dataset.category === 'favoritos') {
            t.classList.remove('bg-red-300', 'text-red-900');
            t.classList.add('bg-pink-200', 'text-pink-900');
          }
        });

        if (cat === 'favoritos') {
          e.target.classList.add('bg-pink-400', 'text-white', 'active');
          e.target.classList.remove('bg-pink-200', 'text-pink-900');
        } else {
          e.target.classList.add('bg-red-600', 'text-white', 'active');
          e.target.classList.remove('bg-red-300', 'text-red-900');
        }

        // Show/hide sections based on category
        document.querySelectorAll('.category-section').forEach(section => {
          if (cat === 'favoritos') {
            // Favoritos: mostrar s√≥ essa se√ß√£o
            section.classList.toggle('hidden', section.id !== 'favoritos');
          } else {
            // Outras categorias: esconder favoritos
            if (section.id === 'favoritos') {
              section.classList.add('hidden');
            } else {
              section.classList.remove('hidden');
            }
          }
        });

        // Scroll to section smoothly
        const section = document.getElementById(cat);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Filter tabs (promo/encomenda)
      if (e.target.classList.contains('filter-tab')) {
        const filter = e.target.dataset.filter;
        if (!filter) return;

        // Toggle active state
        const wasActive = e.target.classList.contains('active');
        document.querySelectorAll('.filter-tab').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.filter === 'promo') {
            btn.classList.remove('bg-yellow-500', 'text-white');
            btn.classList.add('bg-yellow-200', 'text-yellow-900');
          } else {
            btn.classList.remove('bg-purple-500', 'text-white');
            btn.classList.add('bg-purple-200', 'text-purple-900');
          }
        });

        if (!wasActive) {
          e.target.classList.add('active');
          if (filter === 'promo') {
            e.target.classList.add('bg-yellow-500', 'text-white');
            e.target.classList.remove('bg-yellow-200', 'text-yellow-900');
          } else {
            e.target.classList.add('bg-purple-500', 'text-white');
            e.target.classList.remove('bg-purple-200', 'text-purple-900');
          }
          loadFilteredProducts(filter);
        } else {
          // Deactivate filter - show all
          loadProductsPublic();
        }
      }

      // Toggle favorito
      if (e.target.classList.contains('favorite-btn')) {
        const productId = parseInt(e.target.dataset.id);
        const isNowFavorite = FavoritesService.toggle(currentClientPhone, productId);
        e.target.textContent = isNowFavorite ? '‚ù§Ô∏è' : 'ü§ç';
        // Atualizar se√ß√£o de favoritos
        loadFavoritosSection();
      }

      if (e.target.classList.contains('add-to-cart')) {
        const id = parseInt(e.target.dataset.id);
        const name = e.target.dataset.name;
        const description = e.target.dataset.description;
        const price = parseFloat(e.target.dataset.price);
        const category = e.target.dataset.category;

        // For kits and bolos, open custom options modal
        if (category === 'kits' || category === 'bolos') {
          openCustomOptionsModal(id, name, description, price, category);
          return;
        }

        // For mini products with flavor selection enabled, open mini-salgados modal
        const product = products.find(p => p.id === id);
        if (product && product.category === 'mini' && product.flavor_selection?.enabled) {
          openMiniSalgadosModal(product);
          return;
        }

        // For other products, add directly to cart
        const existing = cart.find(i => i.id === id);
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ id, name, description, price, quantity: 1, note: '' });
        }
        updateCart();
        e.target.textContent = 'Adicionado!';
        e.target.classList.add('bg-green-600');
        setTimeout(() => { e.target.textContent = 'Adicionar'; e.target.classList.remove('bg-green-600'); e.target.classList.add('bg-rose-600'); }, 1000);
      }
    });
    function updateCart() {
      cartTotal = cart.reduce((t, i) => t + i.price * i.quantity, 0);
      const count = cart.reduce((t, i) => t + i.quantity, 0);
      document.getElementById('cartCount').textContent = count;
      const desktopCount = document.getElementById('cartCountDesktop');
      if (desktopCount) desktopCount.textContent = count;
      const total = `R$ ${cartTotal.toFixed(2).replace('.', ',')}`;
      document.getElementById('cartTotal').textContent = total;
      document.getElementById('mobileCartTotal').textContent = total;
      updateCartItems('cartItems');
      updateCartItems('mobileCartItems');
      const has = cart.length > 0;
      document.getElementById('checkoutBtn').disabled = !has;
      document.getElementById('mobileCheckoutBtn').disabled = !has;

      // Update floating cart button (mobile) - only show on public store
      const floatingBtn = document.getElementById('floatingCartButton');
      if (floatingBtn) {
        const hasItems = cart.length > 0;
        const isPublicStoreVisible = !document.getElementById('publicStore')?.classList.contains('hidden');

        if (hasItems && isPublicStoreVisible) {
          floatingBtn.classList.remove('hidden');
          floatingBtn.style.display = 'flex';
          // Ensure FAB is positioned correctly
          floatingBtn.style.position = 'fixed';
          floatingBtn.style.bottom = '1rem';
          floatingBtn.style.right = '1rem';
          floatingBtn.style.zIndex = '9999';
          const countEl = document.getElementById('floatingCartCount');
          const totalEl = document.getElementById('floatingCartTotal');

          if (countEl) countEl.textContent = count;
          if (totalEl) totalEl.textContent = total;
        } else {
          floatingBtn.classList.add('hidden');
          floatingBtn.style.display = 'none';
        }
      }

      // Persist cart to localStorage
      try { localStorage.setItem('fastCart', JSON.stringify(cart)); } catch (e) { }

      // Update upsell suggestions
      renderUpsellSuggestions();
    }

    // Render upsell suggestions based on cart contents
    function renderUpsellSuggestions() {
      const section = document.getElementById('upsellSection');
      const container = document.getElementById('upsellContainer');
      if (!section || !container) return;

      if (cart.length === 0) {
        section.classList.add('hidden');
        return;
      }

      // Get categories in cart
      const cartProductIds = cart.map(item => item.id);
      const cartProducts = products.filter(p => cartProductIds.includes(p.id));
      const cartCategories = [...new Set(cartProducts.map(p => p.category))];

      // Define complementary categories
      const complementMap = {
        'salgados': ['bebidas', 'adicionais'],
        'mini': ['bebidas', 'adicionais'],
        'kits': ['bebidas', 'adicionais'],
        'bolos': ['bebidas'],
        'bebidas': ['salgados', 'adicionais'],
        'adicionais': ['bebidas']
      };

      // Find complementary products not in cart
      let suggestCategories = [];
      cartCategories.forEach(cat => {
        if (complementMap[cat]) {
          suggestCategories.push(...complementMap[cat]);
        }
      });
      suggestCategories = [...new Set(suggestCategories)].filter(cat => !cartCategories.includes(cat));

      if (suggestCategories.length === 0) {
        section.classList.add('hidden');
        return;
      }

      // Get up to 3 suggestions from complementary categories
      const suggestions = products
        .filter(p =>
          suggestCategories.includes(p.category) &&
          !cartProductIds.includes(p.id) &&
          isProductAvailableToday(p) &&
          p.visible !== false
        )
        .slice(0, 2);

      if (suggestions.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      container.innerHTML = suggestions.map(product => {
        const priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
        return `
          <div class="flex-shrink-0 bg-white rounded-lg p-2 border shadow-sm min-w-[120px]">
            <div class="flex items-center gap-2 mb-1">
              ${product.image ? `<img src="${product.image}" class="w-8 h-8 object-cover rounded">` : `<span class="text-lg">${product.emoji}</span>`}
              <span class="text-xs font-medium text-gray-800 truncate flex-1">${product.name}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-xs text-rose-600 font-bold">${priceDisplay}</span>
              <button class="add-to-cart bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" 
                data-id="${product.id}" data-name="${product.name}" data-description="${product.description || ''}" data-price="${product.price}">+</button>
            </div>
          </div>
        `;
      }).join('');
    }
    function updateCartItems(containerId) {
      const container = document.getElementById(containerId);

      if (cart.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Carrinho vazio</p>';
        return;
      }

      container.innerHTML = cart.map(item => `
        <div class="cart-item p-3 bg-gray-50 rounded-lg mb-2">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <h4 class="font-medium text-gray-800">${item.name}</h4>
              <p class="text-sm text-gray-800">R$ ${item.price.toFixed(2).replace('.', ',')}</p>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="changeQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-200 text-black rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors">-</button>
              <span class="w-8 text-center font-bold text-gray-900">${item.quantity}</span>
              <button onclick="changeQuantity(${item.id}, 1)" class="w-8 h-8 bg-gray-200 text-black rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors">+</button>
            </div>
          </div>
          <div class="mt-2">
            ${item.note ? `<p class="text-xs text-gray-600 italic mb-1">üìù ${item.note}</p>` : ''}
            <button onclick="toggleItemNote(${item.id})" class="text-xs text-rose-600 hover:text-rose-800">
              ${item.note ? '‚úèÔ∏è Editar obs' : 'üìù Adicionar obs'}
            </button>
            <div id="noteInput_${item.id}_${containerId}" class="hidden mt-2">
              <input type="text" 
                placeholder="Ex.: sem cebola, bem passado..." 
                value="${item.note || ''}"
                onblur="saveItemNote(${item.id}, this.value)"
                onkeydown="if(event.key==='Enter'){saveItemNote(${item.id}, this.value);}"
                class="w-full px-2 py-1 text-sm border rounded">
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleItemNote(itemId) {
      // Toggle both cart containers
      const containers = ['cartItems', 'mobileCartItems'];
      containers.forEach(containerId => {
        const input = document.getElementById(`noteInput_${itemId}_${containerId}`);
        if (input) {
          input.classList.toggle('hidden');
          if (!input.classList.contains('hidden')) {
            input.querySelector('input')?.focus();
          }
        }
      });
    }

    function saveItemNote(itemId, note) {
      const item = cart.find(i => i.id === itemId);
      if (item) {
        item.note = note.trim();
        updateCart();
      }
    }

    function changeQuantity(id, chg) { const it = cart.find(i => i.id === id); if (it) { it.quantity += chg; if (it.quantity <= 0) { cart = cart.filter(x => x.id !== id); } updateCart(); } }

    // ========================================
    // REORDER FUNCTIONS (√öltimos Pedidos)
    // ========================================
    function showLastOrders() {
      const phone = document.getElementById('customerPhone').value.trim();
      const orders = OrderHistoryService.getOrders(phone || null);
      const section = document.getElementById('lastOrdersSection');
      const list = document.getElementById('lastOrdersList');

      if (orders.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      list.innerHTML = orders.slice(0, 2).map((order, idx) => {
        const date = safeDate(order.createdAt).toLocaleDateString('pt-BR');
        const summary = order.items.slice(0, 2).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const more = order.items.length > 2 ? ` +${order.items.length - 2}` : '';
        return `
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="flex justify-between items-start gap-2">
              <div class="flex-1 min-w-0">
                <p class="text-xs text-gray-500">${date}</p>
                <p class="text-sm text-gray-800 truncate">${summary}${more}</p>
                <p class="text-sm font-semibold text-rose-600">R$ ${order.total.toFixed(2).replace('.', ',')}</p>
              </div>
              <button onclick="repeatOrder(${idx})" 
                class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium whitespace-nowrap flex-shrink-0">
                üîÑ Repetir
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function repeatOrder(orderIndex) {
      const phone = document.getElementById('customerPhone').value.trim();
      const orders = OrderHistoryService.getOrders(phone || null);
      const order = orders[orderIndex];
      if (!order) return;

      cart = []; // Limpa carrinho
      let unavailable = [];

      order.items.forEach(item => {
        const product = products.find(p => p.id === item.productId && p.visible !== false);
        if (product) {
          cart.push({
            id: product.id,
            name: product.name,
            description: product.description || '',
            price: product.price, // Usa pre√ßo atual!
            quantity: item.quantity
          });
        } else {
          unavailable.push(item.name);
        }
      });

      updateCart();
      document.getElementById('checkoutModal').classList.add('hidden');

      if (unavailable.length > 0) {
        alert(`‚ö†Ô∏è Alguns itens n√£o est√£o mais dispon√≠veis:\n${unavailable.join(', ')}`);
      }

      showInlineMessage('publicStore', '‚úÖ Pedido carregado no carrinho!', 'success');
    }

    // ========================================
    // ADDRESS MANAGEMENT (M√∫ltiplos Endere√ßos)
    // ========================================
    function renderSavedAddresses(phone) {
      const select = document.getElementById('savedAddressSelect');
      if (!select) return;

      const addresses = AddressService.load(phone);
      select.innerHTML = '<option value="">Selecione um endere√ßo...</option>';

      if (addresses.length === 0) {
        document.getElementById('savedAddressSection')?.classList.add('hidden');
        document.getElementById('noAddressSection')?.classList.remove('hidden');
        return;
      }

      addresses.forEach((addr, idx) => {
        const label = addr.label || 'Endere√ßo';
        const text = `${label} ‚Äì ${addr.street}, ${addr.number} ‚Äì ${addr.neighborhood}`;
        const opt = document.createElement('option');
        opt.value = idx.toString();
        opt.textContent = text;
        select.appendChild(opt);
      });

      document.getElementById('savedAddressSection')?.classList.remove('hidden');
      document.getElementById('noAddressSection')?.classList.add('hidden');
    }

    function fillAddressFromSaved(phone, index) {
      const addresses = AddressService.load(phone);
      const addr = addresses[index];
      if (!addr) return;

      document.getElementById('street').value = addr.street || '';
      document.getElementById('number').value = addr.number || '';
      document.getElementById('neighborhood').value = addr.neighborhood || '';
      document.getElementById('reference').value = addr.reference || '';
      if (addr.label) {
        const labelSelect = document.getElementById('addressLabel');
        if (labelSelect) labelSelect.value = addr.label;
      }
    }

    // Event: Ao selecionar endere√ßo salvo, preencher campos
    document.getElementById('savedAddressSelect')?.addEventListener('change', (e) => {
      const idx = parseInt(e.target.value);
      if (!isNaN(idx)) {
        const phone = document.getElementById('customerPhone').value.trim();
        fillAddressFromSaved(phone, idx);
      }
    });

    // Event: Confirmar uso do endere√ßo selecionado
    document.getElementById('confirmSavedAddress')?.addEventListener('click', () => {
      const select = document.getElementById('savedAddressSelect');
      const idx = parseInt(select?.value);
      if (isNaN(idx)) {
        alert('Selecione um endere√ßo da lista.');
        return;
      }
      const phone = document.getElementById('customerPhone').value.trim();
      fillAddressFromSaved(phone, idx);
      document.getElementById('addressForm')?.classList.remove('hidden');
      document.getElementById('savedAddressSection')?.classList.add('hidden');
    });

    // Event: Usar outro endere√ßo (mostrar formul√°rio vazio)
    document.getElementById('useDifferentAddress')?.addEventListener('click', () => {
      document.getElementById('addressForm')?.classList.remove('hidden');
      document.getElementById('savedAddressSection')?.classList.add('hidden');
      // Limpar campos
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';
    });

    // Normaliza√ß√£o e valida√ß√£o do telefone do cliente
    const customerPhoneInput = document.getElementById('customerPhone');

    if (customerPhoneInput) {
      // Bloqueia caracteres que n√£o sejam d√≠gitos
      customerPhoneInput.addEventListener('keypress', (e) => {
        const char = String.fromCharCode(e.which || e.keyCode);
        if (!/[0-9]/.test(char)) {
          e.preventDefault();
        }
      });

      // Ao digitar/colar, mant√©m apenas d√≠gitos
      customerPhoneInput.addEventListener('input', (e) => {
        const onlyDigits = e.target.value.replace(/\D/g, '');
        e.target.value = onlyDigits;
      });
    }

    // Event: Ao mudar o telefone do cliente, recarregar endere√ßos
    document.getElementById('customerPhone')?.addEventListener('blur', () => {
      const phone = document.getElementById('customerPhone').value.trim();
      if (phone && phone.length >= 10) {
        renderSavedAddresses(phone);
        updateLoyaltyUI(phone);
      }
    });

    document.getElementById('cartBtn')?.addEventListener('click', () => document.getElementById('cartModal').classList.remove('hidden'));
    document.getElementById('cartBtnDesktop')?.addEventListener('click', () => document.getElementById('cartModal').classList.remove('hidden'));
    document.getElementById('closeCartModal')?.addEventListener('click', () => { document.getElementById('cartModal').classList.add('hidden'); const floatingBtn = document.getElementById('floatingCartButton'); if (floatingBtn && cart.length > 0) { floatingBtn.style.display = 'flex'; } });
    document.getElementById('checkoutBtn')?.addEventListener('click', showCheckout);
    document.getElementById('mobileCheckoutBtn')?.addEventListener('click', () => { document.getElementById('cartModal').classList.add('hidden'); showCheckout(); });
    function showCheckout() {
      if (cart.length === 0) return;
      const ci = document.getElementById('checkoutItems');
      ci.innerHTML = cart.map(i => {
        let html = `<div class='flex justify-between'><span>${i.quantity}x ${i.name}</span><span>R$ ${(i.price * i.quantity).toFixed(2).replace('.', ',')}</span></div>`;
        if (i.note) {
          html += `<p class='text-xs text-gray-500 italic ml-4'>üìù ${i.note}</p>`;
        }
        return html;
      }).join('');
      // Kits e Bolos: desabilitar entrega
      const containsKit = cart.some(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'kits'; });
      const containsBolo = cart.some(i => {
        const p = products.find(x => x.id === i.id);
        if (!p) return false;
        const name = p.name.toLowerCase();
        return p.category === 'bolos' || name.includes('bolo p') || name.includes('bolo g') || name.match(/bolo\s*[pg]/i);
      });
      const onlyBeverages = cart.every(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'bebidas'; });
      const deliveryTitle = document.getElementById('deliveryTitle');
      const entregaRadio = document.querySelector('input[name="delivery"][value="entrega"]');
      const retiradaRadio = document.querySelector('input[name="delivery"][value="retirada"]');

      // Check if delivery is globally disabled
      const deliveryDisabled = !storeConfig.delivery_enabled;

      if (containsKit || containsBolo || onlyBeverages || deliveryDisabled) {
        entregaRadio.checked = false;
        entregaRadio.disabled = true;
        retiradaRadio.checked = true;

        // Show delivery disabled reason if applicable
        if (deliveryDisabled && storeConfig.delivery_disabled_reason) {
          const existingNotice = document.getElementById('deliveryDisabledNotice');
          if (!existingNotice) {
            const notice = document.createElement('div');
            notice.id = 'deliveryDisabledNotice';
            notice.className = 'mt-2 p-3 rounded-lg bg-orange-100 border border-orange-300 text-orange-800 text-sm';
            notice.innerHTML = `üöö <strong>Entregas suspensas:</strong> ${storeConfig.delivery_disabled_reason}`;
            entregaRadio.parentElement.parentElement.appendChild(notice);
          }
        }
      } else {
        entregaRadio.disabled = false;
        // Remove notice if exists
        document.getElementById('deliveryDisabledNotice')?.remove();
      }
      // Fora do hor√°rio: encomenda + data
      const open = isFastOpen();
      const dateBox = document.getElementById('orderDateBox');
      const encomendaWarn = document.getElementById('encomendaWarning');
      if (!open) { deliveryTitle.textContent = 'Fazer Encomenda'; dateBox.classList.remove('hidden'); encomendaWarn.classList.remove('hidden'); const d = document.getElementById('orderDate'); const minDate = getMinEncomendaDateYYYYMMDD(); d.min = minDate; if (d.value && d.value < minDate) d.value = minDate; }
      else { deliveryTitle.textContent = 'Entrega'; dateBox.classList.add('hidden'); encomendaWarn.classList.add('hidden'); }

      try {
        const deliverySel = document.querySelector('input[name="delivery"]:checked');
        const slot = document.getElementById('orderTimeSlot');
        if (slot) {
          if (deliverySel && deliverySel.value === 'entrega') { slot.min = '07:00'; slot.max = '18:00'; }
          else { slot.removeAttribute('min'); slot.removeAttribute('max'); }
        }
      } catch (e) { }
      updateCheckoutFeeAndTotalFast();
      showLastOrders(); // Mostrar √∫ltimos pedidos para recompra r√°pida
      updateLoyaltyUI(document.getElementById('customerPhone')?.value);
      document.getElementById('checkoutModal').classList.remove('hidden');
    }

    // ========================================
    // TRACKING ORDER MODAL LOGIC
    // ========================================
    function normalizePhoneDigits(phone) {
      const digits = String(phone || '').replace(/\D/g, '');
      if (digits.length === 13 && digits.startsWith('55')) return digits.slice(2);
      return digits;
    }

    function openTrackingModal() {
      document.getElementById('trackingModal')?.classList.remove('hidden');
    }

    function closeTrackingModal() {
      document.getElementById('trackingModal')?.classList.add('hidden');
    }

    function setTrackingMessage(text, type) {
      const box = document.getElementById('trackingMessage');
      if (!box) return;
      box.classList.remove('hidden');
      box.textContent = text;
      box.className = 'mt-2 text-sm';
      if (type === 'success') box.classList.add('text-green-700');
      else if (type === 'error') box.classList.add('text-red-700');
      else box.classList.add('text-gray-700');
    }

    function hideTrackingMessage() {
      const box = document.getElementById('trackingMessage');
      if (!box) return;
      box.classList.add('hidden');
      box.textContent = '';
    }

    function buildTrackingLink(orderId, phone) {
      const code = formatOrderCode(orderId);
      const phoneDigits = normalizePhoneDigits(phone);
      const baseUrl = `${window.location.origin}${window.location.pathname}`;
      return `${baseUrl}?track=${encodeURIComponent(code)}&phone=${encodeURIComponent(phoneDigits)}`;
    }

    function getTrackingStepIndex(status) {
      const st = String(status || '').toLowerCase();
      if (st === 'cancelled' || st === 'cancelado') return -1;
      const mapped = (typeof MsgTemplateService !== 'undefined' && MsgTemplateService?.statusMap && MsgTemplateService.statusMap[st]) ? MsgTemplateService.statusMap[st] : st;
      const pt = String(mapped || '').toLowerCase();
      if (pt === 'recebido' || st === 'pending') return 0;
      if (pt === 'em_preparo' || st === 'preparing' || pt === 'aceito' || st === 'accepted') return 1;
      if (pt === 'pronto' || st === 'confirmed') return 2;
      if (pt === 'saiu_entrega' || st === 'out_for_delivery') return 3;
      if (pt === 'entregue' || st === 'delivered') return 4;
      return 0;
    }

    function getTrackingStatusLabel(status) {
      const st = String(status || '').toLowerCase();
      if (typeof STATUS_LABELS !== 'undefined' && STATUS_LABELS[st]) {
        return `${STATUS_LABELS[st].emoji} ${STATUS_LABELS[st].label}`;
      }
      const mapped = (typeof MsgTemplateService !== 'undefined' && MsgTemplateService?.statusMap && MsgTemplateService.statusMap[st]) ? MsgTemplateService.statusMap[st] : st;
      const pt = String(mapped || '').toLowerCase();
      const labelsPt = {
        recebido: 'üÜï Recebido',
        aceito: '‚úÖ Aceito',
        em_preparo: 'üç≥ Em Preparo',
        pronto: '‚úÖ Pronto',
        saiu_entrega: 'üöö Saiu para entrega',
        entregue: '‚úîÔ∏è Entregue',
        cancelado: '‚ùå Cancelado'
      };
      return labelsPt[pt] || (status || 'Recebido');
    }

    function getTrackingEstimate(order) {
      const prepMin = storeConfig.prep_time_min || storeConfig.prepTimeMin || 20;
      const prepMax = storeConfig.prep_time_max || storeConfig.prepTimeMax || 40;
      const delMin = storeConfig.delivery_time_min || storeConfig.deliveryTimeMin || 0;
      const delMax = storeConfig.delivery_time_max || storeConfig.deliveryTimeMax || 0;
      const isDelivery = (order?.delivery_type || '') === 'entrega';
      if (!isDelivery) return `${prepMin}-${prepMax} min`;
      if (!delMin && !delMax) return `${prepMin}-${prepMax} min`;
      return `Preparo: ${prepMin}-${prepMax} min | Entrega: ${delMin}-${delMax} min`;
    }

    function renderTrackingTimeline(status) {
      const steps = [
        { label: 'Recebido' },
        { label: 'Em preparo' },
        { label: 'Pronto' },
        { label: 'Saiu para entrega' },
        { label: 'Entregue' }
      ];
      const idx = getTrackingStepIndex(status);
      const container = document.getElementById('trackingTimeline');
      if (!container) return;

      if (idx < 0) {
        container.innerHTML = '<div class="p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm">‚ùå Pedido cancelado</div>';
        return;
      }

      container.innerHTML = steps.map((s, i) => {
        const done = i < idx;
        const current = i === idx;
        const base = 'flex items-center gap-3 p-3 rounded-lg border';
        const cls = done ? 'bg-green-50 border-green-200 text-green-800' : current ? 'bg-yellow-50 border-yellow-200 text-yellow-900' : 'bg-gray-50 border-gray-200 text-gray-600';
        const icon = done ? '‚úÖ' : current ? 'üü°' : '‚ö™';
        return `<div class="${base} ${cls}"><span class="text-lg">${icon}</span><span class="font-medium">${s.label}</span></div>`;
      }).join('');
    }

    async function fetchOrderForTracking(orderCode, phoneDigits) {
      const code = String(orderCode || '').trim().toUpperCase();
      const phone = normalizePhoneDigits(phoneDigits);
      if (!code || !phone) return null;

      if (window.supabaseClient) {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_orders')
            .select('*')
            .eq('client_phone', phone)
            .order('created_at', { ascending: false })
            .limit(50);

          if (error) throw error;

          // Busca por order_code (sequencial) ou por formatOrderCode (timestamp)
          const found = (data || []).find(o =>
            o.order_code === code ||
            formatOrderCode(o.order_sequence || o.id) === code
          );
          if (found) return found;
        } catch (e) {
          console.warn('[Tracking] Falha ao buscar no Supabase:', e);
        }
      }

      try {
        const history = loadOrderHistory(phone);
        const foundLocal = (history || []).find(o =>
          o.orderCode === code ||
          formatOrderCode(o.orderSequence || o.id) === code
        );
        if (foundLocal) {
          return {
            id: foundLocal.id,
            order_code: foundLocal.orderCode,
            order_sequence: foundLocal.orderSequence,
            client_phone: phone,
            delivery_type: foundLocal.deliveryType || 'retirada',
            status: 'pending',
            created_at: foundLocal.createdAt || new Date().toISOString()
          };
        }
      } catch (e2) { }

      return null;
    }

    async function handleTrackOrder() {
      hideTrackingMessage();
      document.getElementById('trackingResult')?.classList.add('hidden');

      const code = document.getElementById('trackingOrderCode')?.value?.trim();
      const phoneRaw = document.getElementById('trackingPhone')?.value?.trim();
      const phone = normalizePhoneDigits(phoneRaw);

      if (!code) {
        setTrackingMessage('Informe o c√≥digo do pedido.', 'error');
        return;
      }

      if (!phone || phone.length !== 11) {
        setTrackingMessage('Informe um telefone v√°lido com 11 d√≠gitos (DDD + 9).', 'error');
        return;
      }

      setTrackingMessage('Buscando pedido...', 'info');
      const order = await fetchOrderForTracking(code, phone);

      if (!order) {
        setTrackingMessage('Pedido n√£o encontrado. Verifique o c√≥digo e o telefone.', 'error');
        return;
      }

      setTrackingMessage('Pedido encontrado!', 'success');
      const codeLabel = document.getElementById('trackingCodeLabel');
      const statusLabel = document.getElementById('trackingStatusLabel');
      const estLabel = document.getElementById('trackingEstimateLabel');

      if (codeLabel) codeLabel.textContent = order.order_code || formatOrderCode(order.order_sequence || order.id);
      if (statusLabel) statusLabel.textContent = getTrackingStatusLabel(order.status);
      if (estLabel) estLabel.textContent = getTrackingEstimate(order);

      renderTrackingTimeline(order.status);
      document.getElementById('trackingResult')?.classList.remove('hidden');
    }

    document.getElementById('openTrackingModalBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      openTrackingModal();
    });

    // Bot√£o "Pedir de novo" - repete √∫ltimo pedido
    document.getElementById('repeatLastOrderBtn')?.addEventListener('click', () => {
      repeatOrderFromHistory(0);
      // Abrir modal do carrinho ap√≥s carregar itens
      setTimeout(() => {
        document.getElementById('cartModal')?.classList.remove('hidden');
      }, 100);
    });

    document.getElementById('closeTrackingModalBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      closeTrackingModal();
    });

    document.getElementById('trackOrderBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      handleTrackOrder();
    });

    document.getElementById('trackingPhone')?.addEventListener('input', (e) => {
      e.target.value = normalizePhoneDigits(e.target.value);
    });

    // ========================================
    // RATING SYSTEM
    // ========================================
    let currentRatingOrderId = null;
    let currentRatingPhone = null;

    // ========================================
    // TERMS OF USE MODAL
    // ========================================
    function openTermsModal() {
      document.getElementById('termsModal')?.classList.remove('hidden');
    }

    function closeTermsModal() {
      document.getElementById('termsModal')?.classList.add('hidden');
    }

    // ========================================
    // TERMS ACCEPTANCE SERVICE (Per Phone)
    // ========================================
    const TermsAcceptanceService = {
      storageKey: 'fastTermsAccepted',
      cache: null,

      loadFromSupabase: async function () {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_clients')
            .select('phone, terms_accepted')
            .eq('terms_accepted', true);

          if (!error && data) {
            this.cache = data.map(d => d.phone?.replace(/\D/g, '')).filter(Boolean);
            // Also update localStorage as fallback
            localStorage.setItem(this.storageKey, JSON.stringify(this.cache));
          }
        } catch (e) {
          console.warn('[Terms] Erro ao carregar do Supabase:', e);
        }
      },

      getAcceptedPhones: function () {
        if (this.cache) return this.cache;
        try {
          const data = localStorage.getItem(this.storageKey);
          this.cache = data ? JSON.parse(data) : [];
          return this.cache;
        } catch (e) {
          return [];
        }
      },

      hasAccepted: function (phone) {
        if (!phone) return false;
        const phoneDigits = phone.replace(/\D/g, '');
        return this.getAcceptedPhones().includes(phoneDigits);
      },

      markAccepted: async function (phone) {
        if (!phone) return;
        const phoneDigits = phone.replace(/\D/g, '');
        const phones = this.getAcceptedPhones();
        if (!phones.includes(phoneDigits)) {
          phones.push(phoneDigits);
          this.cache = phones;
          try {
            localStorage.setItem(this.storageKey, JSON.stringify(phones));
            // Also update in Supabase client record
            await window.supabaseClient
              .from('fast_clients')
              .update({ terms_accepted: true, terms_accepted_at: new Date().toISOString() })
              .eq('phone', phoneDigits);
          } catch (e) {
            console.warn('[Terms] Erro ao salvar no Supabase:', e);
          }
        }
      }
    };

    // Check terms acceptance when phone is entered
    function checkTermsAcceptance(phone) {
      const checkbox = document.getElementById('acceptTermsCheckbox');
      if (!checkbox) return;

      if (TermsAcceptanceService.hasAccepted(phone)) {
        checkbox.checked = true;
        checkbox.disabled = true; // Already accepted, can't uncheck
      } else {
        checkbox.checked = false;
        checkbox.disabled = false;
      }
    }

    // Rating Modal Functions
    function openRatingModal() {
      document.getElementById('ratingModal')?.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevent scroll
      resetRatingModal();
    }

    function closeRatingModal() {
      document.getElementById('ratingModal')?.classList.add('hidden');
      document.body.style.overflow = ''; // Restore scroll
      // Clear URL params
      const url = new URL(window.location);
      url.searchParams.delete('rate');
      url.searchParams.delete('phone');
      window.history.replaceState({}, '', url);
    }

    function resetRatingModal() {
      document.getElementById('ratingForm')?.classList.remove('hidden');
      document.getElementById('ratingAlreadyDone')?.classList.add('hidden');
      document.getElementById('ratingThankYou')?.classList.add('hidden');
      const ratingValue = document.getElementById('ratingValue');
      if (ratingValue) ratingValue.value = '0';
      const ratingComment = document.getElementById('ratingComment');
      if (ratingComment) ratingComment.value = '';
      const ratingClientName = document.getElementById('ratingClientName');
      if (ratingClientName) ratingClientName.value = '';
      const ratingCharCount = document.getElementById('ratingCharCount');
      if (ratingCharCount) ratingCharCount.textContent = '0';
      const submitBtn = document.getElementById('submitRatingBtn');
      if (submitBtn) submitBtn.disabled = true;
      document.getElementById('ratingMessage')?.classList.add('hidden');
      updateStarDisplay(0);
      currentRatingOrderId = null;
      currentRatingPhone = null;
    }

    function updateStarDisplay(rating) {
      document.querySelectorAll('#starRating .star-btn').forEach((btn, i) => {
        btn.classList.toggle('text-yellow-400', i < rating);
        btn.classList.toggle('text-gray-300', i >= rating);
      });
    }

    function setRatingMessage(text, type) {
      const box = document.getElementById('ratingMessage');
      if (!box) return;
      box.classList.remove('hidden');
      box.textContent = text;
      box.className = 'mb-4 p-3 rounded-lg text-sm text-center';
      if (type === 'success') box.classList.add('bg-green-100', 'text-green-700');
      else if (type === 'error') box.classList.add('bg-red-100', 'text-red-700');
      else box.classList.add('bg-blue-100', 'text-blue-700');
    }

    async function loadOrderForRating(orderCode, phone) {
      const code = String(orderCode || '').trim().toUpperCase();
      const phoneDigits = normalizePhoneDigits(phone);

      if (!code || !phoneDigits) {
        setRatingMessage('C√≥digo do pedido ou telefone inv√°lido.', 'error');
        return null;
      }

      try {
        const { data, error } = await window.supabaseClient
          .from('fast_orders')
          .select('*')
          .eq('client_phone', phoneDigits)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) throw error;

        const order = (data || []).find(o =>
          o.order_code === code ||
          formatOrderCode(o.order_sequence || o.id) === code
        );

        return order || null;
      } catch (e) {
        console.error('[Rating] Erro ao buscar pedido:', e);
        return null;
      }
    }

    async function initRatingModal(orderCode, phone) {
      openRatingModal();
      setRatingMessage('Buscando pedido...', 'info');

      const order = await loadOrderForRating(orderCode, phone);

      if (!order) {
        setRatingMessage('Pedido n√£o encontrado. Verifique o c√≥digo e telefone.', 'error');
        return;
      }

      currentRatingOrderId = order.id;
      currentRatingPhone = phone;

      const displayCode = order.order_code || formatOrderCode(order.order_sequence || order.id);
      document.getElementById('ratingOrderCode').textContent = displayCode;

      // Check if already rated
      if (order.rating && order.rating > 0) {
        showExistingRating(order.rating, order.rating_comment);
        return;
      }

      document.getElementById('ratingMessage')?.classList.add('hidden');
    }

    function showExistingRating(rating, comment) {
      document.getElementById('ratingForm')?.classList.add('hidden');
      document.getElementById('ratingAlreadyDone')?.classList.remove('hidden');
      document.getElementById('existingRatingStars').textContent = '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
      document.getElementById('existingRatingComment').textContent = comment || 'Sem coment√°rio';
    }

    async function submitRating() {
      const rating = parseInt(document.getElementById('ratingValue').value, 10);
      const comment = document.getElementById('ratingComment').value.trim();
      const clientName = document.getElementById('ratingClientName')?.value?.trim() || 'Cliente';
      const orderCode = document.getElementById('ratingOrderCode')?.textContent || '';

      if (!rating || rating < 1 || rating > 5) {
        setRatingMessage('Selecione uma nota de 1 a 5 estrelas.', 'error');
        return;
      }

      if (!currentRatingOrderId) {
        setRatingMessage('Pedido n√£o identificado.', 'error');
        return;
      }

      // Disable button to prevent double submit
      const submitBtn = document.getElementById('submitRatingBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      }

      try {
        // Check for duplicate in fast_ratings first
        const existing = await RatingsModule.checkExists(orderCode, currentRatingPhone);
        if (existing) {
          console.log('[Rating] Avalia√ß√£o j√° existe:', existing);
          showExistingRating(existing.rating, existing.comment);
          return;
        }

        // Save to fast_orders for quick reference
        const { error: orderError } = await window.supabaseClient
          .from('fast_orders')
          .update({ rating, rating_comment: comment })
          .eq('id', currentRatingOrderId);

        if (orderError) {
          console.error('[Rating] Erro ao salvar em fast_orders:', orderError);
          // Continue anyway - fast_ratings is the main storage
        }

        // Save to fast_ratings for testimonials system
        console.log('[Rating] Salvando avalia√ß√£o:', { orderCode, phone: currentRatingPhone, clientName, rating, comment });

        const ratingResult = await RatingsModule.submit({
          orderCode: orderCode,
          phone: currentRatingPhone,
          clientName: clientName,
          rating: rating,
          comment: comment
        });

        if (!ratingResult.success) {
          if (ratingResult.duplicate) {
            showExistingRating(ratingResult.existing.rating, ratingResult.existing.comment);
            return;
          }
          console.error('[Rating] Erro ao salvar em fast_ratings:', ratingResult.error);
          throw ratingResult.error;
        }

        console.log('[Rating] Avalia√ß√£o salva com sucesso!');
        document.getElementById('ratingForm')?.classList.add('hidden');
        document.getElementById('ratingThankYou')?.classList.remove('hidden');
      } catch (e) {
        console.error('[Rating] Erro ao salvar:', e);
        setRatingMessage('Erro ao salvar avalia√ß√£o. Tente novamente.', 'error');
        // Re-enable button on error
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar Avalia√ß√£o';
        }
      }
    }

    // Star rating click handlers
    document.querySelectorAll('#starRating .star-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const star = parseInt(btn.dataset.star, 10);
        document.getElementById('ratingValue').value = star;
        updateStarDisplay(star);
        validateRatingForm();
      });
    });

    document.getElementById('closeRatingModalBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      closeRatingModal();
    });

    document.getElementById('submitRatingBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      submitRating();
    });

    // Character counter for rating comment
    document.getElementById('ratingComment')?.addEventListener('input', (e) => {
      const count = e.target.value.length;
      const counter = document.getElementById('ratingCharCount');
      if (counter) counter.textContent = count;
      validateRatingForm();
    });

    // Validate rating form and enable/disable submit button
    document.getElementById('ratingClientName')?.addEventListener('input', validateRatingForm);

    function validateRatingForm() {
      const name = document.getElementById('ratingClientName')?.value?.trim() || '';
      const rating = parseInt(document.getElementById('ratingValue')?.value || 0, 10);
      const comment = document.getElementById('ratingComment')?.value?.trim() || '';
      const btn = document.getElementById('submitRatingBtn');
      if (btn) {
        btn.disabled = !(name.length >= 2 && rating >= 1 && comment.length >= 10);
      }
    }

    // Build rating link
    function buildRatingLink(orderCode, phone) {
      const phoneDigits = normalizePhoneDigits(phone);
      const baseUrl = 'https://fastsavorys.netlify.app/pages/fast.html';
      return `${baseUrl}?rate=${encodeURIComponent(orderCode)}&phone=${encodeURIComponent(phoneDigits)}#rating`;
    }

    // ========================================
    // COUPON LOGIC (CHECKOUT)
    // ========================================
    function setCouponMessage(text, type) {
      const box = document.getElementById('couponMessage');
      if (!box) return;
      box.classList.remove('hidden');
      box.textContent = text;
      box.className = 'mt-2 text-sm';
      if (type === 'success') box.classList.add('text-green-700');
      else if (type === 'error') box.classList.add('text-red-700');
      else box.classList.add('text-gray-700');
    }

    function hideCouponMessage() {
      const box = document.getElementById('couponMessage');
      if (!box) return;
      box.classList.add('hidden');
      box.textContent = '';
    }

    function findValidCouponByCode(code) {
      const c = String(code || '').trim().toUpperCase();
      if (!c) return null;
      const coupon = (coupons || []).find(x => String(x.code || '').toUpperCase() === c);
      if (!coupon) return null;
      if (coupon.active === false) return null;
      if (typeof isCouponExpired === 'function' && isCouponExpired(coupon)) return null;
      if (typeof isCouponExhausted === 'function' && isCouponExhausted(coupon)) return null;
      return coupon;
    }

    function computeCouponDiscount(baseAmount, coupon) {
      if (!coupon) return 0;
      const base = Math.max(0, Number(baseAmount || 0));
      if (base <= 0) return 0;
      let discount = 0;
      if (coupon.type === 'percentage') discount = base * (Number(coupon.value || 0) / 100);
      else if (coupon.type === 'fixed') discount = Number(coupon.value || 0);
      if (coupon.maxValue != null && !isNaN(coupon.maxValue)) {
        discount = Math.min(discount, Number(coupon.maxValue));
      }
      discount = Math.min(discount, base);
      discount = Math.max(0, discount);
      return discount;
    }

    function clearAppliedCoupon() {
      appliedCoupon = null;
      const input = document.getElementById('couponInput');
      const removeBtn = document.getElementById('removeCouponBtn');
      const applyBtn = document.getElementById('applyCouponBtn');
      if (input) input.value = '';
      if (removeBtn) removeBtn.classList.add('hidden');
      if (applyBtn) applyBtn.classList.remove('hidden');
      hideCouponMessage();
      const row = document.getElementById('couponDiscountRow');
      if (row) row.remove();
    }

    async function applyCouponFromInput() {
      hideCouponMessage();
      const input = document.getElementById('couponInput');
      const code = input?.value?.trim()?.toUpperCase();

      if (!code) {
        setCouponMessage('Digite um cupom para aplicar.', 'error');
        return;
      }

      const coupon = findValidCouponByCode(code);
      if (!coupon) {
        setCouponMessage('Cupom inv√°lido, vencido ou indispon√≠vel.', 'error');
        return;
      }

      if (coupon.minOrder && cartTotal < coupon.minOrder) {
        setCouponMessage(`Este cupom exige pedido m√≠nimo de R$ ${Number(coupon.minOrder).toFixed(2).replace('.', ',')}.`, 'error');
        return;
      }

      // Check if coupon was already used by this phone
      const customerPhone = document.getElementById('customerPhone')?.value?.trim() || '';
      const phoneDigits = customerPhone.replace(/\D/g, '');
      console.log('[Coupon] Verificando uso para telefone:', phoneDigits, 'cupom:', code);

      if (phoneDigits && phoneDigits.length === 11) {
        try {
          const alreadyUsed = await CouponUsageService.hasUsed(phoneDigits, code);
          console.log('[Coupon] Resultado hasUsed:', alreadyUsed);
          if (alreadyUsed) {
            setCouponMessage('Cupom j√° utilizado pelo cliente.', 'error');
            return;
          }
        } catch (e) {
          console.warn('[Coupon] Erro ao verificar uso:', e);
          // Continue anyway if check fails
        }
      }

      appliedCoupon = coupon;
      const removeBtn = document.getElementById('removeCouponBtn');
      const applyBtn = document.getElementById('applyCouponBtn');
      if (removeBtn) removeBtn.classList.remove('hidden');
      if (applyBtn) applyBtn.classList.add('hidden');
      setCouponMessage(`Cupom ${coupon.code} aplicado!`, 'success');
      updateCheckoutFeeAndTotalFast();
    }

    function removeAppliedCoupon() {
      clearAppliedCoupon();
      updateCheckoutFeeAndTotalFast();
    }

    document.getElementById('applyCouponBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      applyCouponFromInput();
    });

    document.getElementById('removeCouponBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      removeAppliedCoupon();
    });

    // ========================================
    // LOYALTY UI (CHECKOUT)
    // ========================================
    async function updateLoyaltyUI(phone) {
      const box = document.getElementById('loyaltyInfoBox');
      const textEl = document.getElementById('loyaltyInfoText');
      if (!box || !textEl) return;

      const digits = normalizePhoneDigits(phone);
      if (!digits || digits.length !== 11) {
        box.classList.add('hidden');
        return;
      }

      // Check Special Discount Config
      const config = await SpecialDiscountService.getConfig();
      if (!config || !config.active) {
        box.classList.add('hidden');
        return;
      }

      const count = await SpecialDiscountService.getValidOrderCount(digits);
      const minOrders = config.min_orders || 10;

      let text = `Voc√™ tem ${count} pedido${count !== 1 ? 's' : ''} entregues/pagos.`;

      const remainder = count % minOrders;
      const needed = minOrders - remainder;

      if (remainder === 0 && count > 0) {
        // Just reached the milestone (on this next order? No, if 10 orders done, next is 11th. 
        // Logic: After 10 orders, the 11th gets discount? Or the 10th?
        // Usually "Complete 10 orders, get discount on next".
        // So if count = 10, discount available!
        // If count = 11, discount used? We need to track usage.
        // Ah, simpler logic: Every X orders.
        // If count > 0 and count % minOrders == 0, then user has X completed orders. They are ELIGIBLE for discount on CURRENT order (which will be X+1).
        // Wait. "A cada 10 pedidos".
        // Use modulus.
        text += ` üåü PARAB√âNS! Voc√™ completou ${minOrders} pedidos e tem um desconto especial agora!`;
        currentSpecialDiscount = config;
      } else {
        text += ` Faltam ${needed} pedidos para seu pr√≥ximo desconto especial!`;
        currentSpecialDiscount = null;
      }
      // Re-calculate totals to show discount immediately if phone entered
      updateCheckoutFeeAndTotalFast();

      textEl.textContent = text;
      box.classList.remove('hidden');
    }

    document.addEventListener('change', (e) => {
      if (e.target.name === 'delivery') {
        const f = document.getElementById('addressForm');

        // Check if cart contains kits or bolos (delivery not allowed)
        if (e.target.value === 'entrega') {
          const containsKit = cart.some(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'kits'; });
          const containsBolo = cart.some(i => {
            const p = products.find(x => x.id === i.id);
            if (!p) return false;
            const name = p.name.toLowerCase();
            return p.category === 'bolos' || name.includes('bolo p') || name.includes('bolo g') || name.match(/bolo\s*[pg]/i);
          });

          if (containsKit || containsBolo) {
            // Block delivery selection - revert to pickup
            e.target.checked = false;
            document.querySelector('input[name="delivery"][value="retirada"]').checked = true;
            f.classList.add('hidden');
            alert('‚ö†Ô∏è Kits festa e bolos grandes n√£o possuem entrega. Apenas retirada na loja.');
            return;
          }
          f.classList.remove('hidden');
        } else {
          f.classList.add('hidden');
        }
        try {
          const slot = document.getElementById('orderTimeSlot');
          if (slot) {
            if (e.target.value === 'entrega') { slot.min = '07:00'; slot.max = '18:00'; }
            else { slot.removeAttribute('min'); slot.removeAttribute('max'); }
          }
        } catch (e2) { }
        updateCheckoutFeeAndTotalFast();
      }
      if (e.target.name === 'payment') { const b = document.getElementById('moneyChangeBox'); if (e.target.value === 'dinheiro') b.classList.remove('hidden'); else b.classList.add('hidden'); updateCheckoutFeeAndTotalFast(); }
      if (['street', 'number', 'neighborhood', 'reference', 'customerPhone'].includes(e.target.id)) { updateCheckoutFeeAndTotalFast(); }

      // Busca autom√°tica de cliente
      if (e.target.id === 'customerName' || e.target.id === 'customerPhone') {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();

        if (name || phone) {
          const foundClient = searchClient(name, phone);
          if (foundClient) {
            currentSelectedClient = foundClient;
            const searchArea = document.getElementById('customerSearchArea');
            const foundInfo = document.getElementById('foundCustomerInfo');

            searchArea.classList.remove('hidden');
            foundInfo.innerHTML = `Nome: ${foundClient.name}<br>Telefone: ${foundClient.phone}`;

            // Show address confirmation UI when delivery is selected
            showClientAddressConfirmation(foundClient);

            // Preenche o nome completo se foi busca parcial
            if (name && foundClient.name.toLowerCase().includes(name.toLowerCase()) && foundClient.name !== name) {
              document.getElementById('customerName').value = foundClient.name;
            }
          } else {
            currentSelectedClient = null;
            document.getElementById('customerSearchArea').classList.add('hidden');
          }
        } else {
          currentSelectedClient = null;
          document.getElementById('customerSearchArea').classList.add('hidden');
        }

        // Check terms acceptance when phone changes
        if (e.target.id === 'customerPhone') {
          checkTermsAcceptance(phone);
        }
      }
    });
    document.getElementById('cancelCheckout')?.addEventListener('click', () => document.getElementById('checkoutModal').classList.add('hidden'));
    document.getElementById('confirmOrder')?.addEventListener('click', async () => {
      const warnings = document.getElementById('validationWarnings'); warnings.innerHTML = ''; warnings.classList.add('hidden');
      const payment = document.querySelector('input[name="payment"]:checked'); const delivery = document.querySelector('input[name="delivery"]:checked');

      // Validate customer data
      const customerName = document.getElementById('customerName')?.value?.trim();
      const customerPhone = document.getElementById('customerPhone')?.value?.trim();

      if (!customerName || !customerPhone) {
        showWarning('Preencha seu nome e telefone.'); return;
      }

      // Normaliza telefone para 11 d√≠gitos
      const normalizedPhone = customerPhone.replace(/\D/g, '');
      if (normalizedPhone.length !== 11) {
        showWarning('Informe um telefone v√°lido com DDD e 9 d√≠gitos. Ex: 73999348552.');
        document.getElementById('customerPhone')?.focus();
        return;
      }

      // Validate Terms of Use acceptance (required for new customers)
      const termsCheckbox = document.getElementById('acceptTermsCheckbox');
      if (termsCheckbox && !termsCheckbox.checked) {
        showWarning('Voc√™ precisa aceitar os Termos de Uso para continuar.');
        return;
      }

      if (!payment) { showWarning('Selecione uma forma de pagamento.'); return; }
      const minOrder = delivery && delivery.value === 'entrega' ? 15 : 8;
      if (cartTotal < minOrder) { showWarning(`Pedido m√≠nimo: R$ ${minOrder.toFixed(2).replace('.', ',')}`); return; }
      const containsKit = cart.some(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'kits'; });
      const containsBolo = cart.some(i => {
        const p = products.find(x => x.id === i.id);
        if (!p) return false;
        const name = p.name.toLowerCase();
        return p.category === 'bolos' || name.includes('bolo p') || name.includes('bolo g') || name.match(/bolo\s*[pg]/i);
      });
      const onlyBeverages = cart.every(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'bebidas'; });
      if (onlyBeverages && delivery && delivery.value === 'entrega') { showWarning('N√£o entregamos apenas refrigerantes. Adicione salgados ao pedido ou escolha retirada na loja.'); return; }
      if ((containsKit || containsBolo) && delivery && delivery.value === 'entrega') { showWarning('Kits festa e bolos grandes n√£o possuem entrega. Altere para retirada na loja.'); return; }
      if (!isFastOpen()) {
        const od = document.getElementById('orderDate').value;
        if (!od) { showWarning('Informe a data da encomenda.'); return; }
        const minDate = getMinEncomendaDateYYYYMMDD();
        if (od < minDate) { showWarning('Data da encomenda inv√°lida.'); return; }

        // Validate time slot selection
        const orderTimeSlot = document.getElementById('orderTimeSlot').value;
        if (!orderTimeSlot) { showWarning('Selecione um hor√°rio desejado.'); return; }

        // Valida√ß√£o de hor√°rio PARA ENTREGA E RETIRADA (faixa geral 07:00‚Äì18:00)
        const normalizedTimeSlot = orderTimeSlot.replace(/:/g, '');
        const timeAsNumber = parseInt(normalizedTimeSlot, 10);

        if (timeAsNumber < 700 || timeAsNumber > 1800) {
          const tipoMsg = delivery && delivery.value === 'entrega' ? 'entrega' : 'retirada';
          showWarning(`Para ${tipoMsg}, o hor√°rio permitido √© das 07:00 √†s 18:00.`);
          return;
        }

        // Valida√ß√£o de regras especiais para hor√°rio entre 7h‚Äì14h (delivery e retirada)
        const timeValidation = isOrderAllowedAtTime(orderTimeSlot, cartTotal, cart);
        if (!timeValidation.allowed) {
          showWarning(timeValidation.reason);
          return;
        }
      }
      function showWarning(txt) { const w = document.getElementById('validationWarnings'); w.innerHTML = `<div class='p-3 bg-red-100 border border-red-400 text-red-900 rounded-lg text-sm'>${txt}</div>`; w.classList.remove('hidden'); }

      // Gerar c√≥digo sequencial do pedido
      const { sequence: orderSequence, code: orderCode } = await generateOrderCode();
      const orderId = Date.now();

      let msg = `ü•ü *Pedido Fast Savory's*\n\n`;
      msg += `üßæ *C√≥digo:* ${orderCode}\n`;
      msg += `üë§ *Cliente:* ${customerName}\n`;
      msg += `üì± *Telefone:* ${customerPhone}\n\n`;

      msg += `üìã *Itens do Pedido:*\n`;
      cart.forEach(i => {
        const promotion = promotions.find(p => p.productId === i.id);
        let itemPrice = i.price;
        let discountText = '';

        if (promotion) {
          if (promotion.type === 'percentage') {
            itemPrice = i.price * (1 - promotion.value / 100);
            discountText = ` (-${promotion.value}%)`;
          } else {
            itemPrice = i.price - promotion.value;
            discountText = ` (-R$ ${promotion.value.toFixed(2).replace('.', ',')})`;
          }
        }

        msg += `${i.quantity}x ${i.name}${discountText} - R$ ${(itemPrice * i.quantity).toFixed(2).replace('.', ',')}\n`;
        if (i.note) {
          msg += `   üìù Obs: ${i.note}\n`;
        }
      });

      // Calculate discounts
      // NOTE: productDiscount is already applied in cart item prices when added
      // So we just calculate for display in WhatsApp message, not for subtraction
      let productDiscount = 0;
      cart.forEach(item => {
        const promotion = promotions.find(p => p.productId === item.id);
        if (promotion) {
          // Calculate original price vs discounted to show savings
          const originalPrice = products.find(p => p.id === item.id)?.price || item.price;
          if (promotion.type === 'percentage') {
            productDiscount += (originalPrice * item.quantity) * (promotion.value / 100);
          } else {
            productDiscount += promotion.value * item.quantity;
          }
        }
      });

      let clientDiscount = 0;
      // SPECIAL DISCOUNT LOGIC (Replacing old clientDiscount logic)
      const specialConfig = await SpecialDiscountService.getConfig();
      if (specialConfig && specialConfig.active) {
        const validOrderCount = await SpecialDiscountService.getValidOrderCount(normalizedPhone);
        const minOrders = specialConfig.min_orders || 10;
        const minVal = specialConfig.min_order_value || 0;

        // Check if eligible (Every X orders)
        // e.g. at 10, 20, 30...
        // If validOrderCount is 10, and user is making 11th order... NO.
        // Discount is usually given ON the 10th order? Or after 10?
        // "Faltam 2 pedidos".
        // If I have 9 orders. I make 10th. Do I get discount?
        // Usually loyalty programs give reward AFTER accumulated points.
        // So if I have 10 valid orders, I have a "reward" pending. 
        // Unless it's automatically applied on the 10th order?
        // Let's assume: When validOrderCount > 0 and validOrderCount % minOrders == 0.
        // This means I have exactly 10, 20, 30 past orders.
        // So this CURRENT order is the 11th, 21st... 
        // WAIT. 
        // If I have 9 orders. I place 10th. Count is still 9 (until this one is delivered).
        // If I need to complete 10 to get discount.
        // Then when count is 10, I get discount on the 11th.

        if (validOrderCount > 0 && (validOrderCount % minOrders === 0)) {
          if (cartTotal >= minVal) {
            const type = specialConfig.discount_type;
            const val = specialConfig.discount_value;

            if (type === 'percentage') {
              clientDiscount = (cartTotal - productDiscount) * (val / 100);
            } else {
              clientDiscount = val;
            }
            // Cap discount?
            clientDiscount = Math.min(clientDiscount, (cartTotal - productDiscount));
          }
        }
      } else if (customerPhone && clientDiscounts[customerPhone]) {
        // Fallback to manual per-client discount if configured and special discount inactive
        clientDiscount = (cartTotal - productDiscount) * (clientDiscounts[customerPhone] / 100);
      }

      // Birthday discount (10% - once per year, only on birthday)
      let birthdayDiscount = 0;
      let hasBirthdayDiscount = false;
      const clientForBdayDiscount = clients.find(c => c.phone === customerPhone);
      if (clientForBdayDiscount && isTodayBirthday(clientForBdayDiscount.birthdate)) {
        // Check if already used this year (synchronous check via localStorage fallback)
        const currentYear = new Date().getFullYear();
        const usageKey = `birthdayDiscount_${customerPhone}_${currentYear}`;
        const alreadyUsed = localStorage.getItem(usageKey) === 'used';

        if (!alreadyUsed) {
          birthdayDiscount = (cartTotal - productDiscount - clientDiscount) * 0.10;
          hasBirthdayDiscount = true;
        }
      }

      // taxas
      let deliveryFeeMsg = 0;
      let cardFeeMsg = 0;
      if (delivery && delivery.value === 'entrega') {
        const nb = document.getElementById('neighborhood').value; if (!nb) { showWarning('Preencha o endere√ßo.'); return; }
        if (!isFastDeliveryAllowed(nb)) { showWarning('Para sua localidade n√£o h√° entrega dispon√≠vel. Selecione Retirada na loja.'); return; }
        const f = calcFastDeliveryFee(nb);
        if (f > 0) { msg += `Taxa de entrega: R$ ${f.toFixed(2).replace('.', ',')}\n`; deliveryFeeMsg = f; }
        else if (f === 0) { msg += `Taxa de entrega: Gr√°tis\n`; }
        else { msg += `Taxa de entrega: Consulte valor de entrega\n`; }
      }
      // Card fees using configurable rates
      if (payment.value === 'cartao1x') {
        cardFeeMsg = cartTotal * (storeConfig.card_fee_1x / 100);
        msg += `Taxa cart√£o (1x - ${storeConfig.card_fee_1x}%): R$ ${cardFeeMsg.toFixed(2).replace('.', ',')}\n`;
      }

      // Show discounts in message
      if (productDiscount > 0) {
        msg += `Desconto produtos: -R$ ${productDiscount.toFixed(2).replace('.', ',')}\n`;
      }
      if (clientDiscount > 0) {
        msg += `Desconto fidelidade: -R$ ${clientDiscount.toFixed(2).replace('.', ',')}\n`;
      }
      if (birthdayDiscount > 0) {
        msg += `üéÇ Desconto Aniversariante (10%): -R$ ${birthdayDiscount.toFixed(2).replace('.', ',')}\n`;
      }

      // Coupon discount
      let couponDiscountMsg = 0;
      let appliedCouponCode = null;
      if (appliedCoupon) {
        const validCoupon = findValidCouponByCode(appliedCoupon.code);
        if (validCoupon && (!validCoupon.minOrder || cartTotal >= validCoupon.minOrder)) {
          const baseForCoupon = cartTotal - productDiscount - clientDiscount - birthdayDiscount;
          couponDiscountMsg = computeCouponDiscount(baseForCoupon, validCoupon);
          appliedCouponCode = validCoupon.code;
          if (couponDiscountMsg > 0) {
            msg += `üéüÔ∏è Cupom (${validCoupon.code}): -R$ ${couponDiscountMsg.toFixed(2).replace('.', ',')}\n`;
          }
        }
      }

      const totalWithFees = cartTotal + deliveryFeeMsg + cardFeeMsg - productDiscount - clientDiscount - birthdayDiscount - couponDiscountMsg;
      msg += `\n*Total: R$ ${totalWithFees.toFixed(2).replace('.', ',')}*\n\n`;
      const paymentMap = { dinheiro: 'üíµ Dinheiro', cartao1x: 'üí≥ Cart√£o 1x', pix: 'üì± PIX' }; msg += `*Pagamento:* ${paymentMap[payment.value] || payment.value}\n`;
      // Aviso especial para pagamento em cart√£o
      if (payment.value === 'cartao1x') {
        msg += `\nüí≥ *IMPORTANTE:* O link de pagamento em cart√£o ser√° enviado ap√≥s a Fast Savory's aceitar seu pedido.\n`;
        msg += `Aguarde nosso retorno com o link de pagamento.\n`;
      }
      if (payment.value === 'dinheiro') { const ch = parseFloat(document.getElementById('moneyChangeValue').value || '0'); if (ch > 0) { msg += `*Troco para:* R$ ${ch.toFixed(2).replace('.', ',')}\n`; } }
      if (delivery.value === 'retirada') { msg += `*Entrega:* üè™ Retirada na loja\n`; }
      else {
        const s = document.getElementById('street').value; const n = document.getElementById('number').value; const nb = document.getElementById('neighborhood').value; const r = document.getElementById('reference').value; if (!s || !n || !nb) { alert('Preencha o endere√ßo.'); return; }
        msg += `*Entrega:* üöö Delivery\n*Endere√ßo:* ${s}, ${n} - ${nb}\n`;
        if (r) msg += `*Refer√™ncia:* ${r}\n`;
      }
      if (!isFastOpen()) {
        const od = document.getElementById('orderDate').value;
        const ot = document.getElementById('orderTimeSlot').value;
        if (!od) { alert('Selecione a data da encomenda.'); return; }
        if (!ot) { alert('Selecione o hor\u00e1rio desejado.'); return; }
        msg += `\n\u26a0\ufe0f *Encomenda:* Pedido fora do hor\u00e1rio. Antec\u00eadencia m\u00ednima de 1 dia e 50% de entrada.\n*Data da encomenda:* ${od}\n*Hor\u00e1rio:* ${ot}\n`;
      }
      msg += `\n‚ö†Ô∏è *Este pedido s√≥ ser√° v√°lido ap√≥s a confirma√ß√£o da Fast Savory's.*\n\n`;
      msg += `üîç *Acompanhar pedido:* ${buildTrackingLink(orderCode, customerPhone)}\n\n`;
      msg += `üìû *Contato:* (73) 99936-6554\n\nObrigado pelo seu pedido! üòä`;

      // Save client if not exists
      const existingClient = clients.find(c => c.phone === customerPhone);
      if (!existingClient) {
        // Auto-register client with minimal data
        const newClient = {
          id: Date.now(), // Generate unique ID for Supabase
          name: customerName,
          phone: customerPhone,
          birthdate: '', // Empty - will ask in modal
          email: '',
          addresses: []
        };
        clients.push(newClient);
        saveClients(); // Async but don't need to await
      }

      // Save address to client if it's a new address (for delivery orders)
      if (delivery.value === 'entrega') {
        const newAddress = {
          label: document.getElementById('addressLabel')?.value || 'Casa',
          street: document.getElementById('street').value,
          number: document.getElementById('number').value,
          neighborhood: document.getElementById('neighborhood').value,
          reference: document.getElementById('reference').value
        };

        // Save to AddressService (localStorage) if checkbox is checked
        const saveCheckbox = document.getElementById('saveAddressCheckbox');
        if (saveCheckbox?.checked && newAddress.street && newAddress.number && newAddress.neighborhood) {
          AddressService.save(customerPhone, newAddress);
        }

        // Find and update client with this address (legacy)
        const clientToUpdate = clients.find(c => c.phone === customerPhone);
        if (clientToUpdate) {
          const addresses = clientToUpdate.addresses || [];
          // Check if this address already exists
          const addressExists = addresses.some(a =>
            a.street === newAddress.street &&
            a.number === newAddress.number &&
            a.neighborhood === newAddress.neighborhood
          );
          if (!addressExists && newAddress.street && newAddress.number && newAddress.neighborhood) {
            addresses.push(newAddress);
            clientToUpdate.addresses = addresses;
            saveClients();
          }
        }
      }

      // Save order to Supabase for analytics
      const orderData = {
        id: orderId,
        order_sequence: orderSequence,
        order_code: orderCode,
        client_name: customerName,
        client_phone: customerPhone,
        items: cart.map(i => ({
          id: i.id,
          name: i.name,
          price: i.price,
          quantity: i.quantity
        })),
        subtotal: cartTotal,
        delivery_fee: deliveryFeeMsg,
        card_fee: cardFeeMsg,
        discount: productDiscount + clientDiscount + birthdayDiscount + couponDiscountMsg,
        coupon_code: appliedCouponCode,
        coupon_discount: couponDiscountMsg,
        total: totalWithFees,
        payment_method: payment.value,
        delivery_type: delivery.value,
        address: delivery.value === 'entrega' ? {
          street: document.getElementById('street').value,
          number: document.getElementById('number').value,
          neighborhood: document.getElementById('neighborhood').value,
          reference: document.getElementById('reference').value
        } : null,
        scheduled_date: !isFastOpen() ? document.getElementById('orderDate').value : null,
        status: 'pending'
      };

      // Check if client needs birthday registration
      const clientForBirthday = clients.find(c => c.phone === customerPhone);
      const needsBirthdayRegistration = !clientForBirthday || !clientForBirthday.birthdate || clientForBirthday.birthdate === '' || clientForBirthday.birthdate === formatYYYYMMDD(getBrasiliaDate());

      if (needsBirthdayRegistration) {
        // Store pending order and show birthday modal
        pendingOrderData = orderData;
        pendingWhatsAppMessage = msg;
        showBirthdayModal();
      } else {
        // Client has birthdate - proceed directly
        await saveOrderToSupabase(orderData);

        // Record birthday discount usage if applied
        if (hasBirthdayDiscount && customerPhone) {
          recordBirthdayDiscountUsage(customerPhone, birthdayDiscount, orderData.id);
        }

        // Mark coupon as used for this phone (single-use per client)
        if (appliedCoupon && appliedCoupon.code && customerPhone) {
          await CouponUsageService.markUsed(customerPhone, appliedCoupon.code, orderData.id);
        }

        // Salvar no hist√≥rico local para recompra r√°pida
        const orderForHistory = {
          id: Date.now().toString(),
          createdAt: new Date().toISOString(),
          items: cart.map(i => ({
            productId: i.id,
            name: i.name,
            price: i.price,
            quantity: i.quantity,
            category: products.find(p => p.id === i.id)?.category || ''
          })),
          total: totalWithFees,
          isEncomenda: !isFastOpen(),
          deliveryType: delivery.value,
          neighborhood: document.getElementById('neighborhood').value || '',
          encomendaDate: !isFastOpen() ? document.getElementById('orderDate').value : null,
          encomendaSlot: !isFastOpen() ? document.getElementById('orderTimeSlot').value : null,
          notes: ''
        };
        saveOrderToHistory(customerPhone, orderForHistory);
        localStorage.setItem('fastLastPhone', customerPhone);
        currentClientPhone = customerPhone;

        const number = '5573999366554';
        const url = `https://wa.me/${number}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank', 'noopener,noreferrer');

        // Limpar dados do checkout ap√≥s envio
        clearCheckoutData();
        clearAppliedCoupon();

        // Mark terms as accepted for this phone for future orders
        TermsAcceptanceService.markAccepted(customerPhone);

        cart = []; updateCart(); document.getElementById('checkoutModal').classList.add('hidden');
        showInlineMessage('publicStore', '‚úÖ Pedido enviado para o WhatsApp!', 'success');
      }
    });

    // Fun√ß√£o para limpar dados do checkout
    function clearCheckoutData() {
      // Limpa campos do cliente
      document.getElementById('customerName').value = '';
      document.getElementById('customerPhone').value = '';

      // Esconde √°rea de busca de cliente
      document.getElementById('customerSearchArea').classList.add('hidden');
      currentSelectedClient = null;

      // Limpa campos de endere√ßo
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';
      document.getElementById('addressForm').classList.add('hidden');

      // Limpa campos de pagamento
      document.querySelectorAll('input[name="payment"]').forEach(input => input.checked = false);
      document.getElementById('moneyChangeValue').value = '';
      document.getElementById('moneyChangeBox').classList.add('hidden');

      // Limpa campos de entrega
      document.querySelector('input[name="delivery"][value="retirada"]').checked = true;
      document.getElementById('addressForm').classList.add('hidden');

      // Limpa data de encomenda
      document.getElementById('orderDate').value = '';
      document.getElementById('orderDateBox').classList.add('hidden');
      document.getElementById('encomendaWarning').classList.add('hidden');

      // Limpa avisos de valida√ß√£o
      document.getElementById('validationWarnings').innerHTML = '';
      document.getElementById('validationWarnings').classList.add('hidden');
    }

    // ===========================================
    // ADDRESS CONFIRMATION EVENT HANDLERS
    // ===========================================

    function showClientAddressConfirmation(client) {
      const savedAddressSection = document.getElementById('savedAddressSection');
      const noAddressSection = document.getElementById('noAddressSection');
      const savedAddressText = document.getElementById('savedAddressText');

      // Guard clause: se os elementos n√£o existirem nesse contexto, n√£o faz nada
      if (!savedAddressSection || !noAddressSection || !savedAddressText) {
        return;
      }

      const hasAddresses = client && Array.isArray(client.addresses) && client.addresses.length > 0;

      if (hasAddresses) {
        const addr = client.addresses[0];

        const street = addr.street || '';
        const number = addr.number || '';
        const neighborhood = addr.neighborhood || '';
        const reference = addr.reference || '';

        const addressText = `${street}, ${number} - ${neighborhood}${reference ? ` (Ref: ${reference})` : ''}`.trim();
        savedAddressText.textContent = addressText;
        savedAddressSection.classList.remove('hidden');
        noAddressSection.classList.add('hidden');
      } else if (client && client.address) {
        // Old format: single address string
        savedAddressText.textContent = client.address;
        savedAddressSection.classList.remove('hidden');
        noAddressSection.classList.add('hidden');
      } else {
        // No saved address
        savedAddressSection.classList.add('hidden');
        noAddressSection.classList.remove('hidden');
      }
    }

    // Confirm saved address button
    document.getElementById('confirmSavedAddress')?.addEventListener('click', () => {
      if (!currentSelectedClient) return;

      const addresses = currentSelectedClient.addresses || [];
      const defaultAddress = addresses[0];
      if (defaultAddress) {
        document.getElementById('street').value = defaultAddress.street;
        document.getElementById('number').value = defaultAddress.number;
        document.getElementById('neighborhood').value = defaultAddress.neighborhood;
        document.getElementById('reference').value = defaultAddress.reference || '';

        // Hide address form since address is already confirmed
        document.getElementById('addressForm').classList.add('hidden');
        document.getElementById('savedAddressSection').innerHTML = `
          <div class="bg-green-100 border border-green-300 rounded-lg p-2">
            <p class="text-sm text-green-800 font-medium">‚úì Endere√ßo confirmado!</p>
            <p class="text-xs text-green-700">${defaultAddress.street}, ${defaultAddress.number} - ${defaultAddress.neighborhood}</p>
          </div>
        `;

        // Update delivery type to delivery
        document.querySelector('input[name="delivery"][value="entrega"]').checked = true;
        updateCheckoutFeeAndTotalFast();
      }
    });

    // Use different address button
    document.getElementById('useDifferentAddress')?.addEventListener('click', () => {
      // Clear current address fields
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';

      // Show address form
      document.getElementById('addressForm').classList.remove('hidden');

      // Update delivery type to delivery
      document.querySelector('input[name="delivery"][value="entrega"]').checked = true;
    });

    // ===========================================
    // BIRTHDAY MODAL EVENT HANDLERS
    // ===========================================

    let pendingOrderData = null;
    let pendingWhatsAppMessage = null;

    function showBirthdayModal() {
      // Reset modal to step 1
      document.getElementById('birthdayStep1').classList.remove('hidden');
      document.getElementById('birthdayStep2').classList.add('hidden');
      document.getElementById('birthdayDateInput').value = '';
      document.getElementById('birthdayModal').classList.remove('hidden');
    }

    function hideBirthdayModal() {
      document.getElementById('birthdayModal').classList.add('hidden');
    }

    function proceedWithOrder() {
      if (!pendingOrderData || !pendingWhatsAppMessage) return;

      // Save order to Supabase
      saveOrderToSupabase(pendingOrderData);

      // Record birthday discount usage if applied
      if (pendingOrderData.birthday_discount && pendingOrderData.birthday_discount > 0 && pendingOrderData.client_phone) {
        recordBirthdayDiscountUsage(pendingOrderData.client_phone, pendingOrderData.birthday_discount, pendingOrderData.id);
      }

      // Open WhatsApp
      const number = '5573999366554';
      const url = `https://wa.me/${number}?text=${encodeURIComponent(pendingWhatsAppMessage)}`;
      window.open(url, '_blank', 'noopener,noreferrer');

      // Clear checkout
      clearCheckoutData();
      clearAppliedCoupon();
      cart = [];
      updateCart();
      document.getElementById('checkoutModal').classList.add('hidden');
      hideBirthdayModal();
      showInlineMessage('publicStore', '‚úÖ Pedido enviado para o WhatsApp!', 'success');

      // Clear pending data
      pendingOrderData = null;
      pendingWhatsAppMessage = null;
    }

    // Birthday Yes button - show date picker
    document.getElementById('birthdayYes')?.addEventListener('click', () => {
      document.getElementById('birthdayStep1').classList.add('hidden');
      document.getElementById('birthdayStep2').classList.remove('hidden');
    });

    // Birthday No button - send order without registration
    document.getElementById('birthdayNo')?.addEventListener('click', () => {
      proceedWithOrder();
    });

    // Save birthday and send order
    document.getElementById('saveBirthdaySend')?.addEventListener('click', async () => {
      const birthdayDate = document.getElementById('birthdayDateInput').value;
      const customerPhone = document.getElementById('customerPhone')?.value?.trim();

      if (birthdayDate && customerPhone) {
        // Find and update client
        const clientIndex = clients.findIndex(c => c.phone === customerPhone);
        if (clientIndex !== -1) {
          clients[clientIndex].birthdate = birthdayDate;
          await saveClients();
        }
      }

      proceedWithOrder();
    });

    // Fees (Fast)
    function readFastFees() { try { return JSON.parse(localStorage.getItem('fastDeliveryFees') || '{}'); } catch { return {}; } }
    function writeFastFees(m) { localStorage.setItem('fastDeliveryFees', JSON.stringify(m)); }
    function calcFastDeliveryFee(nei) {
      const n = norm(nei);
      const cfg = readFastFees();
      const val = cfg[n];
      if (val !== undefined && val !== "") {
        if (typeof val === 'number') return val;
        if (typeof val === 'object') return val.fee;
        const v = parseFloat(val);
        if (!isNaN(v)) return v;
      }
      return -1;
    }

    function getFastMinOrderValue(nei) {
      if (!nei) return 0;
      const n = norm(nei);
      const cfg = readFastFees();
      const val = cfg[n];
      if (val && typeof val === 'object' && val.min) {
        return val.min;
      }
      return 0;
    }

    // Load fees from Supabase on startup to sync between devices
    async function loadFeesFromSupabase() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_delivery_fees')
          .select('*');

        if (error) throw error;

        if (data && data.length > 0) {
          // Verify if column exists
          const sample = data[0];
          if (sample.min_order_value === undefined) {
            console.error('CRITICAL: min_order_value column missing in DB!');
            alert('ATEN√á√ÉO: A coluna "min_order_value" n√£o foi encontrada no banco de dados.\n\nPor favor, execute o script de migra√ß√£o no Supabase SQL Editor para corrigir o erro ao salvar.');
          }

          const feesObj = {};
          data.forEach(row => {
            feesObj[row.neighborhood] = {
              fee: row.fee,
              min: row.min_order_value || 0
            };
          });
          writeFastFees(feesObj);
          console.log('Taxas carregadas do Supabase:', Object.keys(feesObj).length, 'bairros');
        }
      } catch (error) {
        console.error('Erro ao carregar taxas do Supabase (usando localStorage):', error);
      }
    }
    // Call on load
    loadFeesFromSupabase();
    function updateCheckoutFeeAndTotalFast() {
      // Recalc subtotal
      cartTotal = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
      const delivery = document.querySelector('input[name="delivery"]:checked');
      const payment = document.querySelector('input[name="payment"]:checked');
      const customerPhone = document.getElementById('customerPhone')?.value?.trim();
      let deliveryFee = 0;
      const deliveryRow = document.getElementById('deliveryFeeRowFast');

      const confirmBtn = document.getElementById('confirmOrder');
      const warningBox = document.getElementById('validationWarnings');

      if (delivery && delivery.value === 'entrega') {
        const nb = document.getElementById('neighborhood').value;
        if (nb) {
          const f = calcFastDeliveryFee(nb);
          const minOrder = getFastMinOrderValue(nb);

          if (f >= 0) {
            deliveryFee = f;
            document.getElementById('checkoutDeliveryFeeFast').textContent = `R$ ${f.toFixed(2).replace('.', ',')}`;

            if (minOrder > 0 && cartTotal < minOrder) {
              warningBox.innerHTML = `<div class='p-3 bg-red-100 border border-red-400 text-red-900 rounded-lg text-sm'>
                 Pedido m√≠nimo para <strong>${nb}</strong> √© <strong>R$ ${minOrder.toFixed(2).replace('.', ',')}</strong>.<br>
                 Faltam R$ ${(minOrder - cartTotal).toFixed(2).replace('.', ',')} para liberar a entrega.
               </div>`;
              warningBox.classList.remove('hidden');
              confirmBtn.disabled = true;
              confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
              if (warningBox.innerHTML.includes('Pedido m√≠nimo')) {
                warningBox.classList.add('hidden');
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              }
            }
          } else {
            document.getElementById('checkoutDeliveryFeeFast').textContent = 'Consulte';
          }
          deliveryRow.classList.remove('hidden');
        } else {
          deliveryRow.classList.add('hidden');
        }
      } else {
        deliveryRow.classList.add('hidden');
        if (confirmBtn.classList.contains('cursor-not-allowed')) {
          confirmBtn.disabled = false;
          confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          if (warningBox.innerHTML.includes('Pedido m√≠nimo')) warningBox.classList.add('hidden');
        }
      }

      let cardFee = 0;
      const cardRow = document.getElementById('cardFeeRowFast');
      if (payment && payment.value === 'cartao1x') {
        cardFee = cartTotal * (storeConfig.card_fee_1x / 100);
        document.getElementById('checkoutCardFeeFast').textContent = `R$ ${cardFee.toFixed(2).replace('.', ',')}`;
        cardRow.classList.remove('hidden');
      }
      else {
        cardRow.classList.add('hidden');
      }

      // NOTE: Product promotions are ALREADY applied to cart item prices when added
      // So cartTotal already reflects discounted prices - we just show info, don't subtract again
      let productDiscount = 0;
      cart.forEach(item => {
        const promotion = promotions.find(p => p.productId === item.id);
        if (promotion) {
          // Calculate savings for display only (original price - discounted price)
          const originalProduct = products.find(p => p.id === item.id);
          if (originalProduct) {
            const originalPrice = originalProduct.price;
            const discountPerItem = originalPrice - item.price;
            productDiscount += discountPerItem * item.quantity;
          }
        }
      });

      // Calculate client discount (Special Discount OR Manual)
      // Client discount applies to cartTotal (which already has promo discounts)
      let clientDiscount = 0;
      if (currentSpecialDiscount && currentSpecialDiscount.active) {
        const minVal = currentSpecialDiscount.min_order_value || 0;
        if (cartTotal >= minVal) {
          if (currentSpecialDiscount.discount_type === 'percentage') {
            clientDiscount = cartTotal * (currentSpecialDiscount.discount_value / 100);
          } else {
            clientDiscount = currentSpecialDiscount.discount_value;
          }
          // Cap discount
          clientDiscount = Math.min(clientDiscount, cartTotal);
        }
      } else if (customerPhone && clientDiscounts[customerPhone]) {
        clientDiscount = cartTotal * (clientDiscounts[customerPhone] / 100);
      }

      // Update discount rows
      const productDiscountRow = document.getElementById('productDiscountRow');
      const clientDiscountRow = document.getElementById('clientDiscountRow');

      // Show product discount info (savings from promos - already in cart prices)
      if (productDiscount > 0) {
        if (!productDiscountRow) {
          const checkoutTotal = document.getElementById('checkoutTotal').parentElement;
          const newRow = document.createElement('div');
          newRow.id = 'productDiscountRow';
          newRow.className = 'flex justify-between text-sm mb-1 text-green-600';
          newRow.innerHTML = '<span>Economia promo√ß√µes:</span><span id="productDiscountValue">R$ 0,00</span>';
          checkoutTotal.insertBefore(newRow, checkoutTotal.querySelector('.border-t'));
        }
        document.getElementById('productDiscountValue').textContent = `R$ ${productDiscount.toFixed(2).replace('.', ',')}`;
      } else if (productDiscountRow) {
        productDiscountRow.remove();
      }

      if (clientDiscount > 0) {
        if (!clientDiscountRow) {
          const checkoutTotal = document.getElementById('checkoutTotal').parentElement;
          const newRow = document.createElement('div');
          newRow.id = 'clientDiscountRow';
          newRow.className = 'flex justify-between text-sm mb-1 text-green-600';
          newRow.innerHTML = '<span>Desconto fidelidade:</span><span id="clientDiscountValue">R$ 0,00</span>';
          checkoutTotal.insertBefore(newRow, checkoutTotal.querySelector('.border-t'));
        }
        document.getElementById('clientDiscountValue').textContent = `R$ ${clientDiscount.toFixed(2).replace('.', ',')}`;
      } else if (clientDiscountRow) {
        clientDiscountRow.remove();
      }

      // Calculate coupon discount
      let couponDiscount = 0;
      const couponDiscountRow = document.getElementById('couponDiscountRow');
      if (appliedCoupon) {
        // Check if any cart item has a promotion - if so, coupon doesn't apply to those
        const hasPromoItems = cart.some(item => promotions.find(p => p.productId === item.id));

        const validCoupon = findValidCouponByCode(appliedCoupon.code);
        if (!validCoupon) {
          clearAppliedCoupon();
          setCouponMessage('O cupom ficou indispon√≠vel.', 'error');
        } else if (validCoupon.minOrder && cartTotal < validCoupon.minOrder) {
          clearAppliedCoupon();
          setCouponMessage('Cupom removido: pedido abaixo do m√≠nimo.', 'error');
        } else if (hasPromoItems && validCoupon.code !== 'ANIVERSARIO') {
          // Products with promotions can't use coupons (except birthday)
          clearAppliedCoupon();
          setCouponMessage('Cupom n√£o acumula com produtos em promo√ß√£o.', 'error');
        } else {
          appliedCoupon = validCoupon;
          const baseForCoupon = cartTotal - clientDiscount;
          couponDiscount = computeCouponDiscount(baseForCoupon, appliedCoupon);

          if (couponDiscount > 0) {
            if (!couponDiscountRow) {
              const checkoutTotal = document.getElementById('checkoutTotal').parentElement;
              const totalRow = checkoutTotal.querySelector('.font-semibold');
              const newRow = document.createElement('div');
              newRow.id = 'couponDiscountRow';
              newRow.className = 'flex justify-between text-sm mb-1 text-green-600';
              newRow.innerHTML = '<span>Desconto cupom:</span><span id="couponDiscountValue">R$ 0,00</span>';
              if (totalRow) checkoutTotal.insertBefore(newRow, totalRow);
              else checkoutTotal.appendChild(newRow);
            }
            document.getElementById('couponDiscountValue').textContent = `-R$ ${couponDiscount.toFixed(2).replace('.', ',')}`;
          }
        }
      } else if (couponDiscountRow) {
        couponDiscountRow.remove();
      }

      // Total: cartTotal already has product discounts, so only subtract client and coupon discounts
      const total = cartTotal + (isNaN(deliveryFee) ? 0 : deliveryFee) + cardFee - clientDiscount - couponDiscount;
      document.getElementById('checkoutTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    // Fees modal UI
    function openFeesFastModal() { const modal = document.getElementById('feesModalFast'); if (modal) { modal.classList.remove('hidden'); renderFastFeesList(); } }
    function closeFeesFastModal() { const modal = document.getElementById('feesModalFast'); if (modal) { modal.classList.add('hidden'); } }
    function renderFastFeesList() { const list = document.getElementById('feesListFast'); if (!list) return; const m = readFastFees(); const entries = Object.entries(m).sort((a, b) => a[1] - b[1] || a[0].localeCompare(b[0])); list.innerHTML = entries.length ? entries.map(([k, v]) => `<div class='flex items-center justify-between py-2 border-b'><div class='flex-1'><span class='font-medium capitalize text-gray-900'>${k}</span></div><input data-k='${k}' class='w-24 px-2 py-1 border rounded text-right' value='${v}'/><button data-del='${k}' class='ml-3 text-red-600 text-sm hover:text-red-800'>Excluir</button></div>`).join('') : `<p class='text-sm text-gray-600'>Nenhum bairro cadastrado.</p>`; }
    document.getElementById('openFeesFast')?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openFeesFastModal(); });
    document.getElementById('closeFeesFast')?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); closeFeesFastModal(); });
    document.getElementById('addFeeFast')?.addEventListener('click', (e) => { e.preventDefault(); const b = document.getElementById('feeNeighborhoodFast').value.trim(); const v = parseFloat(document.getElementById('feeValueFast').value.replace(',', '.')); if (!b || isNaN(v)) { alert('Preencha bairro e valor.'); return; } const m = readFastFees(); m[norm(b)] = v; writeFastFees(m); document.getElementById('feeNeighborhoodFast').value = ''; document.getElementById('feeValueFast').value = ''; renderFastFeesList(); });
    // saveAllFeesFast listener movido para final do arquivo para incluir l√≥gica de sincroniza√ß√£o com Supabase
    document.getElementById('feesListFast')?.addEventListener('click', (e) => { if (e.target.dataset.del) { e.preventDefault(); const m = readFastFees(); delete m[e.target.dataset.del]; writeFastFees(m); renderFastFeesList(); } });
    document.getElementById('feesListFast')?.addEventListener('change', (e) => { if (e.target.dataset.k) { const m = readFastFees(); const val = parseFloat(e.target.value.replace(',', '.')); if (!isNaN(val)) { m[e.target.dataset.k] = val; writeFastFees(m); } } });

    // Panel Navigation (Fast Admin)
    function showPanel(panelName) {
      const panels = ['productsPanelFast', 'clientsPanelFast', 'promotionsPanelFast', 'configPanelFast', 'reportsPanelFast', 'ordersPanelFast', 'ratingsPanelFast', 'bannerPanelFast'];
      panels.forEach(p => {
        const el = document.getElementById(p);
        if (el) el.classList.toggle('hidden', p !== panelName);
      });
      // Auto-load orders when opening orders panel
      if (panelName === 'ordersPanelFast') {
        loadDashboardOrders();
      }
    }

    // ========================================
    // ORDER DASHBOARD MANAGEMENT
    // ========================================
    const ORDER_STATUS = {
      PENDING: 'pending',
      PREPARING: 'preparing',
      CONFIRMED: 'confirmed',
      DELIVERED: 'delivered',
      CANCELLED: 'cancelled'
    };

    const STATUS_LABELS = {
      'pending': { emoji: 'üÜï', label: 'Recebido', color: 'blue' },
      'accepted': { emoji: '‚úÖ', label: 'Aceito', color: 'purple' },
      'preparing': { emoji: 'üç≥', label: 'Em Preparo', color: 'yellow' },
      'confirmed': { emoji: '‚úÖ', label: 'Pronto', color: 'green' },
      'delivered': { emoji: '‚úîÔ∏è', label: 'Entregue', color: 'gray' },
      'cancelled': { emoji: '‚ùå', label: 'Cancelado', color: 'red' }
    };

    const PAYMENT_STATUS_LABELS = {
      'pending': { emoji: '‚è≥', label: 'Pendente', color: 'gray' },
      'awaiting_payment': { emoji: 'üí≥', label: 'Aguardando Pgto', color: 'yellow' },
      'paid_partial': { emoji: 'üí∞', label: 'Entrada Paga (50%)', color: 'orange' },
      'paid_full': { emoji: '‚úÖ', label: 'Pago Total', color: 'green' },
      'cash': { emoji: 'üíµ', label: 'Dinheiro', color: 'green' },
      'pix': { emoji: 'üì±', label: 'PIX', color: 'green' }
    };

    async function loadDashboardOrders() {
      const container = document.getElementById('ordersListContainer');
      const dateFilter = document.getElementById('ordersFilterDate')?.value || 'today';
      const statusFilter = document.getElementById('ordersFilterStatus')?.value || 'all';

      try {
        // Calculate date range
        const now = new Date();
        let startDate = null, endDate = null;

        if (dateFilter === 'today') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
        } else if (dateFilter === 'yesterday') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).toISOString();
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        } else if (dateFilter === 'week') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7).toISOString();
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
        } else if (dateFilter === 'month') {
          startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
        }
        // dateFilter === 'all' -> startDate e endDate ficam null

        // Fetch from Supabase
        let query = window.supabaseClient
          .from('fast_orders')
          .select('*')
          .order('created_at', { ascending: false });

        // Aplicar filtro de data apenas se n√£o for "all"
        if (startDate && endDate) {
          query = query.gte('created_at', startDate).lt('created_at', endDate);
        }

        if (statusFilter !== 'all') {
          query = query.eq('status', statusFilter);
        }

        const { data: orders, error } = await query;
        if (error) throw error;

        // Update stats
        updateOrderStats(orders || []);

        // Update KPIs dashboard
        updateKPIsDashboard(orders || [], dateFilter);

        // Render orders
        renderDashboardOrders(orders || []);

      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        container.innerHTML = `<div class="text-center py-8 text-red-500">
          <p class="text-4xl mb-2">‚ö†Ô∏è</p>
          <p>Erro ao carregar pedidos. Verifique o console.</p>
        </div>`;
      }
    }

    function updateOrderStats(orders) {
      const counts = {
        pending: 0, preparing: 0, confirmed: 0,
        delivered: 0, cancelled: 0
      };

      orders.forEach(o => {
        if (counts[o.status] !== undefined) counts[o.status]++;
      });

      document.getElementById('ordersCountNew').textContent = counts.pending;
      document.getElementById('ordersCountPreparing').textContent = counts.preparing;
      document.getElementById('ordersCountReady').textContent = counts.confirmed;
      document.getElementById('ordersCountDelivery').textContent = 0;
      document.getElementById('ordersCountDelivered').textContent = counts.delivered;
      document.getElementById('ordersCountCanceled').textContent = counts.cancelled;
    }

    function updateKPIsDashboard(orders, dateFilter) {
      try {
        // Filtrar apenas pedidos pagos/entregues para faturamento
        // Status v√°lidos: delivered (entregue) ou com payment_status pago
        const paidOrders = orders.filter(o =>
          o.status === 'delivered' ||
          o.payment_status === 'paid' ||
          o.payment_status === 'paid_full'
        );

        // Pedidos v√°lidos (n√£o cancelados) para outras m√©tricas
        const validOrders = orders.filter(o => o.status !== 'cancelled');

        // Faturamento total (apenas pedidos pagos/entregues)
        const faturamento = paidOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        document.getElementById('kpiFaturamento').textContent = `R$ ${faturamento.toFixed(2).replace('.', ',')}`;

        // Total de pedidos
        document.getElementById('kpiTotalPedidos').textContent = orders.length;

        // Ticket m√©dio
        const ticketMedio = validOrders.length > 0 ? faturamento / validOrders.length : 0;
        document.getElementById('kpiTicketMedio').textContent = `R$ ${ticketMedio.toFixed(2).replace('.', ',')}`;

        // Maior pedido
        const maiorPedido = validOrders.length > 0 ? Math.max(...validOrders.map(o => o.total || 0)) : 0;
        document.getElementById('kpiMaiorPedido').textContent = `R$ ${maiorPedido.toFixed(2).replace('.', ',')}`;

        // Label do per√≠odo
        const periodLabels = {
          today: 'hoje',
          yesterday: 'ontem',
          week: 'na semana',
          month: 'no m√™s',
          all: 'total'
        };
        const periodLabel = periodLabels[dateFilter] || 'no per√≠odo';
        document.getElementById('kpiFaturamentoLabel')?.setAttribute('textContent', periodLabel);
        document.getElementById('kpiPedidosLabel')?.setAttribute('textContent', periodLabel);
        if (document.getElementById('kpiFaturamentoLabel')) {
          document.getElementById('kpiFaturamentoLabel').textContent = periodLabel;
        }
        if (document.getElementById('kpiPedidosLabel')) {
          document.getElementById('kpiPedidosLabel').textContent = periodLabel;
        }
      } catch (e) {
        console.warn('[KPIs] Erro ao atualizar dashboard:', e);
      }
    }

    function renderDashboardOrders(orders) {
      const container = document.getElementById('ordersListContainer');

      if (orders.length === 0) {
        container.innerHTML = `<div class="text-center py-12 text-gray-500">
          <p class="text-5xl mb-3">üì¶</p>
          <p class="font-medium">Nenhum pedido encontrado</p>
          <p class="text-sm">Os pedidos aparecer√£o aqui quando forem feitos.</p>
        </div>`;
        return;
      }

      container.innerHTML = orders.map(order => {
        const status = STATUS_LABELS[order.status] || STATUS_LABELS.pending;
        const time = new Date(order.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const date = new Date(order.created_at).toLocaleDateString('pt-BR');
        const items = order.items || [];
        const itemsSummary = items.slice(0, 3).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const moreItems = items.length > 3 ? ` +${items.length - 3}` : '';
        const deliveryType = order.delivery_type === 'entrega' ? 'üöö Entrega' : 'üè™ Retirada';
        const address = order.address ? `${order.address.street}, ${order.address.number} - ${order.address.neighborhood}` : '';

        // Payment info
        const isCardPayment = order.payment_method === 'cartao1x' || order.payment_method === 'cartao2x' || order.payment_method === 'card_stripe';
        const paymentMethod = order.payment_method === 'cartao1x' ? 'üí≥ Cart√£o 1x' :
          order.payment_method === 'cartao2x' ? 'üí≥ Cart√£o 1x' :
            order.payment_method === 'pix' ? 'üì± PIX' :
              order.payment_method === 'dinheiro' ? 'üíµ Dinheiro' : '‚è≥ Pendente';
        const paymentStatus = PAYMENT_STATUS_LABELS[order.payment_status] || PAYMENT_STATUS_LABELS.pending;
        const needsAcceptance = isCardPayment && order.status === 'pending' && !order.payment_link;
        const awaitingPayment = isCardPayment && order.payment_status === 'awaiting_payment';
        const partiallyPaid = order.payment_status === 'paid_partial';

        return `
          <div class="bg-white border rounded-lg p-4 shadow-sm ${isCardPayment ? 'border-l-4 border-l-purple-500' : ''}">
            <div class="flex flex-wrap items-start justify-between gap-2 mb-3">
              <div>
                <p class="text-sm text-gray-500">${date} √†s ${time} - <strong class="text-rose-600">${order.order_code || formatOrderCode(order.order_sequence || order.id)}</strong></p>
                <p class="font-semibold text-gray-800">${order.client_name || 'Cliente'}</p>
                <p class="text-sm text-gray-600">üì± ${order.client_phone || '-'}</p>
              </div>
              <div class="text-right">
                <span class="inline-block px-2 py-1 rounded text-sm bg-${status.color}-100 text-${status.color}-800">
                  ${status.emoji} ${status.label}
                </span>
                <p class="text-lg font-bold text-rose-600 mt-1">R$ ${(order.total || 0).toFixed(2).replace('.', ',')}</p>
              </div>
            </div>
            
            <div class="text-sm text-gray-700 mb-3">
              <p><strong>Itens:</strong> ${itemsSummary}${moreItems}</p>
              <p><strong>Tipo:</strong> ${deliveryType}</p>
              ${address ? `<p><strong>Endere√ßo:</strong> ${address}</p>` : ''}
              ${order.scheduled_date ? `<p><strong>üìÖ Encomenda:</strong> ${order.scheduled_date}</p>` : ''}
              <p><strong>Pagamento:</strong> ${paymentMethod} 
                ${isCardPayment ? `<span class="inline-block px-2 py-0.5 rounded text-xs bg-${paymentStatus.color}-100 text-${paymentStatus.color}-800 ml-1">${paymentStatus.emoji} ${paymentStatus.label}</span>` : ''}
              </p>
              ${partiallyPaid ? `<p class="text-orange-600 font-medium">‚ö†Ô∏è Falta pagar restante na entrega/retirada</p>` : ''}
              ${order.payment_link ? `<p class="text-xs text-purple-600 truncate"><strong>Link:</strong> <a href="${order.payment_link}" target="_blank" class="underline">${order.payment_link}</a></p>` : ''}
              
              <!-- Detalhamento do Valor -->
              <div class="mt-2 pt-2 border-t border-gray-200 text-xs">
                <p class="text-gray-600"><strong>Subtotal:</strong> R$ ${(order.subtotal || order.total || 0).toFixed(2).replace('.', ',')}</p>
                ${order.delivery_fee && order.delivery_fee > 0 ? `<p class="text-gray-600"><strong>Taxa Entrega:</strong> R$ ${Number(order.delivery_fee).toFixed(2).replace('.', ',')}</p>` : ''}
                ${order.card_fee && order.card_fee > 0 ? `<p class="text-gray-600"><strong>Taxa Cart√£o:</strong> R$ ${Number(order.card_fee).toFixed(2).replace('.', ',')}</p>` : ''}
                ${order.discount && order.discount > 0 ? `<p class="text-green-600"><strong>Desconto:</strong> -R$ ${Number(order.discount).toFixed(2).replace('.', ',')}</p>` : ''}
                ${order.coupon_code ? `<p class="text-blue-600"><strong>Cupom:</strong> ${order.coupon_code} ${order.coupon_discount ? `(-R$ ${Number(order.coupon_discount).toFixed(2).replace('.', ',')})` : ''}</p>` : ''}
              </div>
            </div>
            
            <div class="flex flex-wrap gap-2">
              ${needsAcceptance ? `
                <button id="acceptBtn_${order.id}" onclick="acceptCardOrder(${order.id})" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm font-medium">üí≥ Aceitar & Enviar Link</button>
              ` : ''}
              ${order.status === 'pending' && !needsAcceptance ? `
                <button onclick="updateOrderStatus(${order.id}, 'preparing')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">üç≥ Preparar</button>
              ` : ''}
              ${order.status === 'accepted' ? `
                <button onclick="updateOrderStatus(${order.id}, 'preparing')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">üç≥ Preparar</button>
              ` : ''}
              ${order.status === 'preparing' ? `
                <button onclick="updateOrderStatus(${order.id}, 'confirmed')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">‚úÖ Pronto</button>
              ` : ''}
              ${order.status === 'confirmed' && order.delivery_type === 'entrega' ? `
                <button onclick="updateOrderStatus(${order.id}, 'out_for_delivery')" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm">üöö Saiu</button>
              ` : ''}
              ${(order.status === 'confirmed' || order.status === 'out_for_delivery') && order.delivery_type !== 'entrega' ? `
                <button onclick="updateOrderStatus(${order.id}, 'delivered')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">‚úîÔ∏è Entregue</button>
              ` : ''}
              ${order.status === 'out_for_delivery' ? `
                <button onclick="updateOrderStatus(${order.id}, 'delivered')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">‚úîÔ∏è Entregue</button>
              ` : ''}
              ${order.status !== 'delivered' && order.status !== 'cancelled' ? `
                <button onclick="updateOrderStatus(${order.id}, 'cancelled')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded text-sm">‚ùå Cancelar</button>
              ` : ''}
              <button onclick="openWhatsAppForOrder('${order.client_phone}')" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded text-sm">üì± WhatsApp</button>
              ${isCardPayment && order.payment_link ? `
                <button onclick="resendPaymentLink(${order.id}, '${order.client_phone}', '${order.client_name || 'Cliente'}', '${order.order_code || ''}', '${order.payment_link}')" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded text-sm">üîó Reenviar Link</button>
              ` : ''}
              <button onclick="prepareOrderUpdate('${order.id}')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded text-sm">üí¨ Enviar Atualiza√ß√£o</button>
            </div>
          </div>
          `;
      }).join('');
    }

    // ========================================
    // ORDER ARCHIVING SERVICE
    // ========================================
    async function archiveOldOrders(daysOld = 90) {
      try {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - daysOld);
        const cutoffISO = cutoffDate.toISOString();

        // Buscar pedidos antigos finalizados (delivered ou cancelled)
        // Nota: order_code pode n√£o existir em bancos antigos
        const { data: oldOrders, error: fetchError } = await window.supabaseClient
          .from('fast_orders')
          .select('id, created_at, status')
          .in('status', ['delivered', 'cancelled'])
          .lt('created_at', cutoffISO);

        if (fetchError) throw fetchError;

        if (!oldOrders || oldOrders.length === 0) {
          console.log('[Archive] Nenhum pedido antigo para arquivar');
          return { archived: 0 };
        }

        console.log(`[Archive] Arquivando ${oldOrders.length} pedidos com mais de ${daysOld} dias...`);

        // Marcar pedidos como arquivados (adicionar campo archived = true)
        const orderIds = oldOrders.map(o => o.id);
        const { error: updateError } = await window.supabaseClient
          .from('fast_orders')
          .update({ archived: true })
          .in('id', orderIds);

        if (updateError) throw updateError;

        // Salvar resumo no localStorage para backup
        const archiveLog = JSON.parse(localStorage.getItem('fastArchiveLog') || '[]');
        archiveLog.push({
          date: new Date().toISOString(),
          count: oldOrders.length,
          cutoff: cutoffISO
        });
        localStorage.setItem('fastArchiveLog', JSON.stringify(archiveLog.slice(-50)));

        console.log(`[Archive] ${oldOrders.length} pedidos arquivados com sucesso`);
        return { archived: oldOrders.length };
      } catch (e) {
        console.error('[Archive] Erro ao arquivar pedidos:', e);
        return { archived: 0, error: e.message };
      }
    }

    async function getArchiveStats() {
      try {
        const { data: archivedCount } = await window.supabaseClient
          .from('fast_orders')
          .select('id', { count: 'exact', head: true })
          .eq('archived', true);

        const { data: activeCount } = await window.supabaseClient
          .from('fast_orders')
          .select('id', { count: 'exact', head: true })
          .or('archived.is.null,archived.eq.false');

        return {
          archived: archivedCount?.length || 0,
          active: activeCount?.length || 0
        };
      } catch (e) {
        console.warn('[Archive] Erro ao buscar estat√≠sticas:', e);
        return { archived: 0, active: 0 };
      }
    }

    // Auto-archive check (runs daily)
    async function checkAutoArchive() {
      const lastArchive = localStorage.getItem('fastLastAutoArchive');
      const today = new Date().toDateString();

      if (lastArchive !== today) {
        console.log('[Archive] Verificando pedidos para arquivamento autom√°tico...');
        const result = await archiveOldOrders(90);
        if (result.archived > 0) {
          console.log(`[Archive] Auto-arquivados ${result.archived} pedidos`);
        }
        localStorage.setItem('fastLastAutoArchive', today);
      }
    }

    // Run auto-archive check on load (delayed)
    setTimeout(checkAutoArchive, 10000);

    // ========================================
    // ORDER LOG (AUDITORIA)
    // ========================================
    async function logOrderChange(orderId, orderCode, oldStatus, newStatus, notes = '') {
      try {
        const currentUser = sessionStorage.getItem('fastAdmin') || 'Sistema';
        const logEntry = {
          order_id: orderId,
          order_code: orderCode,
          old_status: oldStatus,
          new_status: newStatus,
          changed_by: currentUser,
          changed_at: new Date().toISOString(),
          notes: notes
        };

        // Tentar salvar no Supabase
        try {
          await window.supabaseClient
            .from('fast_order_logs')
            .insert(logEntry);
        } catch (e) {
          console.warn('[OrderLog] Supabase error, saving locally:', e);
        }

        // Salvar tamb√©m localmente como backup
        const localLogs = JSON.parse(localStorage.getItem('fastOrderLogs') || '[]');
        localLogs.push(logEntry);
        // Manter apenas √∫ltimos 500 logs localmente
        if (localLogs.length > 500) localLogs.shift();
        localStorage.setItem('fastOrderLogs', JSON.stringify(localLogs));
      } catch (e) {
        console.error('[OrderLog] Erro ao registrar log:', e);
      }
    }

    async function getOrderLogs(orderId) {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_order_logs')
          .select('*')
          .eq('order_id', orderId)
          .order('changed_at', { ascending: true });

        if (error) throw error;
        return data || [];
      } catch (e) {
        // Fallback para logs locais
        const localLogs = JSON.parse(localStorage.getItem('fastOrderLogs') || '[]');
        return localLogs.filter(l => l.order_id === orderId);
      }
    }

    async function updateOrderStatus(orderId, newStatus) {
      try {
        // Buscar dados do pedido
        const { data: order } = await window.supabaseClient
          .from('fast_orders')
          .select('*')
          .eq('id', orderId)
          .single();

        const oldStatus = order?.status || 'unknown';

        // Valida√ß√£o para entrega: s√≥ permite se pagamento completo para cart√£o
        if (newStatus === 'delivered') {
          if (order && (order.payment_method === 'cartao1x' || order.payment_method === 'cartao2x' || order.payment_method === 'card_stripe')) {
            if (order.payment_status !== 'paid_full') {
              alert('‚ö†Ô∏è Pagamento em cart√£o n√£o est√° completo!\nO cliente precisa pagar 100% antes de marcar como entregue.');
              return;
            }
          }
        }

        const { error } = await window.supabaseClient
          .from('fast_orders')
          .update({ status: newStatus })
          .eq('id', orderId);

        if (error) throw error;

        // Registrar log de auditoria
        const orderCode = order?.order_code || formatOrderCode(order?.order_sequence || order?.id);
        await logOrderChange(orderId, orderCode, oldStatus, newStatus);

        // Se marcou como entregue, enviar mensagem com link de avalia√ß√£o automaticamente
        if (newStatus === 'delivered' && order && order.client_phone) {
          const ratingLink = buildRatingLink(orderCode, order.client_phone);
          const firstName = (order.client_name || 'Cliente').split(' ')[0];

          // Enviar automaticamente via WhatsApp (sem confirm popup)
          const msg = `Ol√°, ${firstName}! üòä\n\nSeu pedido *${orderCode}* foi entregue!\n\nNos ajude a melhorar: avalie sua experi√™ncia:\n${ratingLink}\n\nObrigado por escolher a Fast Savory's! ü•ü`;
          const whatsappUrl = `https://wa.me/55${normalizePhoneDigits(order.client_phone)}?text=${encodeURIComponent(msg)}`;
          window.open(whatsappUrl, '_blank');
        }

        loadDashboardOrders(); // Refresh list
      } catch (error) {
        console.error('Erro ao atualizar status:', error);
        alert('Erro ao atualizar status do pedido.');
      }
    }

    // ========================================
    // BANNER MODULE (Ad Banner Management)
    // ========================================
    const BannerModule = {
      config: null,
      SESSION_KEY: 'fastAdBannerClosed',

      // Load banner config from Supabase
      async loadConfig() {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_banner_config')
            .select('*')
            .eq('store_id', 1)
            .single();

          if (error && error.code !== 'PGRST116') throw error;
          this.config = data || { enabled: true, image_url: null, link_url: null, alt_text: 'Anuncie aqui' };
          return this.config;
        } catch (e) {
          console.warn('[Banner] Error loading config:', e);
          this.config = { enabled: true, image_url: null, link_url: null, alt_text: 'Anuncie aqui' };
          return this.config;
        }
      },

      // Save banner config to Supabase
      async saveConfig(config) {
        try {
          const { error } = await window.supabaseClient
            .from('fast_banner_config')
            .upsert({
              store_id: 1,
              image_url: config.image_url || null,
              link_url: config.link_url || null,
              alt_text: config.alt_text || 'Anuncie aqui',
              enabled: config.enabled !== false,
              updated_at: new Date().toISOString()
            }, { onConflict: 'store_id' });

          if (error) throw error;
          this.config = config;
          return true;
        } catch (e) {
          console.error('[Banner] Error saving config:', e);
          return false;
        }
      },

      // Check if banner should be shown (sessionStorage)
      shouldShow() {
        try {
          return !sessionStorage.getItem(this.SESSION_KEY);
        } catch (e) {
          return true; // Show by default if sessionStorage fails
        }
      },

      // Mark banner as closed for this session
      markClosed() {
        try {
          sessionStorage.setItem(this.SESSION_KEY, 'true');
        } catch (e) {
          console.warn('[Banner] Could not save close state');
        }
      },

      // Show public banner
      showPublicBanner() {
        if (!this.config || !this.config.enabled || !this.shouldShow()) {
          return;
        }

        const container = document.getElementById('adBannerPublic');
        const image = document.getElementById('adBannerImage');
        const fallback = document.getElementById('adBannerFallback');
        const link = document.getElementById('adBannerLink');

        if (!container) return;

        // Set link URL
        if (this.config.link_url) {
          link.href = this.config.link_url;
          link.style.cursor = 'pointer';
        } else {
          link.removeAttribute('href');
          link.style.cursor = 'default';
        }

        // Show image or fallback
        if (this.config.image_url) {
          image.src = this.config.image_url;
          image.alt = this.config.alt_text || 'Banner publicit√°rio';
          image.classList.remove('hidden');
          fallback.classList.add('hidden');
        } else {
          image.classList.add('hidden');
          fallback.classList.remove('hidden');
        }

        container.classList.remove('hidden');
      },

      // Hide public banner
      hideBanner() {
        const container = document.getElementById('adBannerPublic');
        if (container) {
          container.classList.add('hidden');
        }
        this.markClosed();
      },

      // Admin: Load config into form
      loadAdminForm() {
        if (!this.config) return;

        const enabledEl = document.getElementById('bannerEnabled');
        const imageUrlEl = document.getElementById('bannerImageUrl');
        const linkUrlEl = document.getElementById('bannerLinkUrl');
        const altTextEl = document.getElementById('bannerAltText');
        const previewEl = document.getElementById('bannerImagePreview');
        const previewImgEl = document.getElementById('bannerPreviewImg');
        const livePreviewEl = document.getElementById('bannerLivePreview');

        if (enabledEl) enabledEl.checked = this.config.enabled !== false;
        if (imageUrlEl) imageUrlEl.value = this.config.image_url || '';
        if (linkUrlEl) linkUrlEl.value = this.config.link_url || '';
        if (altTextEl) altTextEl.value = this.config.alt_text || 'Anuncie aqui';

        // Show image preview
        if (this.config.image_url && previewEl && previewImgEl) {
          previewImgEl.src = this.config.image_url;
          previewEl.classList.remove('hidden');
        }

        // Update live preview
        this.updateLivePreview();
      },

      // Admin: Update live preview
      updateLivePreview() {
        const imageUrl = document.getElementById('bannerImageUrl')?.value;
        const altText = document.getElementById('bannerAltText')?.value || 'Anuncie aqui';
        const livePreviewEl = document.getElementById('bannerLivePreview');

        if (!livePreviewEl) return;

        if (imageUrl) {
          livePreviewEl.innerHTML = `<img src="${imageUrl}" alt="${altText}" class="mx-auto max-h-20 rounded">`;
        } else {
          livePreviewEl.innerHTML = `
            <p class="text-purple-600 font-medium">${altText}</p>
            <p class="text-xs text-gray-500 mt-1">Configure uma imagem para substituir este placeholder</p>
          `;
        }
      },

      // Admin: Save from form
      async saveFromForm() {
        const config = {
          enabled: document.getElementById('bannerEnabled')?.checked !== false,
          image_url: document.getElementById('bannerImageUrl')?.value || null,
          link_url: document.getElementById('bannerLinkUrl')?.value || null,
          alt_text: document.getElementById('bannerAltText')?.value || 'Anuncie aqui'
        };

        const success = await this.saveConfig(config);

        const msgEl = document.getElementById('bannerAdminMessage');
        if (msgEl) {
          msgEl.textContent = success ? '‚úÖ Configura√ß√£o salva com sucesso!' : '‚ùå Erro ao salvar configura√ß√£o';
          msgEl.className = success
            ? 'mb-4 p-3 rounded-lg text-sm bg-green-100 text-green-700'
            : 'mb-4 p-3 rounded-lg text-sm bg-red-100 text-red-700';
          msgEl.classList.remove('hidden');
          setTimeout(() => msgEl.classList.add('hidden'), 3000);
        }

        return success;
      },

      // Initialize banner module
      async init() {
        await this.loadConfig();

        // Public: Show banner on store page
        this.showPublicBanner();

        // Public: Close button handler
        document.getElementById('closeBannerBtn')?.addEventListener('click', () => {
          this.hideBanner();
        });

        // Admin: Save button handler
        document.getElementById('saveBannerConfig')?.addEventListener('click', async () => {
          await this.saveFromForm();
        });

        // Admin: Image URL change handler
        document.getElementById('bannerImageUrl')?.addEventListener('input', () => {
          const url = document.getElementById('bannerImageUrl').value;
          const previewEl = document.getElementById('bannerImagePreview');
          const previewImgEl = document.getElementById('bannerPreviewImg');

          if (url && previewEl && previewImgEl) {
            previewImgEl.src = url;
            previewEl.classList.remove('hidden');
          } else if (previewEl) {
            previewEl.classList.add('hidden');
          }

          this.updateLivePreview();
        });

        // Admin: Alt text change handler
        document.getElementById('bannerAltText')?.addEventListener('input', () => {
          this.updateLivePreview();
        });

        // Admin: Image upload handler
        document.getElementById('bannerImageUpload')?.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // Convert to base64 for simplicity (or upload to Supabase Storage)
          const reader = new FileReader();
          reader.onload = (event) => {
            const base64 = event.target.result;
            document.getElementById('bannerImageUrl').value = base64;
            const previewEl = document.getElementById('bannerImagePreview');
            const previewImgEl = document.getElementById('bannerPreviewImg');
            if (previewEl && previewImgEl) {
              previewImgEl.src = base64;
              previewEl.classList.remove('hidden');
            }
            this.updateLivePreview();
          };
          reader.readAsDataURL(file);
        });

        console.log('[Banner] Module initialized');
      }
    };

    // ========================================
    // STRIPE PAYMENT SERVICE
    // ========================================
    function getStripeServerBaseUrl() {
      // Vercel Serverless Functions path
      return '/api';
    }

    const StripeService = {
      config: null,

      async loadConfig() {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_stripe_config')
            .select('*')
            .eq('store_id', 1)
            .single();

          if (error) throw error;
          this.config = data || null;

          if (!this.config) {
            console.warn('[Stripe] Config n√£o encontrada (store_id=1).');
          } else {
            console.log('[Stripe] Config carregada do Supabase:', {
              enabled: this.config.enabled,
              min_payment_percent: this.config.min_payment_percent,
              has_public_key: !!this.config.stripe_public_key
            });
          }

          return this.config;
        } catch (e) {
          console.warn('[Stripe] Erro ao carregar config do Supabase:', e);
          this.config = null;
          return null;
        }
      },

      async saveConfig(config) {
        try {
          const { error } = await window.supabaseClient
            .from('fast_stripe_config')
            .upsert({ ...config, store_id: 1, updated_at: new Date().toISOString() }, { onConflict: 'store_id' });

          if (error) throw error;
          this.config = config;
          return true;
        } catch (e) {
          console.error('[Stripe] Erro ao salvar config:', e);
          return false;
        }
      },

      // Gera sauda√ß√£o din√¢mica baseada no hor√°rio
      getGreeting() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'Bom dia';
        if (hour >= 12 && hour < 18) return 'Boa tarde';
        return 'Boa noite';
      },

      // Gera mensagem de pagamento para WhatsApp
      generatePaymentMessage(order, paymentLink) {
        const greeting = this.getGreeting();
        const firstName = MsgTemplateService.getFirstName(order.client_name);
        // Use already formatted code if available, otherwise format the ID
        const orderCode = order.order_code || formatOrderCode(order.id);

        return `${greeting}, ${firstName}! üéâ

Seu pedido ${orderCode} foi *ACEITO* pela Fast Savory's!

Para confirmar sua encomenda, realize o pagamento pelo link abaixo:
${paymentLink}

Ap√≥s a confirma√ß√£o do pagamento, seu pedido ser√° preparado com muito carinho! ü•ü

*Valor total:* R$ ${(order.total || 0).toFixed(2).replace('.', ',')}

Obrigado pela prefer√™ncia! ‚ù§Ô∏è`;
      },

      // Gera Checkout Session do Stripe usando servidor local
      async generatePaymentLink(order) {
        if (!this.config || !this.config.enabled) {
          console.warn('[Stripe] Stripe n√£o configurado ou desabilitado (Supabase). Tentando gerar link via servidor local mesmo assim...');
        }

        try {
          console.log('[Stripe] Gerando link para pedido:', order.id);

          const baseUrl = getStripeServerBaseUrl();
          if (!baseUrl) {
            throw new Error('Stripe server URL n√£o configurada. Defina localStorage.fastStripeServerUrl em produ√ß√£o.');
          }

          const response = await fetch(baseUrl + '/create-checkout-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderId: order.id,
              amount: order.total,
              customerEmail: order.client_email || '',
              customerName: order.client_name
            })
          });

          if (!response.ok) {
            const error = await response.json().catch(function () { return {}; });
            throw new Error(error.error || 'Erro ao gerar link');
          }

          const data = await response.json();
          console.log('[Stripe] Link gerado com sucesso:', data.url);

          return data.url;
        } catch (error) {
          console.error('[Stripe] Erro ao gerar link:', error);
          // Fallback para modo de teste
          return `https://buy.stripe.com/test_order_${order.id}`;
        }
      }
    };

    // Aceitar pedido com cart√£o e gerar link de pagamento
    async function acceptCardOrder(orderId) {
      const btn = document.getElementById(`acceptBtn_${orderId}`);
      const originalText = btn ? btn.innerHTML : '';

      try {
        // Mostrar loading no bot√£o
        if (btn) {
          btn.innerHTML = '‚è≥ Gerando link...';
          btn.disabled = true;
          btn.classList.add('opacity-75', 'cursor-wait');
        }

        // Busca dados completos do pedido
        const { data: order, error: fetchError } = await window.supabaseClient
          .from('fast_orders')
          .select('*')
          .eq('id', orderId)
          .single();

        if (fetchError || !order) {
          alert('Erro ao buscar pedido');
          return;
        }

        // Carrega config do Stripe se necess√°rio
        if (!StripeService.config) {
          await StripeService.loadConfig();
        }

        // Gera o link de pagamento
        const paymentLink = await StripeService.generatePaymentLink(order);

        // Atualiza o pedido com o link de pagamento
        const { error: updateError } = await window.supabaseClient
          .from('fast_orders')
          .update({
            status: 'accepted',
            payment_status: 'awaiting_payment',
            payment_link: paymentLink,
            accepted_at: new Date().toISOString()
          })
          .eq('id', orderId);

        if (updateError) throw updateError;

        // Gera mensagem para WhatsApp
        const message = StripeService.generatePaymentMessage(order, paymentLink);

        // Abre WhatsApp com a mensagem
        if (order.client_phone) {
          const cleanPhone = order.client_phone.replace(/\D/g, '');
          const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`;
          window.open(url, '_blank');
        }

        // Atualiza a lista de pedidos
        loadDashboardOrders();

      } catch (error) {
        console.error('Erro ao aceitar pedido:', error);
        alert('Erro ao aceitar pedido: ' + error.message);
      } finally {
        // Restaurar bot√£o ao estado original
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          btn.classList.remove('opacity-75', 'cursor-wait');
        }
      }
    }

    // Reenviar link de pagamento via WhatsApp
    async function resendPaymentLink(orderId, phone, clientName, orderCode, paymentLink) {
      try {
        // Sempre busca dados completos do pedido para ter o valor correto
        let order = null;
        try {
          const { data } = await window.supabaseClient
            .from('fast_orders')
            .select('*')
            .eq('id', orderId)
            .single();
          if (data) order = data;
        } catch (e) {
          console.warn('[Stripe] Erro ao buscar pedido:', e);
        }

        // Fallback se n√£o conseguir buscar
        if (!order) {
          order = { client_name: clientName, order_code: orderCode, payment_link: paymentLink, total: 0 };
        }

        // Usa o paymentLink passado se o pedido n√£o tiver
        if (paymentLink && !order.payment_link) {
          order.payment_link = paymentLink;
        }

        // Carrega config do Stripe se necess√°rio
        if (!StripeService.config) {
          await StripeService.loadConfig();
        }

        // Gera mensagem para WhatsApp
        const message = StripeService.generatePaymentMessage(order, order.payment_link);

        // Abre WhatsApp com a mensagem
        const cleanPhone = (phone || '').replace(/\D/g, '');
        if (cleanPhone) {
          const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`;
          window.open(url, '_blank');
        }
      } catch (error) {
        console.error('Erro ao reenviar link:', error);
        alert('Erro ao reenviar link: ' + error.message);
      }
    }

    // Marcar pagamento como recebido (parcial ou total)
    async function markPaymentReceived(orderId, paymentType) {
      try {
        const { data: order } = await window.supabaseClient
          .from('fast_orders')
          .select('total, amount_paid')
          .eq('id', orderId)
          .single();

        const updateData = {
          payment_status: paymentType === 'full' ? 'paid_full' : 'paid_partial',
          amount_paid: paymentType === 'full' ? order.total : (order.total * 0.5)
        };

        const { error } = await window.supabaseClient
          .from('fast_orders')
          .update(updateData)
          .eq('id', orderId);

        if (error) throw error;

        alert(paymentType === 'full' ? '‚úÖ Pagamento total registrado!' : '‚úÖ Entrada de 50% registrada!');
        loadDashboardOrders();
      } catch (error) {
        console.error('Erro ao registrar pagamento:', error);
        alert('Erro ao registrar pagamento');
      }
    }

    function openWhatsAppForOrder(phone) {
      if (!phone) return;
      const cleanPhone = phone.replace(/\D/g, '');
      const url = `https://wa.me/55${cleanPhone}`;
      window.open(url, '_blank');
    }

    // Vari√°veis para modal de exclus√£o de pedidos
    let pendingOrderCodesToDelete = [];

    // Excluir pedidos por c√≥digo (FAST-0001, etc) - abre modal de confirma√ß√£o
    function deleteOrdersByCodes() {
      const orderCodesToDeleteInput = document.getElementById('orderCodesToDelete');
      const deleteOrdersResult = document.getElementById('deleteOrdersResult');

      if (!orderCodesToDeleteInput || !deleteOrdersResult) return;

      const inputValue = orderCodesToDeleteInput.value.trim();

      if (!inputValue) {
        deleteOrdersResult.textContent = '‚ö†Ô∏è Digite ao menos um c√≥digo de pedido.';
        deleteOrdersResult.style.color = '#856404';
        return;
      }

      // Extrai os c√≥digos (separa por v√≠rgula, remove espa√ßos e filtra vazios)
      const codes = inputValue.split(',').map(c => c.trim().toUpperCase()).filter(c => c);

      if (codes.length === 0) {
        deleteOrdersResult.textContent = '‚ö†Ô∏è Nenhum c√≥digo v√°lido encontrado.';
        deleteOrdersResult.style.color = '#856404';
        return;
      }

      // Armazena c√≥digos e abre modal de confirma√ß√£o
      pendingOrderCodesToDelete = codes;
      const deleteOrdersModal = document.getElementById('deleteOrdersModal');
      const deleteOrdersModalText = document.getElementById('deleteOrdersModalText');

      deleteOrdersModalText.textContent = `Tem certeza que deseja excluir ${codes.length} pedido(s)?\n\n${codes.join(', ')}`;
      deleteOrdersModal.classList.remove('hidden');
    }

    // Executa exclus√£o de pedidos ap√≥s confirma√ß√£o no modal
    async function executeDeleteOrders() {
      const orderCodesToDeleteInput = document.getElementById('orderCodesToDelete');
      const deleteOrdersResult = document.getElementById('deleteOrdersResult');
      const deleteOrdersModal = document.getElementById('deleteOrdersModal');

      deleteOrdersModal.classList.add('hidden');

      const codes = pendingOrderCodesToDelete;
      if (codes.length === 0) return;

      try {
        deleteOrdersResult.textContent = '‚è≥ Excluindo...';
        deleteOrdersResult.style.color = '#007bff';

        // Busca todos os pedidos
        const { data: allOrders, error } = await window.supabaseClient
          .from('fast_orders')
          .select('*');

        if (error) throw error;

        // Filtra os pedidos cujo c√≥digo formatado est√° na lista
        const ordersToDelete = (allOrders || []).filter(order => {
          const orderCode = order.order_code || formatOrderCode(order.order_sequence || order.id);
          return codes.includes(orderCode);
        });

        if (ordersToDelete.length === 0) {
          deleteOrdersResult.textContent = `‚ö†Ô∏è Nenhum pedido encontrado com os c√≥digos informados.`;
          deleteOrdersResult.style.color = '#856404';
          pendingOrderCodesToDelete = [];
          return;
        }

        // Exclui os pedidos encontrados
        const idsToDelete = ordersToDelete.map(o => o.id);

        // First delete related logs (to avoid FK constraint violation)
        await window.supabaseClient
          .from('fast_order_logs')
          .delete()
          .in('order_id', idsToDelete);

        // Then delete orders
        const { error: deleteError } = await window.supabaseClient
          .from('fast_orders')
          .delete()
          .in('id', idsToDelete);

        if (deleteError) throw deleteError;

        deleteOrdersResult.textContent = `‚úÖ ${ordersToDelete.length} pedido(s) exclu√≠do(s) com sucesso!`;
        deleteOrdersResult.style.color = '#28a745';

        // Limpa o input e recarrega os pedidos
        orderCodesToDeleteInput.value = '';
        pendingOrderCodesToDelete = [];

        // Limpa cache local
        try { localStorage.removeItem('fastOrders'); } catch (e) { }

        // Recarrega listas
        await loadOrders().catch(function () { });
        try { renderReportsData(); } catch (e) { }
        try { loadDashboardOrders(); } catch (e) { }

      } catch (error) {
        console.error('Erro ao excluir pedidos:', error);
        deleteOrdersResult.textContent = `‚ùå Erro: ${error.message}`;
        deleteOrdersResult.style.color = '#dc3545';
        pendingOrderCodesToDelete = [];
      }
    }

    // Event listeners para modal de exclus√£o de pedidos
    document.getElementById('cancelDeleteOrdersModalBtn')?.addEventListener('click', () => {
      document.getElementById('deleteOrdersModal').classList.add('hidden');
      const deleteOrdersResult = document.getElementById('deleteOrdersResult');
      if (deleteOrdersResult) {
        deleteOrdersResult.textContent = '‚ùå Exclus√£o cancelada.';
        deleteOrdersResult.style.color = '#dc3545';
      }
      pendingOrderCodesToDelete = [];
    });

    document.getElementById('confirmDeleteOrdersModalBtn')?.addEventListener('click', executeDeleteOrders);

    // Fechar modal ao clicar fora
    document.getElementById('deleteOrdersModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'deleteOrdersModal') {
        e.target.classList.add('hidden');
        pendingOrderCodesToDelete = [];
      }
    });

    // Order filters events
    document.getElementById('ordersFilterDate')?.addEventListener('change', loadDashboardOrders);
    document.getElementById('ordersFilterStatus')?.addEventListener('change', loadDashboardOrders);
    document.getElementById('refreshOrders')?.addEventListener('click', loadDashboardOrders);
    document.getElementById('confirmDeleteOrdersBtn')?.addEventListener('click', deleteOrdersByCodes);

    // Desktop buttons
    document.getElementById('showProductsPanelFast')?.addEventListener('click', () => {
      showPanel('productsPanelFast');
      loadProductsAdmin();
    });
    document.getElementById('showClientsPanelFast')?.addEventListener('click', () => {
      showPanel('clientsPanelFast');
      renderClients();
      updateClientDiscountSelect();
    });
    document.getElementById('showPromotionsPanelFast')?.addEventListener('click', async () => {
      showPanel('promotionsPanelFast');
      renderPromotions();
      updatePromotionProductSelect();
      updateClientDiscountSelect();
      renderCoupons();

      // Load Special Discount Config
      try {
        const config = await SpecialDiscountService.getConfig();
        if (config) {
          document.getElementById('specialDiscountMinOrders').value = config.min_orders || '';
          document.getElementById('specialDiscountMinVal').value = config.min_order_value || '';
          document.getElementById('specialDiscountType').value = config.discount_type || 'percentage';
          document.getElementById('specialDiscountValue').value = config.discount_value || '';

          // Update status card
          const statusCard = document.getElementById('specialDiscountStatus');
          if (statusCard && config.active && config.discount_value > 0) {
            const typeText = config.discount_type === 'percentage' ? `${config.discount_value}%` : `R$ ${config.discount_value?.toFixed(2).replace('.', ',')}`;
            statusCard.className = 'mb-4 p-3 rounded-lg bg-green-50 border-l-4 border-green-500';
            statusCard.innerHTML = `
              <p class="text-sm font-bold text-green-800">‚úÖ Desconto Ativo</p>
              <p class="text-xs text-green-700 mt-1">A cada <strong>${config.min_orders}</strong> pedidos pagos, cliente ganha <strong>${typeText}</strong> de desconto</p>
              ${config.min_order_value > 0 ? `<p class="text-xs text-green-600 mt-1">Pedido m√≠nimo: R$ ${config.min_order_value?.toFixed(2).replace('.', ',')}</p>` : ''}
            `;
          } else if (statusCard) {
            statusCard.className = 'mb-4 p-3 rounded-lg bg-gray-100 border-l-4 border-gray-400';
            statusCard.innerHTML = '<p class="text-sm text-gray-600 font-medium">‚ö™ Nenhum desconto configurado</p>';
          }
        }
      } catch (e) {
        console.error('[SpecialDiscount] Erro ao carregar:', e);
        const statusCard = document.getElementById('specialDiscountStatus');
        if (statusCard) {
          statusCard.className = 'mb-4 p-3 rounded-lg bg-gray-100 border-l-4 border-gray-400';
          statusCard.innerHTML = '<p class="text-sm text-gray-600 font-medium">‚ö™ Configure acima</p>';
        }
      }

      // Load Birthday Discount Config
      try {
        const config = await BirthdayDiscountService.getConfig();
        if (config) {
          document.getElementById('birthdayDiscountType').value = config.discount_type || 'percentage';
          document.getElementById('birthdayDiscountValue').value = config.discount_value || '';

          // Update status card
          const statusCard = document.getElementById('birthdayDiscountStatus');
          if (statusCard && config.active && config.discount_value > 0) {
            const typeText = config.discount_type === 'percentage' ? `${config.discount_value}%` : `R$ ${config.discount_value?.toFixed(2).replace('.', ',')}`;
            statusCard.className = 'mb-4 p-3 rounded-lg bg-pink-50 border-l-4 border-pink-500';
            statusCard.innerHTML = `
              <p class="text-sm font-bold text-pink-800">üéÇ Desconto Ativo</p>
              <p class="text-xs text-pink-700 mt-1">Cliente aniversariante ganha <strong>${typeText}</strong> de desconto (uso √∫nico por ano)</p>
            `;
          } else if (statusCard) {
            statusCard.className = 'mb-4 p-3 rounded-lg bg-gray-100 border-l-4 border-gray-400';
            statusCard.innerHTML = '<p class="text-sm text-gray-600 font-medium">‚ö™ Nenhum desconto configurado</p>';
          }
        }
      } catch (e) {
        console.error('[BirthdayDiscount] Erro ao carregar:', e);
        const statusCard = document.getElementById('birthdayDiscountStatus');
        if (statusCard) {
          statusCard.className = 'mb-4 p-3 rounded-lg bg-gray-100 border-l-4 border-gray-400';
          statusCard.innerHTML = '<p class="text-sm text-gray-600 font-medium">‚ö™ Configure acima</p>';
        }
      }
    });

    // Special Discount Save Listener
    document.getElementById('saveSpecialDiscountConfig')?.addEventListener('click', async () => {
      const minOrders = parseInt(document.getElementById('specialDiscountMinOrders').value);
      const minVal = parseFloat(document.getElementById('specialDiscountMinVal').value);
      const type = document.getElementById('specialDiscountType').value;
      const val = parseFloat(document.getElementById('specialDiscountValue').value);
      const msg = document.getElementById('specialDiscountMsg');

      if (isNaN(minOrders) || isNaN(val)) {
        msg.textContent = 'Preencha os campos corretamente.';
        msg.className = 'text-red-600 text-sm ml-2';
        return;
      }

      const config = {
        min_orders: minOrders,
        discount_type: type,
        discount_value: val,
        min_order_value: isNaN(minVal) ? 0 : minVal,
        active: true
      };

      msg.textContent = 'Salvando...';
      const success = await SpecialDiscountService.saveConfig(config);
      if (success) {
        msg.textContent = 'Configura√ß√£o salva!';
        msg.className = 'text-green-600 text-sm ml-2';
        // Update global
        currentSpecialDiscount = config;
        // Update status card
        const statusCard = document.getElementById('specialDiscountStatus');
        const typeText = config.discount_type === 'percentage' ? `${config.discount_value}%` : `R$ ${config.discount_value?.toFixed(2).replace('.', ',')}`;
        statusCard.className = 'mb-4 p-3 rounded-lg bg-green-50 border-l-4 border-green-500';
        statusCard.innerHTML = `
          <p class="text-sm font-bold text-green-800">‚úÖ Desconto Ativo</p>
          <p class="text-xs text-green-700 mt-1">A cada <strong>${config.min_orders}</strong> pedidos pagos, cliente ganha <strong>${typeText}</strong> de desconto</p>
          ${config.min_order_value > 0 ? `<p class="text-xs text-green-600 mt-1">Pedido m√≠nimo: R$ ${config.min_order_value?.toFixed(2).replace('.', ',')}</p>` : ''}
        `;
      } else {
        msg.textContent = 'Erro ao salvar.';
        msg.className = 'text-red-600 text-sm ml-2';
      }
    });

    // Birthday Discount Save Listener
    document.getElementById('saveBirthdayDiscountConfig')?.addEventListener('click', async () => {
      const type = document.getElementById('birthdayDiscountType').value;
      const val = parseFloat(document.getElementById('birthdayDiscountValue').value);
      const msg = document.getElementById('birthdayDiscountMsg');

      if (isNaN(val) || val <= 0) {
        msg.textContent = 'Preencha o valor do desconto.';
        msg.className = 'text-red-600 text-sm ml-2';
        return;
      }

      const config = {
        discount_type: type,
        discount_value: val,
        active: true
      };

      msg.textContent = 'Salvando...';
      const success = await BirthdayDiscountService.saveConfig(config);
      if (success) {
        msg.textContent = 'Configura√ß√£o salva!';
        msg.className = 'text-green-600 text-sm ml-2';
        // Update status card
        const statusCard = document.getElementById('birthdayDiscountStatus');
        const typeText = config.discount_type === 'percentage' ? `${config.discount_value}%` : `R$ ${config.discount_value?.toFixed(2).replace('.', ',')}`;
        statusCard.className = 'mb-4 p-3 rounded-lg bg-pink-50 border-l-4 border-pink-500';
        statusCard.innerHTML = `
          <p class="text-sm font-bold text-pink-800">üéÇ Desconto Ativo</p>
          <p class="text-xs text-pink-700 mt-1">Cliente aniversariante ganha <strong>${typeText}</strong> de desconto (uso √∫nico por ano)</p>
        `;
      } else {
        msg.textContent = 'Erro ao salvar.';
        msg.className = 'text-red-600 text-sm ml-2';
      }
    });

    document.getElementById('showReportsPanelFast')?.addEventListener('click', async () => {
      showPanel('reportsPanelFast');
      await loadOrders();
      renderReportsData();
    });

    // Ratings Panel - Uses RatingsModule (defined earlier)
    document.getElementById('showRatingsPanelFast')?.addEventListener('click', async () => {
      showPanel('ratingsPanelFast');
      await RatingsModule.initAdminPanel();
    });

    document.getElementById('showConfigPanelFast')?.addEventListener('click', () => {
      showPanel('configPanelFast');
      renderUsers();
      renderFastFeesListPanel();
      loadCouriers();
    });
    document.getElementById('showBannerPanelFast')?.addEventListener('click', async () => {
      showPanel('bannerPanelFast');
      await BannerModule.loadConfig();
      BannerModule.loadAdminForm();
    });
    document.getElementById('showOrdersPanelFast')?.addEventListener('click', () => {
      showPanel('ordersPanelFast');
    });

    // Mobile buttons - same actions
    document.getElementById('showProductsPanelFastMobile')?.addEventListener('click', () => {
      showPanel('productsPanelFast');
      loadProductsAdmin();
    });
    document.getElementById('showClientsPanelFastMobile')?.addEventListener('click', () => {
      showPanel('clientsPanelFast');
      renderClients();
      updateClientDiscountSelect();
    });
    document.getElementById('showPromotionsPanelFastMobile')?.addEventListener('click', async () => {
      showPanel('promotionsPanelFast');
      renderPromotions();
      updatePromotionProductSelect();
      updateClientDiscountSelect();
      renderCoupons();
      try {
        const config = await SpecialDiscountService.getConfig();
        if (config) {
          document.getElementById('specialDiscountMinOrders').value = config.min_orders;
          document.getElementById('specialDiscountMinVal').value = config.min_order_value;
          document.getElementById('specialDiscountType').value = config.discount_type;
          document.getElementById('specialDiscountValue').value = config.discount_value;
        }
      } catch (e) { }
    });
    document.getElementById('showReportsPanelFastMobile')?.addEventListener('click', async () => {
      showPanel('reportsPanelFast');
      await loadOrders();
      renderReportsData();
    });
    document.getElementById('showRatingsPanelFastMobile')?.addEventListener('click', async () => {
      showPanel('ratingsPanelFast');
      await loadRatings();
    });
    document.getElementById('showConfigPanelFastMobile')?.addEventListener('click', () => {
      showPanel('configPanelFast');
      renderUsers();
      renderFastFeesListPanel();
      loadCouriers();
    });
    document.getElementById('showBannerPanelFastMobile')?.addEventListener('click', async () => {
      showPanel('bannerPanelFast');
      await BannerModule.loadConfig();
      BannerModule.loadAdminForm();
    });
    document.getElementById('showOrdersPanelFastMobile')?.addEventListener('click', () => {
      showPanel('ordersPanelFast');
    });
    document.getElementById('goToStoreMobile')?.addEventListener('click', () => showPublicStore());
    document.getElementById('logoutBtnMobile')?.addEventListener('click', () => { isAdmin = false; sessionStorage.removeItem('fastAdmin'); sessionStorage.removeItem('fastRole'); showLoginModal(); });

    // Mobile close store button
    document.getElementById('closeStoreTodayMobile')?.addEventListener('click', () => {
      document.getElementById('closeStoreToday')?.click();
    });

    // Helper function to show inline messages instead of alerts
    function showInlineMessage(containerId, message, type = 'success') {
      const container = document.getElementById(containerId);
      if (!container) return;

      const msgDiv = document.createElement('div');
      msgDiv.className = `p-3 rounded-lg text-sm font-medium mb-3 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      msgDiv.textContent = message;
      container.insertBefore(msgDiv, container.firstChild);

      // Auto-remove after 4 seconds
      setTimeout(() => msgDiv.remove(), 4000);
    }

    // Salvar todas as taxas do painel de configura√ß√µes
    document.getElementById('saveAllFeesFastPanel')?.addEventListener('click', async () => {
      try {
        const fees = readFastFees();
        // Tentar salvar no Supabase
        if (window.supabaseClient) {
          const rows = Object.entries(fees).map(([neighborhood, entry]) => {
            let feeValue = entry;
            let minValue = 0;
            if (entry && typeof entry === 'object') {
              feeValue = entry.fee;
              minValue = entry.min || 0;
            }
            feeValue = parseFloat(String(feeValue).replace(',', '.'));
            minValue = parseFloat(String(minValue).replace(',', '.'));
            if (isNaN(feeValue)) feeValue = 0;
            if (isNaN(minValue)) minValue = 0;
            return { neighborhood, fee: feeValue, min_order_value: minValue };
          });

          let { error } = await window.supabaseClient
            .from('fast_delivery_fees')
            .upsert(rows, { onConflict: 'neighborhood' });

          if (error && String(error.message || '').includes('min_order_value')) {
            const rowsWithoutMin = rows.map(r => ({ neighborhood: r.neighborhood, fee: r.fee }));
            ({ error } = await window.supabaseClient
              .from('fast_delivery_fees')
              .upsert(rowsWithoutMin, { onConflict: 'neighborhood' }));
          }

          if (error) throw error;
        }
        // Sempre salva no localStorage tamb√©m
        writeFastFees(fees);
        if (window.supabaseClient) {
          await loadFeesFromSupabase();
        }
        showInlineMessage('feesListFastPanel', '‚úÖ Taxas sincronizadas com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao salvar taxas:', error);
        showInlineMessage('feesListFastPanel', `‚ùå Taxas salvas apenas no aparelho (falha ao sincronizar). ${error?.message ? 'Detalhe: ' + error.message : ''}`, 'error');
      }
    });

    // Store status sync via Supabase
    let storeIsClosed = false;
    let closeStoreConfirmShown = false;

    async function loadStoreStatus() {
      try {
        const today = formatYYYYMMDD(getBrasiliaDate());
        const { data, error } = await window.supabaseClient
          .from('fast_store_status')
          .select('*')
          .eq('date', today)
          .maybeSingle(); // Use maybeSingle instead of single to avoid 406 error

        if (error) throw error;

        if (data && data.is_closed) {
          storeIsClosed = true;
        } else {
          // Check localStorage as fallback
          const manuallyClosed = localStorage.getItem('fastManuallyClosed');
          const todayStr = getBrasiliaDate().toDateString();
          storeIsClosed = manuallyClosed === todayStr;
        }
      } catch (error) {
        // Table might not exist yet, use localStorage fallback
        console.log('Store status: using localStorage fallback');
        const manuallyClosed = localStorage.getItem('fastManuallyClosed');
        const todayStr = getBrasiliaDate().toDateString();
        storeIsClosed = manuallyClosed === todayStr;
      }
      updateStoreButton();
    }

    async function toggleStoreStatus() {
      const today = formatYYYYMMDD(getBrasiliaDate());
      const todayStr = getBrasiliaDate().toDateString();

      try {
        if (storeIsClosed) {
          // Open store
          await window.supabaseClient
            .from('fast_store_status')
            .delete()
            .eq('date', today);
          localStorage.removeItem('fastManuallyClosed');
          storeIsClosed = false;
        } else {
          // Close store
          await window.supabaseClient
            .from('fast_store_status')
            .upsert({ date: today, is_closed: true }, { onConflict: 'date' });
          localStorage.setItem('fastManuallyClosed', todayStr);
          storeIsClosed = true;
        }
      } catch (error) {
        console.error('Erro ao sincronizar status da loja:', error);
        // Fallback to localStorage
        if (storeIsClosed) {
          localStorage.removeItem('fastManuallyClosed');
          storeIsClosed = false;
        } else {
          localStorage.setItem('fastManuallyClosed', todayStr);
          storeIsClosed = true;
        }
      }

      updateStoreButton();
      updateOpenNotice();
    }

    function updateStoreButton() {
      const btn = document.getElementById('closeStoreToday');
      if (!btn) return;

      if (storeIsClosed) {
        btn.textContent = 'Abrir';
        btn.classList.remove('bg-red-600', 'bg-orange-500', 'bg-gray-500');
        btn.classList.add('bg-green-600');
        btn.disabled = false;
      } else {
        btn.textContent = 'Fechar';
        btn.classList.remove('bg-green-600', 'bg-orange-500', 'bg-gray-500');
        btn.classList.add('bg-red-600');
        btn.disabled = false;
      }
      closeStoreConfirmShown = false;
    }

    document.getElementById('closeStoreToday')?.addEventListener('click', () => {
      if (!closeStoreConfirmShown) {
        // Show confirmation inline
        const btn = document.getElementById('closeStoreToday');
        btn.textContent = storeIsClosed ? 'Confirmar Abrir?' : 'Confirmar Fechar?';
        btn.classList.remove('bg-red-600', 'bg-green-600');
        btn.classList.add('bg-orange-500', 'animate-pulse');
        closeStoreConfirmShown = true;

        // Auto-reset after 3 seconds if not confirmed
        setTimeout(() => {
          if (closeStoreConfirmShown) {
            updateStoreButton();
          }
        }, 3000);
      } else {
        // Confirmed - toggle store status
        toggleStoreStatus();
      }
    });

    // Load store status on init
    loadStoreStatus();

    // Welcome Screen - Enter buttons (desktop and mobile)
    document.getElementById('enterStoreBtn')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      sessionStorage.setItem('fastWelcomeSeen', 'true');
    });
    document.getElementById('enterStoreBtnMobile')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      sessionStorage.setItem('fastWelcomeSeen', 'true');
    });

    // Public Store Logo - Click to return to welcome screen
    document.getElementById('publicStoreLogo')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.remove('hidden');
      sessionStorage.removeItem('fastWelcomeSeen');
    });

    // Check if welcome was already seen in this session
    if (sessionStorage.getItem('fastWelcomeSeen') === 'true') {
      document.getElementById('welcomeScreen')?.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    // Evento para salvar novo endere√ßo
    document.getElementById('saveNewAddress')?.addEventListener('click', saveNewAddress);

    // Seed default fees for Fast (same as Imperio)
    function seedDefaultFastFees() {
      const existing = readFastFees();
      if (Object.keys(existing).length > 0) return;
      const defaults = {
        'novo prado': 0, 'sao domingos': 0, 'cristo redentor': 0, 'baixa fria': 0,
        'varzea alegre': 2, 'sao bernardo': 2, 'santo antonio': 2, 'canaa': 2, 'centro': 2, 'fatima': 2, '31 de marco': 2, 'bnh': 2, 'vale do jucurucu': 2, 'jaqueira': 2, 'cidade baixa': 2,
        'marotinho': 3, 'corujao': 3, 'primavera': 3, 'bela vista': 3, 'vista bela': 3, 'liberdade': 3, 'urbis 2': 3, 'urbis 3': 3, 'italage': 3,
        'portal do monte': 4, 'alvorada': 4, 'monte pescoco': 4, 'tarcizao': 4, 'vista da pedra': 4, 'village das pedras': 4, 'itatiaia': 4, 'furlan': 4
      };
      writeFastFees(defaults);
    }
    seedDefaultFastFees();

    // Fees Panel Functions (Fast Admin)
    // Fees Panel Functions (Fast Admin)
    function renderFastFeesListPanel() {
      const list = document.getElementById('feesListFastPanel');
      if (!list) return;
      const m = readFastFees();
      const entries = Object.entries(m).sort((a, b) => {
        const feeA = typeof a[1] === 'object' ? a[1].fee : a[1];
        const feeB = typeof b[1] === 'object' ? b[1].fee : b[1];
        return feeA - feeB || a[0].localeCompare(b[0]);
      });

      list.innerHTML = entries.length ? entries.map(([k, v]) => {
        const fee = typeof v === 'object' ? v.fee : v;
        const min = typeof v === 'object' ? (v.min || 0) : 0;

        return `<div class='py-3 border-b'>
          <div class='mb-2'>
            <span class='font-medium capitalize text-lg text-gray-900'>${k}</span>
          </div>
          <div class="flex flex-wrap items-end gap-2">
            <div class="flex flex-col">
              <span class="text-xs text-gray-500">Taxa</span>
              <input data-k='${k}' data-type="fee" class='w-24 px-3 py-2 border rounded text-right text-lg' value='${fee}'/>
            </div>
            <div class="flex flex-col">
              <span class="text-xs text-gray-500">A partir de</span>
              <input data-k='${k}' data-type="min" class='w-28 px-3 py-2 border rounded text-right text-lg' value='${min}'/>
            </div>
            <button data-del='${k}' class='bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded h-[42px]'>Excluir</button>
          </div>
        </div>`;
      }).join('') : `<p class='text-gray-600 py-4'>Nenhum bairro cadastrado.</p>`;
    }

    document.getElementById('addFeeFastPanel')?.addEventListener('click', () => {
      const b = document.getElementById('feeNeighborhoodFastPanel').value.trim();
      const v = parseFloat(document.getElementById('feeValueFastPanel').value.replace(',', '.'));
      const min = parseFloat(document.getElementById('feeMinValueFastPanel').value.replace(',', '.')) || 0;

      if (!b || isNaN(v)) { alert('Preencha bairro e valor da taxa.'); return; }

      const m = readFastFees();
      m[norm(b)] = { fee: v, min: min };
      writeFastFees(m);

      document.getElementById('feeNeighborhoodFastPanel').value = '';
      document.getElementById('feeValueFastPanel').value = '';
      document.getElementById('feeMinValueFastPanel').value = '';
      renderFastFeesListPanel();
    });

    document.getElementById('feesListFastPanel')?.addEventListener('click', (e) => {
      if (e.target.dataset.del) {
        const m = readFastFees();
        delete m[e.target.dataset.del];
        writeFastFees(m);
        renderFastFeesListPanel();
      }
    });

    document.getElementById('feesListFastPanel')?.addEventListener('change', (e) => {
      if (e.target.dataset.k) {
        const m = readFastFees();
        const key = e.target.dataset.k;
        const type = e.target.dataset.type; // 'fee' or 'min'
        const val = parseFloat(e.target.value.replace(',', '.'));

        if (!isNaN(val)) {
          // Ensure object structure
          if (typeof m[key] !== 'object') {
            m[key] = { fee: m[key], min: 0 };
          }

          if (type === 'fee') m[key].fee = val;
          if (type === 'min') m[key].min = val;

          writeFastFees(m);
        }
      }
    });

    // Batch update buttons
    document.getElementById('batchUpdateMin')?.addEventListener('click', () => {
      const minVal = parseFloat(prompt('Digite o valor m√≠nimo para aplicar a TODOS os bairros listados:', '0'));
      if (isNaN(minVal)) return;

      const m = readFastFees();
      Object.keys(m).forEach(k => {
        if (typeof m[k] !== 'object') m[k] = { fee: m[k], min: 0 };
        m[k].min = minVal;
      });
      writeFastFees(m);
      renderFastFeesListPanel();
      alert('Valores atualizados com sucesso!');
    });

    const toggleLogin = document.getElementById('toggleLoginPass'); if (toggleLogin) { toggleLogin.addEventListener('click', () => { const i = document.getElementById('loginPass'); i.type = i.type === 'password' ? 'text' : 'password'; }); }
    const toggleUser = document.getElementById('toggleUserPass'); if (toggleUser) { toggleUser.addEventListener('click', () => { const i = document.getElementById('userPass'); i.type = i.type === 'password' ? 'text' : 'password'; }); }

    document.getElementById('adminLoginBtn')?.addEventListener('click', () => showLoginModal());
    document.getElementById('adminLoginBtnDesktop')?.addEventListener('click', () => showLoginModal());
    document.getElementById('publicStoreLogoDesktop')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.remove('hidden');
      sessionStorage.removeItem('fastWelcomeSeen');
    });

    // Store Config Event Listeners
    document.getElementById('saveCardFees')?.addEventListener('click', async () => {
      storeConfig.card_fee_1x = parseFloat(document.getElementById('cardFee1x').value) || 5;
      storeConfig.card_fee_2x = storeConfig.card_fee_1x;
      const success = await saveStoreConfig();
      if (success) {
        updateCardFeeLabels(); // Update labels immediately
        showInlineMessage('configPanelFast', '‚úÖ Taxas de cart√£o salvas!', 'success');
      } else {
        showInlineMessage('configPanelFast', '‚ùå Erro ao salvar taxas.', 'error');
      }
    });

    document.getElementById('saveBusinessHours')?.addEventListener('click', async () => {
      const success = await saveBusinessHours();
      if (success) {
        showInlineMessage('configPanelFast', '‚úÖ Hor√°rios salvos! O site ser√° atualizado.', 'success');
        updateOpenNotice();
      } else {
        showInlineMessage('configPanelFast', '‚ùå Erro ao salvar hor√°rios.', 'error');
      }
    });

    document.getElementById('deliveryEnabled')?.addEventListener('change', (e) => {
      const reasonBox = document.getElementById('deliveryDisabledReasonBox');
      if (reasonBox) {
        reasonBox.classList.toggle('hidden', e.target.checked);
      }
    });

    // Save Delivery Settings (including time estimates)
    document.getElementById('saveDeliverySettings')?.addEventListener('click', async () => {
      const enabled = document.getElementById('deliveryEnabled').checked;
      const reason = document.getElementById('deliveryDisabledReason').value.trim();

      storeConfig.delivery_enabled = enabled;
      storeConfig.delivery_disabled_reason = reason;

      // Time Estimates
      storeConfig.prep_time_min = parseInt(document.getElementById('prepTimeMin').value) || 0;
      storeConfig.prep_time_max = parseInt(document.getElementById('prepTimeMax').value) || 0;
      storeConfig.delivery_time_min = parseInt(document.getElementById('deliveryTimeMin').value) || 0;
      storeConfig.delivery_time_max = parseInt(document.getElementById('deliveryTimeMax').value) || 0;

      const success = await saveStoreConfig();
      if (success) {
        showInlineMessage('configPanelFast', '‚úÖ Configura√ß√£o de entrega salva!', 'success');
        updateOpenNotice();
      } else {
        showInlineMessage('configPanelFast', '‚ùå Erro ao salvar.', 'error');
      }
    });

    // ========================================
    // MESSAGE TEMPLATES SERVICE
    // ========================================
    const MsgTemplateService = {
      // Mapeamento entre status do banco (ingl√™s) e chaves dos templates (portugu√™s)
      statusMap: {
        'pending': 'recebido',
        'accepted': 'aceito',
        'preparing': 'em_preparo',
        'confirmed': 'pronto',
        'out_for_delivery': 'saiu_entrega',
        'delivered': 'entregue',
        'cancelled': 'cancelado',
        // Tamb√©m aceita os valores em portugu√™s diretamente
        'recebido': 'recebido',
        'aceito': 'aceito',
        'em_preparo': 'em_preparo',
        'pronto': 'pronto',
        'saiu_entrega': 'saiu_entrega',
        'entregue': 'entregue',
        'cancelado': 'cancelado'
      },

      // Mapeamento reverso: portugu√™s -> ingl√™s (para enviar ao banco)
      statusToDb: {
        'recebido': 'pending',
        'aceito': 'accepted',
        'em_preparo': 'preparing',
        'pronto': 'confirmed',
        'saiu_entrega': 'out_for_delivery',
        'entregue': 'delivered',
        'cancelado': 'cancelled'
      },

      defaults: {
        recebido: 'Ol√° {{nome}}! Recebemos seu pedido #{{pedido}} com sucesso. üéâ\nResumo: {{itens}}\nTotal: R$ {{total}}\nJ√° vamos come√ßar a preparar!',
        aceito: '{{saudacao}}, {{nome}}! üéâ\n\nSeu pedido #{{pedido}} foi *ACEITO* pela Fast Savory\'s!\n\nPara confirmar sua encomenda, realize o pagamento pelo link:\n{{payment_link}}\n\nüí≥ *Op√ß√µes:*\n‚Ä¢ M√≠nimo 50% agora (entrada)\n‚Ä¢ Ou valor total\n\n*Valor:* R$ {{total}}\n\nObrigado! ‚ù§Ô∏è',
        em_preparo: 'Ol√° {{nome}}! Seu pedido #{{pedido}} j√° est√° sendo preparado com muito carinho! üç≥üî•\nTempo estimado: {{preparo}} min.',
        pronto: 'Opa {{nome}}! Seu pedido #{{pedido}} est√° PRONTO! ‚úÖ\n{{tipo_entrega}}',
        saiu_entrega: 'Ol√° {{nome}}! Seu pedido #{{pedido}} saiu para entrega! üöö\nAguarde nosso entregador.',
        entregue: 'Ol√°, {{nome}}! üòä\n\nSeu pedido *{{pedido}}* foi entregue!\n\nNos ajude a melhorar: avalie sua experi√™ncia:\n{{rating_link}}\n\nObrigado por escolher a Fast Savory\'s! ü•ü‚ù§Ô∏è',
        cancelado: 'Ol√° {{nome}}. Infelizmente seu pedido #{{pedido}} foi cancelado.\nMotivo: {{motivo}} üòî'
      },

      getAll: function () {
        const saved = localStorage.getItem('fastMsgTemplates');
        return saved ? { ...this.defaults, ...JSON.parse(saved) } : this.defaults;
      },

      save: function (templates) {
        localStorage.setItem('fastMsgTemplates', JSON.stringify(templates));
      },

      // Extrai primeiro nome ou nome composto (ex: "Jo√£o Pedro" de "Jo√£o Pedro dos Santos Costa")
      getFirstName: function (fullName) {
        if (!fullName) return 'Cliente';
        const parts = fullName.trim().split(/\s+/);
        if (parts.length <= 2) return fullName.trim();
        // Conectores comuns em portugu√™s
        const connectors = ['de', 'da', 'do', 'das', 'dos', 'e'];
        // Pega primeiro nome e segundo se n√£o for conector
        let firstName = parts[0];
        if (parts.length > 1 && !connectors.includes(parts[1].toLowerCase())) {
          firstName += ' ' + parts[1];
        }
        return firstName;
      },

      // Gera sauda√ß√£o din√¢mica baseada no hor√°rio
      getGreeting: function () {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'Bom dia';
        if (hour >= 12 && hour < 18) return 'Boa tarde';
        return 'Boa noite';
      },

      getFormatted: function (status, order) {
        // Mapeia o status para a chave correta do template
        // Se status vazio, usa 'recebido' como padr√£o
        const safeStatus = status || 'recebido';
        const templateKey = this.statusMap[safeStatus] || safeStatus;
        const tpl = this.getAll()[templateKey] || this.defaults.recebido;

        if (!tpl) {
          console.warn('[MsgTemplate] Template n√£o encontrado para status:', status, '-> key:', templateKey);
        }

        const itemsSummary = (order.items || []).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const address = order.address ? `${order.address.street}, ${order.address.number}` : 'Balc√£o';
        const deliveryText = order.delivery_type === 'entrega' ? 'Aguarde o entregador.' : 'Pode vir retirar!';
        const prepTime = `${storeConfig.prep_time_min || 20}-${storeConfig.prep_time_max || 40}`;

        // Usa apenas primeiro nome (ou nome composto)
        const firstName = this.getFirstName(order.client_name);

        // Sauda√ß√£o din√¢mica
        const greeting = this.getGreeting();

        // Gerar link de avalia√ß√£o
        const orderCode = order.order_code || formatOrderCode(order.id);
        const ratingLink = buildRatingLink(orderCode, order.client_phone);

        return tpl
          .replace(/{{nome}}/g, firstName)
          .replace(/{{pedido}}/g, orderCode)
          .replace(/{{total}}/g, (order.total || 0).toFixed(2).replace('.', ','))
          .replace(/{{itens}}/g, itemsSummary || 'Itens do pedido')
          .replace(/{{endereco}}/g, address)
          .replace(/{{motivo}}/g, 'Imprevisto na cozinha')
          .replace(/{{tipo_entrega}}/g, deliveryText)
          .replace(/{{preparo}}/g, prepTime)
          .replace(/{{saudacao}}/g, greeting)
          .replace(/{{payment_link}}/g, order.payment_link || '[Link ser√° enviado]')
          .replace(/{{rating_link}}/g, ratingLink);
      }
    };

    // Template UI Logic
    const templateStatusSelect = document.getElementById('templateStatusSelect');
    const templateContent = document.getElementById('templateContent');

    if (templateStatusSelect) {
      templateStatusSelect.addEventListener('change', loadTemplateToEditor);
      document.getElementById('saveTemplate')?.addEventListener('click', saveCurrentTemplate);
      document.getElementById('resetTemplate')?.addEventListener('click', () => {
        const status = templateStatusSelect.value;
        templateContent.value = MsgTemplateService.defaults[status];
      });
      // Init
      loadTemplateToEditor();
    }

    function loadTemplateToEditor() {
      const status = templateStatusSelect.value;
      const templates = MsgTemplateService.getAll();
      templateContent.value = templates[status] || '';
    }

    function saveCurrentTemplate() {
      const status = templateStatusSelect.value;
      const content = templateContent.value;
      const templates = MsgTemplateService.getAll();
      templates[status] = content;
      MsgTemplateService.save(templates);
      showInlineMessage('configPanelFast', '‚úÖ Template salvo!', 'success');
    }

    // Msg Update Modal Logic
    let currentUpdateOrderId = null;

    async function prepareOrderUpdate(orderId) {
      currentUpdateOrderId = orderId;
      const { data: order } = await window.supabaseClient.from('fast_orders').select('*').eq('id', orderId).single();
      if (!order) return;

      const modal = document.getElementById('msgUpdateModal');
      document.getElementById('msgUpdateOrderId').value = orderId;
      document.getElementById('msgUpdateStatus').value = order.status;

      // Update preview on status change
      const updatePreview = () => {
        const newStatus = document.getElementById('msgUpdateStatus').value;
        document.getElementById('msgUpdatePreview').value = MsgTemplateService.getFormatted(newStatus, order);
      };

      document.getElementById('msgUpdateStatus').onchange = updatePreview;
      updatePreview(); // Initial load

      modal.classList.remove('hidden');
    }

    // Event Listeners for Modal
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('closeMsgUpdate')?.addEventListener('click', function () {
        document.getElementById('msgUpdateModal').classList.add('hidden');
      });

      document.getElementById('confirmMsgUpdate')?.addEventListener('click', async function () {
        const orderId = document.getElementById('msgUpdateOrderId').value;
        const newStatus = document.getElementById('msgUpdateStatus').value;
        const msg = document.getElementById('msgUpdatePreview').value;

        // Send WhatsApp
        const { data: order } = await window.supabaseClient.from('fast_orders').select('client_phone').eq('id', orderId).single();
        if (order && order.client_phone) {
          const cleanPhone = order.client_phone.replace(/\D/g, '');
          const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`;
          window.open(url, '_blank');
        }

        // Update Status in Supabase (converte portugu√™s -> ingl√™s para o banco)
        const dbStatus = MsgTemplateService.statusToDb[newStatus] || newStatus;
        updateOrderStatus(orderId, dbStatus);

        document.getElementById('msgUpdateModal').classList.add('hidden');
      });
    });

    // Note: saveStoreConfig and loadStoreConfig are defined earlier and sync with Supabase

    // REDEFINE updateOpenNotice to include Time Estimates
    function updateOpenNotice() {
      const notice = document.getElementById('openNotice');
      if (!notice) return;

      let text = '';
      let colorClass = '';
      const isOpen = isFastOpen();

      if (storeIsClosed) {
        text = 'üî¥ Loja Fechada Temporariamente';
        colorClass = 'bg-red-100 text-red-800 border-red-200 border';
      } else if (isOpen) {
        text = 'üü¢ Estamos Abertos! Fa√ßa seu pedido.';
        colorClass = 'bg-green-100 text-green-800 border-green-200 border';
      } else {
        text = 'üî¥ Fechado no momento. Confira nossos hor√°rios.';
        colorClass = 'bg-red-100 text-red-800 border-red-200 border';
      }

      // Append Time Estimates if configured and open
      if (isOpen && !storeIsClosed) {
        const prep = (storeConfig.prep_time_min && storeConfig.prep_time_max) ?
          `üïí Preparo: ${storeConfig.prep_time_min}-${storeConfig.prep_time_max} min` : '';

        const del = (storeConfig.delivery_enabled && storeConfig.delivery_time_min && storeConfig.delivery_time_max) ?
          `üõµ Entrega: ${storeConfig.delivery_time_min}-${storeConfig.delivery_time_max} min` : '';

        if (prep || del) {
          text += ` ‚Ä¢ ${[prep, del].filter(Boolean).join(' ‚Ä¢ ')}`;
        }
      }

      notice.textContent = text;
      notice.className = `text-sm py-2 px-3 rounded-lg my-2 text-center font-medium ${colorClass}`;

      // Update delivery status banner
      updateDeliveryStatusBanner();
    }

    // Verificar se h√° alta demanda (muitos pedidos em preparo)
    async function checkHighDemand() {
      try {
        const maxConcurrent = storeConfig.max_concurrent_orders || 10;

        // Contar pedidos em preparo (status: pending, preparing, accepted, confirmed)
        const { data, error } = await window.supabaseClient
          .from('fast_orders')
          .select('id')
          .in('status', ['pending', 'preparing', 'accepted', 'confirmed'])
          .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());

        if (error) throw error;

        const inProgressCount = (data || []).length;
        return inProgressCount >= maxConcurrent;
      } catch (e) {
        console.warn('[HighDemand] Erro ao verificar:', e);
        return false;
      }
    }

    // Delivery status banner for public store
    async function updateDeliveryStatusBanner() {
      const banner = document.getElementById('deliveryStatusBanner');
      if (!banner) return;

      const isOpen = isFastOpen() && !storeIsClosed;

      // Only show delivery banner when store is open
      if (!isOpen) {
        banner.classList.add('hidden');
        return;
      }

      banner.classList.remove('hidden');

      // Verificar alta demanda
      const isHighDemand = await checkHighDemand();
      const extraTime = isHighDemand ? (storeConfig.high_demand_extra_time || 15) : 0;

      if (storeConfig.delivery_enabled) {
        // Delivery available
        let deliveryText = 'üõµ Entregas dispon√≠veis';

        // Add time estimates if configured (com ajuste de alta demanda)
        if (storeConfig.delivery_time_min && storeConfig.delivery_time_max) {
          const minTime = parseInt(storeConfig.delivery_time_min) + extraTime;
          const maxTime = parseInt(storeConfig.delivery_time_max) + extraTime;
          deliveryText += ` ‚Ä¢ Tempo estimado: ${minTime}-${maxTime} min`;
        }
        if (storeConfig.prep_time_min && storeConfig.prep_time_max) {
          const minPrep = parseInt(storeConfig.prep_time_min) + extraTime;
          const maxPrep = parseInt(storeConfig.prep_time_max) + extraTime;
          deliveryText += ` ‚Ä¢ Preparo: ${minPrep}-${maxPrep} min`;
        }

        // Aviso de alta demanda
        if (isHighDemand) {
          deliveryText += ' ‚Ä¢ ‚ö†Ô∏è Alta demanda';
        }

        banner.innerHTML = deliveryText;
        const demandClass = isHighDemand ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 'bg-green-50 text-green-700 border-green-200';
        banner.className = `text-sm py-2 px-3 rounded-lg mb-2 text-center font-medium ${demandClass} border`;
      } else {
        // Delivery disabled
        const reason = storeConfig.delivery_disabled_reason || 'No momento, apenas retirada na loja';
        banner.innerHTML = `üö´ Entregas suspensas: <span class="font-semibold">${reason}</span>`;
        banner.className = 'text-sm py-2 px-3 rounded-lg mb-2 text-center font-medium bg-orange-50 text-orange-700 border border-orange-200';
      }
    }

    // Initial update
    updateOpenNotice();

    document.getElementById('saveDeliverySettings')?.addEventListener('click', async () => {
      storeConfig.delivery_enabled = document.getElementById('deliveryEnabled').checked;
      storeConfig.delivery_disabled_reason = document.getElementById('deliveryDisabledReason')?.value || '';
      const success = await saveStoreConfig();
      if (success) {
        const status = storeConfig.delivery_enabled ? 'habilitadas' : 'desabilitadas';
        showInlineMessage('configPanelFast', `‚úÖ Entregas ${status}!`, 'success');
      } else {
        showInlineMessage('configPanelFast', '‚ùå Erro ao salvar configura√ß√£o.', 'error');
      }
    });

    // Salvar todas as taxas - VERS√ÉO SIMPLIFICADA (apenas localStorage)
    // A sincroniza√ß√£o com Supabase foi removida temporariamente devido a erros 400
    const saveAllFeesBtn = document.getElementById('saveAllFeesFast');
    if (saveAllFeesBtn && !saveAllFeesBtn.hasAttribute('data-listener-attached')) {
      saveAllFeesBtn.setAttribute('data-listener-attached', 'true');

      saveAllFeesBtn.addEventListener('click', () => {
        // As taxas j√° s√£o salvas automaticamente no localStorage ao editar
        // Este bot√£o apenas confirma que est√° tudo salvo
        showInlineMessage('configPanelFast', '‚úÖ Taxas salvas localmente!', 'success');
      });
    }
  </script>

  <!-- Msg Update Modal -->
  <div id="msgUpdateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Atualizar Pedido & Notificar</h3>
      <input type="hidden" id="msgUpdateOrderId">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Novo Status</label>
          <select id="msgUpdateStatus" class="w-full px-3 py-2 border rounded-lg">
            <option value="recebido">üÜï Recebido</option>
            <option value="em_preparo">üç≥ Em Preparo</option>
            <option value="pronto">‚úÖ Pronto</option>
            <option value="saiu_entrega">üöö Saiu para Entrega</option>
            <option value="entregue">‚úîÔ∏è Entregue</option>
            <option value="cancelado">‚ùå Cancelado</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem (Preview)</label>
          <textarea id="msgUpdatePreview" rows="4"
            class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50"></textarea>
        </div>
        <div class="flex gap-2 justify-end mt-4">
          <button type="button" id="closeMsgUpdate"
            class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
          <button type="button" id="confirmMsgUpdate"
            class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700">Enviar e Atualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fees Modal Fast (Admin) -->
  <div id="feesModalFast" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
    onclick="if(event.target===this) closeFeesFastModal();">
    <div class="bg-white rounded-xl p-6 w-full max-w-xl mx-4 max-h-[90vh] overflow-y-auto"
      onclick="event.stopPropagation();">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800">Taxas de Entrega</h3>
        <button type="button" id="closeFeesFast"
          class="text-gray-600 hover:text-gray-800 text-3xl font-bold leading-none">√ó</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <input type="text" id="feeNeighborhoodFast" class="md:col-span-2 w-full px-3 py-2 border rounded"
          placeholder="Bairro" />
        <input type="number" step="0.01" id="feeValueFast" class="w-full px-3 py-2 border rounded"
          placeholder="Valor (R$)" />
      </div>
      <div class="mb-3 flex gap-2">
        <button type="button" id="addFeeFast"
          class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded">Adicionar/Atualizar</button>
        <button type="button" id="saveAllFeesFast"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Salvar Todas as Taxas</button>
      </div>
      <div id="feesListFast" class="divide-y"></div>
    </div>
    <!-- Script to ensure FAB and cartModal are at body level for proper fixed positioning -->
    <script>
      (function () {
        // Move floating elements to body level to ensure position:fixed works correctly
        var fab = document.getElementById('floatingCartButton');
        var cartModal = document.getElementById('cartModal');
        if (fab && fab.parentNode !== document.body) {
          document.body.appendChild(fab);
        }
        if (cartModal && cartModal.parentNode !== document.body) {
          document.body.appendChild(cartModal);
        }
        // Ensure FAB has correct fixed positioning styles (in case CSS classes don't apply)
        if (fab) {
          fab.style.position = 'fixed';
          fab.style.bottom = '1rem';
          fab.style.right = '1rem';
          fab.style.zIndex = '9999';
        }
      })();
    </script>
</body>

</html>