<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fast Savory's | Delivery</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Error handlers para debug iOS (tela branca)
    window._debugErrors = [];
    window.addEventListener('error', function(e) {
      var msg = '[GLOBAL ERROR] ' + e.message + ' at ' + e.filename + ':' + e.lineno;
      console.error(msg);
      window._debugErrors.push(msg);
      // Mostra erro visualmente em iOS para debug
      if (window._debugErrors.length <= 3) {
        var div = document.createElement('div');
        div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:10px;z-index:99999;font-size:12px;';
        div.textContent = msg;
        document.body && document.body.appendChild(div);
      }
    });
    window.addEventListener('unhandledrejection', function(e) {
      var msg = '[PROMISE ERROR] ' + (e.reason ? (e.reason.message || e.reason) : 'unknown');
      console.error(msg);
      window._debugErrors.push(msg);
    });

    // Helper para compatibilidade iOS com Datas
    window.safeDate = function (value) {
      if (value === undefined || value === null) return new Date();
      if (value instanceof Date) return value;
      if (typeof value === 'string') {
        // Corrige formato "YYYY-MM-DD HH:mm" para "YYYY-MM-DDTHH:mm" (ISO 8601)
        if (value.includes(' ') && value.includes(':') && !value.includes('T')) {
          value = value.replace(' ', 'T');
        }
      }
      return new Date(value);
    };

    // Service Worker: desregistrar em ambiente local para evitar cache antigo
    (function() {
      try {
        var hostname = location.hostname;
        var isLocal = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1';
        var isPrivateIP = hostname.indexOf('192.168.') === 0 || hostname.indexOf('10.') === 0 || 
                          (hostname.indexOf('172.') === 0 && parseInt(hostname.split('.')[1]) >= 16 && parseInt(hostname.split('.')[1]) <= 31);
        if ((isLocal || isPrivateIP) && 'serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function(regs) {
            regs.forEach(function(reg) {
              reg.unregister();
              console.log('[SW] Desregistrado automaticamente em ambiente local');
            });
          }).catch(function(e) { console.log('[SW] Erro ao desregistrar:', e); });
          // Limpar caches antigos
          if ('caches' in window) {
            caches.keys().then(function(names) {
              names.forEach(function(name) { caches.delete(name); });
              if (names.length) console.log('[CACHE] Limpo automaticamente em ambiente local');
            }).catch(function(e) { console.log('[CACHE] Erro ao limpar:', e); });
          }
        }
      } catch (e) {
        console.log('[SW/CACHE] Erro geral:', e);
      }
    })();
  </script>
  <link rel="stylesheet" href="../assets/css/styles.css" />
  <style>
    .fs-accent {
      background: linear-gradient(135deg, #f59e0b, #ef4444, #f472b6);
    }

    .fs-chip {
      background: #fde68a;
      color: #7c2d12
    }

    input,
    select,
    textarea {
      color: #111 !important;
    }
  </style>
</head>

<body class="bg-white">
  <!-- Welcome Screen with Gradient Background -->
  <div id="welcomeScreen" class="fixed inset-0 z-[100]"
    style="background: linear-gradient(135deg, #9e0b5a 0%, #7a0945 25%, #5a0733 50%, #1f2937 75%, #000000 100%);">

    <!-- Centered Logo Image -->
    <div class="absolute inset-0 flex items-center justify-center">
      <img src="../assets/img/capa-logo.png" alt="Fast Savory's"
        class="max-w-[85%] max-h-[75%] sm:max-w-[80%] sm:max-h-[80%] md:max-w-[85%] md:max-h-[85%] object-contain drop-shadow-2xl" />
    </div>

    <!-- Mobile: Text at TOP, Button at BOTTOM (below logo) -->
    <div class="sm:hidden absolute top-6 left-0 right-0 z-10 text-center px-4">
      <h1 class="text-xl font-bold text-white drop-shadow-lg">
        Bem-vindo Ã  <span class="text-yellow-400">FastSavory's</span>
      </h1>
      <p class="text-sm text-white mt-1 drop-shadow-lg">
        FaÃ§a agora mesmo a sua encomenda!
      </p>
    </div>
    <!-- Mobile Button below logo -->
    <div class="sm:hidden absolute bottom-12 left-0 right-0 z-10 text-center px-4">
      <button id="enterStoreBtnMobile"
        class="px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-black font-bold text-base rounded-full shadow-2xl animate-pulse">
        ğŸ›’ Fazer Pedido
      </button>
    </div>

    <!-- Desktop: Text at top left with larger size -->
    <div class="hidden sm:block absolute top-8 left-8 md:top-12 md:left-12 z-10 max-w-2xl">
      <h1 class="text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-bold text-white drop-shadow-lg">
        Bem-vindo Ã  <span class="text-yellow-400" style="-webkit-text-stroke: 1px black;">FastSavory's</span>
      </h1>
      <p class="text-xl md:text-2xl text-white mt-4 mb-10 drop-shadow-lg whitespace-nowrap">
        FaÃ§a agora mesmo a sua encomenda!
      </p>
      <button id="enterStoreBtn"
        class="px-8 py-4 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-black font-bold text-xl md:text-2xl rounded-full shadow-2xl transform hover:scale-105 transition-all duration-300 animate-pulse">
        ğŸ›’ Fazer Pedido
      </button>
    </div>
  </div>







  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Entrar</h2>
      <form id="loginForm" class="space-y-4">
        <div class="text-center">
          <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Login</label>
          <input type="text" id="loginUser"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400 text-gray-900 placeholder-gray-400 text-center"
            required>
        </div>
        <div class="text-center">
          <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Senha</label>
          <div class="relative">
            <input type="password" id="loginPass"
              class="w-full pr-10 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400 text-gray-900 placeholder-gray-400 text-center"
              required>
            <button type="button" id="toggleLoginPass"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">ğŸ‘ï¸</button>
          </div>
        </div>
        <div class="flex items-center justify-center gap-2">
          <input type="checkbox" id="rememberUser" class="w-4 h-4 rounded border-gray-300">
          <label for="rememberUser" class="text-sm text-gray-600">Lembrar meu usuÃ¡rio</label>
        </div>
        <div id="loginError" class="hidden text-center p-3 rounded-lg bg-red-100 text-red-700 text-sm"></div>
        <button type="submit"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium text-center">Entrar</button>
        <button type="button" id="goToPublic"
          class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg font-medium text-center">Ir para
          Loja</button>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <header class="text-white shadow-lg" style="background:#000">
      <div class="container mx-auto px-3 py-3">
        <!-- Desktop: Logo + Nav Buttons + Logout all in one line -->
        <div class="hidden sm:flex items-center justify-between gap-4">
          <img src="../assets/img/fast-logo.png" alt="Fast Savory's" class="h-12 object-contain" />
          <div class="flex flex-wrap items-center gap-2">
            <button id="showProductsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Produtos</button>
            <button id="showClientsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Clientes</button>
            <button id="showPromotionsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">PromoÃ§Ãµes</button>
            <button id="showReportsPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">RelatÃ³rios</button>
            <button id="showOrdersPanelFast"
              class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg text-xs">ğŸ“‹ Pedidos</button>
            <button id="showConfigPanelFast"
              class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs">Config</button>
            <button id="closeStoreToday"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs">Fechar</button>
            <button id="goToStore" class="bg-rose-200 hover:bg-rose-300 text-black px-3 py-2 rounded-lg text-xs">Ver
              Loja</button>
            <button id="logoutBtn"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs">Sair</button>
          </div>
        </div>

        <!-- Mobile: Logo + Logout on top, buttons below -->
        <div class="sm:hidden">
          <div class="flex items-center justify-between mb-3">
            <img src="../assets/img/fast-logo.png" alt="Fast Savory's" class="h-10 object-contain" />
            <button id="logoutBtnMobile"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs">Sair</button>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <button id="showProductsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Produtos</button>
            <button id="showClientsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Clientes</button>
            <button id="showPromotionsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">PromoÃ§Ãµes</button>
            <button id="showReportsPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">RelatÃ³rios</button>
            <button id="showOrdersPanelFastMobile"
              class="bg-orange-600 hover:bg-orange-700 text-white px-2 py-2 rounded-lg text-xs text-center">ğŸ“‹
              Pedidos</button>
            <button id="showConfigPanelFastMobile"
              class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs text-center">Config</button>
            <button id="closeStoreTodayMobile"
              class="bg-red-600 hover:bg-red-700 text-white px-2 py-2 rounded-lg text-xs text-center">Fechar</button>
            <button id="goToStoreMobile"
              class="col-span-3 bg-rose-200 hover:bg-rose-300 text-black px-2 py-2 rounded-lg text-xs text-center">Ver
              Loja</button>
          </div>
        </div>
      </div>
    </header>


    <main id="productsPanelFast" class="container mx-auto px-4 py-6">
      <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-6">
          <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Adicionar Produto</h3>
            <form id="productForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                <input id="productName" class="w-full px-3 py-2 border rounded-lg" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">DescriÃ§Ã£o</label>
                <textarea id="productDescription" class="w-full px-3 py-2 border rounded-lg" rows="3"
                  required></textarea>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">PreÃ§o (R$)</label>
                  <input type="number" id="productPrice" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                    required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                  <select id="productCategory" class="w-full px-3 py-2 border rounded-lg" required>
                    <option value="salgados">Salgados</option>
                    <option value="mini">Mini-Salgados</option>
                    <option value="kits">Kits Festa</option>
                    <option value="bolos">Bolos</option>
                    <option value="bebidas">Bebidas</option>
                    <option value="adicionais">Adicionais</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Imagem</label>
                <input type="file" id="productImage" accept="image/*" class="w-full" />
              </div>

              <!-- Disponibilidade (Sazonalidade + IndisponÃ­vel hoje) -->
              <div class="border-t pt-4 mt-2">
                <h5 class="text-sm font-medium text-gray-700 mb-3">ğŸ“… Disponibilidade</h5>
                <div class="grid grid-cols-2 gap-3 mb-3">
                  <div>
                    <label class="text-xs text-gray-600">DisponÃ­vel a partir de</label>
                    <input type="date" id="productStartDate" class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">DisponÃ­vel atÃ©</label>
                    <input type="date" id="productEndDate" class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                </div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="productUnavailableToday" class="w-4 h-4 text-rose-600">
                  <span class="text-sm text-gray-700">IndisponÃ­vel hoje</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">Deixe as datas vazias para disponibilidade contÃ­nua.</p>
              </div>

              <!-- PromoÃ§Ã£o -->
              <div class="border-t pt-4 mt-2">
                <h5 class="text-sm font-medium text-gray-700 mb-3">ğŸ·ï¸ PromoÃ§Ã£o</h5>
                <label class="flex items-center gap-2 cursor-pointer mb-3">
                  <input type="checkbox" id="productPromoActive" class="w-4 h-4 text-rose-600">
                  <span class="text-sm text-gray-700">Produto em promoÃ§Ã£o</span>
                </label>
                <div id="promoDetailsFields" class="hidden grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-xs text-gray-600">Tipo de desconto</label>
                    <select id="productPromoType" class="w-full px-2 py-1 border rounded text-sm">
                      <option value="percent">% Percentual</option>
                      <option value="value">R$ Valor fixo</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Valor do desconto</label>
                    <input type="number" id="productPromoValue" step="0.01" placeholder="0"
                      class="w-full px-2 py-1 border rounded text-sm">
                  </div>
                </div>
              </div>

              <!-- Encomenda -->
              <div class="border-t pt-4 mt-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="productIsEncomenda" class="w-4 h-4 text-rose-600">
                  <span class="text-sm text-gray-700">ğŸ“… TÃ­pico de encomenda (exige agendamento)</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">Ex.: Kits festa, bolos personalizados.</p>
              </div>

              <button type="submit"
                class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Salvar
                Produto</button>
            </form>
          </div>

        </div>

        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Produtos Cadastrados</h3>
            <div class="flex flex-wrap gap-2 mb-3">
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900" data-filter="all">Todas</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="salgados">Salgados</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900" data-filter="mini">Mini</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900" data-filter="kits">Kits</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="bolos">Bolos</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="adicionais">Adicionais</button>
              <button class="admin-filter px-3 py-1 rounded bg-rose-200 text-rose-900"
                data-filter="bebidas">Bebidas</button>
              <button class="admin-filter px-3 py-1 rounded bg-gray-200 text-gray-700"
                data-filter="hidden">Ocultos</button>
              <button class="admin-filter px-3 py-1 rounded bg-blue-100 text-blue-800" data-filter="seasonal">ğŸ“…
                Sazonais</button>
              <button class="admin-filter px-3 py-1 rounded bg-red-100 text-red-800" data-filter="unavailable">âŒ
                IndisponÃ­veis</button>
            </div>
            <div id="productsList" class="space-y-4"></div>
          </div>
        </div>
      </div>
    </main>


    <!-- Admin Content - ConfiguraÃ§Ãµes (UsuÃ¡rios + Taxas) -->
    <main id="configPanelFast" class="container mx-auto px-4 py-6 hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <!-- SeÃ§Ã£o de UsuÃ¡rios -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ‘¤ Gerenciar UsuÃ¡rios</h2>
          <form id="userForm" class="space-y-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nome de UsuÃ¡rio</label>
              <input id="userName" class="w-full px-3 py-2 border rounded-lg" placeholder="Digite o nome de usuÃ¡rio"
                required />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                <div class="relative">
                  <input type="password" id="userPass" class="w-full pr-10 px-3 py-2 border rounded-lg"
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required />
                  <button type="button" id="toggleUserPass"
                    class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">ğŸ‘ï¸</button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Papel</label>
                <select id="userRole" class="w-full px-3 py-2 border rounded-lg">
                  <option value="admin">Admin</option>
                  <option value="gerente">Gerente</option>
                  <option value="garcom">GarÃ§om</option>
                  <option value="caixa">Caixa</option>
                </select>
              </div>
            </div>
            <button type="submit" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
              Salvar UsuÃ¡rio
            </button>
          </form>
          <h3 class="font-semibold text-gray-800 mb-3">UsuÃ¡rios Cadastrados</h3>
          <div id="usersList" class="space-y-3 max-h-64 overflow-y-auto"></div>
        </div>

        <!-- SeÃ§Ã£o de HorÃ¡rio de Atendimento (Moved to Left Column - New Position) -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ• HorÃ¡rio de Atendimento</h2>
          <div class="space-y-3" id="businessHoursContainer">
            <!-- Renderizado via JavaScript -->
          </div>
          <button type="button" id="saveBusinessHours"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium mt-4">
            ğŸ’¾ Salvar HorÃ¡rios
          </button>
          <p class="text-xs text-gray-500 mt-2 text-center">O horÃ¡rio de abertura aparecerÃ¡ automaticamente no site.</p>
        </div>

        <!-- SeÃ§Ã£o de Taxas de Entrega -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸšš Taxas de Entrega</h2>
          <div class="space-y-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
              <input type="text" id="feeNeighborhoodFastPanel" class="w-full px-3 py-2 border rounded-lg"
                placeholder="Nome do Bairro" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor da Taxa (R$)</label>
                <input type="number" step="0.01" id="feeValueFastPanel" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="0.00" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">A partir de (R$)</label>
                <input type="number" step="0.01" id="feeMinValueFastPanel" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="15.00" />
              </div>
            </div>
            <button type="button" id="addFeeFastPanel"
              class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
              Adicionar/Atualizar Taxa
            </button>
          </div>

          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-gray-800">Bairros Cadastrados</h3>
            <button type="button" id="batchUpdateMin" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
              ğŸ”„ Atualizar "A partir de" em massa
            </button>
          </div>

          <div id="feesListFastPanel"
            class="divide-y max-h-[500px] overflow-y-auto mb-4 border rounded-lg p-2 bg-gray-50"></div>

          <button type="button" id="saveAllFeesFastPanel"
            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-lg">
            ğŸ’¾ Salvar Todas as Taxas
          </button>
        </div>
      </div>

      <!-- SeÃ§Ã£o de Taxas de CartÃ£o -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ’³ Taxas de CartÃ£o</h2>
        <div class="grid grid-cols-1 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">CartÃ£o 1x (%)</label>
            <input type="number" id="cardFee1x" step="0.1" min="0" max="100" class="w-full px-3 py-2 border rounded-lg"
              placeholder="5.00" />
          </div>
        </div>
        <button type="button" id="saveCardFees"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
          ğŸ’¾ Salvar Taxas de CartÃ£o
        </button>
        <p class="text-xs text-gray-500 mt-2 text-center">As taxas serÃ£o aplicadas automaticamente no checkout.</p>
      </div>



      <!-- SeÃ§Ã£o de Toggle de Delivery -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸšš Controle de Entregas</h2>
        <div class="flex items-center justify-between mb-4 p-4 bg-gray-50 rounded-lg">
          <div>
            <span class="text-gray-800 font-semibold">Delivery Habilitado</span>
            <p class="text-xs text-gray-500">Quando desativado, apenas retirada na loja.</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="deliveryEnabled" class="sr-only peer" checked>
            <div
              class="w-14 h-7 bg-gray-300 peer-focus:ring-2 peer-focus:ring-rose-300 rounded-full peer peer-checked:bg-green-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-7 shadow-inner">
            </div>
          </label>
        </div>
        <div id="deliveryDisabledReasonBox" class="hidden mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da suspensÃ£o</label>
          <input type="text" id="deliveryDisabledReason"
            class="w-full px-3 py-2 border rounded-lg border-orange-300 bg-orange-50"
            placeholder="Ex: Mau tempo, falta de motoboy, alta demanda..." />
          <p class="text-xs text-orange-600 mt-1">Este motivo serÃ¡ exibido para os clientes.</p>
        </div>
        <div class="mt-4 border-t pt-4">
          <h4 class="font-semibold text-gray-800 mb-3">â±ï¸ Estimativas de Tempo</h4>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Preparo (min)</label>
              <div class="flex gap-2">
                <input type="number" id="prepTimeMin" placeholder="Min" class="w-full px-2 py-1 border rounded" min="0">
                <input type="number" id="prepTimeMax" placeholder="Max" class="w-full px-2 py-1 border rounded" min="0">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Entrega (min)</label>
              <div class="flex gap-2">
                <input type="number" id="deliveryTimeMin" placeholder="Min" class="w-full px-2 py-1 border rounded"
                  min="0">
                <input type="number" id="deliveryTimeMax" placeholder="Max" class="w-full px-2 py-1 border rounded"
                  min="0">
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">Essas estimativas aparecerÃ£o no cabeÃ§alho da loja.</p>
        </div>
        <button type="button" id="saveDeliverySettings"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
          ğŸ’¾ Salvar ConfiguraÃ§Ã£o de Entrega
        </button>
      </div>

      <!-- SeÃ§Ã£o de Mensagens AutomÃ¡ticas -->
      <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ’¬ Mensagens AutomÃ¡ticas</h2>
        <div class="space-y-4">
          <p class="text-sm text-gray-500">Configure as mensagens enviadas via WhatsApp para cada status.</p>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Status</label>
              <select id="templateStatusSelect" class="w-full px-3 py-2 border rounded-lg">
                <option value="recebido">ğŸ†• Recebido</option>
                <option value="em_preparo">ğŸ³ Em Preparo</option>
                <option value="pronto">âœ… Pronto</option>
                <option value="saiu_entrega">ğŸšš Saiu para Entrega</option>
                <option value="entregue">âœ”ï¸ Entregue</option>
                <option value="cancelado">âŒ Cancelado</option>
              </select>
            </div>
            <div class="flex items-end">
              <button type="button" id="resetTemplate" class="text-sm text-rose-600 hover:text-rose-800 mb-3">Restaurar
                PadrÃ£o</button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Template da Mensagem</label>
            <div class="text-xs text-gray-500 mb-2 bg-gray-50 p-2 rounded">
              <strong>VariÃ¡veis:</strong> {{nome}}, {{pedido}}, {{total}}, {{itens}}, {{motivo}}
            </div>
            <textarea id="templateContent" rows="5" class="w-full px-3 py-2 border rounded-lg text-sm font-mono"
              placeholder="OlÃ¡ {{nome}}, seu pedido..."></textarea>
          </div>

          <button type="button" id="saveTemplate"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
            ğŸ’¾ Salvar Template
          </button>
        </div>
      </div>
  </div>
  </main>

  <!-- Admin Content - Clients -->
  <main id="clientsPanelFast" class="container mx-auto px-4 py-6 hidden">
    <div class="grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Cliente</h3>
          <form id="clientForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
              <input id="clientName" class="w-full px-3 py-2 border rounded-lg" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Data de Nascimento *</label>
              <input type="date" id="clientBirthdate" class="w-full px-3 py-2 border rounded-lg" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
              <input id="clientPhone" class="w-full px-3 py-2 border rounded-lg" placeholder="(00) 00000-0000"
                required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
              <input type="email" id="clientEmail" class="w-full px-3 py-2 border rounded-lg"
                placeholder="cliente@email.com" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">EndereÃ§o</label>
              <input id="clientAddress" class="w-full px-3 py-2 border rounded-lg" placeholder="Rua, nÃºmero, bairro" />
            </div>
            <div class="bg-blue-50 p-3 rounded-lg">
              <p class="text-xs text-blue-800">
                <strong>LGPD:</strong> Ao se cadastrar, vocÃª concorda com o uso de seus dados para promoÃ§Ãµes, contato
                e registro de pedidos.
                Seus dados serÃ£o armazenados com seguranÃ§a e poderÃ£o ser excluÃ­dos a qualquer momento mediante
                solicitaÃ§Ã£o.
              </p>
            </div>
            <button type="submit"
              class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Cadastrar
              Cliente</button>
          </form>
        </div>
      </div>
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Clientes Cadastrados</h3>
          <div class="mb-4">
            <input type="text" id="clientSearch" placeholder="Buscar por nome ou telefone..."
              class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div id="clientsList" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Admin Content - Promotions -->
  <main id="promotionsPanelFast" class="container mx-auto px-4 py-6 hidden">
    <div class="grid lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">PromoÃ§Ãµes por Produto</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Produto</label>
            <select id="promotionProduct" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Escolha um produto...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Desconto</label>
            <select id="promotionType" class="w-full px-3 py-2 border rounded-lg">
              <option value="percentage">Percentual (%)</option>
              <option value="fixed">Valor Fixo (R$)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Valor do Desconto</label>
            <input type="number" id="promotionValue" step="0.01" class="w-full px-3 py-2 border rounded-lg"
              placeholder="0.00" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">DescriÃ§Ã£o da PromoÃ§Ã£o</label>
            <input type="text" id="promotionDescription" class="w-full px-3 py-2 border rounded-lg"
              placeholder="Ex: PromoÃ§Ã£o de verÃ£o" />
          </div>
          <button type="button" id="savePromotion"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Salvar
            PromoÃ§Ã£o</button>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Descontos por Cliente</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Cliente</label>
            <select id="clientDiscountSelect" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Escolha um cliente...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Desconto de Fidelidade (%)</label>
            <input type="number" id="clientDiscountValue" step="0.01" min="0" max="100"
              class="w-full px-3 py-2 border rounded-lg" placeholder="0" />
          </div>
          <button type="button" id="saveClientDiscount"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">Salvar
            Desconto</button>
        </div>
        <div class="mt-6">
          <h4 class="font-semibold text-gray-800 mb-3">PromoÃ§Ãµes Ativas</h4>
          <div id="promotionsList" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- Cupons de Desconto Section -->
    <div class="mt-6 bg-white rounded-xl shadow p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸŸï¸ Cupons de Desconto</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div id="couponFormContainer">
            <input type="hidden" id="editingCouponId" value="" />
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">CÃ³digo do Cupom</label>
              <input type="text" id="couponCode" class="w-full px-3 py-2 border rounded-lg uppercase"
                placeholder="EX: PROMO10" />
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                <select id="couponType" class="w-full px-3 py-2 border rounded-lg">
                  <option value="percentage">% Percentual</option>
                  <option value="fixed">R$ Fixo</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor</label>
                <input type="number" id="couponValue" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="0.00" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">MÃ­nimo Pedido (R$)</label>
                <input type="number" id="couponMinOrder" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="0.00" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Validade</label>
                <input type="date" id="couponExpiry" class="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Limite Valor (R$)</label>
                <input type="number" id="couponMaxValue" step="0.01" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="Ex: 100.00" />
                <p class="text-xs text-gray-500 mt-1">Limite total de desconto</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Limite Usos</label>
                <input type="number" id="couponMaxUsage" step="1" min="0" class="w-full px-3 py-2 border rounded-lg"
                  placeholder="Ex: 20" />
                <p class="text-xs text-gray-500 mt-1">NÂº de utilizaÃ§Ãµes</p>
              </div>
            </div>
            <div class="flex gap-2 mt-4">
              <button type="button" id="saveCoupon"
                class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
                Criar Cupom
              </button>
              <button type="button" id="cancelEditCoupon"
                class="hidden flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-lg font-medium">
                Cancelar
              </button>
            </div>
          </div>
        </div>
        <div>
          <h4 class="font-semibold text-gray-800 mb-3">âœ… Cupons Ativos</h4>
          <div id="couponsList" class="space-y-2 max-h-48 overflow-y-auto"></div>

          <h4 class="font-semibold text-gray-800 mb-3 mt-6">âŒ Cupons Inativos</h4>
          <div id="inactiveCouponsList" class="space-y-2 max-h-32 overflow-y-auto text-sm"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Reports Panel -->
  <main id="reportsPanelFast" class="hidden container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“Š RelatÃ³rios</h2>

      <!-- Period Filter -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">PerÃ­odo</label>
        <div class="flex flex-wrap gap-2">
          <button id="reportPeriodMonth"
            class="px-4 py-2 bg-rose-600 text-white rounded-lg text-sm font-medium">Mensal</button>
          <button id="reportPeriodSemester"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Semestral</button>
          <button id="reportPeriodYear"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Anual</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- Client Ranking -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ† Ranking de Clientes</h3>
          <p class="text-sm text-gray-600 mb-4">Clientes que mais gastaram no perÃ­odo selecionado:</p>
          <div id="clientRankingList" class="space-y-2 max-h-80 overflow-y-auto">
            <div class="text-center py-8 text-gray-500">
              <p class="text-4xl mb-2">ğŸ“ˆ</p>
              <p>Nenhum pedido registrado ainda.</p>
              <p class="text-xs mt-2">Os pedidos serÃ£o registrados no Supabase para anÃ¡lise.</p>
            </div>
          </div>
        </div>

        <!-- Order History -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ HistÃ³rico de Pedidos</h3>
          <div class="mb-4">
            <input type="text" id="orderSearchClient" placeholder="Buscar por cliente..."
              class="w-full px-3 py-2 border rounded-lg text-sm" />
          </div>
          <div id="orderHistoryList" class="space-y-2 max-h-80 overflow-y-auto">
            <div class="text-center py-8 text-gray-500">
              <p class="text-4xl mb-2">ğŸ›’</p>
              <p>Nenhum pedido registrado ainda.</p>
              <p class="text-xs mt-2">Os pedidos enviados via WhatsApp serÃ£o salvos aqui.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Products -->
      <div class="mt-6 bg-gray-50 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ”¥ Produtos Mais Pedidos</h3>
        <div id="topProductsList" class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="text-center py-6 text-gray-500 col-span-full">
            <p class="text-4xl mb-2">ğŸ½ï¸</p>
            <p>Aguardando dados de pedidos...</p>
          </div>
        </div>
      </div>

      <!-- Neighborhood Orders Chart -->
      <div class="mt-6 bg-gray-50 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ—ºï¸ Pedidos por Bairro</h3>
        <div id="neighborhoodChartContainer" class="space-y-2">
          <div class="text-center py-6 text-gray-500">
            <p class="text-4xl mb-2">ğŸ“</p>
            <p>Aguardando dados de pedidos...</p>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-green-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-green-700" id="totalRevenueCard">R$ 0,00</p>
          <p class="text-xs text-green-600">Faturamento Total</p>
        </div>
        <div class="bg-blue-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-blue-700" id="totalOrdersCard">0</p>
          <p class="text-xs text-blue-600">Total de Pedidos</p>
        </div>
        <div class="bg-purple-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-purple-700" id="avgOrderCard">R$ 0,00</p>
          <p class="text-xs text-purple-600">Ticket MÃ©dio</p>
        </div>
        <div class="bg-orange-100 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-orange-700" id="uniqueClientsCard">0</p>
          <p class="text-xs text-orange-600">Clientes Ãšnicos</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Orders Management Panel -->
  <main id="ordersPanelFast" class="hidden container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“‹ Painel de Pedidos</h2>

      <!-- Filters -->
      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
          <select id="ordersFilterDate" class="w-full px-3 py-2 border rounded-lg">
            <option value="today">Hoje</option>
            <option value="yesterday">Ontem</option>
            <option value="week">Ãšltima semana</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <select id="ordersFilterStatus" class="w-full px-3 py-2 border rounded-lg">
            <option value="all">Todos</option>
            <option value="pending">ğŸ†• Recebido</option>
            <option value="accepted">âœ… Aceito (Aguard. Pgto)</option>
            <option value="preparing">ğŸ³ Em Preparo</option>
            <option value="confirmed">âœ… Pronto</option>
            <option value="out_for_delivery">ğŸšš Saiu p/ Entrega</option>
            <option value="delivered">âœ”ï¸ Entregue</option>
            <option value="cancelled">âŒ Cancelado</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="refreshOrders"
            class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg font-medium">
            ğŸ”„ Atualizar
          </button>
        </div>
      </div>

      <div class="flex flex-wrap items-center justify-between gap-2 mb-6">
        <button id="deleteTestOrdersBtn"
          class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
          ğŸ§¹ Excluir pedidos de teste
        </button>
        <p class="text-xs text-gray-500">Remove pedidos do banco (Supabase) e zera os dados usados em RelatÃ³rios.</p>
      </div>

      <!-- Stats Summary -->
      <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-6">
        <div class="bg-blue-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-blue-700" id="ordersCountNew">0</p>
          <p class="text-xs text-blue-600">Novos</p>
        </div>
        <div class="bg-yellow-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-yellow-700" id="ordersCountPreparing">0</p>
          <p class="text-xs text-yellow-600">Preparando</p>
        </div>
        <div class="bg-green-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-green-700" id="ordersCountReady">0</p>
          <p class="text-xs text-green-600">Prontos</p>
        </div>
        <div class="bg-orange-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-orange-700" id="ordersCountDelivery">0</p>
          <p class="text-xs text-orange-600">Em Entrega</p>
        </div>
        <div class="bg-gray-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-gray-700" id="ordersCountDelivered">0</p>
          <p class="text-xs text-gray-600">Entregues</p>
        </div>
        <div class="bg-red-100 p-3 rounded-lg text-center">
          <p class="text-lg font-bold text-red-700" id="ordersCountCanceled">0</p>
          <p class="text-xs text-red-600">Cancelados</p>
        </div>
      </div>

      <!-- Orders List -->
      <div id="ordersListContainer" class="space-y-4">
        <div class="text-center py-12 text-gray-500">
          <p class="text-5xl mb-3">ğŸ“¦</p>
          <p class="font-medium">Nenhum pedido encontrado</p>
          <p class="text-sm">Os pedidos aparecerÃ£o aqui quando forem feitos.</p>
        </div>
      </div>
    </div>
  </main>
  </div>

  <!-- Public Store -->
  <div id="publicStore" class="hidden">
    <header class="text-white shadow" style="background:#000">
      <div class="container mx-auto px-3 sm:px-4 py-3 sm:py-4">
        <!-- Mobile: Logo, Phone, Buttons in one line -->
        <div class="sm:hidden flex items-center justify-between gap-2">
          <div class="flex items-center cursor-pointer" id="publicStoreLogo">
            <img src="../assets/img/fast-logo.png" alt="Fast Savory's"
              class="h-10 object-contain hover:opacity-80 transition-opacity" />
          </div>
          <div class="text-xs text-white font-bold">ğŸ“ 73 99936-6554</div>
          <div class="flex items-center gap-2">
            <button id="adminLoginBtn"
              class="bg-rose-200 hover:bg-rose-300 text-black px-2 py-2 rounded-lg text-xs font-medium">Entrar</button>
            <button id="cartBtn"
              class="relative bg-white/20 hover:bg-white/30 px-2 py-2 rounded-lg min-w-[40px] min-h-[40px] flex items-center justify-center">
              <span class="text-lg">ğŸ›’</span>
              <span id="cartCount"
                class="absolute -top-1 -right-1 bg-yellow-300 text-black text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
            </button>
          </div>
        </div>

        <!-- Desktop: Original layout -->
        <div class="hidden sm:flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center cursor-pointer" id="publicStoreLogoDesktop">
            <img src="../assets/img/fast-logo.png" alt="Fast Savory's"
              class="h-14 md:h-16 object-contain hover:opacity-80 transition-opacity" />
          </div>
          <div class="flex flex-1 text-center flex-col">
            <div class="text-base md:text-lg text-white leading-tight font-bold">FastSavory's</div>
            <div class="text-sm text-white leading-tight">ğŸ“ 73 99936-6554</div>
            <div class="hidden md:block text-xs text-white leading-tight truncate max-w-[300px] lg:max-w-none mx-auto">
              ğŸ“ Rua Palmeiras, 105, Novo Prado, Itamaraju-BA</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="backToAdminBtn"
              class="hidden bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg text-xs">EdiÃ§Ã£o</button>
            <button id="adminLoginBtnDesktop"
              class="bg-rose-200 hover:bg-rose-300 text-black px-3 py-2 rounded-lg text-sm font-medium">Entrar</button>
            <button id="cartBtnDesktop"
              class="relative bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center">
              <span class="text-xl">ğŸ›’</span>
              <span id="cartCountDesktop"
                class="absolute -top-2 -right-2 bg-yellow-300 text-black text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <nav class="shadow-sm sticky top-0 z-10 bg-white">
      <div class="container mx-auto px-3 sm:px-4">
        <div id="openNotice" class="text-sm py-2 px-3 rounded-lg my-2 text-center"></div>

        <!-- Mobile: Grid 3 columns -->
        <div class="sm:hidden grid grid-cols-3 gap-2 py-3">
          <button class="category-tab active px-2 py-2 rounded-lg text-white font-medium text-xs bg-red-600 text-center"
            data-category="salgados">ğŸ¥Ÿ Salgados</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="mini">ğŸ§ Mini</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="kits">ğŸ Kits Festa</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="bolos">ğŸ‚ Bolos</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="bebidas">ğŸ¥¤ Bebidas</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-xs text-center"
            data-category="adicionais">â• Extras</button>
          <button class="category-tab px-2 py-2 rounded-lg bg-pink-200 text-pink-900 font-medium text-xs text-center"
            data-category="favoritos">â¤ï¸ Favoritos</button>
          <button class="filter-tab px-2 py-2 rounded-lg bg-yellow-200 text-yellow-900 font-medium text-xs text-center"
            data-filter="promo">ğŸ·ï¸ PromoÃ§Ãµes</button>
          <button class="filter-tab px-2 py-2 rounded-lg bg-purple-200 text-purple-900 font-medium text-xs text-center"
            data-filter="encomenda">ğŸ“… Encomendas</button>
          <a href="https://pedidos.site/pedidoimperioburguerepizzas" target="_blank"
            class="col-span-3 px-2 py-2 rounded-lg bg-orange-500 text-white font-medium text-xs flex items-center justify-center gap-2">
            <img src="../assets/img/imperio-burguer-icon.png" alt="ImpÃ©rio" class="h-5 w-5 rounded-full object-cover" />
            Lanches e Pizzas
          </a>
        </div>

        <!-- Desktop: Flex row with standardized buttons -->
        <div class="hidden sm:flex flex-wrap gap-2 py-3 justify-center">
          <button
            class="category-tab active px-4 py-2 rounded-lg text-white font-medium text-sm bg-red-600 min-w-[130px] text-center"
            data-category="salgados">ğŸ¥Ÿ Salgados</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="mini">ğŸ§ Mini</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="kits">ğŸ Kits Festa</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="bolos">ğŸ‚ Bolos</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="bebidas">ğŸ¥¤ Bebidas</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-red-300 text-red-900 font-medium text-sm hover:bg-red-400 min-w-[130px] text-center"
            data-category="adicionais">â• Extras</button>
          <button
            class="category-tab px-4 py-2 rounded-lg bg-pink-200 text-pink-900 font-medium text-sm hover:bg-pink-300 min-w-[130px] text-center"
            data-category="favoritos">â¤ï¸ Favoritos</button>
          <button
            class="filter-tab px-4 py-2 rounded-lg bg-yellow-200 text-yellow-900 font-medium text-sm hover:bg-yellow-300 min-w-[130px] text-center"
            data-filter="promo">ğŸ·ï¸ PromoÃ§Ãµes</button>
          <button
            class="filter-tab px-4 py-2 rounded-lg bg-purple-200 text-purple-900 font-medium text-sm hover:bg-purple-300 min-w-[130px] text-center"
            data-filter="encomenda">ğŸ“… Encomendas</button>
          <a href="https://pedidos.site/pedidoimperioburguerepizzas" target="_blank"
            class="px-4 py-2 rounded-lg bg-orange-500 text-white font-medium text-sm hover:bg-orange-600 min-w-[130px] flex items-center justify-center gap-2">
            <img src="../assets/img/imperio-burguer-icon.png" alt="ImpÃ©rio" class="h-5 w-5 rounded-full object-cover" />
            Lanches e Pizzas
          </a>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-3 sm:px-4 py-4 sm:py-6">
      <!-- SeÃ§Ã£o de Ãšltimos Pedidos (para clientes que retornam) -->
      <div id="recentOrdersSection" class="mb-6 hidden"></div>

      <div class="grid lg:grid-cols-3 gap-4 sm:gap-6">
        <div class="lg:col-span-2 space-y-12">
          <!-- Salgados Section -->
          <section id="salgados" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">ğŸ¥Ÿ</span> Salgados
            </h2>
            <div id="salgadosContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Mini-Salgados Section -->
          <section id="mini" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">ğŸ§</span> Mini-Salgados
            </h2>
            <div id="miniContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Kits Festa Section -->
          <section id="kits" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">ğŸ</span> Kits Festa
            </h2>
            <div id="kitsContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Bolos Section -->
          <section id="bolos" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">ğŸ‚</span> Bolos
            </h2>
            <div id="bolosContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Bebidas Section -->
          <section id="bebidas" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">ğŸ¥¤</span> Bebidas
            </h2>
            <div id="bebidasContainer" class="grid md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Adicionais Section -->
          <section id="adicionais" class="category-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">â•</span> Adicionais
            </h2>
            <div id="adicionaisContainer" class="grid md:grid-cols-3 gap-4"></div>
          </section>

          <!-- Favoritos Section -->
          <section id="favoritos" class="category-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
              <span class="mr-3">â¤ï¸</span> Seus Favoritos
            </h2>
            <div id="favoritosContainer" class="grid md:grid-cols-2 gap-4">
              <p class="text-gray-500 text-center py-8 col-span-2">VocÃª ainda nÃ£o marcou nenhum item como favorito.</p>
            </div>
          </section>
        </div>
        <div class="lg:block hidden">
          <div class="bg-white rounded-xl shadow p-6 sticky top-24">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">ğŸ›’</span> Seu Pedido
            </h3>
            <div id="cartItems" class="space-y-3 mb-4 min-h-[100px]">
              <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
            </div>
            <div class="border-t pt-4">
              <div class="flex justify-between items-center mb-4"><span
                  class="font-semibold text-gray-800">Total:</span><span id="cartTotal"
                  class="text-xl text-rose-600 font-bold">R$ 0,00</span></div>
              <button id="checkoutBtn"
                class="w-full bg-rose-600 hover:bg-rose-700 text-black py-3 rounded-lg font-semibold transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                disabled>Finalizar Pedido</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-6 mt-12">
      <div class="container mx-auto px-4 text-center">
        <p class="text-sm mb-2">2025 FastSavory's. Todos os direitos reservados.</p>
        <p class="text-xs text-gray-400">
          Desenvolvido por
          <a href="https://i.im.ge/2025/12/20/BSwhSJ.JNC.png" target="_blank"
            class="text-blue-400 hover:text-blue-300 underline">
            <img src="https://i.im.ge/2025/12/20/BSwhSJ.JNC.png" alt="Desenvolvedor"
              class="inline-block h-4 w-4 align-middle" />
          </a>
        </p>
      </div>
    </footer>
  </div>

  <!-- Mobile Cart Modal -->
  <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden lg:hidden">
    <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-xl p-6 max-h-[80vh] overflow-y-auto text-gray-800">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Seu Pedido</h3><button id="closeCartModal"
          class="text-gray-500 hover:text-gray-700"><span class="text-2xl">Ã—</span></button>
      </div>
      <div id="mobileCartItems" class="space-y-3 mb-4">
        <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
      </div>
      <div class="border-t pt-4">
        <div class="flex justify-between items-center mb-4"><span class="font-semibold text-gray-800">Total:</span><span
            id="mobileCartTotal" class="text-xl text-rose-600 font-bold">R$ 0,00</span></div>
        <button id="mobileCheckoutBtn"
          class="w-full bg-rose-600 hover:bg-rose-700 text-black py-3 rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled>Finalizar Pedido</button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto text-gray-800">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Finalizar Pedido</h3>

      <!-- Dados do Cliente - Primeiro -->
      <div class="mb-6">
        <h4 class="font-semibold text-gray-800 mb-3">Seus Dados</h4>
        <div class="space-y-3">
          <input id="customerName" placeholder="Seu nome completo" class="w-full px-3 py-2 border rounded-lg">
          <input id="customerPhone" placeholder="Seu telefone (WhatsApp)" class="w-full px-3 py-2 border rounded-lg">

          <!-- Ãrea de busca e endereÃ§os do cliente -->
          <div id="customerSearchArea" class="hidden">
            <div class="bg-green-50 border border-green-200 p-3 rounded-lg mb-3">
              <p class="text-sm text-green-800 font-medium">ğŸ“ Cliente encontrado!</p>
              <p id="foundCustomerInfo" class="text-sm text-green-700"></p>

              <!-- EndereÃ§os salvos (mÃºltiplos) -->
              <div id="savedAddressSection" class="mt-3 hidden">
                <div class="bg-white border rounded-lg p-3">
                  <p class="text-sm font-medium text-gray-800 mb-2">ğŸ“ Seus endereÃ§os salvos:</p>
                  <select id="savedAddressSelect" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <option value="">Selecione um endereÃ§o...</option>
                    <!-- Options will be populated by JS -->
                  </select>
                  <div class="flex gap-2">
                    <button type="button" id="confirmSavedAddress"
                      class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-medium">âœ“
                      Usar selecionado</button>
                    <button type="button" id="useDifferentAddress"
                      class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg text-sm font-medium">Outro
                      endereÃ§o</button>
                  </div>
                </div>
              </div>

              <!-- Se nÃ£o tem endereÃ§o salvo -->
              <div id="noAddressSection" class="mt-2 hidden">
                <p class="text-sm text-orange-600">Nenhum endereÃ§o cadastrado.</p>
              </div>
            </div>
          </div>

          <div id="addressForm" class="space-y-3 hidden">
            <h5 class="font-medium text-gray-800">EndereÃ§o de Entrega</h5>
            <div>
              <label class="text-xs text-gray-600 mb-1 block">IdentificaÃ§Ã£o (opcional)</label>
              <select id="addressLabel" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="Casa">ğŸ  Casa</option>
                <option value="Trabalho">ğŸ’¼ Trabalho</option>
                <option value="Outro">ğŸ“ Outro</option>
              </select>
            </div>
            <input id="street" placeholder="Nome da rua" class="w-full px-3 py-2 border rounded-lg">
            <input id="number" placeholder="NÃºmero da casa" class="w-full px-3 py-2 border rounded-lg">
            <input id="neighborhood" placeholder="Bairro" class="w-full px-3 py-2 border rounded-lg">
            <input id="reference" placeholder="Ponto de referÃªncia (opcional)"
              class="w-full px-3 py-2 border rounded-lg">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="saveAddressCheckbox" class="w-4 h-4 text-rose-600" checked>
              <span class="text-sm text-gray-700">Salvar este endereÃ§o para prÃ³ximos pedidos</span>
            </label>
          </div>

          <div class="bg-blue-50 p-3 rounded-lg">
            <p class="text-xs text-blue-800">
              <strong>LGPD:</strong> Seus dados serÃ£o usados apenas para contato sobre este pedido e para participar de
              promoÃ§Ãµes.
              Ao confirmar, vocÃª concorda com nossa polÃ­tica de privacidade.
            </p>
          </div>
        </div>
      </div>

      <!-- Ãšltimos Pedidos (Recompra RÃ¡pida) -->
      <div id="lastOrdersSection" class="mb-6 hidden">
        <h4 class="font-semibold text-gray-800 mb-3">ğŸ”„ Repetir pedido anterior</h4>
        <div id="lastOrdersList" class="space-y-2 max-h-40 overflow-y-auto"></div>
      </div>

      <!-- Forma de Pagamento -->
      <div class="mb-6">
        <h4 class="font-semibold text-gray-800 mb-3">Forma de Pagamento</h4>
        <div class="space-y-2 text-gray-800">
          <label class="flex items-center">
            <input type="radio" name="payment" value="dinheiro" class="mr-2">
            <span>ğŸ’µ Dinheiro</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="payment" value="pix" class="mr-2">
            <span>ğŸ“± PIX</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="payment" value="cartao1x" class="mr-2">
            <span>ğŸ’³ CartÃ£o 1x (<span id="cardFeeLabel1x">+5%</span>)</span>
          </label>
        </div>
      </div>

      <div id="moneyChangeBox" class="mb-6 hidden">
        <h4 class="font-semibold text-gray-800 mb-3">Troco para quanto?</h4>
        <input type="number" step="0.01" id="moneyChangeValue" placeholder="Ex.: 50.00"
          class="w-full px-3 py-2 border rounded-lg">
      </div>

      <div class="mb-6 text-gray-800">
        <h4 id="deliveryTitle" class="font-semibold text-gray-800 mb-3">Entrega</h4>
        <div class="space-y-2">
          <label class="flex items-center">
            <input type="radio" name="delivery" value="retirada" class="mr-2" checked>
            <span>ğŸª Retirada na loja</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="delivery" value="entrega" class="mr-2">
            <span>ğŸšš Entrega</span>
          </label>
        </div>
        <div class="mt-3 p-3 rounded-md bg-yellow-100 border border-yellow-300 text-yellow-900 text-sm font-semibold">
          Consulte o valor da taxa de entrega antes de finalizar o pedido.</div>
      </div>

      <div id="orderDateBox" class="mb-6 hidden">
        <div class="p-3 rounded-md bg-blue-100 border border-blue-300 text-blue-900 text-sm font-semibold mb-2">Fora do
          horÃ¡rio, aceitamos encomendas. AtÃ© 07:00, pode agendar para hoje. A partir de 07:01, apenas para o prÃ³ximo dia.</div>
        <label class="block text-sm font-semibold text-gray-800 mb-2">Data da encomenda</label>
        <input type="date" id="orderDate" class="w-full px-3 py-2 border rounded-lg" />

        <label class="block text-sm font-semibold text-gray-800 mb-2 mt-4">HorÃ¡rio desejado</label>
        <input type="time" id="orderTimeSlot" class="w-full px-3 py-2 border rounded-lg" />
        <p id="orderTimeHint" class="text-xs text-gray-500 mt-1">Informe o horÃ¡rio exato da entrega/retirada.</p>
      </div>

      <div id="encomendaWarning" class="mb-6 hidden">
        <div class="p-3 rounded-md bg-yellow-100 border border-yellow-400 text-yellow-900 text-sm">
          <strong>âš ï¸ Encomenda:</strong> Estamos fora do horÃ¡rio. Informe a data e o horÃ¡rio desejado.
        </div>
      </div>

      <div class="mb-6 p-4 bg-gray-50 rounded-lg text-gray-800">
        <h4 class="font-semibold text-gray-800 mb-2">Resumo do Pedido</h4>
        <div id="checkoutItems" class="space-y-1 text-sm">
          <!-- Items will be loaded here -->
        </div>
        <div class="border-t mt-2 pt-2">
          <div id="deliveryFeeRowFast" class="flex justify-between text-sm mb-1 hidden"><span>Taxa de
              entrega:</span><span id="checkoutDeliveryFeeFast">R$ 0,00</span></div>
          <div id="cardFeeRowFast" class="flex justify-between text-sm mb-1 hidden"><span>Taxa cartÃ£o:</span><span
              id="checkoutCardFeeFast">R$ 0,00</span></div>
          <div class="flex justify-between font-semibold">
            <span>Total:</span>
            <span id="checkoutTotal">R$ 0,00</span>
          </div>
        </div>
      </div>

      <div id="validationWarnings" class="mb-4 space-y-2 hidden">
        <!-- Warnings will appear here -->
      </div>

      <div class="flex gap-3">
        <button id="cancelCheckout"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-medium">Cancelar</button>
        <button id="confirmOrder"
          class="flex-1 bg-rose-600 hover:bg-rose-700 text-black py-2 rounded-lg font-medium">Confirmar Pedido</button>
      </div>
    </div>
  </div>

  <!-- Birthday Registration Modal -->
  <div id="birthdayModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-gray-800">
      <!-- Step 1: Ask if want to register -->
      <div id="birthdayStep1">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ğŸ‚ Cadastro de AniversÃ¡rio</h3>
        <p class="text-sm text-gray-600 mb-6 text-center">
          Deseja cadastrar sua data de nascimento e participar de promoÃ§Ãµes futuras?
        </p>
        <div class="flex gap-3">
          <button type="button" id="birthdayYes"
            class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-medium">
            âœ“ Sim, Cadastrar
          </button>
          <button type="button" id="birthdayNo"
            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium">
            NÃ£o, Enviar Pedido
          </button>
        </div>
      </div>

      <!-- Step 2: Date picker -->
      <div id="birthdayStep2" class="hidden">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ğŸ‚ Data de Nascimento</h3>
        <p class="text-sm text-gray-600 mb-4 text-center">
          Informe sua data de nascimento:
        </p>
        <input type="date" id="birthdayDateInput" class="w-full px-3 py-3 border rounded-lg text-center text-lg mb-4">
        <button type="button" id="saveBirthdaySend"
          class="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-medium">
          Salvar e Enviar Pedido
        </button>
      </div>
    </div>
  </div>

  <script>
    // ConfiguraÃ§Ã£o do Supabase
    const supabaseUrl = 'https://vqjyjdllapqbqpylshkw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxanlqZGxsYXBxYnFweWxzaGt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MzgyNDUsImV4cCI6MjA4MjAxNDI0NX0.tfTR9YnM5l0do7FJfxML6i05KTSrMInQMqFrWXx6aAU';

    // Inicializar Supabase apenas uma vez
    if (typeof window.supabaseClient === 'undefined') {
      window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    }

    let products = [];
    let cart = [];
    let cartTotal = 0;
    let isAdmin = false;
    let editingProductId = null;
    let editingClientId = undefined;
    let users = [];
    let currentUserRole = null;
    let clients = [];
    let promotions = [];
    let clientDiscounts = {};
    let currentSelectedClient = null;
    let coupons = [];

    // Store configuration
    let storeConfig = {
      card_fee_1x: 5,
      card_fee_2x: 5,
      delivery_enabled: true,
      delivery_disabled_reason: ''
    };
    let businessHours = [];

    // ========================================
    // ORDER HISTORY SERVICE (localStorage + Supabase)
    // ========================================
    const OrderHistoryService = {
      getKey: (phone) => phone ? `fastOrders_${phone.replace(/\D/g, '')}` : 'fastOrders_anon',

      getOrders: function (phone) {
        try {
          const key = this.getKey(phone);
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error('[OrderHistory] Erro ao ler:', e);
          return [];
        }
      },

      saveOrder: function (phone, order) {
        try {
          const key = this.getKey(phone);
          const orders = this.getOrders(phone);
          orders.unshift(order); // Adiciona no inÃ­cio
          // MantÃ©m apenas Ãºltimos 10 pedidos
          localStorage.setItem(key, JSON.stringify(orders.slice(0, 10)));
        } catch (e) {
          console.error('[OrderHistory] Erro ao salvar:', e);
        }
      },

      migrateToPhone: function (phone) {
        try {
          const anonOrders = this.getOrders(null);
          if (anonOrders.length > 0) {
            const phoneOrders = this.getOrders(phone);
            const merged = [...anonOrders, ...phoneOrders].slice(0, 10);
            localStorage.setItem(this.getKey(phone), JSON.stringify(merged));
            localStorage.removeItem('fastOrders_anon');
          }
        } catch (e) { }
      }
    };

    // ========================================
    // FAVORITES SERVICE (localStorage)
    // ========================================
    const FavoritesService = {
      getKey: (phone) => phone ? `fastFavorites_${phone.replace(/\D/g, '')}` : 'fastFavorites_anon',

      getFavorites: function (phone) {
        try {
          const key = this.getKey(phone);
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          return [];
        }
      },

      isFavorite: function (phone, productId) {
        return this.getFavorites(phone).includes(productId);
      },

      toggle: function (phone, productId) {
        try {
          const key = this.getKey(phone);
          let favorites = this.getFavorites(phone);
          const index = favorites.indexOf(productId);
          if (index > -1) {
            favorites.splice(index, 1);
          } else {
            favorites.push(productId);
          }
          localStorage.setItem(key, JSON.stringify(favorites));
          return index === -1; // Returns true if now favorite
        } catch (e) {
          return false;
        }
      },

      migrateToPhone: function (phone) {
        try {
          const anonFavs = this.getFavorites(null);
          if (anonFavs.length > 0) {
            const phoneFavs = this.getFavorites(phone);
            const merged = [...new Set([...anonFavs, ...phoneFavs])];
            localStorage.setItem(this.getKey(phone), JSON.stringify(merged));
            localStorage.removeItem('fastFavorites_anon');
          }
        } catch (e) { }
      }
    };

    // ========================================
    // ADDRESS SERVICE (mÃºltiplos endereÃ§os por cliente)
    // ========================================
    const AddressService = {
      getKey: (phone) => phone ? `fastAddresses_${phone.replace(/\D/g, '')}` : 'fastAddresses_anon',

      load: function (phone) {
        try {
          const key = this.getKey(phone);
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error('[AddressService] Erro ao carregar:', e);
          return [];
        }
      },

      save: function (phone, address) {
        try {
          const key = this.getKey(phone);
          let addresses = this.load(phone);

          // Check if address already exists (same street, number, neighborhood)
          const exists = addresses.some(a =>
            a.street === address.street &&
            a.number === address.number &&
            a.neighborhood === address.neighborhood
          );

          if (!exists) {
            address.id = Date.now().toString();
            addresses.push(address);
            localStorage.setItem(key, JSON.stringify(addresses.slice(-5))); // max 5 addresses
          }
          return !exists;
        } catch (e) {
          console.error('[AddressService] Erro ao salvar:', e);
          return false;
        }
      },

      remove: function (phone, addressId) {
        try {
          const key = this.getKey(phone);
          let addresses = this.load(phone);
          addresses = addresses.filter(a => a.id !== addressId);
          localStorage.setItem(key, JSON.stringify(addresses));
        } catch (e) {
          console.error('[AddressService] Erro ao remover:', e);
        }
      }
    };

    // ========================================
    // NEIGHBORHOOD NORMALIZATION (para alias de bairro)
    // ========================================
    function normalizeNeighborhood(name) {
      if (!name) return '';
      return name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // remove acentos
        .replace(/[^a-z0-9 ]/g, '')
        .trim();
    }

    // Aliases de bairro (mapeamento para cÃ¡lculo de taxa)
    let deliveryAliases = {};

    function getCanonicalNeighborhood(name) {
      const normalized = normalizeNeighborhood(name);
      for (const [canonical, aliases] of Object.entries(deliveryAliases)) {
        if (aliases.some(alias => normalizeNeighborhood(alias) === normalized)) {
          return canonical;
        }
      }
      return name; // retorna original se nÃ£o encontrar alias
    }

    // Telefone atual do cliente (para favoritos/histÃ³rico)
    let currentClientPhone = localStorage.getItem('fastLastPhone') || '';

    // ========================================
    // GLOBAL HISTORY FUNCTIONS
    // ========================================

    // Salvar pedido no histÃ³rico (chamado ao confirmar pedido)
    function saveOrderToHistory(phone, orderSummary) {
      console.log('[History] Tentando salvar pedido:', { phone, itemsCount: orderSummary?.items?.length });
      if (!phone || !orderSummary || !Array.isArray(orderSummary.items)) {
        console.warn('[History] Dados invÃ¡lidos para salvar:', { phone: !!phone, orderSummary: !!orderSummary, items: Array.isArray(orderSummary?.items) });
        return;
      }
      try {
        const key = `fastOrders_${phone.replace(/\D/g, '')}`;
        const existing = localStorage.getItem(key);
        const list = existing ? JSON.parse(existing) : [];
        const entry = {
          id: Date.now().toString(),
          createdAt: new Date().toISOString(),
          items: orderSummary.items.map(i => ({
            productId: i.productId || i.id || null,
            name: i.name,
            price: Number(i.price) || 0,
            quantity: Number(i.quantity) || 1,
            category: i.category || null
          })),
          total: Number(orderSummary.total) || 0,
          isEncomenda: !!orderSummary.isEncomenda,
          deliveryType: orderSummary.deliveryType || 'retirada',
          neighborhood: orderSummary.neighborhood || '',
          encomendaDate: orderSummary.encomendaDate || null,
          encomendaSlot: orderSummary.encomendaSlot || null
        };
        list.unshift(entry);
        localStorage.setItem(key, JSON.stringify(list.slice(0, 10)));
        localStorage.setItem('fastLastPhone', phone);
        currentClientPhone = phone;
        console.log('[History] Pedido salvo com sucesso! Key:', key, 'Total de pedidos:', list.length);
      } catch (e) {
        console.error('[History] Falha ao salvar:', e);
      }
    }

    // Carregar histÃ³rico pelo telefone
    function loadOrderHistory(phone) {
      if (!phone) return [];
      try {
        const key = `fastOrders_${phone.replace(/\D/g, '')}`;
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('[History] Falha ao carregar:', e);
        return [];
      }
    }

    // Renderizar "Ãšltimos Pedidos" na loja pÃºblica
    function renderRecentOrders() {
      const phone = localStorage.getItem('fastLastPhone');
      const container = document.getElementById('recentOrdersSection');
      if (!container) return;

      if (!phone) {
        container.classList.add('hidden');
        return;
      }

      const history = loadOrderHistory(phone);
      if (!history.length) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');
      container.innerHTML = `
        <div class="bg-gradient-to-r from-rose-50 to-orange-50 rounded-xl p-4 border border-rose-100">
          <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
            <span class="mr-2">ğŸ”„</span> Seus Ãºltimos pedidos
          </h2>
          <div class="space-y-2">
            ${history.slice(0, 3).map((order, idx) => {
        const resumo = order.items.slice(0, 2).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const more = order.items.length > 2 ? ` +${order.items.length - 2}` : '';
        const data = safeDate(order.createdAt).toLocaleDateString('pt-BR');
        const total = (order.total || 0).toFixed(2).replace('.', ',');
        return `
                <div class="p-3 rounded-lg bg-white border flex justify-between items-center gap-2">
                  <div class="flex-1 min-w-0">
                    <p class="text-xs text-gray-500">${data}</p>
                    <p class="text-sm text-gray-800 truncate">${resumo}${more}</p>
                    <p class="text-sm font-semibold text-rose-600">R$ ${total}</p>
                  </div>
                  <button onclick="repeatOrderFromHistory(${idx})" 
                    class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium whitespace-nowrap flex-shrink-0">
                    ğŸ”„ Repetir
                  </button>
                </div>
              `;
      }).join('')}
          </div>
        </div>
      `;
    }

    // Repetir pedido do histÃ³rico (versÃ£o para loja pÃºblica)
    function repeatOrderFromHistory(orderIndex) {
      const phone = localStorage.getItem('fastLastPhone');
      const history = loadOrderHistory(phone);
      const order = history[orderIndex];
      if (!order) return;

      cart = [];
      let unavailable = [];

      order.items.forEach(item => {
        const product = products.find(p => p.id === item.productId && p.visible !== false) ||
          products.find(p => p.name === item.name && p.visible !== false);
        if (product) {
          cart.push({
            id: product.id,
            name: product.name,
            description: product.description || '',
            price: product.price,
            quantity: item.quantity
          });
        } else {
          unavailable.push(item.name);
        }
      });

      updateCart();

      if (unavailable.length > 0) {
        alert(`âš ï¸ Alguns itens nÃ£o estÃ£o mais disponÃ­veis:\n${unavailable.join(', ')}`);
      }

      showInlineMessage('publicStore', 'âœ… Itens carregados no carrinho!', 'success');
    }

    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[INIT] DOMContentLoaded iniciado');
      try {
        // Verificar se Supabase estÃ¡ disponÃ­vel
        if (!window.supabaseClient) {
          console.error('[INIT] Supabase client nÃ£o disponÃ­vel - usando dados locais');
        }
        
        // Load all data in parallel for faster page load
        // FunÃ§Ãµes sÃ­ncronas sÃ£o wrappadas em Promise.resolve()
        await Promise.all([
          seedDefaultUsers().catch(function(e) { console.error('[INIT] seedDefaultUsers erro:', e); }),
          loadProducts().catch(function(e) { console.error('[INIT] loadProducts erro:', e); }),
          loadClients().catch(function(e) { console.error('[INIT] loadClients erro:', e); }),
          Promise.resolve().then(function() { loadPromotions(); }).catch(function(e) { console.error('[INIT] loadPromotions erro:', e); }),
          loadCoupons().catch(function(e) { console.error('[INIT] loadCoupons erro:', e); }),
          loadStoreConfig().catch(function(e) { console.error('[INIT] loadStoreConfig erro:', e); }),
          loadBusinessHours().catch(function(e) { console.error('[INIT] loadBusinessHours erro:', e); })
        ]);

        console.log('[INIT] Dados carregados, mostrando painel');
        
        // Now show the appropriate panel
        if (sessionStorage.getItem('fastAdmin') === '1') {
          isAdmin = true;
          showAdminPanel();
        } else {
          showPublicStore();
        }

        try {
          const params = new URLSearchParams(window.location.search);
          const checkout = params.get('checkout');
          const sessionId = params.get('session_id');
          if (checkout === 'success' && sessionId) {
            console.log('[Stripe] Retorno do Checkout detectado. Sincronizando pagamento...', sessionId);
            const baseUrl = (typeof getStripeServerBaseUrl === 'function') ? getStripeServerBaseUrl() : '';
            let syncedOrderId = null;
            if (!baseUrl) {
              console.warn('[Stripe] Stripe server URL nÃ£o configurada para sync (ok em produÃ§Ã£o se webhook estiver ativo).');
            } else {
              const resp = await fetch(baseUrl + '/sync-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
              });
              const data = await resp.json().catch(function() { return {}; });
              if (!resp.ok) {
                console.warn('[Stripe] Falha ao sincronizar Checkout:', data);
              } else {
                console.log('[Stripe] SincronizaÃ§Ã£o concluÃ­da:', data);
                syncedOrderId = data.orderId;
                try { loadDashboardOrders(); } catch (e) {}
              }
            }
            
            // Redirecionar para WhatsApp apÃ³s pagamento bem-sucedido
            if (syncedOrderId) {
              const waMessage = `OlÃ¡! Acabei de realizar o pagamento do pedido #${syncedOrderId} pelo cartÃ£o. Aguardo confirmaÃ§Ã£o!`;
              const waUrl = `https://wa.me/5573999366554?text=${encodeURIComponent(waMessage)}`;
              
              // Limpar URL params e redirecionar para WhatsApp
              window.history.replaceState({}, document.title, window.location.pathname);
              
              // Mostrar confirmaÃ§Ã£o e abrir WhatsApp
              alert('âœ… Pagamento confirmado!\n\nVocÃª serÃ¡ redirecionado para o WhatsApp para confirmar seu pedido.');
              window.open(waUrl, '_blank');
            }
          }
        } catch (e) {
          console.warn('[Stripe] Erro ao sincronizar pagamento no retorno do Checkout:', e);
        }
        console.log('[INIT] Painel exibido com sucesso');
      } catch (e) {
        console.error('[INIT] Erro crÃ­tico na inicializaÃ§Ã£o:', e);
        // Tentar mostrar a loja pÃºblica mesmo com erro
        try { showPublicStore(); } catch (e2) { console.error('[INIT] Falha ao mostrar loja:', e2); }
      }
    });

    async function seedDefaultUsers() {
      try {
        // Try to load from Supabase first
        const { data, error } = await window.supabaseClient
          .from('fast_users')
          .select('*');

        if (error) throw error;

        if (data && data.length > 0) {
          users = data;
        } else {
          // Seed default admin if table is empty
          users = [{ username: 'fast', password: 'fast123', role: 'admin' }];
          await window.supabaseClient.from('fast_users').upsert(users[0], { onConflict: 'username' });
        }
        // Keep localStorage as cache
        localStorage.setItem('fastUsers', JSON.stringify(users));
      } catch (error) {
        console.error('Erro ao carregar usuÃ¡rios do Supabase:', error);
        // Fallback to localStorage
        const saved = localStorage.getItem('fastUsers');
        if (saved) { users = JSON.parse(saved); }
        else { users = [{ username: 'fast', password: 'fast123', role: 'admin' }]; localStorage.setItem('fastUsers', JSON.stringify(users)); }
      }
    }

    async function saveUsers() {
      // Always save to localStorage first (instant)
      localStorage.setItem('fastUsers', JSON.stringify(users));

      // Then sync with Supabase
      try {
        if (window.supabaseClient) {
          // Clear and re-insert for simplicity
          await window.supabaseClient.from('fast_users').delete().neq('id', 0);
          for (const user of users) {
            await window.supabaseClient.from('fast_users').upsert(
              { username: user.username, password: user.password, role: user.role },
              { onConflict: 'username' }
            );
          }
          console.log('UsuÃ¡rios sincronizados com Supabase');
        }
      } catch (error) {
        console.error('Erro ao salvar usuÃ¡rios no Supabase:', error);
      }
    }
    function renderUsers() {
      const box = document.getElementById('usersList'); if (!box) return;
      box.innerHTML = users.map((u, i) => `
        <div class='p-3 border rounded-lg'>
          <div id='userView${i}' class='flex flex-col sm:flex-row sm:items-center justify-between gap-2'>
            <div>
              <p class='font-medium text-gray-800'>${u.username}</p>
              <p class='text-xs text-gray-600'>Papel: ${u.role}</p>
            </div>
            <div class='flex gap-2'>
              <button class='flex-1 sm:flex-none px-2 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs' onclick='showEditUserForm(${i})'>Editar</button>
              <button class='flex-1 sm:flex-none px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs' onclick='deleteUser(${i})'>Excluir</button>
            </div>
          </div>
          <div id='userEditForm${i}' class='hidden mt-3 p-3 bg-gray-50 rounded-lg'>
            <div class='space-y-3'>
              <div>
                <label class='block text-xs font-medium text-gray-700 mb-1'>Nome de usuÃ¡rio</label>
                <input type='text' id='editUsername${i}' value='${u.username}' class='w-full px-2 py-1 border rounded text-sm' />
              </div>
              <div>
                <label class='block text-xs font-medium text-gray-700 mb-1'>Nova senha (vazio = manter)</label>
                <input type='password' id='editPassword${i}' class='w-full px-2 py-1 border rounded text-sm' placeholder='â€¢â€¢â€¢â€¢â€¢â€¢' />
              </div>
              <div>
                <label class='block text-xs font-medium text-gray-700 mb-1'>Papel</label>
                <select id='editRole${i}' class='w-full px-2 py-1 border rounded text-sm'>
                  <option value='admin' ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                  <option value='gerente' ${u.role === 'gerente' ? 'selected' : ''}>Gerente</option>
                  <option value='garcom' ${u.role === 'garcom' ? 'selected' : ''}>GarÃ§om</option>
                  <option value='caixa' ${u.role === 'caixa' ? 'selected' : ''}>Caixa</option>
                </select>
              </div>
              <div id='editUserMsg${i}' class='text-xs hidden'></div>
              <div class='flex gap-2'>
                <button class='flex-1 px-2 py-1 rounded bg-gray-300 hover:bg-gray-400 text-gray-800 text-xs' onclick='cancelEditUser(${i})'>Cancelar</button>
                <button class='flex-1 px-2 py-1 rounded bg-green-500 hover:bg-green-600 text-white text-xs' onclick='saveEditUser(${i})'>Salvar</button>
              </div>
            </div>
          </div>
        </div>`).join('');
    }

    function showEditUserForm(i) {
      document.getElementById('userView' + i).classList.add('hidden');
      document.getElementById('userEditForm' + i).classList.remove('hidden');
    }

    function cancelEditUser(i) {
      document.getElementById('userView' + i).classList.remove('hidden');
      document.getElementById('userEditForm' + i).classList.add('hidden');
      // Reset values
      document.getElementById('editUsername' + i).value = users[i].username;
      document.getElementById('editPassword' + i).value = '';
    }

    function saveEditUser(i) {
      const newUsername = document.getElementById('editUsername' + i).value.trim();
      const newPassword = document.getElementById('editPassword' + i).value;
      const newRole = document.getElementById('editRole' + i).value;
      const msgBox = document.getElementById('editUserMsg' + i);

      if (!newUsername) {
        msgBox.textContent = 'âŒ Nome de usuÃ¡rio nÃ£o pode ser vazio';
        msgBox.className = 'text-xs text-red-600';
        msgBox.classList.remove('hidden');
        return;
      }

      // Check duplicate username
      if (newUsername !== users[i].username && users.some(u => u.username === newUsername)) {
        msgBox.textContent = 'âŒ Este nome de usuÃ¡rio jÃ¡ existe!';
        msgBox.className = 'text-xs text-red-600';
        msgBox.classList.remove('hidden');
        return;
      }

      // Impedir remoÃ§Ã£o do Ãºltimo admin
      if (users[i].role === 'admin' && newRole !== 'admin' && users.filter(u => u.role === 'admin').length === 1) {
        msgBox.textContent = 'âŒ Mantenha ao menos um administrador!';
        msgBox.className = 'text-xs text-red-600';
        msgBox.classList.remove('hidden');
        return;
      }

      users[i].username = newUsername;
      if (newPassword) users[i].password = newPassword;
      users[i].role = newRole;

      saveUsers();
      renderUsers();

      // Show success message
      showInlineMessage('usersList', 'âœ… UsuÃ¡rio atualizado com sucesso!', 'success');
    }

    function editUser(i) { showEditUserForm(i); } // Compatibility alias

    function changeUserPassword(i) { editUser(i); } // MantÃ©m compatibilidade
    function deleteUser(i) { if (users[i].role === 'admin' && users.filter(u => u.role === 'admin').length === 1) { alert('Mantenha ao menos um administrador.'); return; } if (confirm('Excluir usuÃ¡rio ' + users[i].username + '?')) { users.splice(i, 1); saveUsers(); renderUsers(); } }

    // Client Management Functions
    async function loadClients() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_clients')
          .select('*');

        if (error) throw error;
        clients = data || [];
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        // Fallback para localStorage
        const saved = localStorage.getItem('fastClients');
        if (saved) { clients = JSON.parse(saved); }
        else { clients = []; }
      }
    }

    async function saveClients() {
      try {
        // Sincroniza com Supabase
        for (const client of clients) {
          const { error } = await window.supabaseClient
            .from('fast_clients')
            .upsert(client, { onConflict: 'phone' });

          if (error) throw error;
        }

        // MantÃ©m backup no localStorage
        localStorage.setItem('fastClients', JSON.stringify(clients));
      } catch (error) {
        console.error('Erro ao salvar clientes:', error);
        // Fallback para localStorage
        localStorage.setItem('fastClients', JSON.stringify(clients));
      }
    }

    // FunÃ§Ã£o para buscar cliente por nome parcial ou telefone
    function searchClient(name, phone) {
      if (!name && !phone) return null;

      // Busca exata por telefone primeiro
      if (phone) {
        const exactPhone = clients.find(c => c.phone === phone);
        if (exactPhone) return exactPhone;
      }

      // Busca por nome parcial + telefone
      if (name && phone) {
        const partialMatch = clients.find(c =>
          c.phone === phone &&
          c.name.toLowerCase().includes(name.toLowerCase().trim())
        );
        if (partialMatch) return partialMatch;
      }

      // Busca por nome parcial (sem telefone)
      if (name) {
        const nameMatch = clients.find(c =>
          c.name.toLowerCase().includes(name.toLowerCase().trim())
        );
        if (nameMatch) return nameMatch;
      }

      return null;
    }

    // FunÃ§Ã£o para renderizar endereÃ§os do cliente
    function renderClientAddresses(client) {
      const addressesDiv = document.getElementById('customerAddresses');
      if (!addressesDiv || !client) return;

      const addresses = client.addresses || [];
      if (addresses.length === 0) {
        addressesDiv.innerHTML = '<p class="text-sm text-gray-600">Nenhum endereÃ§o cadastrado.</p>';
        return;
      }

      addressesDiv.innerHTML = addresses.map((addr, index) => `
        <div class="bg-white border border-gray-200 p-2 rounded flex justify-between items-center">
          <div class="flex-1">
            <p class="text-sm font-medium">${addr.street}, ${addr.number}</p>
            <p class="text-xs text-gray-600">${addr.neighborhood}</p>
            ${addr.reference ? `<p class="text-xs text-gray-500">Ref: ${addr.reference}</p>` : ''}
          </div>
          <div class="flex gap-2">
            <button onclick="selectAddress(${index})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">Usar</button>
            <button onclick="deleteAddress(${index})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">Excluir</button>
          </div>
        </div>
      `).join('');
    }

    // FunÃ§Ã£o para selecionar endereÃ§o
    function selectAddress(index) {
      if (!currentSelectedClient) return;

      const address = currentSelectedClient.addresses[index];
      document.getElementById('street').value = address.street;
      document.getElementById('number').value = address.number;
      document.getElementById('neighborhood').value = address.neighborhood;
      document.getElementById('reference').value = address.reference || '';

      // Mostra o formulÃ¡rio de endereÃ§o com os dados preenchidos
      document.getElementById('addressForm').classList.remove('hidden');
    }

    // FunÃ§Ã£o para excluir endereÃ§o
    function deleteAddress(index) {
      if (!currentSelectedClient) return;

      if (confirm('Deseja excluir este endereÃ§o?')) {
        currentSelectedClient.addresses.splice(index, 1);

        // Encontra e atualiza o cliente no array principal
        const clientIndex = clients.findIndex(c => c.phone === currentSelectedClient.phone);
        if (clientIndex !== -1) {
          clients[clientIndex] = currentSelectedClient;
          saveClients();
          renderClientAddresses(currentSelectedClient);
        }
      }
    }

    // FunÃ§Ã£o para salvar novo endereÃ§o
    function saveNewAddress() {
      if (!currentSelectedClient) return;

      const street = document.getElementById('street').value.trim();
      const number = document.getElementById('number').value.trim();
      const neighborhood = document.getElementById('neighborhood').value.trim();
      const reference = document.getElementById('reference').value.trim();

      if (!street || !number || !neighborhood) {
        alert('Preencha rua, nÃºmero e bairro.');
        return;
      }

      if (!currentSelectedClient.addresses) {
        currentSelectedClient.addresses = [];
      }

      currentSelectedClient.addresses.push({ street, number, neighborhood, reference });

      // Encontra e atualiza o cliente no array principal
      const clientIndex = clients.findIndex(c => c.phone === currentSelectedClient.phone);
      if (clientIndex !== -1) {
        clients[clientIndex] = currentSelectedClient;
        saveClients();
        renderClientAddresses(currentSelectedClient);
      }

      // Limpa o formulÃ¡rio
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';

      alert('EndereÃ§o salvo com sucesso!');
    }
    function renderClients(searchTerm = '') {
      const box = document.getElementById('clientsList'); if (!box) return;
      const filtered = clients.filter(c =>
        c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.phone.includes(searchTerm)
      );
      box.innerHTML = filtered.length ? filtered.map((c, i) => `
        <div class='flex items-center justify-between p-4 border rounded-lg'>
          <div class='flex-1'>
            <p class='font-medium text-gray-800'>${c.name}</p>
            <p class='text-sm text-gray-600'>ğŸ“± ${c.phone}</p>
            ${c.email ? `<p class='text-sm text-gray-600'>ğŸ“§ ${c.email}</p>` : ''}
            ${c.address ? `<p class='text-sm text-gray-600'>ğŸ“ ${c.address}</p>` : ''}
            <p class='text-xs text-gray-500'>ğŸ‚ ${c.birthdate ? c.birthdate.split('-').reverse().join('/') : 'NÃ£o informado'}</p>
            ${clientDiscounts[c.phone] ? `<p class='text-xs text-green-600 font-semibold'>Desconto: ${clientDiscounts[c.phone]}%</p>` : ''}
          </div>
          <div class='flex gap-2'>
            <button class='px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-sm' onclick='editClient(${i})'>Editar</button>
            <button class='px-3 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-sm' onclick='deleteClient(${i})'>Excluir</button>
          </div>
        </div>`).join('') : '<p class="text-gray-500 text-center py-8">Nenhum cliente cadastrado.</p>';
    }
    function editClient(i) {
      const c = clients[i];
      document.getElementById('clientName').value = c.name;
      document.getElementById('clientBirthdate').value = c.birthdate;
      document.getElementById('clientPhone').value = c.phone;
      document.getElementById('clientEmail').value = c.email || '';
      document.getElementById('clientAddress').value = c.address || '';
      editingClientId = i;
    }
    function deleteClient(i) {
      if (confirm('Excluir cliente ' + clients[i].name + '?')) {
        const phone = clients[i].phone;
        clients.splice(i, 1);
        delete clientDiscounts[phone];
        saveClients();
        saveClientDiscounts();
        renderClients();
      }
    }
    document.addEventListener('submit', (e) => {
      if (e.target && e.target.id === 'clientForm') {
        e.preventDefault();
        const name = document.getElementById('clientName').value.trim();
        const birthdate = document.getElementById('clientBirthdate').value;
        const phone = document.getElementById('clientPhone').value.trim();
        const email = document.getElementById('clientEmail').value.trim();
        const address = document.getElementById('clientAddress').value.trim();

        // Check for duplicate
        const duplicate = clients.find(c =>
          c.name.toLowerCase() === name.toLowerCase() && c.phone === phone
        );
        if (duplicate && editingClientId !== undefined) {
          alert('Cadastro jÃ¡ existente para este nome e telefone.');
          return;
        }

        if (editingClientId !== undefined) {
          const oldPhone = clients[editingClientId].phone;
          clients[editingClientId] = { name, birthdate, phone, email, address };
          // Migrate discount if phone changed
          if (oldPhone !== phone && clientDiscounts[oldPhone]) {
            clientDiscounts[phone] = clientDiscounts[oldPhone];
            delete clientDiscounts[oldPhone];
            saveClientDiscounts();
          }
          editingClientId = undefined;
        } else {
          clients.push({ name, birthdate, phone, email, address });
        }
        saveClients();
        renderClients();
        e.target.reset();
        alert('Cliente salvo com sucesso!');
      }
    });

    // =============================================
    // ORDER MANAGEMENT AND REPORTS
    // =============================================
    let orders = [];
    let currentReportPeriod = 'month'; // month, semester, year

    // =============================================
    // BIRTHDAY DISCOUNT SYSTEM (10% - once per year)
    // =============================================

    function isTodayBirthday(birthdate) {
      if (!birthdate) return false;

      const today = new Date();
      const todayStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      // Parse birthdate (handles YYYY-MM-DD format)
      const parts = birthdate.split('-');
      if (parts.length !== 3) return false;

      const birthMonthDay = `${parts[1]}-${parts[2]}`;

      // Check if today matches birthday
      if (birthMonthDay === todayStr) return true;

      // If store is closed today, check if yesterday was birthday (extend promo)
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = `${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;

      // Check if yesterday was birthday AND store was closed yesterday
      if (birthMonthDay === yesterdayStr) {
        // Check if store was closed yesterday (Sunday or manually closed)
        const yesterdayDay = yesterday.getDay();
        if (yesterdayDay === 0) return true; // Sunday - extend to Monday
      }

      return false;
    }

    async function checkBirthdayDiscountUsed(phone) {
      if (!phone) return true; // No phone = can't verify

      const currentYear = new Date().getFullYear();

      try {
        const { data, error } = await window.supabaseClient
          .from('fast_birthday_discount_usage')
          .select('id')
          .eq('client_phone', phone)
          .eq('usage_year', currentYear)
          .single();

        if (error && error.code !== 'PGRST116') throw error; // PGRST116 = not found

        return !!data; // Returns true if already used this year
      } catch (error) {
        console.error('Erro ao verificar uso de desconto de aniversÃ¡rio:', error);
        // Fallback to localStorage
        const usageKey = `birthdayDiscount_${phone}_${currentYear}`;
        return localStorage.getItem(usageKey) === 'used';
      }
    }

    async function recordBirthdayDiscountUsage(phone, discountAmount, orderId) {
      if (!phone) return;

      const currentYear = new Date().getFullYear();

      try {
        await window.supabaseClient
          .from('fast_birthday_discount_usage')
          .insert([{
            client_phone: phone,
            usage_year: currentYear,
            discount_applied: discountAmount,
            order_id: orderId
          }]);
        console.log('Uso de desconto de aniversÃ¡rio registrado:', phone);
      } catch (error) {
        console.error('Erro ao registrar uso de desconto de aniversÃ¡rio:', error);
        // Fallback to localStorage
        const usageKey = `birthdayDiscount_${phone}_${currentYear}`;
        localStorage.setItem(usageKey, 'used');
      }
    }

    async function saveOrderToSupabase(orderData) {
      try {
        const { error } = await window.supabaseClient
          .from('fast_orders')
          .insert([orderData]);

        if (error) throw error;
        console.log('Pedido salvo com sucesso:', orderData.id);
      } catch (error) {
        console.error('Erro ao salvar pedido:', error);
        // Save locally as fallback
        const localOrders = JSON.parse(localStorage.getItem('fastOrders') || '[]');
        localOrders.push(orderData);
        localStorage.setItem('fastOrders', JSON.stringify(localOrders));
      }
    }

    async function loadOrders() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_orders')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;
        orders = data || [];

        // Merge with local fallback orders
        const localOrders = JSON.parse(localStorage.getItem('fastOrders') || '[]');
        if (localOrders.length > 0) {
          orders = [...orders, ...localOrders.filter(lo => !orders.find(o => o.id === lo.id))];
        }
      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        orders = JSON.parse(localStorage.getItem('fastOrders') || '[]');
      }
    }

    function getOrdersInPeriod(period) {
      const now = new Date();
      let startDate;

      switch (period) {
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case 'semester':
          startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          break;
        default:
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      }

      return orders.filter(o => safeDate(o.created_at || o.id) >= startDate);
    }

    function calculateClientRanking(periodOrders) {
      const clientTotals = {};

      periodOrders.forEach(order => {
        const key = order.client_phone || order.client_name;
        if (!clientTotals[key]) {
          clientTotals[key] = {
            name: order.client_name,
            phone: order.client_phone,
            total: 0,
            orderCount: 0
          };
        }
        clientTotals[key].total += parseFloat(order.total || 0);
        clientTotals[key].orderCount++;
      });

      return Object.values(clientTotals)
        .sort((a, b) => b.total - a.total)
        .slice(0, 10);
    }

    function calculateTopProducts(periodOrders) {
      const productCounts = {};

      periodOrders.forEach(order => {
        const items = typeof order.items === 'string' ? JSON.parse(order.items) : (order.items || []);
        items.forEach(item => {
          if (!productCounts[item.name]) {
            productCounts[item.name] = { name: item.name, quantity: 0, revenue: 0 };
          }
          productCounts[item.name].quantity += item.quantity || 1;
          productCounts[item.name].revenue += (item.price || 0) * (item.quantity || 1);
        });
      });

      return Object.values(productCounts)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 8);
    }

    function calculateNeighborhoodStats(periodOrders) {
      const neighborhoodCounts = {};

      periodOrders.forEach(order => {
        let neighborhood = null;

        // Extract neighborhood from address if delivery
        if (order.address) {
          const addr = typeof order.address === 'string' ? JSON.parse(order.address) : order.address;
          neighborhood = addr.neighborhood || addr.bairro;
        }

        if (neighborhood) {
          const key = neighborhood.toLowerCase().trim();
          if (!neighborhoodCounts[key]) {
            neighborhoodCounts[key] = { name: neighborhood, count: 0, total: 0 };
          }
          neighborhoodCounts[key].count++;
          neighborhoodCounts[key].total += parseFloat(order.total || 0);
        }
      });

      return Object.values(neighborhoodCounts)
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);
    }

    function renderReportsData() {
      const periodOrders = getOrdersInPeriod(currentReportPeriod);

      // Client Ranking
      const ranking = calculateClientRanking(periodOrders);
      const rankingList = document.getElementById('clientRankingList');
      if (rankingList) {
        if (ranking.length > 0) {
          rankingList.innerHTML = ranking.map((c, i) => `
            <div class="flex items-center justify-between p-2 ${i < 3 ? 'bg-yellow-50 border border-yellow-200' : 'bg-white border'} rounded-lg">
              <div class="flex items-center gap-3">
                <span class="text-lg font-bold ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-orange-400' : 'text-gray-600'}">${i + 1}Âº</span>
                <div>
                  <p class="font-medium text-gray-800 text-sm">${c.name}</p>
                  <p class="text-xs text-gray-500">${c.orderCount} pedidos</p>
                </div>
              </div>
              <span class="font-bold text-green-600">R$ ${c.total.toFixed(2).replace('.', ',')}</span>
            </div>
          `).join('');
        } else {
          rankingList.innerHTML = `<div class="text-center py-8 text-gray-500"><p class="text-4xl mb-2">ğŸ“ˆ</p><p>Nenhum pedido no perÃ­odo.</p></div>`;
        }
      }

      // Order History
      const historyList = document.getElementById('orderHistoryList');
      if (historyList) {
        if (periodOrders.length > 0) {
          historyList.innerHTML = periodOrders.slice(0, 20).map(o => {
            const date = safeDate(o.created_at || o.id).toLocaleDateString('pt-BR');
            const items = typeof o.items === 'string' ? JSON.parse(o.items) : (o.items || []);
            return `
              <div class="p-2 bg-white border rounded-lg">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-medium text-gray-800 text-sm">${o.client_name}</p>
                    <p class="text-xs text-gray-500">${date} | ${items.length} itens</p>
                  </div>
                  <span class="font-bold text-green-600 text-sm">R$ ${parseFloat(o.total || 0).toFixed(2).replace('.', ',')}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          historyList.innerHTML = `<div class="text-center py-8 text-gray-500"><p class="text-4xl mb-2">ğŸ›’</p><p>Nenhum pedido no perÃ­odo.</p></div>`;
        }
      }

      // Top Products
      const topProducts = calculateTopProducts(periodOrders);
      const topProductsList = document.getElementById('topProductsList');
      if (topProductsList) {
        if (topProducts.length > 0) {
          topProductsList.innerHTML = topProducts.map((p, i) => `
            <div class="bg-white border rounded-lg p-3 text-center">
              <p class="text-2xl mb-1">${i < 3 ? 'ğŸ”¥' : 'ğŸ“¦'}</p>
              <p class="font-medium text-gray-800 text-sm truncate">${p.name}</p>
              <p class="text-xs text-gray-500">${p.quantity}x vendidos</p>
              <p class="text-xs text-green-600 font-bold">R$ ${p.revenue.toFixed(2).replace('.', ',')}</p>
            </div>
          `).join('');
        } else {
          topProductsList.innerHTML = `<div class="text-center py-6 text-gray-500 col-span-full"><p class="text-4xl mb-2">ğŸ½ï¸</p><p>Sem dados de produtos.</p></div>`;
        }
      }

      // Neighborhood Chart
      const neighborhoodStats = calculateNeighborhoodStats(periodOrders);
      const neighborhoodContainer = document.getElementById('neighborhoodChartContainer');
      if (neighborhoodContainer) {
        if (neighborhoodStats.length > 0) {
          const maxCount = Math.max(...neighborhoodStats.map(n => n.count));
          neighborhoodContainer.innerHTML = neighborhoodStats.map((n, i) => {
            const percentage = (n.count / maxCount) * 100;
            const colors = ['bg-rose-500', 'bg-rose-400', 'bg-rose-300', 'bg-pink-400', 'bg-pink-300'];
            const bgColor = colors[Math.min(i, colors.length - 1)];
            return `
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-sm font-medium text-gray-700 truncate capitalize">${n.name}</div>
                <div class="flex-1 bg-gray-200 rounded-full h-6 relative overflow-hidden">
                  <div class="${bgColor} h-full rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                  <span class="absolute inset-0 flex items-center justify-center text-xs font-bold ${percentage > 50 ? 'text-white' : 'text-gray-700'}">${n.count} pedidos</span>
                </div>
                <div class="w-20 text-right text-xs text-green-600 font-bold">R$ ${n.total.toFixed(2).replace('.', ',')}</div>
              </div>
            `;
          }).join('');
        } else {
          neighborhoodContainer.innerHTML = `<div class="text-center py-6 text-gray-500"><p class="text-4xl mb-2">ğŸ“</p><p>Nenhum pedido com entrega no perÃ­odo.</p></div>`;
        }
      }

      // Summary Cards
      const totalRevenue = periodOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
      const totalOrders = periodOrders.length;
      const avgOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
      const uniqueClients = new Set(periodOrders.map(o => o.client_phone || o.client_name)).size;

      document.getElementById('totalRevenueCard').textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
      document.getElementById('totalOrdersCard').textContent = totalOrders;
      document.getElementById('avgOrderCard').textContent = `R$ ${avgOrder.toFixed(2).replace('.', ',')}`;
      document.getElementById('uniqueClientsCard').textContent = uniqueClients;
    }

    // Period filter buttons
    document.getElementById('reportPeriodMonth')?.addEventListener('click', () => {
      currentReportPeriod = 'month';
      updatePeriodButtons();
      renderReportsData();
    });
    document.getElementById('reportPeriodSemester')?.addEventListener('click', () => {
      currentReportPeriod = 'semester';
      updatePeriodButtons();
      renderReportsData();
    });
    document.getElementById('reportPeriodYear')?.addEventListener('click', () => {
      currentReportPeriod = 'year';
      updatePeriodButtons();
      renderReportsData();
    });

    function updatePeriodButtons() {
      const buttons = {
        'reportPeriodMonth': 'month',
        'reportPeriodSemester': 'semester',
        'reportPeriodYear': 'year'
      };
      Object.entries(buttons).forEach(([id, period]) => {
        const btn = document.getElementById(id);
        if (btn) {
          if (currentReportPeriod === period) {
            btn.classList.remove('bg-gray-200', 'text-gray-700');
            btn.classList.add('bg-rose-600', 'text-white');
          } else {
            btn.classList.remove('bg-rose-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
          }
        }
      });
    }

    // Search order history
    document.getElementById('orderSearchClient')?.addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase().trim();
      const periodOrders = getOrdersInPeriod(currentReportPeriod);
      const filtered = search ? periodOrders.filter(o =>
        o.client_name?.toLowerCase().includes(search) ||
        o.client_phone?.includes(search)
      ) : periodOrders;

      const historyList = document.getElementById('orderHistoryList');
      if (historyList && filtered.length > 0) {
        historyList.innerHTML = filtered.slice(0, 20).map(o => {
          const date = safeDate(o.created_at || o.id).toLocaleDateString('pt-BR');
          const items = typeof o.items === 'string' ? JSON.parse(o.items) : (o.items || []);
          return `
            <div class="p-2 bg-white border rounded-lg">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium text-gray-800 text-sm">${o.client_name}</p>
                  <p class="text-xs text-gray-500">${date} | ${items.length} itens</p>
                </div>
                <span class="font-bold text-green-600 text-sm">R$ ${parseFloat(o.total || 0).toFixed(2).replace('.', ',')}</span>
              </div>
            </div>
          `;
        }).join('');
      } else if (historyList) {
        historyList.innerHTML = `<div class="text-center py-8 text-gray-500"><p>Nenhum resultado encontrado.</p></div>`;
      }
    });

    // ========== STORE CONFIG MANAGEMENT ==========

    async function loadStoreConfig() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_store_config')
          .select('*')
          .eq('id', 1)
          .single();

        if (error) throw error;
        if (data) {
          storeConfig = {
            card_fee_1x: parseFloat(data.card_fee_1x) || 5,
            card_fee_2x: parseFloat(data.card_fee_2x) || 10,
            delivery_enabled: data.delivery_enabled !== false,
            delivery_disabled_reason: data.delivery_disabled_reason || '',
            prep_time_min: parseInt(data.prep_time_min) || 0,
            prep_time_max: parseInt(data.prep_time_max) || 0,
            delivery_time_min: parseInt(data.delivery_time_min) || 0,
            delivery_time_max: parseInt(data.delivery_time_max) || 0,
          };
          storeConfig.card_fee_2x = storeConfig.card_fee_1x;
          localStorage.setItem('fastStoreConfig', JSON.stringify(storeConfig));
          console.log('ConfiguraÃ§Ãµes carregadas do Supabase');
        }
      } catch (error) {
        console.log('Carregando config do localStorage:', error.message);
        try {
          const saved = localStorage.getItem('fastStoreConfig');
          if (saved) {
            const parsed = JSON.parse(saved);
            storeConfig = { ...storeConfig, ...parsed };
            storeConfig.card_fee_2x = storeConfig.card_fee_1x;
          }
        } catch (e) {
          console.log('Using default store config');
        }
      }

      // Update UI if elements exist
      const fee1x = document.getElementById('cardFee1x');
      const deliveryEnabled = document.getElementById('deliveryEnabled');
      const reasonBox = document.getElementById('deliveryDisabledReasonBox');
      const reasonInput = document.getElementById('deliveryDisabledReason');

      if (fee1x) fee1x.value = storeConfig.card_fee_1x;
      if (deliveryEnabled) {
        deliveryEnabled.checked = storeConfig.delivery_enabled;
        if (reasonBox) reasonBox.classList.toggle('hidden', storeConfig.delivery_enabled);
        if (reasonInput) reasonInput.value = storeConfig.delivery_disabled_reason || '';
      }
      // Time Inputs
      if (document.getElementById('prepTimeMin')) document.getElementById('prepTimeMin').value = storeConfig.prep_time_min || '';
      if (document.getElementById('prepTimeMax')) document.getElementById('prepTimeMax').value = storeConfig.prep_time_max || '';
      if (document.getElementById('deliveryTimeMin')) document.getElementById('deliveryTimeMin').value = storeConfig.delivery_time_min || '';
      if (document.getElementById('deliveryTimeMax')) document.getElementById('deliveryTimeMax').value = storeConfig.delivery_time_max || '';

      // Update card fee labels in checkout
      updateCardFeeLabels();
    }

    function updateCardFeeLabels() {
      const label1x = document.getElementById('cardFeeLabel1x');
      if (label1x) label1x.textContent = `+${storeConfig.card_fee_1x}%`;
    }

    async function saveStoreConfig() {
      try {
        // Always save to localStorage as backup
        localStorage.setItem('fastStoreConfig', JSON.stringify(storeConfig));
        
        // Sync to Supabase
        const { error } = await window.supabaseClient
          .from('fast_store_config')
          .upsert({
            id: 1,
            card_fee_1x: storeConfig.card_fee_1x,
            card_fee_2x: storeConfig.card_fee_2x,
            delivery_enabled: storeConfig.delivery_enabled,
            delivery_disabled_reason: storeConfig.delivery_disabled_reason,
            prep_time_min: storeConfig.prep_time_min || 0,
            prep_time_max: storeConfig.prep_time_max || 0,
            delivery_time_min: storeConfig.delivery_time_min || 0,
            delivery_time_max: storeConfig.delivery_time_max || 0,
            updated_at: new Date().toISOString()
          });

        if (error) throw error;
        console.log('ConfiguraÃ§Ãµes salvas no Supabase');
        return true;
      } catch (error) {
        console.error('Erro ao salvar configuraÃ§Ãµes no Supabase (salvo localmente):', error);
        return true; // Return true because localStorage save succeeded
      }
    }

    async function loadBusinessHours() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_business_hours')
          .select('*')
          .order('day_of_week', { ascending: true });

        if (error) throw error;
        if (data && data.length > 0) {
          businessHours = data;
        } else {
          // Use defaults
          businessHours = [
            { day_of_week: 0, day_name: 'Domingo', is_open: false, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 1, day_name: 'Segunda', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 2, day_name: 'TerÃ§a', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 3, day_name: 'Quarta', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 4, day_name: 'Quinta', is_open: true, open_time: '14:00', close_time: '18:00' },
            { day_of_week: 5, day_name: 'Sexta', is_open: true, open_time: '14:00', close_time: '19:30' },
            { day_of_week: 6, day_name: 'SÃ¡bado', is_open: true, open_time: '14:00', close_time: '18:00' }
          ];
        }
      } catch (error) {
        console.log('Using default business hours:', error.message);
        businessHours = [
          { day_of_week: 0, day_name: 'Domingo', is_open: false, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 1, day_name: 'Segunda', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 2, day_name: 'TerÃ§a', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 3, day_name: 'Quarta', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 4, day_name: 'Quinta', is_open: true, open_time: '14:00', close_time: '18:00' },
          { day_of_week: 5, day_name: 'Sexta', is_open: true, open_time: '14:00', close_time: '19:30' },
          { day_of_week: 6, day_name: 'SÃ¡bado', is_open: true, open_time: '14:00', close_time: '18:00' }
        ];
      }
      renderBusinessHoursAdmin();
    }

    function renderBusinessHoursAdmin() {
      const container = document.getElementById('businessHoursContainer');
      if (!container) return;

      container.innerHTML = businessHours.map(day => `
        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg flex-wrap">
          <label class="flex items-center min-w-[100px]">
            <input type="checkbox" class="mr-2 w-4 h-4" 
              data-day="${day.day_of_week}" 
              ${day.is_open ? 'checked' : ''}
              onchange="toggleDayOpen(${day.day_of_week}, this.checked)">
            <span class="text-sm font-medium ${day.is_open ? 'text-gray-800' : 'text-gray-400'}">${day.day_name}</span>
          </label>
          <div class="flex items-center gap-1 ${day.is_open ? '' : 'opacity-40'}">
            <input type="time" id="open_${day.day_of_week}" value="${day.open_time}" 
              class="px-2 py-1 border rounded text-sm w-24" ${day.is_open ? '' : 'disabled'}>
            <span class="text-gray-500">Ã s</span>
            <input type="time" id="close_${day.day_of_week}" value="${day.close_time}" 
              class="px-2 py-1 border rounded text-sm w-24" ${day.is_open ? '' : 'disabled'}>
          </div>
        </div>
      `).join('');
    }

    function toggleDayOpen(dayOfWeek, isOpen) {
      const day = businessHours.find(d => d.day_of_week === dayOfWeek);
      if (day) {
        day.is_open = isOpen;
        renderBusinessHoursAdmin();
      }
    }

    async function saveBusinessHours() {
      try {
        // Read values from UI
        businessHours.forEach(day => {
          const openInput = document.getElementById(`open_${day.day_of_week}`);
          const closeInput = document.getElementById(`close_${day.day_of_week}`);
          if (openInput) day.open_time = openInput.value;
          if (closeInput) day.close_time = closeInput.value;
        });

        // Save to Supabase
        for (const day of businessHours) {
          const { error } = await window.supabaseClient
            .from('fast_business_hours')
            .upsert({
              day_of_week: day.day_of_week,
              day_name: day.day_name,
              is_open: day.is_open,
              open_time: day.open_time,
              close_time: day.close_time
            }, { onConflict: 'day_of_week' });

          if (error) throw error;
        }
        return true;
      } catch (error) {
        console.error('Erro ao salvar horÃ¡rios:', error);
        return false;
      }
    }

    // Promotion Management Functions
    function loadPromotions() {
      const saved = localStorage.getItem('fastPromotions');
      if (saved) { promotions = JSON.parse(saved); }
      else { promotions = []; savePromotions(); }

      const discountsSaved = localStorage.getItem('fastClientDiscounts');
      if (discountsSaved) { clientDiscounts = JSON.parse(discountsSaved); }
      else { clientDiscounts = {}; saveClientDiscounts(); }
    }
    function savePromotions() { localStorage.setItem('fastPromotions', JSON.stringify(promotions)); }
    function saveClientDiscounts() { localStorage.setItem('fastClientDiscounts', JSON.stringify(clientDiscounts)); }
    function renderPromotions() {
      const box = document.getElementById('promotionsList'); if (!box) return;
      box.innerHTML = promotions.length ? promotions.map((p, i) => `
        <div class='p-3 border rounded-lg'>
          <div class='flex justify-between items-start'>
            <div>
              <p class='font-medium text-gray-800'>${p.productName}</p>
              <p class='text-sm text-gray-600'>${p.description}</p>
              <p class='text-sm font-semibold text-green-600'>
                ${p.type === 'percentage' ? p.value + '%' : 'R$ ' + p.value.toFixed(2)} de desconto
              </p>
            </div>
            <button class='px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-sm' onclick='deletePromotion(${i})'>Remover</button>
          </div>
        </div>`).join('') : '<p class="text-gray-500 text-sm">Nenhuma promoÃ§Ã£o ativa.</p>';
    }
    function deletePromotion(i) {
      if (confirm('Remover esta promoÃ§Ã£o?')) {
        promotions.splice(i, 1);
        savePromotions();
        renderPromotions();
        updatePromotionProductSelect();
      }
    }
    function updatePromotionProductSelect() {
      const select = document.getElementById('promotionProduct'); if (!select) return;
      select.innerHTML = '<option value="">Escolha um produto...</option>' +
        products.filter(p => p.visible !== false).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    function updateClientDiscountSelect() {
      const select = document.getElementById('clientDiscountSelect'); if (!select) return;
      select.innerHTML = '<option value="">Escolha um cliente...</option>' +
        clients.map(c => `<option value="${c.phone}">${c.name} - ${c.phone}</option>`).join('');
    }
    document.getElementById('savePromotion')?.addEventListener('click', () => {
      const productId = parseInt(document.getElementById('promotionProduct').value);
      const type = document.getElementById('promotionType').value;
      const value = parseFloat(document.getElementById('promotionValue').value);
      const description = document.getElementById('promotionDescription').value.trim();

      if (!productId || !value || !description) {
        alert('Preencha todos os campos da promoÃ§Ã£o.');
        return;
      }

      const product = products.find(p => p.id === productId);
      if (!product) return;

      // Remove existing promotion for this product
      promotions = promotions.filter(p => p.productId !== productId);

      promotions.push({
        productId,
        productName: product.name,
        type,
        value,
        description
      });

      savePromotions();
      renderPromotions();
      alert('PromoÃ§Ã£o salva com sucesso!');

      // Reset form
      document.getElementById('promotionProduct').value = '';
      document.getElementById('promotionValue').value = '';
      document.getElementById('promotionDescription').value = '';
    });
    document.getElementById('saveClientDiscount')?.addEventListener('click', () => {
      const phone = document.getElementById('clientDiscountSelect').value;
      const discount = parseFloat(document.getElementById('clientDiscountValue').value) || 0;

      if (!phone) {
        alert('Selecione um cliente.');
        return;
      }

      if (discount < 0 || discount > 100) {
        alert('Desconto deve estar entre 0% e 100%.');
        return;
      }

      if (discount > 0) {
        clientDiscounts[phone] = discount;
      } else {
        delete clientDiscounts[phone];
      }

      saveClientDiscounts();
      renderClients();
      alert('Desconto salvo com sucesso!');

      document.getElementById('clientDiscountValue').value = '';
    });
    document.getElementById('clientSearch')?.addEventListener('input', (e) => {
      renderClients(e.target.value);
    });

    // =================== COUPON MANAGEMENT ===================
    async function loadCoupons() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_coupons')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Map Supabase columns to JS format
        coupons = (data || []).map(c => ({
          id: c.id,
          code: c.code,
          type: c.discount_type,
          value: parseFloat(c.value),
          minOrder: parseFloat(c.min_order) || 0,
          maxValue: c.max_discount_value ? parseFloat(c.max_discount_value) : null,
          maxUsage: c.max_usage_count,
          currentUsage: c.current_usage_count || 0,
          currentTotal: parseFloat(c.current_discount_total) || 0,
          expiry: c.expiry_date,
          active: c.active !== false
        }));

        // Sync to localStorage
        localStorage.setItem('fastCoupons', JSON.stringify(coupons));
      } catch (error) {
        console.error('Erro ao carregar cupons do Supabase:', error);
        // Fallback to localStorage
        const saved = localStorage.getItem('fastCoupons');
        if (saved) { coupons = JSON.parse(saved); }
        else { coupons = []; }
      }
    }

    async function saveCoupons() {
      // Always save to localStorage first
      localStorage.setItem('fastCoupons', JSON.stringify(coupons));

      // Sync to Supabase
      try {
        for (const c of coupons) {
          const couponData = {
            code: c.code,
            discount_type: c.type,
            value: c.value,
            min_order: c.minOrder || 0,
            max_discount_value: c.maxValue || null,
            max_usage_count: c.maxUsage || null,
            current_usage_count: c.currentUsage || 0,
            current_discount_total: c.currentTotal || 0,
            expiry_date: c.expiry || null,
            active: c.active !== false
          };

          if (c.id) {
            // Update existing
            await window.supabaseClient
              .from('fast_coupons')
              .update(couponData)
              .eq('id', c.id);
          } else {
            // Insert new
            const { data } = await window.supabaseClient
              .from('fast_coupons')
              .insert([couponData])
              .select();
            if (data && data[0]) {
              c.id = data[0].id;
            }
          }
        }
      } catch (error) {
        console.error('Erro ao salvar cupons no Supabase:', error);
      }
    }

    async function deleteCouponFromSupabase(couponId) {
      if (!couponId) return;
      try {
        await window.supabaseClient
          .from('fast_coupons')
          .delete()
          .eq('id', couponId);
      } catch (error) {
        console.error('Erro ao excluir cupom do Supabase:', error);
      }
    }

    function isCouponExhausted(c) {
      // Check if exhausted by usage count
      if (c.maxUsage && c.currentUsage >= c.maxUsage) return true;
      // Check if exhausted by total discount value
      if (c.maxValue && c.currentTotal >= c.maxValue) return true;
      return false;
    }

    function isCouponExpired(c) {
      if (!c.expiry) return false;
      const today = formatYYYYMMDD(getBrasiliaDate());
      return c.expiry < today;
    }

    function renderCoupons() {
      const activeBox = document.getElementById('couponsList');
      const inactiveBox = document.getElementById('inactiveCouponsList');
      if (!activeBox) return;

      // Separate active and inactive coupons
      const activeCoupons = coupons.filter(c => c.active !== false && !isCouponExhausted(c) && !isCouponExpired(c));
      const inactiveCoupons = coupons.filter(c => c.active === false || isCouponExhausted(c) || isCouponExpired(c));

      // Render active coupons
      activeBox.innerHTML = activeCoupons.length ? activeCoupons.map((c, i) => {
        const originalIndex = coupons.indexOf(c);
        const usageInfo = c.maxUsage ? `${c.currentUsage || 0}/${c.maxUsage} usos` : '';
        const valueInfo = c.maxValue ? `R$ ${(c.currentTotal || 0).toFixed(2)}/${c.maxValue.toFixed(2)}` : '';
        const limitsInfo = [usageInfo, valueInfo].filter(x => x).join(' â€¢ ');
        return `
        <div class='p-3 border rounded-lg bg-gradient-to-r from-purple-50 to-pink-50'>
          <div class='flex justify-between items-start'>
            <div>
              <p class='font-bold text-purple-700 text-lg'>${c.code}</p>
              <p class='text-sm text-gray-600'>
                ${c.type === 'percentage' ? c.value + '%' : 'R$ ' + c.value.toFixed(2).replace('.', ',')} de desconto
              </p>
              ${c.minOrder > 0 ? `<p class='text-xs text-gray-500'>MÃ­nimo: R$ ${c.minOrder.toFixed(2).replace('.', ',')}</p>` : ''}
              ${c.expiry ? `<p class='text-xs text-gray-500'>VÃ¡lido atÃ©: ${safeDate(c.expiry).toLocaleDateString('pt-BR')}</p>` : ''}
              ${limitsInfo ? `<p class='text-xs text-blue-600'>${limitsInfo}</p>` : ''}
            </div>
            <div class='flex flex-col gap-1'>
              <button class='px-2 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs' onclick='editCoupon(${originalIndex})'>Editar</button>
              <button class='px-2 py-1 rounded bg-orange-500 hover:bg-orange-600 text-white text-xs' onclick='inactivateCoupon(${originalIndex})'>Inativar</button>
            </div>
          </div>
        </div>`}).join('') : '<p class="text-gray-500 text-sm">Nenhum cupom ativo.</p>';

      // Render inactive coupons
      if (inactiveBox) {
        inactiveBox.innerHTML = inactiveCoupons.length ? inactiveCoupons.map((c) => {
          const originalIndex = coupons.indexOf(c);
          const reason = isCouponExhausted(c) ? '(Esgotado)' : isCouponExpired(c) ? '(Vencido)' : '(Inativo)';
          return `
          <div class='p-2 border rounded-lg bg-gray-100 opacity-70'>
            <div class='flex justify-between items-center'>
              <div>
                <span class='font-medium text-gray-600'>${c.code}</span>
                <span class='text-xs text-red-500 ml-2'>${reason}</span>
              </div>
              <button class='px-2 py-1 rounded bg-green-500 hover:bg-green-600 text-white text-xs' onclick='reactivateCoupon(${originalIndex})'>Reativar</button>
            </div>
          </div>`}).join('') : '<p class="text-gray-400 text-xs">Nenhum cupom inativo.</p>';
      }
    }

    function editCoupon(i) {
      const c = coupons[i];
      document.getElementById('editingCouponId').value = i;
      document.getElementById('couponCode').value = c.code;
      document.getElementById('couponType').value = c.type;
      document.getElementById('couponValue').value = c.value;
      document.getElementById('couponMinOrder').value = c.minOrder || '';
      document.getElementById('couponExpiry').value = c.expiry || '';
      document.getElementById('couponMaxValue').value = c.maxValue || '';
      document.getElementById('couponMaxUsage').value = c.maxUsage || '';
      document.getElementById('couponCode').disabled = true; // Can't change code
      document.getElementById('saveCoupon').textContent = 'Salvar AlteraÃ§Ãµes';
      document.getElementById('cancelEditCoupon').classList.remove('hidden');
    }

    function cancelEditCoupon() {
      document.getElementById('editingCouponId').value = '';
      document.getElementById('couponCode').disabled = false;
      document.getElementById('saveCoupon').textContent = 'Criar Cupom';
      document.getElementById('cancelEditCoupon').classList.add('hidden');
      resetCouponForm();
    }

    function resetCouponForm() {
      document.getElementById('couponCode').value = '';
      document.getElementById('couponValue').value = '';
      document.getElementById('couponMinOrder').value = '';
      document.getElementById('couponExpiry').value = '';
      document.getElementById('couponMaxValue').value = '';
      document.getElementById('couponMaxUsage').value = '';
    }

    function inactivateCoupon(i) {
      coupons[i].active = false;
      saveCoupons();
      renderCoupons();
      showInlineMessage('couponsList', 'ğŸ”´ Cupom inativado!', 'success');
    }

    function reactivateCoupon(i) {
      coupons[i].active = true;
      // Reset usage if reactivating
      coupons[i].currentUsage = 0;
      coupons[i].currentTotal = 0;
      saveCoupons();
      renderCoupons();
      showInlineMessage('couponsList', 'ğŸŸ¢ Cupom reativado!', 'success');
    }

    document.getElementById('cancelEditCoupon')?.addEventListener('click', cancelEditCoupon);

    document.getElementById('saveCoupon')?.addEventListener('click', () => {
      const editingId = document.getElementById('editingCouponId').value;
      const code = document.getElementById('couponCode').value.trim().toUpperCase();
      const type = document.getElementById('couponType').value;
      const value = parseFloat(document.getElementById('couponValue').value) || 0;
      const minOrder = parseFloat(document.getElementById('couponMinOrder').value) || 0;
      const expiry = document.getElementById('couponExpiry').value;
      const maxValue = parseFloat(document.getElementById('couponMaxValue').value) || null;
      const maxUsage = parseInt(document.getElementById('couponMaxUsage').value) || null;

      if (!code || value <= 0) {
        showInlineMessage('couponsList', 'âŒ Preencha cÃ³digo e valor do cupom.', 'error');
        return;
      }

      if (editingId !== '') {
        // Editing existing coupon
        const i = parseInt(editingId);
        coupons[i].type = type;
        coupons[i].value = value;
        coupons[i].minOrder = minOrder;
        coupons[i].expiry = expiry;
        coupons[i].maxValue = maxValue;
        coupons[i].maxUsage = maxUsage;
        saveCoupons();
        renderCoupons();
        showInlineMessage('couponsList', 'âœ… Cupom atualizado!', 'success');
        cancelEditCoupon();
      } else {
        // Creating new coupon
        if (coupons.some(c => c.code === code)) {
          showInlineMessage('couponsList', 'âŒ Este cÃ³digo de cupom jÃ¡ existe!', 'error');
          return;
        }
        coupons.push({
          code, type, value, minOrder, expiry, maxValue, maxUsage,
          currentUsage: 0, currentTotal: 0, active: true,
          createdAt: new Date().toISOString()
        });
        saveCoupons();
        renderCoupons();
        showInlineMessage('couponsList', 'âœ… Cupom criado com sucesso!', 'success');
        resetCouponForm();
      }
    });
    document.addEventListener('submit', (e) => {
      if (e.target && e.target.id === 'userForm') {
        e.preventDefault();
        const username = document.getElementById('userName').value.trim();
        const password = document.getElementById('userPass').value;
        const role = document.getElementById('userRole').value;
        if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) { alert('UsuÃ¡rio jÃ¡ existe.'); return; }
        users.push({ username, password, role }); saveUsers(); renderUsers(); e.target.reset();
      }
    });

    document.getElementById('loginForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const u = document.getElementById('loginUser').value.trim().toLowerCase();
      const p = document.getElementById('loginPass').value;
      const rememberUser = document.getElementById('rememberUser').checked;
      const loginError = document.getElementById('loginError');

      // Hide previous error
      loginError.classList.add('hidden');

      const found = users.find(x => x.username.toLowerCase() === u && x.password === p);
      if (found) {
        // Save username if checkbox is checked
        if (rememberUser) {
          localStorage.setItem('fastRememberedUser', u);
        } else {
          localStorage.removeItem('fastRememberedUser');
        }
        isAdmin = true;
        sessionStorage.setItem('fastAdmin', '1');
        sessionStorage.setItem('fastRole', found.role);
        currentUserRole = found.role;
        showAdminPanel();
      } else {
        // Show inline error instead of alert
        loginError.textContent = 'âŒ Login ou senha incorretos!';
        loginError.classList.remove('hidden');
      }
    });
    document.getElementById('goToPublic')?.addEventListener('click', () => showPublicStore());
    document.getElementById('goToStore')?.addEventListener('click', () => showPublicStore());
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    if (adminLoginBtn) { adminLoginBtn.addEventListener('click', () => showLoginModal()); }
    document.getElementById('logoutBtn')?.addEventListener('click', () => { isAdmin = false; sessionStorage.removeItem('fastAdmin'); sessionStorage.removeItem('fastRole'); showLoginModal(); });

    function hideAllAdminPanels() {
      // Esconde todos os painÃ©is do admin
      ['adminPanel', 'productsPanelFast', 'configPanelFast', 'clientsPanelFast', 
       'promotionsPanelFast', 'reportsPanelFast', 'ordersPanelFast'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }

    function showLoginModal() {
      hideAllAdminPanels();
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('publicStore').classList.add('hidden');
      const f = document.getElementById('loginForm'); if (f) { f.reset(); }
      const loginError = document.getElementById('loginError');
      if (loginError) loginError.classList.add('hidden');
      // Restore remembered username
      const rememberedUser = localStorage.getItem('fastRememberedUser');
      if (rememberedUser) {
        document.getElementById('loginUser').value = rememberedUser;
        document.getElementById('rememberUser').checked = true;
      }
    }
    function showAdminPanel() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('publicStore').classList.add('hidden');
      const role = currentUserRole || sessionStorage.getItem('fastRole') || 'admin';
      // Bloquear apenas 'caixa' de acessar admin
      if (role === 'caixa') {
        alert('Sem acesso ao painel administrativo para este perfil.');
        showPublicStore();
        return;
      }
      // Ocultar gestÃ£o de usuÃ¡rios para nÃ£o-admin
      const usersCard = document.getElementById('usersList')?.parentElement;
      if (usersCard) usersCard.style.display = (role === 'admin') ? 'block' : 'none';
      loadProductsAdmin();
      renderUsers();
    }
    function showPublicStore() {
      hideAllAdminPanels();
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('publicStore').classList.remove('hidden');
      // Toggle header buttons
      const isLogged = sessionStorage.getItem('fastAdmin') === '1';
      const role = sessionStorage.getItem('fastRole');
      const backBtn = document.getElementById('backToAdminBtn');
      const enterBtn = document.getElementById('adminLoginBtn');
      const feesBtn = document.getElementById('openFeesFast');
      if (backBtn && enterBtn) {
        if (isLogged && role !== 'caixa') { backBtn.classList.remove('hidden'); enterBtn.classList.add('hidden'); }
        else { backBtn.classList.add('hidden'); enterBtn.classList.remove('hidden'); }
      }
      if (feesBtn) { if (isLogged && role !== 'caixa') { feesBtn.classList.remove('hidden'); } else { feesBtn.classList.add('hidden'); } }
      if (backBtn) { backBtn.onclick = () => showAdminPanel(); }
      updateOpenNotice();
      loadProductsPublic();
    }

    function updateOpenNotice() {
      const el = document.getElementById('openNotice'); if (!el) return;
      const brasilia = getBrasiliaDate();
      const today = brasilia.toDateString();
      const manuallyClosed = localStorage.getItem('fastManuallyClosed');

      // Check if we're within normal operating hours using businessHours
      const d = brasilia.getDay();
      const h = brasilia.getHours();
      const m = brasilia.getMinutes();
      const timeNow = h + m / 60;

      // Determine if we're in normal operating hours using config
      let isNormallyOpen = false;
      const todayHours = businessHours.find(bh => bh.day_of_week === d);
      if (todayHours && todayHours.is_open) {
        const [openH, openM] = (todayHours.open_time || '14:00').split(':').map(Number);
        const [closeH, closeM] = (todayHours.close_time || '18:00').split(':').map(Number);
        const openTime = openH + openM / 60;
        const closeTime = closeH + closeM / 60;
        isNormallyOpen = timeNow >= openTime && timeNow < closeTime;
      }

      // Generate hours display string from config
      const hoursStr = generateHoursDisplayString();

      if (manuallyClosed === today && isNormallyOpen) {
        // Show manual closed message only during normal hours
        el.innerHTML = '<strong class="text-2xl">ğŸš« FECHADO HOJE</strong><br>Loja fechada manualmente. Voltamos amanhÃ£!';
        el.className = 'text-base py-3 px-4 rounded-lg my-2 text-red-900 font-semibold text-center';
      } else if (isFastOpen()) {
        el.innerHTML = `<strong class="block text-lg">Aberto</strong><span class="block text-sm">${hoursStr}</span>`;
        el.className = 'text-base py-3 px-4 rounded-lg my-2 bg-green-600/20 text-green-900 font-semibold text-center';
      } else {
        el.innerHTML = '<strong class="text-2xl">âš ï¸ ESTAMOS FECHADOS</strong><br>Aceitamos encomendas com 1 dia de antecedÃªncia (50% de entrada).';
        el.className = 'text-base py-3 px-4 rounded-lg my-2 text-red-900 font-semibold text-center';
      }
    }

    function generateHoursDisplayString() {
      if (!businessHours || businessHours.length === 0) {
        return 'Segâ€“Qui e SÃ¡b 14hâ€“18h, Sexta 14hâ€“19h30';
      }

      const openDays = businessHours.filter(d => d.is_open);
      if (openDays.length === 0) return 'Fechado';

      // Group by similar hours
      const groups = [];
      let currentGroup = null;

      openDays.forEach(day => {
        const hours = `${day.open_time.replace(':00', 'h').replace(':', 'h')}â€“${day.close_time.replace(':00', 'h').replace(':', 'h')}`;
        if (currentGroup && currentGroup.hours === hours) {
          currentGroup.days.push(day.day_name);
        } else {
          currentGroup = { hours, days: [day.day_name] };
          groups.push(currentGroup);
        }
      });

      return groups.map(g => {
        const dayStr = g.days.length > 2
          ? `${g.days[0].substr(0, 3)}â€“${g.days[g.days.length - 1].substr(0, 3)}`
          : g.days.map(d => d.substr(0, 3)).join(', ');
        return `${dayStr} ${g.hours}`;
      }).join(', ');
    }

    // Helper function to get current time in BrasÃ­lia timezone (UTC-3)
    // Using manual offset for iOS Safari compatibility (toLocaleString timeZone not supported in older Safari)
    function getBrasiliaDate() {
      const now = new Date();
      // BrasÃ­lia is UTC-3 (no daylight saving since 2019)
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const brasiliaOffset = -3 * 60 * 60000; // UTC-3 in milliseconds
      const brasiliaDate = new Date(utc + brasiliaOffset);
      return brasiliaDate;
    }

    function formatYYYYMMDD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function getMinEncomendaDateYYYYMMDD() {
      const brasilia = getBrasiliaDate();
      const mins = brasilia.getHours() * 60 + brasilia.getMinutes();
      const cutoff = 7 * 60;
      const d = new Date(brasilia.getTime());
      if (mins > cutoff) d.setDate(d.getDate() + 1);
      d.setHours(0, 0, 0, 0);
      return formatYYYYMMDD(d);
    }

    function isFastOpen() {
      // Verificar se a loja foi fechada manualmente hoje
      const brasilia = getBrasiliaDate();
      const today = brasilia.toDateString();
      const manuallyClosed = localStorage.getItem('fastManuallyClosed');
      if (manuallyClosed === today) return false;

      const d = brasilia.getDay();
      const h = brasilia.getHours();
      const m = brasilia.getMinutes();
      const timeNow = h + m / 60;

      // Check configurable business hours
      const todayHours = businessHours.find(bh => bh.day_of_week === d);
      if (todayHours) {
        if (!todayHours.is_open) return false;

        // Parse open/close times
        const [openH, openM] = (todayHours.open_time || '14:00').split(':').map(Number);
        const [closeH, closeM] = (todayHours.close_time || '18:00').split(':').map(Number);
        const openTime = openH + openM / 60;
        const closeTime = closeH + closeM / 60;

        return timeNow >= openTime && timeNow < closeTime;
      }

      // Fallback to defaults if no config
      if (d === 0) return false; // domingo fechado
      if (d === 5) return timeNow >= 14 && timeNow < 19.5; // sexta atÃ© 19h30
      return timeNow >= 14 && timeNow < 18; // seg-qui e sÃ¡b
    }
    // Using character range instead of \p{Diacritic} for iOS/Safari compatibility
    function norm(s) { return (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, ' ').trim(); }
    function isFastDeliveryAllowed(nei) {
      const n = norm(nei);
      const allowed = ['novo prado', 'sao domingos', 'cristo redentor', 'cidade baixa', 'santo antonio', 'varzea alegre', 'centro'];
      return allowed.includes(n);
    }


    // ========== PRODUCTS - SUPABASE INTEGRATION ==========

    async function loadProducts() {
      try {
        // Tentar carregar do Supabase primeiro
        const { data, error } = await window.supabaseClient
          .from('fast_products')
          .select('*')
          .order('id', { ascending: true });

        if (error) throw error;

        if (data && data.length > 0) {
          products = data;
          console.log('Produtos carregados do Supabase:', products.length);
        } else {
          // Se nÃ£o hÃ¡ produtos no Supabase, usar defaults e salvar
          await seedDefaultProducts();
        }
      } catch (error) {
        console.error('Erro ao carregar produtos do Supabase:', error);
        // Fallback para localStorage
        const saved = localStorage.getItem('fastProducts');
        if (saved) {
          products = JSON.parse(saved);
          console.log('Produtos carregados do localStorage (fallback)');
        } else {
          await seedDefaultProducts();
        }
      }
      // Sempre manter backup local
      localStorage.setItem('fastProducts', JSON.stringify(products));
    }

    async function seedDefaultProducts() {
      products = [
        { id: 1, name: 'Coxinha de frango', description: 'Tradicional', price: 4.00, category: 'salgados', image: null, emoji: 'ğŸ¥Ÿ', visible: true },
        { id: 2, name: 'Enroladinho', description: 'Presunto e queijo', price: 4.00, category: 'salgados', image: null, emoji: 'ğŸŒ­', visible: true },
        { id: 3, name: 'Risole de carne', description: 'Recheado de carne', price: 4.50, category: 'salgados', image: null, emoji: 'ğŸ¥Ÿ', visible: true },
        { id: 4, name: 'Risole de queijo e presunto', description: 'Cremoso', price: 4.50, category: 'salgados', image: null, emoji: 'ğŸ¥Ÿ', visible: true },
        { id: 5, name: 'Mini coxinha', description: 'Bandeja 25 un', price: 15.00, category: 'mini', image: null, emoji: 'ğŸ¥Ÿ', visible: true },
        { id: 6, name: 'Quibe', description: 'Bandeja 25 un', price: 18.00, category: 'mini', image: null, emoji: 'ğŸ¥Ÿ', visible: true },
        { id: 7, name: 'Enroladinho mini', description: 'Bandeja 25 un', price: 15.00, category: 'mini', image: null, emoji: 'ğŸŒ­', visible: true },
        { id: 8, name: 'Bolinho de carne', description: 'Bandeja 25 un', price: 18.00, category: 'mini', image: null, emoji: 'ğŸ¥Ÿ', visible: true },
        { id: 9, name: 'Bolinha de queijo', description: 'Bandeja 25 un', price: 18.00, category: 'mini', image: null, emoji: 'ğŸ§€', visible: true },
        { id: 10, name: 'Pepsi 1L', description: 'Refrigerante', price: 8.00, category: 'bebidas', image: null, emoji: 'ğŸ¥¤', visible: true },
        { id: 11, name: 'Coca-Cola 1L', description: 'Refrigerante', price: 9.00, category: 'bebidas', image: null, emoji: 'ğŸ¥¤', visible: true },
        { id: 12, name: 'Coca-Cola lata 350ml', description: 'Lata 350ml', price: 6.00, category: 'bebidas', image: null, emoji: 'ğŸ¥¤', visible: true },
        { id: 13, name: 'Pepsi lata 350ml', description: 'Lata 350ml', price: 5.50, category: 'bebidas', image: null, emoji: 'ğŸ¥¤', visible: true },
        { id: 14, name: 'GuaranÃ¡ 1L', description: 'Refrigerante', price: 8.00, category: 'bebidas', image: null, emoji: 'ğŸ¥¤', visible: true },
      ];
      await saveProductsToSupabase();
    }

    async function saveProducts() {
      // Salvar localmente primeiro (rÃ¡pido)
      localStorage.setItem('fastProducts', JSON.stringify(products));
      // Depois sincronizar com Supabase (assÃ­ncrono)
      await saveProductsToSupabase();
    }

    async function saveProductsToSupabase() {
      try {
        // Upsert todos os produtos
        for (const product of products) {
          const { error } = await window.supabaseClient
            .from('fast_products')
            .upsert({
              id: product.id,
              name: product.name,
              description: product.description,
              price: product.price,
              category: product.category,
              image: product.image,
              emoji: product.emoji,
              visible: product.visible
            }, { onConflict: 'id' });

          if (error) {
            console.error('Erro ao salvar produto:', product.name, error);
          }
        }
        console.log('Produtos sincronizados com Supabase');
      } catch (error) {
        console.error('Erro ao sincronizar produtos com Supabase:', error);
      }
    }

    // Upload de imagem para Supabase Storage
    async function uploadImageToStorage(file) {
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `product_${Date.now()}.${fileExt}`;
        const filePath = `products/${fileName}`;

        const { data, error } = await window.supabaseClient.storage
          .from('fast-images')
          .upload(filePath, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (error) throw error;

        // Retornar URL pÃºblica da imagem
        const { data: urlData } = window.supabaseClient.storage
          .from('fast-images')
          .getPublicUrl(filePath);

        console.log('Imagem enviada:', urlData.publicUrl);
        return urlData.publicUrl;
      } catch (error) {
        console.error('Erro ao enviar imagem:', error);
        // Fallback: retornar base64 se o upload falhar
        return null;
      }
    }


    document.getElementById('productForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('productName').value.trim();
      const description = document.getElementById('productDescription').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value || '0');
      const category = document.getElementById('productCategory').value;
      const imageFile = document.getElementById('productImage').files[0];


      let imageUrl = null;

      if (imageFile) {
        // Tentar upload para Supabase Storage
        const uploadedUrl = await uploadImageToStorage(imageFile);
        if (uploadedUrl) {
          imageUrl = uploadedUrl;
        } else {
          // NÃ£o usar base64 para evitar estouro do localStorage
          alert('âš ï¸ NÃ£o foi possÃ­vel enviar a imagem. Verifique se o bucket "fast-images" foi criado no Supabase Storage!\n\nO produto serÃ¡ salvo sem imagem.');
          imageUrl = null;
        }
      }

      await saveProduct(name, description, price, category, imageUrl);
    });

    async function saveProduct(name, description, price, category, image) {
      const emojiMap = { salgados: 'ğŸ¥Ÿ', mini: 'ğŸ§', kits: 'ğŸ', bolos: 'ğŸ‚', adicionais: 'â•', bebidas: 'ğŸ¥¤' };
      const emoji = emojiMap[category] || 'ğŸ¥Ÿ';

      // Campos de disponibilidade
      const startDate = document.getElementById('productStartDate').value || null;
      const endDate = document.getElementById('productEndDate').value || null;
      const unavailableToday = document.getElementById('productUnavailableToday').checked;

      // Campos de promoÃ§Ã£o
      const promoActive = document.getElementById('productPromoActive').checked;
      const promo = {
        active: promoActive,
        type: document.getElementById('productPromoType').value || 'percent',
        value: parseFloat(document.getElementById('productPromoValue').value) || 0
      };

      // Encomenda
      const isEncomenda = document.getElementById('productIsEncomenda').checked;

      if (editingProductId) {
        const i = products.findIndex(p => p.id === editingProductId);
        if (i !== -1) {
          products[i] = {
            ...products[i],
            name, description, price, category,
            image: image || products[i].image,
            emoji, startDate, endDate, unavailableToday,
            promo, isEncomenda
          };
        }
        editingProductId = null;
      } else {
        products.push({
          id: Date.now(), name, description, price, category,
          image, emoji, visible: true, startDate, endDate, unavailableToday,
          promo, isEncomenda
        });
      }

      await saveProducts();
      loadProductsAdmin();
      loadProductsPublic();
      document.getElementById('productForm').reset();
      showInlineMessage('productsPanelFast', 'âœ… Produto salvo com sucesso!', 'success');
    }
    let adminFilter = 'all';
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('admin-filter')) {
        adminFilter = e.target.getAttribute('data-filter');
        loadProductsAdmin();
      }
    });
    function loadProductsAdmin() {
      const c = document.getElementById('productsList');
      const role = currentUserRole || sessionStorage.getItem('fastRole') || 'admin';
      const filtered = products.filter(p => {
        const isVisible = (p.visible !== false);
        if (adminFilter === 'hidden') return !isVisible;
        if (adminFilter === 'seasonal') return p.startDate && p.endDate;
        if (adminFilter === 'unavailable') return p.unavailableToday;
        if (adminFilter === 'all') return true;
        return p.category === adminFilter;
      });
      c.innerHTML = filtered.map(p => {
        const isVisible = (p.visible !== false);
        // Badges de disponibilidade
        let badges = [];
        if (p.startDate && p.endDate) {
          const start = safeDate(p.startDate).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          const end = safeDate(p.endDate).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          badges.push(`<span class='text-xs bg-blue-100 text-blue-800 px-1 rounded ml-1'>ğŸ“… ${start}-${end}</span>`);
        }
        if (p.unavailableToday) {
          badges.push(`<span class='text-xs bg-red-100 text-red-800 px-1 rounded ml-1'>âŒ IndisponÃ­vel</span>`);
        }
        const badgesHtml = badges.join('');

        return `<div class='p-3 border rounded-lg ${isVisible ? '' : 'opacity-60'}'>
      <!-- Product Info Row -->
      <div class='flex items-start gap-3 mb-3'>
        ${p.image ? `<img src='${p.image}' class='w-12 h-12 sm:w-14 sm:h-14 object-cover rounded flex-shrink-0'>` : `<span class='text-2xl sm:text-3xl'>${p.emoji}</span>`}
        <div class='flex-1 min-w-0'>
          <h4 class='font-semibold text-gray-800 text-sm truncate'>${p.name}</h4>
          <p class='text-xs text-gray-700 truncate'>${p.description || ''}</p>
          <p class='text-sm font-medium text-gray-900'>R$ ${p.price.toFixed(2).replace('.', ',')}</p>
          <div class='flex flex-wrap items-center gap-1 mt-1'>
            <span class='text-xs fs-chip px-2 py-0.5 rounded'>${p.category}${isVisible ? '' : ' â€¢ oculto'}</span>
            ${badgesHtml}
          </div>
        </div>
      </div>
      <!-- Action Buttons Row -->
      <div class='grid grid-cols-3 gap-2'>
        ${(role === 'admin' || role === 'gerente') ? `<button class='bg-rose-600 hover:bg-rose-700 text-white px-2 py-2 rounded text-xs' onclick='editProduct(${p.id})'>Editar</button>` : '<div></div>'}
        ${(role === 'admin' || role === 'gerente' || role === 'garcom') ? `<button class='bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-2 rounded text-xs' onclick='toggleVisibility(${p.id})'>${isVisible ? 'Ocultar' : 'Mostrar'}</button>` : '<div></div>'}
        ${(role === 'admin' || role === 'gerente') ? `<button class='bg-red-500 hover:bg-red-600 text-white px-2 py-2 rounded text-xs' onclick='deleteProduct(${p.id})'>Excluir</button>` : '<div></div>'}
      </div>
    </div>`}).join('');
    }
    function toggleVisibility(id) { const i = products.findIndex(p => p.id === id); if (i !== -1) { products[i].visible = !products[i].visible; saveProducts(); loadProductsAdmin(); loadProductsPublic(); } }
    function editProduct(id) {
      const p = products.find(x => x.id === id);
      if (p) {
        document.getElementById('productName').value = p.name;
        document.getElementById('productDescription').value = p.description;
        document.getElementById('productPrice').value = p.price;
        document.getElementById('productCategory').value = p.category;
        // Campos de disponibilidade
        document.getElementById('productStartDate').value = p.startDate || '';
        document.getElementById('productEndDate').value = p.endDate || '';
        document.getElementById('productUnavailableToday').checked = !!p.unavailableToday;
        // Campos de promoÃ§Ã£o
        const promoActive = p.promo?.active || false;
        document.getElementById('productPromoActive').checked = promoActive;
        document.getElementById('productPromoType').value = p.promo?.type || 'percent';
        document.getElementById('productPromoValue').value = p.promo?.value || '';
        document.getElementById('promoDetailsFields').classList.toggle('hidden', !promoActive);
        // Encomenda
        document.getElementById('productIsEncomenda').checked = !!p.isEncomenda;
        editingProductId = id;
        // Scroll to form
        document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
      }
    }
    function deleteProduct(id) { if (confirm('Excluir este produto?')) { products = products.filter(p => p.id !== id); saveProducts(); loadProductsAdmin(); loadProductsPublic(); } }

    // ========================================
    // PRODUCT AVAILABILITY CHECK (Seasonal + Unavailable)
    // ========================================
    function isProductAvailableToday(product) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // IndisponÃ­vel hoje (flag manual)
      if (product.unavailableToday) return false;

      // Sazonalidade (perÃ­odo definido)
      if (product.startDate && product.endDate) {
        const start = safeDate(product.startDate);
        const end = safeDate(product.endDate);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
        if (today < start || today > end) return false;
      }

      // Visibilidade normal
      if (product.visible === false) return false;

      return true;
    }

    function loadProductsPublic() {
      const map = {
        salgados: document.getElementById('salgadosContainer'),
        mini: document.getElementById('miniContainer'),
        kits: document.getElementById('kitsContainer'),
        bolos: document.getElementById('bolosContainer'),
        adicionais: document.getElementById('adicionaisContainer'),
        bebidas: document.getElementById('bebidasContainer')
      };
      Object.values(map).forEach(el => { if (el) el.innerHTML = ''; });
      products.filter(p => isProductAvailableToday(p)).forEach(product => {
        const isAdditional = product.category === 'adicionais';
        const priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
        const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
        const heartIcon = isFav ? 'â¤ï¸' : 'ğŸ¤';
        const html = `<div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border'>
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='${isAdditional ? "text-2xl" : "text-3xl"} mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800 ${isAdditional ? 'text-sm' : ''}'>${product.name}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1 hover:scale-110 transition-transform' data-id='${product.id}' title='Favorito'>${heartIcon}</button>
          </div>
          <div class='flex items-center justify-between'>
            <span class='text-rose-600 ${isAdditional ? "text-sm" : "text-lg"} font-bold'>${priceDisplay}</span>
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' data-id='${product.id}' data-name='${product.name}' data-description='${product.description}' data-price='${product.price}'>Adicionar</button>
          </div>
        </div>`;
        map[product.category].innerHTML += html;
      });
      // Carregar seÃ§Ã£o de favoritos
      loadFavoritosSection();
      // Carregar Ãºltimos pedidos para clientes que retornam
      renderRecentOrders();
    }

    function loadFavoritosSection() {
      const container = document.getElementById('favoritosContainer');
      if (!container) return;

      const favIds = FavoritesService.getFavorites(currentClientPhone);
      const favProducts = products.filter(p => favIds.includes(p.id) && isProductAvailableToday(p));

      if (favProducts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-2">VocÃª ainda nÃ£o marcou nenhum item como favorito. Toque no ğŸ¤ para adicionar!</p>';
        return;
      }

      container.innerHTML = favProducts.map(product => {
        const priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
        return `<div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border border-pink-200'>
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='text-3xl mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800'>${product.name}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1 hover:scale-110 transition-transform' data-id='${product.id}' title='Remover dos favoritos'>â¤ï¸</button>
          </div>
          <div class='flex items-center justify-between'>
            <span class='text-rose-600 text-lg font-bold'>${priceDisplay}</span>
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' data-id='${product.id}' data-name='${product.name}' data-description='${product.description}' data-price='${product.price}'>Adicionar</button>
          </div>
        </div>`;
      }).join('');
    }

    function loadFilteredProducts(filter) {
      // Get all category containers
      const categories = ['salgados', 'mini', 'kits', 'bolos', 'bebidas', 'adicionais'];
      const containers = {};
      categories.forEach(cat => {
        const el = document.getElementById(`${cat}Container`);
        if (el) containers[cat] = el;
      });

      // Show all category sections
      document.querySelectorAll('.category-section').forEach(section => {
        if (section.id !== 'favoritos') {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });

      // Clear all containers
      Object.values(containers).forEach(c => c.innerHTML = '');

      // Filter products
      const filtered = products.filter(p => {
        if (!isProductAvailableToday(p)) return false;
        if (filter === 'promo') return p.promo?.active === true;
        if (filter === 'encomenda') return p.isEncomenda === true || p.category === 'kits';
        return true;
      });

      if (filtered.length === 0) {
        Object.values(containers)[0].innerHTML = `<p class='text-gray-500 text-center py-8 col-span-2'>Nenhum produto encontrado para este filtro.</p>`;
        return;
      }

      // Render filtered products
      filtered.forEach(product => {
        const container = containers[product.category];
        if (!container) return;

        const isAdditional = product.category === 'adicionais';
        const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
        const heartIcon = isFav ? 'â¤ï¸' : 'ğŸ¤';

        // Promo price calculation
        let priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
        let promoBadge = '';

        if (product.promo?.active && product.promo?.value > 0) {
          let finalPrice = product.price;
          if (product.promo.type === 'percent') {
            finalPrice = product.price * (1 - product.promo.value / 100);
            promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded'>-${product.promo.value}%</span>`;
          } else {
            finalPrice = product.price - product.promo.value;
            promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded'>-R$${product.promo.value}</span>`;
          }
          priceDisplay = `<span class='line-through text-gray-400 text-sm'>R$ ${product.price.toFixed(2).replace('.', ',')}</span> <span class='text-rose-600 font-bold'>R$ ${finalPrice.toFixed(2).replace('.', ',')}</span>`;
        }

        const html = `<div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border ${product.promo?.active ? 'border-yellow-400' : ''}'>
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='${isAdditional ? "text-2xl" : "text-3xl"} mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800 ${isAdditional ? 'text-sm' : ''}'>${product.name} ${promoBadge}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1 hover:scale-110 transition-transform' data-id='${product.id}' title='Favorito'>${heartIcon}</button>
          </div>
          <div class='flex items-center justify-between'>
            <span class='${isAdditional ? "text-sm" : "text-lg"}'>${priceDisplay}</span>
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' data-id='${product.id}' data-name='${product.name}' data-description='${product.description}' data-price='${product.price}'>Adicionar</button>
          </div>
        </div>`;
        container.innerHTML += html;
      });
    }

    function createProductCard(product, isAdditional = false) {
      let priceDisplay = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
      let promoBadge = '';
      let cardBorder = '';

      if (product.promo?.active && product.promo?.value > 0) {
        let finalPrice = product.price;
        if (product.promo.type === 'percent') {
          finalPrice = product.price * (1 - product.promo.value / 100);
          promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded ml-2'>-${product.promo.value}%</span>`;
        } else {
          finalPrice = product.price - product.promo.value;
          promoBadge = `<span class='bg-yellow-400 text-yellow-900 text-xs px-1 rounded ml-2'>-R$${product.promo.value}</span>`;
        }
        priceDisplay = `<span class='line-through text-gray-400 text-sm'>R$ ${product.price.toFixed(2).replace('.', ',')}</span> <span class='text-rose-600 font-bold'>R$ ${finalPrice.toFixed(2).replace('.', ',')}</span>`;
        cardBorder = 'border-yellow-400';
      }

      const isFav = FavoritesService.isFavorite(currentClientPhone, product.id);
      const heartIcon = isFav ? 'â¤ï¸' : 'ğŸ¤';

      return `
        <div class='bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-4 border ${cardBorder}'>
          <div class='flex items-center mb-3'>
            ${product.image ? `<img src='${product.image}' class='w-14 h-14 object-cover rounded mr-3'>` : `<span class='${isAdditional ? "text-2xl" : "text-3xl"} mr-3'>${product.emoji}</span>`}
            <div class='flex-1'>
              <h3 class='font-semibold text-gray-800 ${isAdditional ? 'text-sm' : ''}'>${product.name} ${promoBadge}</h3>
              <p class='text-xs text-gray-600'>${product.description}</p>
            </div>
            <button class='favorite-btn text-xl p-1' data-id='${product.id}'>${heartIcon}</button>
          </div>
          <div class='flex items-center justify-between'>
            <span class='text-rose-600 ${isAdditional ? "text-sm" : "text-lg"} font-bold'>${priceDisplay}</span>
            <button class='add-to-cart bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium' 
              data-id='${product.id}' 
              data-name='${product.name}' 
              data-description='${product.description}' 
              data-price='${product.price}'>
              Adicionar
            </button>
          </div>
        </div>`;
    }

    // Admin: Toggle promo fields
    document.getElementById('productPromoActive')?.addEventListener('change', (e) => {
      document.getElementById('promoDetailsFields').classList.toggle('hidden', !e.target.checked);
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('category-tab')) {
        const cat = e.target.dataset.category;
        document.querySelectorAll('.category-tab').forEach(t => {
          t.classList.remove('bg-red-600', 'bg-pink-300', 'text-white', 'active');
          t.classList.add('bg-red-300', 'text-red-900');
          // Reset pink tabs
          if (t.dataset.category === 'favoritos') {
            t.classList.remove('bg-red-300', 'text-red-900');
            t.classList.add('bg-pink-200', 'text-pink-900');
          }
        });

        if (cat === 'favoritos') {
          e.target.classList.add('bg-pink-400', 'text-white', 'active');
          e.target.classList.remove('bg-pink-200', 'text-pink-900');
        } else {
          e.target.classList.add('bg-red-600', 'text-white', 'active');
          e.target.classList.remove('bg-red-300', 'text-red-900');
        }

        // Show/hide sections based on category
        document.querySelectorAll('.category-section').forEach(section => {
          if (cat === 'favoritos') {
            // Favoritos: mostrar sÃ³ essa seÃ§Ã£o
            section.classList.toggle('hidden', section.id !== 'favoritos');
          } else {
            // Outras categorias: esconder favoritos
            if (section.id === 'favoritos') {
              section.classList.add('hidden');
            } else {
              section.classList.remove('hidden');
            }
          }
        });

        // Scroll to section smoothly
        const section = document.getElementById(cat);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Filter tabs (promo/encomenda)
      if (e.target.classList.contains('filter-tab')) {
        const filter = e.target.dataset.filter;
        if (!filter) return;

        // Toggle active state
        const wasActive = e.target.classList.contains('active');
        document.querySelectorAll('.filter-tab').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.filter === 'promo') {
            btn.classList.remove('bg-yellow-500', 'text-white');
            btn.classList.add('bg-yellow-200', 'text-yellow-900');
          } else {
            btn.classList.remove('bg-purple-500', 'text-white');
            btn.classList.add('bg-purple-200', 'text-purple-900');
          }
        });

        if (!wasActive) {
          e.target.classList.add('active');
          if (filter === 'promo') {
            e.target.classList.add('bg-yellow-500', 'text-white');
            e.target.classList.remove('bg-yellow-200', 'text-yellow-900');
          } else {
            e.target.classList.add('bg-purple-500', 'text-white');
            e.target.classList.remove('bg-purple-200', 'text-purple-900');
          }
          loadFilteredProducts(filter);
        } else {
          // Deactivate filter - show all
          loadProductsPublic();
        }
      }

      // Toggle favorito
      if (e.target.classList.contains('favorite-btn')) {
        const productId = parseInt(e.target.dataset.id);
        const isNowFavorite = FavoritesService.toggle(currentClientPhone, productId);
        e.target.textContent = isNowFavorite ? 'â¤ï¸' : 'ğŸ¤';
        // Atualizar seÃ§Ã£o de favoritos
        loadFavoritosSection();
      }

      if (e.target.classList.contains('add-to-cart')) {
        const id = parseInt(e.target.dataset.id); const name = e.target.dataset.name; const description = e.target.dataset.description; const price = parseFloat(e.target.dataset.price);
        const existing = cart.find(i => i.id === id);
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ id, name, description, price, quantity: 1, note: '' });
        }
        updateCart();
        e.target.textContent = 'Adicionado!';
        e.target.classList.add('bg-green-600');
        setTimeout(() => { e.target.textContent = 'Adicionar'; e.target.classList.remove('bg-green-600'); e.target.classList.add('bg-rose-600'); }, 1000);
      }
    });
    function updateCart() { cartTotal = cart.reduce((t, i) => t + i.price * i.quantity, 0); const count = cart.reduce((t, i) => t + i.quantity, 0); document.getElementById('cartCount').textContent = count; const desktopCount = document.getElementById('cartCountDesktop'); if (desktopCount) desktopCount.textContent = count; const total = `R$ ${cartTotal.toFixed(2).replace('.', ',')}`; document.getElementById('cartTotal').textContent = total; document.getElementById('mobileCartTotal').textContent = total; updateCartItems('cartItems'); updateCartItems('mobileCartItems'); const has = cart.length > 0; document.getElementById('checkoutBtn').disabled = !has; document.getElementById('mobileCheckoutBtn').disabled = !has; }
    function updateCartItems(containerId) {
      const container = document.getElementById(containerId);

      if (cart.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Carrinho vazio</p>';
        return;
      }

      container.innerHTML = cart.map(item => `
        <div class="cart-item p-3 bg-gray-50 rounded-lg mb-2">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <h4 class="font-medium text-gray-800">${item.name}</h4>
              <p class="text-sm text-gray-800">R$ ${item.price.toFixed(2).replace('.', ',')}</p>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="changeQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-200 text-black rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors">-</button>
              <span class="w-8 text-center font-bold text-gray-900">${item.quantity}</span>
              <button onclick="changeQuantity(${item.id}, 1)" class="w-8 h-8 bg-gray-200 text-black rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors">+</button>
            </div>
          </div>
          <div class="mt-2">
            ${item.note ? `<p class="text-xs text-gray-600 italic mb-1">ğŸ“ ${item.note}</p>` : ''}
            <button onclick="toggleItemNote(${item.id})" class="text-xs text-rose-600 hover:text-rose-800">
              ${item.note ? 'âœï¸ Editar obs' : 'ğŸ“ Adicionar obs'}
            </button>
            <div id="noteInput_${item.id}_${containerId}" class="hidden mt-2">
              <input type="text" 
                placeholder="Ex.: sem cebola, bem passado..." 
                value="${item.note || ''}"
                onblur="saveItemNote(${item.id}, this.value)"
                onkeydown="if(event.key==='Enter'){saveItemNote(${item.id}, this.value);}"
                class="w-full px-2 py-1 text-sm border rounded">
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleItemNote(itemId) {
      // Toggle both cart containers
      const containers = ['cartItems', 'mobileCartItems'];
      containers.forEach(containerId => {
        const input = document.getElementById(`noteInput_${itemId}_${containerId}`);
        if (input) {
          input.classList.toggle('hidden');
          if (!input.classList.contains('hidden')) {
            input.querySelector('input')?.focus();
          }
        }
      });
    }

    function saveItemNote(itemId, note) {
      const item = cart.find(i => i.id === itemId);
      if (item) {
        item.note = note.trim();
        updateCart();
      }
    }

    function changeQuantity(id, chg) { const it = cart.find(i => i.id === id); if (it) { it.quantity += chg; if (it.quantity <= 0) { cart = cart.filter(x => x.id !== id); } updateCart(); } }

    // ========================================
    // REORDER FUNCTIONS (Ãšltimos Pedidos)
    // ========================================
    function showLastOrders() {
      const phone = document.getElementById('customerPhone').value.trim();
      const orders = OrderHistoryService.getOrders(phone || null);
      const section = document.getElementById('lastOrdersSection');
      const list = document.getElementById('lastOrdersList');

      if (orders.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      list.innerHTML = orders.slice(0, 3).map((order, idx) => {
        const date = safeDate(order.createdAt).toLocaleDateString('pt-BR');
        const summary = order.items.slice(0, 2).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const more = order.items.length > 2 ? ` +${order.items.length - 2}` : '';
        return `
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="flex justify-between items-start gap-2">
              <div class="flex-1 min-w-0">
                <p class="text-xs text-gray-500">${date}</p>
                <p class="text-sm text-gray-800 truncate">${summary}${more}</p>
                <p class="text-sm font-semibold text-rose-600">R$ ${order.total.toFixed(2).replace('.', ',')}</p>
              </div>
              <button onclick="repeatOrder(${idx})" 
                class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded-lg text-xs font-medium whitespace-nowrap flex-shrink-0">
                ğŸ”„ Repetir
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function repeatOrder(orderIndex) {
      const phone = document.getElementById('customerPhone').value.trim();
      const orders = OrderHistoryService.getOrders(phone || null);
      const order = orders[orderIndex];
      if (!order) return;

      cart = []; // Limpa carrinho
      let unavailable = [];

      order.items.forEach(item => {
        const product = products.find(p => p.id === item.productId && p.visible !== false);
        if (product) {
          cart.push({
            id: product.id,
            name: product.name,
            description: product.description || '',
            price: product.price, // Usa preÃ§o atual!
            quantity: item.quantity
          });
        } else {
          unavailable.push(item.name);
        }
      });

      updateCart();
      document.getElementById('checkoutModal').classList.add('hidden');

      if (unavailable.length > 0) {
        alert(`âš ï¸ Alguns itens nÃ£o estÃ£o mais disponÃ­veis:\n${unavailable.join(', ')}`);
      }

      showInlineMessage('publicStore', 'âœ… Pedido carregado no carrinho!', 'success');
    }

    // ========================================
    // ADDRESS MANAGEMENT (MÃºltiplos EndereÃ§os)
    // ========================================
    function renderSavedAddresses(phone) {
      const select = document.getElementById('savedAddressSelect');
      if (!select) return;

      const addresses = AddressService.load(phone);
      select.innerHTML = '<option value="">Selecione um endereÃ§o...</option>';

      if (addresses.length === 0) {
        document.getElementById('savedAddressSection')?.classList.add('hidden');
        document.getElementById('noAddressSection')?.classList.remove('hidden');
        return;
      }

      addresses.forEach((addr, idx) => {
        const label = addr.label || 'EndereÃ§o';
        const text = `${label} â€“ ${addr.street}, ${addr.number} â€“ ${addr.neighborhood}`;
        const opt = document.createElement('option');
        opt.value = idx.toString();
        opt.textContent = text;
        select.appendChild(opt);
      });

      document.getElementById('savedAddressSection')?.classList.remove('hidden');
      document.getElementById('noAddressSection')?.classList.add('hidden');
    }

    function fillAddressFromSaved(phone, index) {
      const addresses = AddressService.load(phone);
      const addr = addresses[index];
      if (!addr) return;

      document.getElementById('street').value = addr.street || '';
      document.getElementById('number').value = addr.number || '';
      document.getElementById('neighborhood').value = addr.neighborhood || '';
      document.getElementById('reference').value = addr.reference || '';
      if (addr.label) {
        const labelSelect = document.getElementById('addressLabel');
        if (labelSelect) labelSelect.value = addr.label;
      }
    }

    // Event: Ao selecionar endereÃ§o salvo, preencher campos
    document.getElementById('savedAddressSelect')?.addEventListener('change', (e) => {
      const idx = parseInt(e.target.value);
      if (!isNaN(idx)) {
        const phone = document.getElementById('customerPhone').value.trim();
        fillAddressFromSaved(phone, idx);
      }
    });

    // Event: Confirmar uso do endereÃ§o selecionado
    document.getElementById('confirmSavedAddress')?.addEventListener('click', () => {
      const select = document.getElementById('savedAddressSelect');
      const idx = parseInt(select?.value);
      if (isNaN(idx)) {
        alert('Selecione um endereÃ§o da lista.');
        return;
      }
      const phone = document.getElementById('customerPhone').value.trim();
      fillAddressFromSaved(phone, idx);
      document.getElementById('addressForm')?.classList.remove('hidden');
      document.getElementById('savedAddressSection')?.classList.add('hidden');
    });

    // Event: Usar outro endereÃ§o (mostrar formulÃ¡rio vazio)
    document.getElementById('useDifferentAddress')?.addEventListener('click', () => {
      document.getElementById('addressForm')?.classList.remove('hidden');
      document.getElementById('savedAddressSection')?.classList.add('hidden');
      // Limpar campos
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';
    });

    // Event: Ao mudar o telefone do cliente, recarregar endereÃ§os
    document.getElementById('customerPhone')?.addEventListener('blur', () => {
      const phone = document.getElementById('customerPhone').value.trim();
      if (phone && phone.length >= 10) {
        renderSavedAddresses(phone);
      }
    });

    document.getElementById('cartBtn')?.addEventListener('click', () => document.getElementById('cartModal').classList.remove('hidden'));
    document.getElementById('cartBtnDesktop')?.addEventListener('click', () => document.getElementById('cartModal').classList.remove('hidden'));
    document.getElementById('closeCartModal')?.addEventListener('click', () => document.getElementById('cartModal').classList.add('hidden'));
    document.getElementById('checkoutBtn')?.addEventListener('click', showCheckout);
    document.getElementById('mobileCheckoutBtn')?.addEventListener('click', () => { document.getElementById('cartModal').classList.add('hidden'); showCheckout(); });
    function showCheckout() {
      if (cart.length === 0) return;
      const ci = document.getElementById('checkoutItems');
      ci.innerHTML = cart.map(i => {
        let html = `<div class='flex justify-between'><span>${i.quantity}x ${i.name}</span><span>R$ ${(i.price * i.quantity).toFixed(2).replace('.', ',')}</span></div>`;
        if (i.note) {
          html += `<p class='text-xs text-gray-500 italic ml-4'>ğŸ“ ${i.note}</p>`;
        }
        return html;
      }).join('');
      // Kits e Bolos: desabilitar entrega
      const containsKit = cart.some(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'kits'; });
      const containsBolo = cart.some(i => {
        const p = products.find(x => x.id === i.id);
        if (!p) return false;
        const name = p.name.toLowerCase();
        return p.category === 'bolos' || name.includes('bolo p') || name.includes('bolo g') || name.match(/bolo\s*[pg]/i);
      });
      const onlyBeverages = cart.every(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'bebidas'; });
      const deliveryTitle = document.getElementById('deliveryTitle');
      const entregaRadio = document.querySelector('input[name="delivery"][value="entrega"]');
      const retiradaRadio = document.querySelector('input[name="delivery"][value="retirada"]');

      // Check if delivery is globally disabled
      const deliveryDisabled = !storeConfig.delivery_enabled;

      if (containsKit || containsBolo || onlyBeverages || deliveryDisabled) {
        entregaRadio.checked = false;
        entregaRadio.disabled = true;
        retiradaRadio.checked = true;

        // Show delivery disabled reason if applicable
        if (deliveryDisabled && storeConfig.delivery_disabled_reason) {
          const existingNotice = document.getElementById('deliveryDisabledNotice');
          if (!existingNotice) {
            const notice = document.createElement('div');
            notice.id = 'deliveryDisabledNotice';
            notice.className = 'mt-2 p-3 rounded-lg bg-orange-100 border border-orange-300 text-orange-800 text-sm';
            notice.innerHTML = `ğŸšš <strong>Entregas suspensas:</strong> ${storeConfig.delivery_disabled_reason}`;
            entregaRadio.parentElement.parentElement.appendChild(notice);
          }
        }
      } else {
        entregaRadio.disabled = false;
        // Remove notice if exists
        document.getElementById('deliveryDisabledNotice')?.remove();
      }
      // Fora do horÃ¡rio: encomenda + data
      const open = isFastOpen();
      const dateBox = document.getElementById('orderDateBox');
      const encomendaWarn = document.getElementById('encomendaWarning');
      if (!open) { deliveryTitle.textContent = 'Fazer Encomenda'; dateBox.classList.remove('hidden'); encomendaWarn.classList.remove('hidden'); const d = document.getElementById('orderDate'); const minDate = getMinEncomendaDateYYYYMMDD(); d.min = minDate; if (d.value && d.value < minDate) d.value = minDate; }
      else { deliveryTitle.textContent = 'Entrega'; dateBox.classList.add('hidden'); encomendaWarn.classList.add('hidden'); }

      try {
        const deliverySel = document.querySelector('input[name="delivery"]:checked');
        const slot = document.getElementById('orderTimeSlot');
        if (slot) {
          if (deliverySel && deliverySel.value === 'entrega') { slot.min = '07:00'; slot.max = '18:00'; }
          else { slot.removeAttribute('min'); slot.removeAttribute('max'); }
        }
      } catch (e) {}
      updateCheckoutFeeAndTotalFast();
      showLastOrders(); // Mostrar Ãºltimos pedidos para recompra rÃ¡pida
      document.getElementById('checkoutModal').classList.remove('hidden');
    }

    document.addEventListener('change', (e) => {
      if (e.target.name === 'delivery') {
        const f = document.getElementById('addressForm');

        // Check if cart contains kits or bolos (delivery not allowed)
        if (e.target.value === 'entrega') {
          const containsKit = cart.some(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'kits'; });
          const containsBolo = cart.some(i => {
            const p = products.find(x => x.id === i.id);
            if (!p) return false;
            const name = p.name.toLowerCase();
            return p.category === 'bolos' || name.includes('bolo p') || name.includes('bolo g') || name.match(/bolo\s*[pg]/i);
          });

          if (containsKit || containsBolo) {
            // Block delivery selection - revert to pickup
            e.target.checked = false;
            document.querySelector('input[name="delivery"][value="retirada"]').checked = true;
            f.classList.add('hidden');
            alert('âš ï¸ Kits festa e bolos grandes nÃ£o possuem entrega. Apenas retirada na loja.');
            return;
          }
          f.classList.remove('hidden');
        } else {
          f.classList.add('hidden');
        }
        try {
          const slot = document.getElementById('orderTimeSlot');
          if (slot) {
            if (e.target.value === 'entrega') { slot.min = '07:00'; slot.max = '18:00'; }
            else { slot.removeAttribute('min'); slot.removeAttribute('max'); }
          }
        } catch (e2) {}
        updateCheckoutFeeAndTotalFast();
      }
      if (e.target.name === 'payment') { const b = document.getElementById('moneyChangeBox'); if (e.target.value === 'dinheiro') b.classList.remove('hidden'); else b.classList.add('hidden'); updateCheckoutFeeAndTotalFast(); }
      if (['street', 'number', 'neighborhood', 'reference', 'customerPhone'].includes(e.target.id)) { updateCheckoutFeeAndTotalFast(); }

      // Busca automÃ¡tica de cliente
      if (e.target.id === 'customerName' || e.target.id === 'customerPhone') {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();

        if (name || phone) {
          const foundClient = searchClient(name, phone);
          if (foundClient) {
            currentSelectedClient = foundClient;
            const searchArea = document.getElementById('customerSearchArea');
            const foundInfo = document.getElementById('foundCustomerInfo');

            searchArea.classList.remove('hidden');
            foundInfo.innerHTML = `Nome: ${foundClient.name}<br>Telefone: ${foundClient.phone}`;

            // Show address confirmation UI when delivery is selected
            showClientAddressConfirmation(foundClient);

            // Preenche o nome completo se foi busca parcial
            if (name && foundClient.name.toLowerCase().includes(name.toLowerCase()) && foundClient.name !== name) {
              document.getElementById('customerName').value = foundClient.name;
            }
          } else {
            currentSelectedClient = null;
            document.getElementById('customerSearchArea').classList.add('hidden');
          }
        } else {
          currentSelectedClient = null;
          document.getElementById('customerSearchArea').classList.add('hidden');
        }
      }
    });
    document.getElementById('cancelCheckout')?.addEventListener('click', () => document.getElementById('checkoutModal').classList.add('hidden'));
    document.getElementById('confirmOrder')?.addEventListener('click', () => {
      const warnings = document.getElementById('validationWarnings'); warnings.innerHTML = ''; warnings.classList.add('hidden');
      const payment = document.querySelector('input[name="payment"]:checked'); const delivery = document.querySelector('input[name="delivery"]:checked');

      // Validate customer data
      const customerName = document.getElementById('customerName')?.value?.trim();
      const customerPhone = document.getElementById('customerPhone')?.value?.trim();

      if (!customerName || !customerPhone) {
        showWarning('Preencha seu nome e telefone.'); return;
      }

      if (!payment) { showWarning('Selecione uma forma de pagamento.'); return; }
      const minOrder = delivery && delivery.value === 'entrega' ? 15 : 8;
      if (cartTotal < minOrder) { showWarning(`Pedido mÃ­nimo: R$ ${minOrder.toFixed(2).replace('.', ',')}`); return; }
      const containsKit = cart.some(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'kits'; });
      const containsBolo = cart.some(i => {
        const p = products.find(x => x.id === i.id);
        if (!p) return false;
        const name = p.name.toLowerCase();
        return p.category === 'bolos' || name.includes('bolo p') || name.includes('bolo g') || name.match(/bolo\s*[pg]/i);
      });
      const onlyBeverages = cart.every(i => { const p = products.find(x => x.id === i.id); return p && p.category === 'bebidas'; });
      if (onlyBeverages && delivery && delivery.value === 'entrega') { showWarning('NÃ£o entregamos apenas refrigerantes. Adicione salgados ao pedido ou escolha retirada na loja.'); return; }
      if ((containsKit || containsBolo) && delivery && delivery.value === 'entrega') { showWarning('Kits festa e bolos grandes nÃ£o possuem entrega. Altere para retirada na loja.'); return; }
      if (!isFastOpen()) {
        const od = document.getElementById('orderDate').value;
        if (!od) { showWarning('Informe a data da encomenda.'); return; }
        const minDate = getMinEncomendaDateYYYYMMDD();
        if (od < minDate) { showWarning('Data da encomenda invÃ¡lida.'); return; }

        // Validate time slot selection
        const orderTimeSlot = document.getElementById('orderTimeSlot').value;
        if (!orderTimeSlot) { showWarning('Selecione um horÃ¡rio desejado.'); return; }
        if (delivery && delivery.value === 'entrega') {
          if (orderTimeSlot < '07:00' || orderTimeSlot > '18:00') { showWarning('Para entrega, o horÃ¡rio permitido Ã© das 07:00 Ã s 18:00.'); return; }
        }
      }
      function showWarning(txt) { const w = document.getElementById('validationWarnings'); w.innerHTML = `<div class='p-3 bg-red-100 border border-red-400 text-red-900 rounded-lg text-sm'>${txt}</div>`; w.classList.remove('hidden'); }

      let msg = `ğŸ¥Ÿ *Pedido Fast Savory's*\n\n`;
      msg += `ğŸ‘¤ *Cliente:* ${customerName}\n`;
      msg += `ğŸ“± *Telefone:* ${customerPhone}\n\n`;

      msg += `ğŸ“‹ *Itens do Pedido:*\n`;
      cart.forEach(i => {
        const promotion = promotions.find(p => p.productId === i.id);
        let itemPrice = i.price;
        let discountText = '';

        if (promotion) {
          if (promotion.type === 'percentage') {
            itemPrice = i.price * (1 - promotion.value / 100);
            discountText = ` (-${promotion.value}%)`;
          } else {
            itemPrice = i.price - promotion.value;
            discountText = ` (-R$ ${promotion.value.toFixed(2).replace('.', ',')})`;
          }
        }

        msg += `${i.quantity}x ${i.name}${discountText} - R$ ${(itemPrice * i.quantity).toFixed(2).replace('.', ',')}\n`;
        if (i.note) {
          msg += `   ğŸ“ Obs: ${i.note}\n`;
        }
      });

      // Calculate discounts
      let productDiscount = 0;
      cart.forEach(item => {
        const promotion = promotions.find(p => p.productId === item.id);
        if (promotion) {
          if (promotion.type === 'percentage') {
            productDiscount += (item.price * item.quantity) * (promotion.value / 100);
          } else {
            productDiscount += promotion.value * item.quantity;
          }
        }
      });

      let clientDiscount = 0;
      if (customerPhone && clientDiscounts[customerPhone]) {
        clientDiscount = (cartTotal - productDiscount) * (clientDiscounts[customerPhone] / 100);
      }

      // Birthday discount (10% - once per year, only on birthday)
      let birthdayDiscount = 0;
      let hasBirthdayDiscount = false;
      const clientForBdayDiscount = clients.find(c => c.phone === customerPhone);
      if (clientForBdayDiscount && isTodayBirthday(clientForBdayDiscount.birthdate)) {
        // Check if already used this year (synchronous check via localStorage fallback)
        const currentYear = new Date().getFullYear();
        const usageKey = `birthdayDiscount_${customerPhone}_${currentYear}`;
        const alreadyUsed = localStorage.getItem(usageKey) === 'used';

        if (!alreadyUsed) {
          birthdayDiscount = (cartTotal - productDiscount - clientDiscount) * 0.10;
          hasBirthdayDiscount = true;
        }
      }

      // taxas
      let deliveryFeeMsg = 0;
      let cardFeeMsg = 0;
      if (delivery && delivery.value === 'entrega') {
        const nb = document.getElementById('neighborhood').value; if (!nb) { showWarning('Preencha o endereÃ§o.'); return; }
        if (!isFastDeliveryAllowed(nb)) { showWarning('Para sua localidade nÃ£o hÃ¡ entrega disponÃ­vel. Selecione Retirada na loja.'); return; }
        const f = calcFastDeliveryFee(nb);
        if (f > 0) { msg += `Taxa de entrega: R$ ${f.toFixed(2).replace('.', ',')}\n`; deliveryFeeMsg = f; }
        else if (f === 0) { msg += `Taxa de entrega: GrÃ¡tis\n`; }
        else { msg += `Taxa de entrega: Consulte valor de entrega\n`; }
      }
      // Card fees using configurable rates
      if (payment.value === 'cartao1x') {
        cardFeeMsg = cartTotal * (storeConfig.card_fee_1x / 100);
        msg += `Taxa cartÃ£o (1x - ${storeConfig.card_fee_1x}%): R$ ${cardFeeMsg.toFixed(2).replace('.', ',')}\n`;
      }

      // Show discounts in message
      if (productDiscount > 0) {
        msg += `Desconto produtos: -R$ ${productDiscount.toFixed(2).replace('.', ',')}\n`;
      }
      if (clientDiscount > 0) {
        msg += `Desconto fidelidade: -R$ ${clientDiscount.toFixed(2).replace('.', ',')}\n`;
      }
      if (birthdayDiscount > 0) {
        msg += `ğŸ‚ Desconto Aniversariante (10%): -R$ ${birthdayDiscount.toFixed(2).replace('.', ',')}\n`;
      }

      const totalWithFees = cartTotal + deliveryFeeMsg + cardFeeMsg - productDiscount - clientDiscount - birthdayDiscount;
      msg += `\n*Total: R$ ${totalWithFees.toFixed(2).replace('.', ',')}*\n\n`;
      const paymentMap = { dinheiro: 'ğŸ’µ Dinheiro', cartao1x: 'ğŸ’³ CartÃ£o 1x', pix: 'ğŸ“± PIX' }; msg += `*Pagamento:* ${paymentMap[payment.value] || payment.value}\n`;
      // Aviso especial para pagamento em cartÃ£o
      if (payment.value === 'cartao1x') {
        msg += `\nğŸ’³ *IMPORTANTE:* O link de pagamento em cartÃ£o serÃ¡ enviado apÃ³s a Fast Savory's aceitar seu pedido.\n`;
        msg += `Aguarde nosso retorno com o link de pagamento. MÃ­nimo de 50% de entrada.\n`;
      }
      if (payment.value === 'dinheiro') { const ch = parseFloat(document.getElementById('moneyChangeValue').value || '0'); if (ch > 0) { msg += `*Troco para:* R$ ${ch.toFixed(2).replace('.', ',')}\n`; } }
      if (delivery.value === 'retirada') { msg += `*Entrega:* ğŸª Retirada na loja\n`; }
      else {
        const s = document.getElementById('street').value; const n = document.getElementById('number').value; const nb = document.getElementById('neighborhood').value; const r = document.getElementById('reference').value; if (!s || !n || !nb) { alert('Preencha o endereÃ§o.'); return; }
        msg += `*Entrega:* ğŸšš Delivery\n*EndereÃ§o:* ${s}, ${n} - ${nb}\n`;
        if (r) msg += `*ReferÃªncia:* ${r}\n`;
      }
      if (!isFastOpen()) {
        const od = document.getElementById('orderDate').value;
        const ot = document.getElementById('orderTimeSlot').value;
        if (!od) { alert('Selecione a data da encomenda.'); return; }
        if (!ot) { alert('Selecione o hor\u00e1rio desejado.'); return; }
        msg += `\n\u26a0\ufe0f *Encomenda:* Pedido fora do hor\u00e1rio. Antec\u00eadencia m\u00ednima de 1 dia e 50% de entrada.\n*Data da encomenda:* ${od}\n*Hor\u00e1rio:* ${ot}\n`;
      }
      msg += `\nâš ï¸ *Este pedido sÃ³ serÃ¡ vÃ¡lido apÃ³s a confirmaÃ§Ã£o da Fast Savory's.*\n\n`;
      msg += `ğŸ“ *Contato:* (73) 99936-6554\n\nObrigado pelo seu pedido! ğŸ˜Š`;

      // Save client if not exists
      const existingClient = clients.find(c => c.phone === customerPhone);
      if (!existingClient) {
        // Auto-register client with minimal data
        const newClient = {
          id: Date.now(), // Generate unique ID for Supabase
          name: customerName,
          phone: customerPhone,
          birthdate: '', // Empty - will ask in modal
          email: '',
          addresses: []
        };
        clients.push(newClient);
        saveClients(); // Async but don't need to await
      }

      // Save address to client if it's a new address (for delivery orders)
      if (delivery.value === 'entrega') {
        const newAddress = {
          label: document.getElementById('addressLabel')?.value || 'Casa',
          street: document.getElementById('street').value,
          number: document.getElementById('number').value,
          neighborhood: document.getElementById('neighborhood').value,
          reference: document.getElementById('reference').value
        };

        // Save to AddressService (localStorage) if checkbox is checked
        const saveCheckbox = document.getElementById('saveAddressCheckbox');
        if (saveCheckbox?.checked && newAddress.street && newAddress.number && newAddress.neighborhood) {
          AddressService.save(customerPhone, newAddress);
        }

        // Find and update client with this address (legacy)
        const clientToUpdate = clients.find(c => c.phone === customerPhone);
        if (clientToUpdate) {
          const addresses = clientToUpdate.addresses || [];
          // Check if this address already exists
          const addressExists = addresses.some(a =>
            a.street === newAddress.street &&
            a.number === newAddress.number &&
            a.neighborhood === newAddress.neighborhood
          );
          if (!addressExists && newAddress.street && newAddress.number && newAddress.neighborhood) {
            addresses.push(newAddress);
            clientToUpdate.addresses = addresses;
            saveClients();
          }
        }
      }

      // Save order to Supabase for analytics
      const orderData = {
        id: Date.now(),
        client_name: customerName,
        client_phone: customerPhone,
        items: cart.map(i => ({
          id: i.id,
          name: i.name,
          price: i.price,
          quantity: i.quantity
        })),
        subtotal: cartTotal,
        delivery_fee: deliveryFeeMsg,
        card_fee: cardFeeMsg,
        discount: productDiscount + clientDiscount + birthdayDiscount,
        total: totalWithFees,
        payment_method: payment.value,
        delivery_type: delivery.value,
        address: delivery.value === 'entrega' ? {
          street: document.getElementById('street').value,
          number: document.getElementById('number').value,
          neighborhood: document.getElementById('neighborhood').value,
          reference: document.getElementById('reference').value
        } : null,
        scheduled_date: !isFastOpen() ? document.getElementById('orderDate').value : null,
        status: 'pending'
      };

      // Check if client needs birthday registration
      const clientForBirthday = clients.find(c => c.phone === customerPhone);
      const needsBirthdayRegistration = !clientForBirthday || !clientForBirthday.birthdate || clientForBirthday.birthdate === '' || clientForBirthday.birthdate === formatYYYYMMDD(getBrasiliaDate());

      if (needsBirthdayRegistration) {
        // Store pending order and show birthday modal
        pendingOrderData = orderData;
        pendingWhatsAppMessage = msg;
        showBirthdayModal();
      } else {
        // Client has birthdate - proceed directly
        saveOrderToSupabase(orderData);

        // Record birthday discount usage if applied
        if (hasBirthdayDiscount && customerPhone) {
          recordBirthdayDiscountUsage(customerPhone, birthdayDiscount, orderData.id);
        }

        // Salvar no histÃ³rico local para recompra rÃ¡pida
        const orderForHistory = {
          id: Date.now().toString(),
          createdAt: new Date().toISOString(),
          items: cart.map(i => ({
            productId: i.id,
            name: i.name,
            price: i.price,
            quantity: i.quantity,
            category: products.find(p => p.id === i.id)?.category || ''
          })),
          total: totalWithFees,
          isEncomenda: !isFastOpen(),
          deliveryType: delivery.value,
          neighborhood: document.getElementById('neighborhood').value || '',
          encomendaDate: !isFastOpen() ? document.getElementById('orderDate').value : null,
          encomendaSlot: !isFastOpen() ? document.getElementById('orderTimeSlot').value : null,
          notes: ''
        };
        saveOrderToHistory(customerPhone, orderForHistory);
        localStorage.setItem('fastLastPhone', customerPhone);
        currentClientPhone = customerPhone;

        const number = '5573999366554';
        const url = `https://wa.me/${number}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank', 'noopener,noreferrer');

        // Limpar dados do checkout apÃ³s envio
        clearCheckoutData();

        cart = []; updateCart(); document.getElementById('checkoutModal').classList.add('hidden');
        showInlineMessage('publicStore', 'âœ… Pedido enviado para o WhatsApp!', 'success');
      }
    });

    // FunÃ§Ã£o para limpar dados do checkout
    function clearCheckoutData() {
      // Limpa campos do cliente
      document.getElementById('customerName').value = '';
      document.getElementById('customerPhone').value = '';

      // Esconde Ã¡rea de busca de cliente
      document.getElementById('customerSearchArea').classList.add('hidden');
      currentSelectedClient = null;

      // Limpa campos de endereÃ§o
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';
      document.getElementById('addressForm').classList.add('hidden');

      // Limpa campos de pagamento
      document.querySelectorAll('input[name="payment"]').forEach(input => input.checked = false);
      document.getElementById('moneyChangeValue').value = '';
      document.getElementById('moneyChangeBox').classList.add('hidden');

      // Limpa campos de entrega
      document.querySelector('input[name="delivery"][value="retirada"]').checked = true;
      document.getElementById('addressForm').classList.add('hidden');

      // Limpa data de encomenda
      document.getElementById('orderDate').value = '';
      document.getElementById('orderDateBox').classList.add('hidden');
      document.getElementById('encomendaWarning').classList.add('hidden');

      // Limpa avisos de validaÃ§Ã£o
      document.getElementById('validationWarnings').innerHTML = '';
      document.getElementById('validationWarnings').classList.add('hidden');
    }

    // ===========================================
    // ADDRESS CONFIRMATION EVENT HANDLERS
    // ===========================================

    function showClientAddressConfirmation(client) {
      const savedAddressSection = document.getElementById('savedAddressSection');
      const noAddressSection = document.getElementById('noAddressSection');
      const savedAddressText = document.getElementById('savedAddressText');

      if (!client) return;

      const addresses = client.addresses || [];
      const defaultAddress = addresses[0]; // First address is default

      if (defaultAddress) {
        // Show saved address with confirmation buttons
        savedAddressText.textContent = `${defaultAddress.street}, ${defaultAddress.number} - ${defaultAddress.neighborhood}${defaultAddress.reference ? ` (Ref: ${defaultAddress.reference})` : ''}`;
        savedAddressSection.classList.remove('hidden');
        noAddressSection.classList.add('hidden');
      } else if (client.address) {
        // Old format: single address string
        savedAddressText.textContent = client.address;
        savedAddressSection.classList.remove('hidden');
        noAddressSection.classList.add('hidden');
      } else {
        // No saved address
        savedAddressSection.classList.add('hidden');
        noAddressSection.classList.remove('hidden');
      }
    }

    // Confirm saved address button
    document.getElementById('confirmSavedAddress')?.addEventListener('click', () => {
      if (!currentSelectedClient) return;

      const addresses = currentSelectedClient.addresses || [];
      const defaultAddress = addresses[0];
      if (defaultAddress) {
        document.getElementById('street').value = defaultAddress.street;
        document.getElementById('number').value = defaultAddress.number;
        document.getElementById('neighborhood').value = defaultAddress.neighborhood;
        document.getElementById('reference').value = defaultAddress.reference || '';

        // Hide address form since address is already confirmed
        document.getElementById('addressForm').classList.add('hidden');
        document.getElementById('savedAddressSection').innerHTML = `
          <div class="bg-green-100 border border-green-300 rounded-lg p-2">
            <p class="text-sm text-green-800 font-medium">âœ“ EndereÃ§o confirmado!</p>
            <p class="text-xs text-green-700">${defaultAddress.street}, ${defaultAddress.number} - ${defaultAddress.neighborhood}</p>
          </div>
        `;

        // Update delivery type to delivery
        document.querySelector('input[name="delivery"][value="entrega"]').checked = true;
        updateCheckoutFeeAndTotalFast();
      }
    });

    // Use different address button
    document.getElementById('useDifferentAddress')?.addEventListener('click', () => {
      // Clear current address fields
      document.getElementById('street').value = '';
      document.getElementById('number').value = '';
      document.getElementById('neighborhood').value = '';
      document.getElementById('reference').value = '';

      // Show address form
      document.getElementById('addressForm').classList.remove('hidden');

      // Update delivery type to delivery
      document.querySelector('input[name="delivery"][value="entrega"]').checked = true;
    });

    // ===========================================
    // BIRTHDAY MODAL EVENT HANDLERS
    // ===========================================

    let pendingOrderData = null;
    let pendingWhatsAppMessage = null;

    function showBirthdayModal() {
      // Reset modal to step 1
      document.getElementById('birthdayStep1').classList.remove('hidden');
      document.getElementById('birthdayStep2').classList.add('hidden');
      document.getElementById('birthdayDateInput').value = '';
      document.getElementById('birthdayModal').classList.remove('hidden');
    }

    function hideBirthdayModal() {
      document.getElementById('birthdayModal').classList.add('hidden');
    }

    function proceedWithOrder() {
      if (!pendingOrderData || !pendingWhatsAppMessage) return;

      // Save order to Supabase
      saveOrderToSupabase(pendingOrderData);

      // Record birthday discount usage if applied
      if (pendingOrderData.birthday_discount && pendingOrderData.birthday_discount > 0 && pendingOrderData.client_phone) {
        recordBirthdayDiscountUsage(pendingOrderData.client_phone, pendingOrderData.birthday_discount, pendingOrderData.id);
      }

      // Open WhatsApp
      const number = '5573999366554';
      const url = `https://wa.me/${number}?text=${encodeURIComponent(pendingWhatsAppMessage)}`;
      window.open(url, '_blank', 'noopener,noreferrer');

      // Clear checkout
      clearCheckoutData();
      cart = [];
      updateCart();
      document.getElementById('checkoutModal').classList.add('hidden');
      hideBirthdayModal();
      showInlineMessage('publicStore', 'âœ… Pedido enviado para o WhatsApp!', 'success');

      // Clear pending data
      pendingOrderData = null;
      pendingWhatsAppMessage = null;
    }

    // Birthday Yes button - show date picker
    document.getElementById('birthdayYes')?.addEventListener('click', () => {
      document.getElementById('birthdayStep1').classList.add('hidden');
      document.getElementById('birthdayStep2').classList.remove('hidden');
    });

    // Birthday No button - send order without registration
    document.getElementById('birthdayNo')?.addEventListener('click', () => {
      proceedWithOrder();
    });

    // Save birthday and send order
    document.getElementById('saveBirthdaySend')?.addEventListener('click', async () => {
      const birthdayDate = document.getElementById('birthdayDateInput').value;
      const customerPhone = document.getElementById('customerPhone')?.value?.trim();

      if (birthdayDate && customerPhone) {
        // Find and update client
        const clientIndex = clients.findIndex(c => c.phone === customerPhone);
        if (clientIndex !== -1) {
          clients[clientIndex].birthdate = birthdayDate;
          await saveClients();
        }
      }

      proceedWithOrder();
    });

    // Fees (Fast)
    function readFastFees() { try { return JSON.parse(localStorage.getItem('fastDeliveryFees') || '{}'); } catch { return {}; } }
    function writeFastFees(m) { localStorage.setItem('fastDeliveryFees', JSON.stringify(m)); }
    function calcFastDeliveryFee(nei) {
      const n = norm(nei);
      const cfg = readFastFees();
      const val = cfg[n];
      if (val !== undefined && val !== "") {
        if (typeof val === 'number') return val;
        if (typeof val === 'object') return val.fee;
        const v = parseFloat(val);
        if (!isNaN(v)) return v;
      }
      return -1;
    }

    function getFastMinOrderValue(nei) {
      if (!nei) return 0;
      const n = norm(nei);
      const cfg = readFastFees();
      const val = cfg[n];
      if (val && typeof val === 'object' && val.min) {
        return val.min;
      }
      return 0;
    }

    // Load fees from Supabase on startup to sync between devices
    async function loadFeesFromSupabase() {
      try {
        const { data, error } = await window.supabaseClient
          .from('fast_delivery_fees')
          .select('*');

        if (error) throw error;

        if (data && data.length > 0) {
          // Verify if column exists
          const sample = data[0];
          if (sample.min_order_value === undefined) {
            console.error('CRITICAL: min_order_value column missing in DB!');
            alert('ATENÃ‡ÃƒO: A coluna "min_order_value" nÃ£o foi encontrada no banco de dados.\n\nPor favor, execute o script de migraÃ§Ã£o no Supabase SQL Editor para corrigir o erro ao salvar.');
          }

          const feesObj = {};
          data.forEach(row => {
            feesObj[row.neighborhood] = {
              fee: row.fee,
              min: row.min_order_value || 0
            };
          });
          writeFastFees(feesObj);
          console.log('Taxas carregadas do Supabase:', Object.keys(feesObj).length, 'bairros');
        }
      } catch (error) {
        console.error('Erro ao carregar taxas do Supabase (usando localStorage):', error);
      }
    }
    // Call on load
    loadFeesFromSupabase();
    function updateCheckoutFeeAndTotalFast() {
      // Recalc subtotal
      cartTotal = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
      const delivery = document.querySelector('input[name="delivery"]:checked');
      const payment = document.querySelector('input[name="payment"]:checked');
      const customerPhone = document.getElementById('customerPhone')?.value?.trim();
      let deliveryFee = 0;
      const deliveryRow = document.getElementById('deliveryFeeRowFast');

      const confirmBtn = document.getElementById('confirmOrder');
      const warningBox = document.getElementById('validationWarnings');

      if (delivery && delivery.value === 'entrega') {
        const nb = document.getElementById('neighborhood').value;
        if (nb) {
          const f = calcFastDeliveryFee(nb);
          const minOrder = getFastMinOrderValue(nb);

          if (f >= 0) {
            deliveryFee = f;
            document.getElementById('checkoutDeliveryFeeFast').textContent = `R$ ${f.toFixed(2).replace('.', ',')}`;

            if (minOrder > 0 && cartTotal < minOrder) {
              warningBox.innerHTML = `<div class='p-3 bg-red-100 border border-red-400 text-red-900 rounded-lg text-sm'>
                 Pedido mÃ­nimo para <strong>${nb}</strong> Ã© <strong>R$ ${minOrder.toFixed(2).replace('.', ',')}</strong>.<br>
                 Faltam R$ ${(minOrder - cartTotal).toFixed(2).replace('.', ',')} para liberar a entrega.
               </div>`;
              warningBox.classList.remove('hidden');
              confirmBtn.disabled = true;
              confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
              if (warningBox.innerHTML.includes('Pedido mÃ­nimo')) {
                warningBox.classList.add('hidden');
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              }
            }
          } else {
            document.getElementById('checkoutDeliveryFeeFast').textContent = 'Consulte';
          }
          deliveryRow.classList.remove('hidden');
        } else {
          deliveryRow.classList.add('hidden');
        }
      } else {
        deliveryRow.classList.add('hidden');
        if (confirmBtn.classList.contains('cursor-not-allowed')) {
          confirmBtn.disabled = false;
          confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          if (warningBox.innerHTML.includes('Pedido mÃ­nimo')) warningBox.classList.add('hidden');
        }
      }

      let cardFee = 0;
      const cardRow = document.getElementById('cardFeeRowFast');
      if (payment && payment.value === 'cartao1x') {
        cardFee = cartTotal * (storeConfig.card_fee_1x / 100);
        document.getElementById('checkoutCardFeeFast').textContent = `R$ ${cardFee.toFixed(2).replace('.', ',')}`;
        cardRow.classList.remove('hidden');
      }
      else {
        cardRow.classList.add('hidden');
      }

      // Calculate product promotions
      let productDiscount = 0;
      cart.forEach(item => {
        const promotion = promotions.find(p => p.productId === item.id);
        if (promotion) {
          if (promotion.type === 'percentage') {
            productDiscount += (item.price * item.quantity) * (promotion.value / 100);
          } else {
            productDiscount += promotion.value * item.quantity;
          }
        }
      });

      // Calculate client discount
      let clientDiscount = 0;
      if (customerPhone && clientDiscounts[customerPhone]) {
        clientDiscount = (cartTotal - productDiscount) * (clientDiscounts[customerPhone] / 100);
      }

      // Update discount rows
      const productDiscountRow = document.getElementById('productDiscountRow');
      const clientDiscountRow = document.getElementById('clientDiscountRow');

      if (productDiscount > 0) {
        if (!productDiscountRow) {
          const checkoutTotal = document.getElementById('checkoutTotal').parentElement;
          const newRow = document.createElement('div');
          newRow.id = 'productDiscountRow';
          newRow.className = 'flex justify-between text-sm mb-1 text-green-600';
          newRow.innerHTML = '<span>Desconto produtos:</span><span id="productDiscountValue">R$ 0,00</span>';
          checkoutTotal.insertBefore(newRow, checkoutTotal.querySelector('.border-t'));
        }
        document.getElementById('productDiscountValue').textContent = `R$ ${productDiscount.toFixed(2).replace('.', ',')}`;
      } else if (productDiscountRow) {
        productDiscountRow.remove();
      }

      if (clientDiscount > 0) {
        if (!clientDiscountRow) {
          const checkoutTotal = document.getElementById('checkoutTotal').parentElement;
          const newRow = document.createElement('div');
          newRow.id = 'clientDiscountRow';
          newRow.className = 'flex justify-between text-sm mb-1 text-green-600';
          newRow.innerHTML = '<span>Desconto fidelidade:</span><span id="clientDiscountValue">R$ 0,00</span>';
          checkoutTotal.insertBefore(newRow, checkoutTotal.querySelector('.border-t'));
        }
        document.getElementById('clientDiscountValue').textContent = `R$ ${clientDiscount.toFixed(2).replace('.', ',')}`;
      } else if (clientDiscountRow) {
        clientDiscountRow.remove();
      }

      const total = cartTotal + (isNaN(deliveryFee) ? 0 : deliveryFee) + cardFee - productDiscount - clientDiscount;
      document.getElementById('checkoutTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    // Fees modal UI
    function openFeesFastModal() { const modal = document.getElementById('feesModalFast'); if (modal) { modal.classList.remove('hidden'); renderFastFeesList(); } }
    function closeFeesFastModal() { const modal = document.getElementById('feesModalFast'); if (modal) { modal.classList.add('hidden'); } }
    function renderFastFeesList() { const list = document.getElementById('feesListFast'); if (!list) return; const m = readFastFees(); const entries = Object.entries(m).sort((a, b) => a[1] - b[1] || a[0].localeCompare(b[0])); list.innerHTML = entries.length ? entries.map(([k, v]) => `<div class='flex items-center justify-between py-2 border-b'><div class='flex-1'><span class='font-medium capitalize text-gray-900'>${k}</span></div><input data-k='${k}' class='w-24 px-2 py-1 border rounded text-right' value='${v}'/><button data-del='${k}' class='ml-3 text-red-600 text-sm hover:text-red-800'>Excluir</button></div>`).join('') : `<p class='text-sm text-gray-600'>Nenhum bairro cadastrado.</p>`; }
    document.getElementById('openFeesFast')?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openFeesFastModal(); });
    document.getElementById('closeFeesFast')?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); closeFeesFastModal(); });
    document.getElementById('addFeeFast')?.addEventListener('click', (e) => { e.preventDefault(); const b = document.getElementById('feeNeighborhoodFast').value.trim(); const v = parseFloat(document.getElementById('feeValueFast').value.replace(',', '.')); if (!b || isNaN(v)) { alert('Preencha bairro e valor.'); return; } const m = readFastFees(); m[norm(b)] = v; writeFastFees(m); document.getElementById('feeNeighborhoodFast').value = ''; document.getElementById('feeValueFast').value = ''; renderFastFeesList(); });
    // saveAllFeesFast listener movido para final do arquivo para incluir lÃ³gica de sincronizaÃ§Ã£o com Supabase
    document.getElementById('feesListFast')?.addEventListener('click', (e) => { if (e.target.dataset.del) { e.preventDefault(); const m = readFastFees(); delete m[e.target.dataset.del]; writeFastFees(m); renderFastFeesList(); } });
    document.getElementById('feesListFast')?.addEventListener('change', (e) => { if (e.target.dataset.k) { const m = readFastFees(); const val = parseFloat(e.target.value.replace(',', '.')); if (!isNaN(val)) { m[e.target.dataset.k] = val; writeFastFees(m); } } });

    // Panel Navigation (Fast Admin)
    function showPanel(panelName) {
      const panels = ['productsPanelFast', 'clientsPanelFast', 'promotionsPanelFast', 'configPanelFast', 'reportsPanelFast', 'ordersPanelFast'];
      panels.forEach(p => {
        const el = document.getElementById(p);
        if (el) el.classList.toggle('hidden', p !== panelName);
      });
      // Auto-load orders when opening orders panel
      if (panelName === 'ordersPanelFast') {
        loadDashboardOrders();
      }
    }

    // ========================================
    // ORDER DASHBOARD MANAGEMENT
    // ========================================
    const ORDER_STATUS = {
      PENDING: 'pending',
      PREPARING: 'preparing',
      CONFIRMED: 'confirmed',
      DELIVERED: 'delivered',
      CANCELLED: 'cancelled'
    };

    const STATUS_LABELS = {
      'pending': { emoji: 'ğŸ†•', label: 'Recebido', color: 'blue' },
      'accepted': { emoji: 'âœ…', label: 'Aceito', color: 'purple' },
      'preparing': { emoji: 'ğŸ³', label: 'Em Preparo', color: 'yellow' },
      'confirmed': { emoji: 'âœ…', label: 'Pronto', color: 'green' },
      'delivered': { emoji: 'âœ”ï¸', label: 'Entregue', color: 'gray' },
      'cancelled': { emoji: 'âŒ', label: 'Cancelado', color: 'red' }
    };

    const PAYMENT_STATUS_LABELS = {
      'pending': { emoji: 'â³', label: 'Pendente', color: 'gray' },
      'awaiting_payment': { emoji: 'ğŸ’³', label: 'Aguardando Pgto', color: 'yellow' },
      'paid_partial': { emoji: 'ğŸ’°', label: 'Entrada Paga (50%)', color: 'orange' },
      'paid_full': { emoji: 'âœ…', label: 'Pago Total', color: 'green' },
      'cash': { emoji: 'ğŸ’µ', label: 'Dinheiro', color: 'green' },
      'pix': { emoji: 'ğŸ“±', label: 'PIX', color: 'green' }
    };

    async function loadDashboardOrders() {
      const container = document.getElementById('ordersListContainer');
      const dateFilter = document.getElementById('ordersFilterDate')?.value || 'today';
      const statusFilter = document.getElementById('ordersFilterStatus')?.value || 'all';

      try {
        // Calculate date range
        const now = new Date();
        let startDate, endDate;

        if (dateFilter === 'today') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
        } else if (dateFilter === 'yesterday') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).toISOString();
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        } else {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7).toISOString();
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
        }

        // Fetch from Supabase
        let query = window.supabaseClient
          .from('fast_orders')
          .select('*')
          .gte('created_at', startDate)
          .lt('created_at', endDate)
          .order('created_at', { ascending: false });

        if (statusFilter !== 'all') {
          query = query.eq('status', statusFilter);
        }

        const { data: orders, error } = await query;
        if (error) throw error;

        // Update stats
        updateOrderStats(orders || []);

        // Render orders
        renderDashboardOrders(orders || []);

      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        container.innerHTML = `<div class="text-center py-8 text-red-500">
          <p class="text-4xl mb-2">âš ï¸</p>
          <p>Erro ao carregar pedidos. Verifique o console.</p>
        </div>`;
      }
    }

    function updateOrderStats(orders) {
      const counts = {
        pending: 0, preparing: 0, confirmed: 0,
        delivered: 0, cancelled: 0
      };

      orders.forEach(o => {
        if (counts[o.status] !== undefined) counts[o.status]++;
      });

      document.getElementById('ordersCountNew').textContent = counts.pending;
      document.getElementById('ordersCountPreparing').textContent = counts.preparing;
      document.getElementById('ordersCountReady').textContent = counts.confirmed;
      document.getElementById('ordersCountDelivery').textContent = 0;
      document.getElementById('ordersCountDelivered').textContent = counts.delivered;
      document.getElementById('ordersCountCanceled').textContent = counts.cancelled;
    }

    function renderDashboardOrders(orders) {
      const container = document.getElementById('ordersListContainer');

      if (orders.length === 0) {
        container.innerHTML = `<div class="text-center py-12 text-gray-500">
          <p class="text-5xl mb-3">ğŸ“¦</p>
          <p class="font-medium">Nenhum pedido encontrado</p>
          <p class="text-sm">Os pedidos aparecerÃ£o aqui quando forem feitos.</p>
        </div>`;
        return;
      }

      container.innerHTML = orders.map(order => {
        const status = STATUS_LABELS[order.status] || STATUS_LABELS.pending;
        const time = new Date(order.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const date = new Date(order.created_at).toLocaleDateString('pt-BR');
        const items = order.items || [];
        const itemsSummary = items.slice(0, 3).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const moreItems = items.length > 3 ? ` +${items.length - 3}` : '';
        const deliveryType = order.delivery_type === 'entrega' ? 'ğŸšš Entrega' : 'ğŸª Retirada';
        const address = order.address ? `${order.address.street}, ${order.address.number} - ${order.address.neighborhood}` : '';
        
        // Payment info
        const isCardPayment = order.payment_method === 'cartao1x' || order.payment_method === 'cartao2x' || order.payment_method === 'card_stripe';
        const paymentMethod = order.payment_method === 'cartao1x' ? 'ğŸ’³ CartÃ£o 1x' : 
                              order.payment_method === 'cartao2x' ? 'ğŸ’³ CartÃ£o 1x' : 
                              order.payment_method === 'pix' ? 'ğŸ“± PIX' : 
                              order.payment_method === 'dinheiro' ? 'ğŸ’µ Dinheiro' : 'â³ Pendente';
        const paymentStatus = PAYMENT_STATUS_LABELS[order.payment_status] || PAYMENT_STATUS_LABELS.pending;
        const needsAcceptance = isCardPayment && order.status === 'pending' && !order.payment_link;
        const awaitingPayment = isCardPayment && order.payment_status === 'awaiting_payment';
        const partiallyPaid = order.payment_status === 'paid_partial';

        return `
          <div class="bg-white border rounded-lg p-4 shadow-sm ${isCardPayment ? 'border-l-4 border-l-purple-500' : ''}">
            <div class="flex flex-wrap items-start justify-between gap-2 mb-3">
              <div>
                <p class="text-sm text-gray-500">${date} Ã s ${time}</p>
                <p class="font-semibold text-gray-800">${order.client_name || 'Cliente'}</p>
                <p class="text-sm text-gray-600">ğŸ“± ${order.client_phone || '-'}</p>
              </div>
              <div class="text-right">
                <span class="inline-block px-2 py-1 rounded text-sm bg-${status.color}-100 text-${status.color}-800">
                  ${status.emoji} ${status.label}
                </span>
                <p class="text-lg font-bold text-rose-600 mt-1">R$ ${(order.total || 0).toFixed(2).replace('.', ',')}</p>
              </div>
            </div>
            
            <div class="text-sm text-gray-700 mb-3">
              <p><strong>Itens:</strong> ${itemsSummary}${moreItems}</p>
              <p><strong>Tipo:</strong> ${deliveryType}</p>
              ${address ? `<p><strong>EndereÃ§o:</strong> ${address}</p>` : ''}
              ${order.scheduled_date ? `<p><strong>ğŸ“… Encomenda:</strong> ${order.scheduled_date}</p>` : ''}
              <p><strong>Pagamento:</strong> ${paymentMethod} 
                ${isCardPayment ? `<span class="inline-block px-2 py-0.5 rounded text-xs bg-${paymentStatus.color}-100 text-${paymentStatus.color}-800 ml-1">${paymentStatus.emoji} ${paymentStatus.label}</span>` : ''}
              </p>
              ${partiallyPaid ? `<p class="text-orange-600 font-medium">âš ï¸ Falta pagar restante na entrega/retirada</p>` : ''}
              ${order.payment_link ? `<p class="text-xs text-purple-600 truncate"><strong>Link:</strong> <a href="${order.payment_link}" target="_blank" class="underline">${order.payment_link}</a></p>` : ''}
            </div>
            
            <div class="flex flex-wrap gap-2">
              ${needsAcceptance ? `
                <button id="acceptBtn_${order.id}" onclick="acceptCardOrder(${order.id})" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm font-medium">ğŸ’³ Aceitar & Enviar Link</button>
              ` : ''}
              ${order.status === 'pending' && !needsAcceptance ? `
                <button onclick="updateOrderStatus(${order.id}, 'preparing')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">ğŸ³ Preparar</button>
              ` : ''}
              ${order.status === 'accepted' ? `
                <button onclick="updateOrderStatus(${order.id}, 'preparing')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">ğŸ³ Preparar</button>
              ` : ''}
              ${order.status === 'preparing' ? `
                <button onclick="updateOrderStatus(${order.id}, 'confirmed')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">âœ… Pronto</button>
              ` : ''}
              ${order.status === 'confirmed' && order.delivery_type === 'entrega' ? `
                <button onclick="updateOrderStatus(${order.id}, 'out_for_delivery')" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm">ğŸšš Saiu</button>
              ` : ''}
              ${(order.status === 'confirmed' || order.status === 'out_for_delivery') && order.delivery_type !== 'entrega' ? `
                <button onclick="updateOrderStatus(${order.id}, 'delivered')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">âœ”ï¸ Entregue</button>
              ` : ''}
              ${order.status === 'out_for_delivery' ? `
                <button onclick="updateOrderStatus(${order.id}, 'delivered')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">âœ”ï¸ Entregue</button>
              ` : ''}
              ${order.status !== 'delivered' && order.status !== 'cancelled' ? `
                <button onclick="updateOrderStatus(${order.id}, 'cancelled')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded text-sm">âŒ Cancelar</button>
              ` : ''}
              <button onclick="openWhatsAppForOrder('${order.client_phone}')" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded text-sm">ğŸ“± WhatsApp</button>
              <button onclick="prepareOrderUpdate('${order.id}')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded text-sm">ğŸ’¬ Enviar AtualizaÃ§Ã£o</button>
            </div>
          </div>
          `;
      }).join('');
    }

    async function updateOrderStatus(orderId, newStatus) {
      try {
        // ValidaÃ§Ã£o para entrega: sÃ³ permite se pagamento completo para cartÃ£o
        if (newStatus === 'delivered') {
          const { data: order } = await window.supabaseClient
            .from('fast_orders')
            .select('payment_method, payment_status')
            .eq('id', orderId)
            .single();
          
          if (order && (order.payment_method === 'cartao1x' || order.payment_method === 'cartao2x' || order.payment_method === 'card_stripe')) {
            if (order.payment_status !== 'paid_full') {
              alert('âš ï¸ Pagamento em cartÃ£o nÃ£o estÃ¡ completo!\nO cliente precisa pagar 100% antes de marcar como entregue.');
              return;
            }
          }
        }

        const { error } = await window.supabaseClient
          .from('fast_orders')
          .update({ status: newStatus })
          .eq('id', orderId);

        if (error) throw error;
        loadDashboardOrders(); // Refresh list
      } catch (error) {
        console.error('Erro ao atualizar status:', error);
        alert('Erro ao atualizar status do pedido.');
      }
    }

    // ========================================
    // STRIPE PAYMENT SERVICE
    // ========================================
    function getStripeServerBaseUrl() {
      try {
        const hostname = location.hostname;
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1';
        const isPrivateIP = /^(10\.|172\.(1[6-9]|2\d|3[01])\.|192\.168\.)/.test(hostname);
        if (isLocal || isPrivateIP) return 'http://localhost:3001';
      } catch (e) {}
      try {
        return localStorage.getItem('fastStripeServerUrl') || 'https://fastsavorys.onrender.com';
      } catch (e2) {
        return 'https://fastsavorys.onrender.com';
      }
    }

    const StripeService = {
      config: null,
      
      async loadConfig() {
        try {
          const { data, error } = await window.supabaseClient
            .from('fast_stripe_config')
            .select('*')
            .eq('store_id', 1)
            .single();
          
          if (error) throw error;
          this.config = data || null;
          
          if (!this.config) {
            console.warn('[Stripe] Config nÃ£o encontrada (store_id=1).');
          } else {
            console.log('[Stripe] Config carregada do Supabase:', {
              enabled: this.config.enabled,
              min_payment_percent: this.config.min_payment_percent,
              has_public_key: !!this.config.stripe_public_key
            });
          }
          
          return this.config;
        } catch (e) {
          console.warn('[Stripe] Erro ao carregar config do Supabase:', e);
          this.config = null;
          return null;
        }
      },
      
      async saveConfig(config) {
        try {
          const { error } = await window.supabaseClient
            .from('fast_stripe_config')
            .upsert({ ...config, store_id: 1, updated_at: new Date().toISOString() }, { onConflict: 'store_id' });
          
          if (error) throw error;
          this.config = config;
          return true;
        } catch (e) {
          console.error('[Stripe] Erro ao salvar config:', e);
          return false;
        }
      },
      
      // Gera saudaÃ§Ã£o dinÃ¢mica baseada no horÃ¡rio
      getGreeting() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'Bom dia';
        if (hour >= 12 && hour < 18) return 'Boa tarde';
        return 'Boa noite';
      },
      
      // Gera mensagem de pagamento para WhatsApp
      generatePaymentMessage(order, paymentLink) {
        const greeting = this.getGreeting();
        const firstName = MsgTemplateService.getFirstName(order.client_name);
        
        return `${greeting}, ${firstName}! ğŸ‰

Seu pedido #${order.id} foi *ACEITO* pela Fast Savory's!

Para confirmar sua encomenda, realize o pagamento pelo link abaixo:
${paymentLink}

ApÃ³s a confirmaÃ§Ã£o do pagamento, seu pedido serÃ¡ preparado com muito carinho! ğŸ¥Ÿ

*Valor total:* R$ ${(order.total || 0).toFixed(2).replace('.', ',')}

Obrigado pela preferÃªncia! â¤ï¸`;
      },
      
      // Gera Checkout Session do Stripe usando servidor local
      async generatePaymentLink(order) {
        if (!this.config || !this.config.enabled) {
          console.warn('[Stripe] Stripe nÃ£o configurado ou desabilitado (Supabase). Tentando gerar link via servidor local mesmo assim...');
        }
        
        try {
          console.log('[Stripe] Gerando link para pedido:', order.id);

          const baseUrl = getStripeServerBaseUrl();
          if (!baseUrl) {
            throw new Error('Stripe server URL nÃ£o configurada. Defina localStorage.fastStripeServerUrl em produÃ§Ã£o.');
          }
          
          const response = await fetch(baseUrl + '/create-checkout-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderId: order.id,
              amount: order.total,
              customerEmail: order.client_email || '',
              customerName: order.client_name
            })
          });
          
          if (!response.ok) {
            const error = await response.json().catch(function() { return {}; });
            throw new Error(error.error || 'Erro ao gerar link');
          }
          
          const data = await response.json();
          console.log('[Stripe] Link gerado com sucesso:', data.url);
          
          return data.url;
        } catch (error) {
          console.error('[Stripe] Erro ao gerar link:', error);
          // Fallback para modo de teste
          return `https://buy.stripe.com/test_order_${order.id}`;
        }
      }
    };

    // Aceitar pedido com cartÃ£o e gerar link de pagamento
    async function acceptCardOrder(orderId) {
      const btn = document.getElementById(`acceptBtn_${orderId}`);
      const originalText = btn ? btn.innerHTML : '';
      
      try {
        // Mostrar loading no botÃ£o
        if (btn) {
          btn.innerHTML = 'â³ Gerando link...';
          btn.disabled = true;
          btn.classList.add('opacity-75', 'cursor-wait');
        }
        
        // Busca dados completos do pedido
        const { data: order, error: fetchError } = await window.supabaseClient
          .from('fast_orders')
          .select('*')
          .eq('id', orderId)
          .single();
        
        if (fetchError || !order) {
          alert('Erro ao buscar pedido');
          return;
        }
        
        // Carrega config do Stripe se necessÃ¡rio
        if (!StripeService.config) {
          await StripeService.loadConfig();
        }
        
        // Gera o link de pagamento
        const paymentLink = await StripeService.generatePaymentLink(order);
        
        // Atualiza o pedido com o link de pagamento
        const { error: updateError } = await window.supabaseClient
          .from('fast_orders')
          .update({
            status: 'accepted',
            payment_status: 'awaiting_payment',
            payment_link: paymentLink,
            accepted_at: new Date().toISOString()
          })
          .eq('id', orderId);
        
        if (updateError) throw updateError;
        
        // Gera mensagem para WhatsApp
        const message = StripeService.generatePaymentMessage(order, paymentLink);
        
        // Abre WhatsApp com a mensagem
        if (order.client_phone) {
          const cleanPhone = order.client_phone.replace(/\D/g, '');
          const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`;
          window.open(url, '_blank');
        }
        
        // Atualiza a lista de pedidos
        loadDashboardOrders();
        
      } catch (error) {
        console.error('Erro ao aceitar pedido:', error);
        alert('Erro ao aceitar pedido: ' + error.message);
      } finally {
        // Restaurar botÃ£o ao estado original
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          btn.classList.remove('opacity-75', 'cursor-wait');
        }
      }
    }

    // Marcar pagamento como recebido (parcial ou total)
    async function markPaymentReceived(orderId, paymentType) {
      try {
        const { data: order } = await window.supabaseClient
          .from('fast_orders')
          .select('total, amount_paid')
          .eq('id', orderId)
          .single();
        
        const updateData = {
          payment_status: paymentType === 'full' ? 'paid_full' : 'paid_partial',
          amount_paid: paymentType === 'full' ? order.total : (order.total * 0.5)
        };
        
        const { error } = await window.supabaseClient
          .from('fast_orders')
          .update(updateData)
          .eq('id', orderId);
        
        if (error) throw error;
        
        alert(paymentType === 'full' ? 'âœ… Pagamento total registrado!' : 'âœ… Entrada de 50% registrada!');
        loadDashboardOrders();
      } catch (error) {
        console.error('Erro ao registrar pagamento:', error);
        alert('Erro ao registrar pagamento');
      }
    }

    function openWhatsAppForOrder(phone) {
      if (!phone) return;
      const cleanPhone = phone.replace(/\D/g, '');
      const url = `https://wa.me/55${cleanPhone}`;
      window.open(url, '_blank');
    }

    async function deleteTestOrders() {
      try {
        const ok1 = confirm('âš ï¸ ATENÃ‡ÃƒO!\n\nIsso vai EXCLUIR pedidos do Supabase e pode ser irreversÃ­vel.\n\nDeseja continuar?');
        if (!ok1) return;

        const fromDate = prompt('Opcional: apagar pedidos a partir de qual data?\nFormato: AAAA-MM-DD\n\nDeixe vazio para apagar TODOS os pedidos.');
        const ok2 = prompt('Para confirmar, digite APAGAR');
        if (ok2 !== 'APAGAR') {
          alert('OperaÃ§Ã£o cancelada.');
          return;
        }

        let query = window.supabaseClient.from('fast_orders').delete();
        if (fromDate && /^\d{4}-\d{2}-\d{2}$/.test(fromDate)) {
          query = query.gte('created_at', `${fromDate}T00:00:00.000Z`);
        } else {
          // Supabase exige filtro no delete; usa um filtro neutro
          query = query.neq('id', 0);
        }

        const { error } = await query;
        if (error) throw error;

        // Limpa cache local usado como fallback de pedidos
        try { localStorage.removeItem('fastOrders'); } catch (e) {}

        // Recarrega listas
        await loadOrders().catch(function() {});
        try { renderReportsData(); } catch (e) {}
        try { loadDashboardOrders(); } catch (e) {}

        alert('âœ… Pedidos apagados com sucesso.');
      } catch (e) {
        console.error('Erro ao excluir pedidos:', e);
        alert('âŒ Erro ao excluir pedidos.');
      }
    }

    // Order filters events
    document.getElementById('ordersFilterDate')?.addEventListener('change', loadDashboardOrders);
    document.getElementById('ordersFilterStatus')?.addEventListener('change', loadDashboardOrders);
    document.getElementById('refreshOrders')?.addEventListener('click', loadDashboardOrders);
    document.getElementById('deleteTestOrdersBtn')?.addEventListener('click', deleteTestOrders);

    // Desktop buttons
    document.getElementById('showProductsPanelFast')?.addEventListener('click', () => {
      showPanel('productsPanelFast');
    });
    document.getElementById('showClientsPanelFast')?.addEventListener('click', () => {
      showPanel('clientsPanelFast');
      renderClients();
      updateClientDiscountSelect();
    });
    document.getElementById('showPromotionsPanelFast')?.addEventListener('click', () => {
      showPanel('promotionsPanelFast');
      renderPromotions();
      updatePromotionProductSelect();
      updateClientDiscountSelect();
      renderCoupons();
    });
    document.getElementById('showReportsPanelFast')?.addEventListener('click', async () => {
      showPanel('reportsPanelFast');
      await loadOrders();
      renderReportsData();
    });
    document.getElementById('showConfigPanelFast')?.addEventListener('click', () => {
      showPanel('configPanelFast');
      renderUsers();
      renderFastFeesListPanel();
    });
    document.getElementById('showOrdersPanelFast')?.addEventListener('click', () => {
      showPanel('ordersPanelFast');
    });

    // Mobile buttons - same actions
    document.getElementById('showProductsPanelFastMobile')?.addEventListener('click', () => {
      showPanel('productsPanelFast');
    });
    document.getElementById('showClientsPanelFastMobile')?.addEventListener('click', () => {
      showPanel('clientsPanelFast');
      renderClients();
      updateClientDiscountSelect();
    });
    document.getElementById('showPromotionsPanelFastMobile')?.addEventListener('click', () => {
      showPanel('promotionsPanelFast');
      renderPromotions();
      updatePromotionProductSelect();
      updateClientDiscountSelect();
      renderCoupons();
    });
    document.getElementById('showReportsPanelFastMobile')?.addEventListener('click', async () => {
      showPanel('reportsPanelFast');
      await loadOrders();
      renderReportsData();
    });
    document.getElementById('showConfigPanelFastMobile')?.addEventListener('click', () => {
      showPanel('configPanelFast');
      renderUsers();
      renderFastFeesListPanel();
    });
    document.getElementById('showOrdersPanelFastMobile')?.addEventListener('click', () => {
      showPanel('ordersPanelFast');
    });
    document.getElementById('goToStoreMobile')?.addEventListener('click', () => showPublicStore());
    document.getElementById('logoutBtnMobile')?.addEventListener('click', () => { isAdmin = false; sessionStorage.removeItem('fastAdmin'); sessionStorage.removeItem('fastRole'); showLoginModal(); });

    // Mobile close store button
    document.getElementById('closeStoreTodayMobile')?.addEventListener('click', () => {
      document.getElementById('closeStoreToday')?.click();
    });

    // Helper function to show inline messages instead of alerts
    function showInlineMessage(containerId, message, type = 'success') {
      const container = document.getElementById(containerId);
      if (!container) return;

      const msgDiv = document.createElement('div');
      msgDiv.className = `p-3 rounded-lg text-sm font-medium mb-3 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      msgDiv.textContent = message;
      container.insertBefore(msgDiv, container.firstChild);

      // Auto-remove after 4 seconds
      setTimeout(() => msgDiv.remove(), 4000);
    }

    // Salvar todas as taxas do painel de configuraÃ§Ãµes
    document.getElementById('saveAllFeesFastPanel')?.addEventListener('click', async () => {
      try {
        const fees = readFastFees();
        // Tentar salvar no Supabase
        if (window.supabaseClient) {
          const rows = Object.entries(fees).map(([neighborhood, entry]) => {
            let feeValue = entry;
            let minValue = 0;
            if (entry && typeof entry === 'object') {
              feeValue = entry.fee;
              minValue = entry.min || 0;
            }
            feeValue = parseFloat(String(feeValue).replace(',', '.'));
            minValue = parseFloat(String(minValue).replace(',', '.'));
            if (isNaN(feeValue)) feeValue = 0;
            if (isNaN(minValue)) minValue = 0;
            return { neighborhood, fee: feeValue, min_order_value: minValue };
          });

          let { error } = await window.supabaseClient
            .from('fast_delivery_fees')
            .upsert(rows, { onConflict: 'neighborhood' });

          if (error && String(error.message || '').includes('min_order_value')) {
            const rowsWithoutMin = rows.map(r => ({ neighborhood: r.neighborhood, fee: r.fee }));
            ({ error } = await window.supabaseClient
              .from('fast_delivery_fees')
              .upsert(rowsWithoutMin, { onConflict: 'neighborhood' }));
          }

          if (error) throw error;
        }
        // Sempre salva no localStorage tambÃ©m
        writeFastFees(fees);
        if (window.supabaseClient) {
          await loadFeesFromSupabase();
        }
        showInlineMessage('feesListFastPanel', 'âœ… Taxas sincronizadas com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao salvar taxas:', error);
        showInlineMessage('feesListFastPanel', `âŒ Taxas salvas apenas no aparelho (falha ao sincronizar). ${error?.message ? 'Detalhe: ' + error.message : ''}`, 'error');
      }
    });

    // Store status sync via Supabase
    let storeIsClosed = false;
    let closeStoreConfirmShown = false;

    async function loadStoreStatus() {
      try {
        const today = formatYYYYMMDD(getBrasiliaDate());
        const { data, error } = await window.supabaseClient
          .from('fast_store_status')
          .select('*')
          .eq('date', today)
          .maybeSingle(); // Use maybeSingle instead of single to avoid 406 error

        if (error) throw error;

        if (data && data.is_closed) {
          storeIsClosed = true;
        } else {
          // Check localStorage as fallback
          const manuallyClosed = localStorage.getItem('fastManuallyClosed');
          const todayStr = getBrasiliaDate().toDateString();
          storeIsClosed = manuallyClosed === todayStr;
        }
      } catch (error) {
        // Table might not exist yet, use localStorage fallback
        console.log('Store status: using localStorage fallback');
        const manuallyClosed = localStorage.getItem('fastManuallyClosed');
        const todayStr = getBrasiliaDate().toDateString();
        storeIsClosed = manuallyClosed === todayStr;
      }
      updateStoreButton();
    }

    async function toggleStoreStatus() {
      const today = formatYYYYMMDD(getBrasiliaDate());
      const todayStr = getBrasiliaDate().toDateString();

      try {
        if (storeIsClosed) {
          // Open store
          await window.supabaseClient
            .from('fast_store_status')
            .delete()
            .eq('date', today);
          localStorage.removeItem('fastManuallyClosed');
          storeIsClosed = false;
        } else {
          // Close store
          await window.supabaseClient
            .from('fast_store_status')
            .upsert({ date: today, is_closed: true }, { onConflict: 'date' });
          localStorage.setItem('fastManuallyClosed', todayStr);
          storeIsClosed = true;
        }
      } catch (error) {
        console.error('Erro ao sincronizar status da loja:', error);
        // Fallback to localStorage
        if (storeIsClosed) {
          localStorage.removeItem('fastManuallyClosed');
          storeIsClosed = false;
        } else {
          localStorage.setItem('fastManuallyClosed', todayStr);
          storeIsClosed = true;
        }
      }

      updateStoreButton();
      updateOpenNotice();
    }

    function updateStoreButton() {
      const btn = document.getElementById('closeStoreToday');
      if (!btn) return;

      if (storeIsClosed) {
        btn.textContent = 'Abrir';
        btn.classList.remove('bg-red-600', 'bg-orange-500', 'bg-gray-500');
        btn.classList.add('bg-green-600');
        btn.disabled = false;
      } else {
        btn.textContent = 'Fechar';
        btn.classList.remove('bg-green-600', 'bg-orange-500', 'bg-gray-500');
        btn.classList.add('bg-red-600');
        btn.disabled = false;
      }
      closeStoreConfirmShown = false;
    }

    document.getElementById('closeStoreToday')?.addEventListener('click', () => {
      if (!closeStoreConfirmShown) {
        // Show confirmation inline
        const btn = document.getElementById('closeStoreToday');
        btn.textContent = storeIsClosed ? 'Confirmar Abrir?' : 'Confirmar Fechar?';
        btn.classList.remove('bg-red-600', 'bg-green-600');
        btn.classList.add('bg-orange-500', 'animate-pulse');
        closeStoreConfirmShown = true;

        // Auto-reset after 3 seconds if not confirmed
        setTimeout(() => {
          if (closeStoreConfirmShown) {
            updateStoreButton();
          }
        }, 3000);
      } else {
        // Confirmed - toggle store status
        toggleStoreStatus();
      }
    });

    // Load store status on init
    loadStoreStatus();

    // Welcome Screen - Enter buttons (desktop and mobile)
    document.getElementById('enterStoreBtn')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.add('hidden');
      sessionStorage.setItem('fastWelcomeSeen', 'true');
    });
    document.getElementById('enterStoreBtnMobile')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.add('hidden');
      sessionStorage.setItem('fastWelcomeSeen', 'true');
    });

    // Public Store Logo - Click to return to welcome screen
    document.getElementById('publicStoreLogo')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.remove('hidden');
      sessionStorage.removeItem('fastWelcomeSeen');
    });

    // Check if welcome was already seen in this session
    if (sessionStorage.getItem('fastWelcomeSeen') === 'true') {
      document.getElementById('welcomeScreen')?.classList.add('hidden');
    }

    // Evento para salvar novo endereÃ§o
    document.getElementById('saveNewAddress')?.addEventListener('click', saveNewAddress);

    // Seed default fees for Fast (same as Imperio)
    function seedDefaultFastFees() {
      const existing = readFastFees();
      if (Object.keys(existing).length > 0) return;
      const defaults = {
        'novo prado': 0, 'sao domingos': 0, 'cristo redentor': 0, 'baixa fria': 0,
        'varzea alegre': 2, 'sao bernardo': 2, 'santo antonio': 2, 'canaa': 2, 'centro': 2, 'fatima': 2, '31 de marco': 2, 'bnh': 2, 'vale do jucurucu': 2, 'jaqueira': 2, 'cidade baixa': 2,
        'marotinho': 3, 'corujao': 3, 'primavera': 3, 'bela vista': 3, 'vista bela': 3, 'liberdade': 3, 'urbis 2': 3, 'urbis 3': 3, 'italage': 3,
        'portal do monte': 4, 'alvorada': 4, 'monte pescoco': 4, 'tarcizao': 4, 'vista da pedra': 4, 'village das pedras': 4, 'itatiaia': 4, 'furlan': 4
      };
      writeFastFees(defaults);
    }
    seedDefaultFastFees();

    // Fees Panel Functions (Fast Admin)
    // Fees Panel Functions (Fast Admin)
    function renderFastFeesListPanel() {
      const list = document.getElementById('feesListFastPanel');
      if (!list) return;
      const m = readFastFees();
      const entries = Object.entries(m).sort((a, b) => {
        const feeA = typeof a[1] === 'object' ? a[1].fee : a[1];
        const feeB = typeof b[1] === 'object' ? b[1].fee : b[1];
        return feeA - feeB || a[0].localeCompare(b[0]);
      });

      list.innerHTML = entries.length ? entries.map(([k, v]) => {
        const fee = typeof v === 'object' ? v.fee : v;
        const min = typeof v === 'object' ? (v.min || 0) : 0;

        return `<div class='py-3 border-b'>
          <div class='mb-2'>
            <span class='font-medium capitalize text-lg text-gray-900'>${k}</span>
          </div>
          <div class="flex flex-wrap items-end gap-2">
            <div class="flex flex-col">
              <span class="text-xs text-gray-500">Taxa</span>
              <input data-k='${k}' data-type="fee" class='w-24 px-3 py-2 border rounded text-right text-lg' value='${fee}'/>
            </div>
            <div class="flex flex-col">
              <span class="text-xs text-gray-500">A partir de</span>
              <input data-k='${k}' data-type="min" class='w-28 px-3 py-2 border rounded text-right text-lg' value='${min}'/>
            </div>
            <button data-del='${k}' class='bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded h-[42px]'>Excluir</button>
          </div>
        </div>`;
      }).join('') : `<p class='text-gray-600 py-4'>Nenhum bairro cadastrado.</p>`;
    }

    document.getElementById('addFeeFastPanel')?.addEventListener('click', () => {
      const b = document.getElementById('feeNeighborhoodFastPanel').value.trim();
      const v = parseFloat(document.getElementById('feeValueFastPanel').value.replace(',', '.'));
      const min = parseFloat(document.getElementById('feeMinValueFastPanel').value.replace(',', '.')) || 0;

      if (!b || isNaN(v)) { alert('Preencha bairro e valor da taxa.'); return; }

      const m = readFastFees();
      m[norm(b)] = { fee: v, min: min };
      writeFastFees(m);

      document.getElementById('feeNeighborhoodFastPanel').value = '';
      document.getElementById('feeValueFastPanel').value = '';
      document.getElementById('feeMinValueFastPanel').value = '';
      renderFastFeesListPanel();
    });

    document.getElementById('feesListFastPanel')?.addEventListener('click', (e) => {
      if (e.target.dataset.del) {
        const m = readFastFees();
        delete m[e.target.dataset.del];
        writeFastFees(m);
        renderFastFeesListPanel();
      }
    });

    document.getElementById('feesListFastPanel')?.addEventListener('change', (e) => {
      if (e.target.dataset.k) {
        const m = readFastFees();
        const key = e.target.dataset.k;
        const type = e.target.dataset.type; // 'fee' or 'min'
        const val = parseFloat(e.target.value.replace(',', '.'));

        if (!isNaN(val)) {
          // Ensure object structure
          if (typeof m[key] !== 'object') {
            m[key] = { fee: m[key], min: 0 };
          }

          if (type === 'fee') m[key].fee = val;
          if (type === 'min') m[key].min = val;

          writeFastFees(m);
        }
      }
    });

    // Batch update buttons
    document.getElementById('batchUpdateMin')?.addEventListener('click', () => {
      const minVal = parseFloat(prompt('Digite o valor mÃ­nimo para aplicar a TODOS os bairros listados:', '0'));
      if (isNaN(minVal)) return;

      const m = readFastFees();
      Object.keys(m).forEach(k => {
        if (typeof m[k] !== 'object') m[k] = { fee: m[k], min: 0 };
        m[k].min = minVal;
      });
      writeFastFees(m);
      renderFastFeesListPanel();
      alert('Valores atualizados com sucesso!');
    });

    const toggleLogin = document.getElementById('toggleLoginPass'); if (toggleLogin) { toggleLogin.addEventListener('click', () => { const i = document.getElementById('loginPass'); i.type = i.type === 'password' ? 'text' : 'password'; }); }
    const toggleUser = document.getElementById('toggleUserPass'); if (toggleUser) { toggleUser.addEventListener('click', () => { const i = document.getElementById('userPass'); i.type = i.type === 'password' ? 'text' : 'password'; }); }

    document.getElementById('adminLoginBtn')?.addEventListener('click', () => showLoginModal());
    document.getElementById('adminLoginBtnDesktop')?.addEventListener('click', () => showLoginModal());
    document.getElementById('publicStoreLogoDesktop')?.addEventListener('click', () => {
      document.getElementById('welcomeScreen').classList.remove('hidden');
      sessionStorage.removeItem('fastWelcomeSeen');
    });

    // Store Config Event Listeners
    document.getElementById('saveCardFees')?.addEventListener('click', async () => {
      storeConfig.card_fee_1x = parseFloat(document.getElementById('cardFee1x').value) || 5;
      storeConfig.card_fee_2x = storeConfig.card_fee_1x;
      const success = await saveStoreConfig();
      if (success) {
        updateCardFeeLabels(); // Update labels immediately
        showInlineMessage('configPanelFast', 'âœ… Taxas de cartÃ£o salvas!', 'success');
      } else {
        showInlineMessage('configPanelFast', 'âŒ Erro ao salvar taxas.', 'error');
      }
    });

    document.getElementById('saveBusinessHours')?.addEventListener('click', async () => {
      const success = await saveBusinessHours();
      if (success) {
        showInlineMessage('configPanelFast', 'âœ… HorÃ¡rios salvos! O site serÃ¡ atualizado.', 'success');
        updateOpenNotice();
      } else {
        showInlineMessage('configPanelFast', 'âŒ Erro ao salvar horÃ¡rios.', 'error');
      }
    });

    document.getElementById('deliveryEnabled')?.addEventListener('change', (e) => {
      const reasonBox = document.getElementById('deliveryDisabledReasonBox');
      if (reasonBox) {
        reasonBox.classList.toggle('hidden', e.target.checked);
      }
    });

    // Save Delivery Settings (including time estimates)
    document.getElementById('saveDeliverySettings')?.addEventListener('click', async () => {
      const enabled = document.getElementById('deliveryEnabled').checked;
      const reason = document.getElementById('deliveryDisabledReason').value.trim();

      storeConfig.delivery_enabled = enabled;
      storeConfig.delivery_disabled_reason = reason;

      // Time Estimates
      storeConfig.prep_time_min = parseInt(document.getElementById('prepTimeMin').value) || 0;
      storeConfig.prep_time_max = parseInt(document.getElementById('prepTimeMax').value) || 0;
      storeConfig.delivery_time_min = parseInt(document.getElementById('deliveryTimeMin').value) || 0;
      storeConfig.delivery_time_max = parseInt(document.getElementById('deliveryTimeMax').value) || 0;

      const success = await saveStoreConfig();
      if (success) {
        showInlineMessage('configPanelFast', 'âœ… ConfiguraÃ§Ã£o de entrega salva!', 'success');
        updateOpenNotice();
      } else {
        showInlineMessage('configPanelFast', 'âŒ Erro ao salvar.', 'error');
      }
    });

    // ========================================
    // MESSAGE TEMPLATES SERVICE
    // ========================================
    const MsgTemplateService = {
      // Mapeamento entre status do banco (inglÃªs) e chaves dos templates (portuguÃªs)
      statusMap: {
        'pending': 'recebido',
        'accepted': 'aceito',
        'preparing': 'em_preparo',
        'confirmed': 'pronto',
        'out_for_delivery': 'saiu_entrega',
        'delivered': 'entregue',
        'cancelled': 'cancelado',
        // TambÃ©m aceita os valores em portuguÃªs diretamente
        'recebido': 'recebido',
        'aceito': 'aceito',
        'em_preparo': 'em_preparo',
        'pronto': 'pronto',
        'saiu_entrega': 'saiu_entrega',
        'entregue': 'entregue',
        'cancelado': 'cancelado'
      },
      
      // Mapeamento reverso: portuguÃªs -> inglÃªs (para enviar ao banco)
      statusToDb: {
        'recebido': 'pending',
        'aceito': 'accepted',
        'em_preparo': 'preparing',
        'pronto': 'confirmed',
        'saiu_entrega': 'out_for_delivery',
        'entregue': 'delivered',
        'cancelado': 'cancelled'
      },

      defaults: {
        recebido: 'OlÃ¡ {{nome}}! Recebemos seu pedido #{{pedido}} com sucesso. ğŸ‰\nResumo: {{itens}}\nTotal: R$ {{total}}\nJÃ¡ vamos comeÃ§ar a preparar!',
        aceito: '{{saudacao}}, {{nome}}! ğŸ‰\n\nSeu pedido #{{pedido}} foi *ACEITO* pela Fast Savory\'s!\n\nPara confirmar sua encomenda, realize o pagamento pelo link:\n{{payment_link}}\n\nğŸ’³ *OpÃ§Ãµes:*\nâ€¢ MÃ­nimo 50% agora (entrada)\nâ€¢ Ou valor total\n\n*Valor:* R$ {{total}}\n\nObrigado! â¤ï¸',
        em_preparo: 'OlÃ¡ {{nome}}! Seu pedido #{{pedido}} jÃ¡ estÃ¡ sendo preparado com muito carinho! ğŸ³ğŸ”¥\nTempo estimado: {{preparo}} min.',
        pronto: 'Opa {{nome}}! Seu pedido #{{pedido}} estÃ¡ PRONTO! âœ…\n{{tipo_entrega}}',
        saiu_entrega: 'OlÃ¡ {{nome}}! Seu pedido #{{pedido}} saiu para entrega! ğŸšš\nAguarde nosso entregador.',
        entregue: 'Pedido entregue! ğŸ¥Ÿâ¤ï¸\nObrigado pela preferÃªncia, {{nome}}! Se puder, nos avalie.',
        cancelado: 'OlÃ¡ {{nome}}. Infelizmente seu pedido #{{pedido}} foi cancelado.\nMotivo: {{motivo}} ğŸ˜”'
      },

      getAll: function () {
        const saved = localStorage.getItem('fastMsgTemplates');
        return saved ? { ...this.defaults, ...JSON.parse(saved) } : this.defaults;
      },

      save: function (templates) {
        localStorage.setItem('fastMsgTemplates', JSON.stringify(templates));
      },

      // Extrai primeiro nome ou nome composto (ex: "JoÃ£o Pedro" de "JoÃ£o Pedro dos Santos Costa")
      getFirstName: function(fullName) {
        if (!fullName) return 'Cliente';
        const parts = fullName.trim().split(/\s+/);
        if (parts.length <= 2) return fullName.trim();
        // Conectores comuns em portuguÃªs
        const connectors = ['de', 'da', 'do', 'das', 'dos', 'e'];
        // Pega primeiro nome e segundo se nÃ£o for conector
        let firstName = parts[0];
        if (parts.length > 1 && !connectors.includes(parts[1].toLowerCase())) {
          firstName += ' ' + parts[1];
        }
        return firstName;
      },

      // Gera saudaÃ§Ã£o dinÃ¢mica baseada no horÃ¡rio
      getGreeting: function() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'Bom dia';
        if (hour >= 12 && hour < 18) return 'Boa tarde';
        return 'Boa noite';
      },

      getFormatted: function (status, order) {
        // Mapeia o status para a chave correta do template
        // Se status vazio, usa 'recebido' como padrÃ£o
        const safeStatus = status || 'recebido';
        const templateKey = this.statusMap[safeStatus] || safeStatus;
        const tpl = this.getAll()[templateKey] || this.defaults.recebido;
        
        if (!tpl) {
          console.warn('[MsgTemplate] Template nÃ£o encontrado para status:', status, '-> key:', templateKey);
        }
        
        const itemsSummary = (order.items || []).map(i => `${i.quantity}x ${i.name}`).join(', ');
        const address = order.address ? `${order.address.street}, ${order.address.number}` : 'BalcÃ£o';
        const deliveryText = order.delivery_type === 'entrega' ? 'Aguarde o entregador.' : 'Pode vir retirar!';
        const prepTime = `${storeConfig.prep_time_min || 20}-${storeConfig.prep_time_max || 40}`;
        
        // Usa apenas primeiro nome (ou nome composto)
        const firstName = this.getFirstName(order.client_name);
        
        // SaudaÃ§Ã£o dinÃ¢mica
        const greeting = this.getGreeting();

        return tpl
          .replace(/{{nome}}/g, firstName)
          .replace(/{{pedido}}/g, order.id || '')
          .replace(/{{total}}/g, (order.total || 0).toFixed(2).replace('.', ','))
          .replace(/{{itens}}/g, itemsSummary || 'Itens do pedido')
          .replace(/{{endereco}}/g, address)
          .replace(/{{motivo}}/g, 'Imprevisto na cozinha')
          .replace(/{{tipo_entrega}}/g, deliveryText)
          .replace(/{{preparo}}/g, prepTime)
          .replace(/{{saudacao}}/g, greeting)
          .replace(/{{payment_link}}/g, order.payment_link || '[Link serÃ¡ enviado]');
      }
    };

    // Template UI Logic
    const templateStatusSelect = document.getElementById('templateStatusSelect');
    const templateContent = document.getElementById('templateContent');

    if (templateStatusSelect) {
      templateStatusSelect.addEventListener('change', loadTemplateToEditor);
      document.getElementById('saveTemplate')?.addEventListener('click', saveCurrentTemplate);
      document.getElementById('resetTemplate')?.addEventListener('click', () => {
        const status = templateStatusSelect.value;
        templateContent.value = MsgTemplateService.defaults[status];
      });
      // Init
      loadTemplateToEditor();
    }

    function loadTemplateToEditor() {
      const status = templateStatusSelect.value;
      const templates = MsgTemplateService.getAll();
      templateContent.value = templates[status] || '';
    }

    function saveCurrentTemplate() {
      const status = templateStatusSelect.value;
      const content = templateContent.value;
      const templates = MsgTemplateService.getAll();
      templates[status] = content;
      MsgTemplateService.save(templates);
      showInlineMessage('configPanelFast', 'âœ… Template salvo!', 'success');
    }

    // Msg Update Modal Logic
    let currentUpdateOrderId = null;

    async function prepareOrderUpdate(orderId) {
      currentUpdateOrderId = orderId;
      const { data: order } = await window.supabaseClient.from('fast_orders').select('*').eq('id', orderId).single();
      if (!order) return;

      const modal = document.getElementById('msgUpdateModal');
      document.getElementById('msgUpdateOrderId').value = orderId;
      document.getElementById('msgUpdateStatus').value = order.status;

      // Update preview on status change
      const updatePreview = () => {
        const newStatus = document.getElementById('msgUpdateStatus').value;
        document.getElementById('msgUpdatePreview').value = MsgTemplateService.getFormatted(newStatus, order);
      };

      document.getElementById('msgUpdateStatus').onchange = updatePreview;
      updatePreview(); // Initial load

      modal.classList.remove('hidden');
    }

    // Event Listeners for Modal
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('closeMsgUpdate')?.addEventListener('click', function() {
        document.getElementById('msgUpdateModal').classList.add('hidden');
      });

      document.getElementById('confirmMsgUpdate')?.addEventListener('click', async function() {
        const orderId = document.getElementById('msgUpdateOrderId').value;
        const newStatus = document.getElementById('msgUpdateStatus').value;
        const msg = document.getElementById('msgUpdatePreview').value;

        // Send WhatsApp
        const { data: order } = await window.supabaseClient.from('fast_orders').select('client_phone').eq('id', orderId).single();
        if (order && order.client_phone) {
          const cleanPhone = order.client_phone.replace(/\D/g, '');
          const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`;
          window.open(url, '_blank');
        }

        // Update Status in Supabase (converte portuguÃªs -> inglÃªs para o banco)
        const dbStatus = MsgTemplateService.statusToDb[newStatus] || newStatus;
        updateOrderStatus(orderId, dbStatus);

        document.getElementById('msgUpdateModal').classList.add('hidden');
      });
    });

    // Note: saveStoreConfig and loadStoreConfig are defined earlier and sync with Supabase

    // REDEFINE updateOpenNotice to include Time Estimates
    function updateOpenNotice() {
      const notice = document.getElementById('openNotice');
      if (!notice) return;

      let text = '';
      let colorClass = '';
      const isOpen = isFastOpen();

      if (storeIsClosed) {
        text = 'ğŸ”´ Loja Fechada Temporariamente';
        colorClass = 'bg-red-100 text-red-800 border-red-200 border';
      } else if (isOpen) {
        text = 'ğŸŸ¢ Estamos Abertos! FaÃ§a seu pedido.';
        colorClass = 'bg-green-100 text-green-800 border-green-200 border';
      } else {
        text = 'ğŸ”´ Fechado no momento. Confira nossos horÃ¡rios.';
        colorClass = 'bg-red-100 text-red-800 border-red-200 border';
      }

      // Append Time Estimates if configured and open
      if (isOpen && !storeIsClosed) {
        const prep = (storeConfig.prep_time_min && storeConfig.prep_time_max) ?
          `ğŸ•’ Preparo: ${storeConfig.prep_time_min}-${storeConfig.prep_time_max} min` : '';

        const del = (storeConfig.delivery_enabled && storeConfig.delivery_time_min && storeConfig.delivery_time_max) ?
          `ğŸ›µ Entrega: ${storeConfig.delivery_time_min}-${storeConfig.delivery_time_max} min` : '';

        if (prep || del) {
          text += ` â€¢ ${[prep, del].filter(Boolean).join(' â€¢ ')}`;
        }
      }

      notice.textContent = text;
      notice.className = `text-sm py-2 px-3 rounded-lg my-2 text-center font-medium ${colorClass}`;
    }

    // Initial update
    updateOpenNotice();

    document.getElementById('saveDeliverySettings')?.addEventListener('click', async () => {
      storeConfig.delivery_enabled = document.getElementById('deliveryEnabled').checked;
      storeConfig.delivery_disabled_reason = document.getElementById('deliveryDisabledReason')?.value || '';
      const success = await saveStoreConfig();
      if (success) {
        const status = storeConfig.delivery_enabled ? 'habilitadas' : 'desabilitadas';
        showInlineMessage('configPanelFast', `âœ… Entregas ${status}!`, 'success');
      } else {
        showInlineMessage('configPanelFast', 'âŒ Erro ao salvar configuraÃ§Ã£o.', 'error');
      }
    });

    // Salvar todas as taxas - VERSÃƒO SIMPLIFICADA (apenas localStorage)
    // A sincronizaÃ§Ã£o com Supabase foi removida temporariamente devido a erros 400
    const saveAllFeesBtn = document.getElementById('saveAllFeesFast');
    if (saveAllFeesBtn && !saveAllFeesBtn.hasAttribute('data-listener-attached')) {
      saveAllFeesBtn.setAttribute('data-listener-attached', 'true');

      saveAllFeesBtn.addEventListener('click', () => {
        // As taxas jÃ¡ sÃ£o salvas automaticamente no localStorage ao editar
        // Este botÃ£o apenas confirma que estÃ¡ tudo salvo
        showInlineMessage('configPanelFast', 'âœ… Taxas salvas localmente!', 'success');
      });
    }
  </script>

  <!-- Msg Update Modal -->
  <div id="msgUpdateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Atualizar Pedido & Notificar</h3>
      <input type="hidden" id="msgUpdateOrderId">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Novo Status</label>
          <select id="msgUpdateStatus" class="w-full px-3 py-2 border rounded-lg">
            <option value="recebido">ğŸ†• Recebido</option>
            <option value="em_preparo">ğŸ³ Em Preparo</option>
            <option value="pronto">âœ… Pronto</option>
            <option value="saiu_entrega">ğŸšš Saiu para Entrega</option>
            <option value="entregue">âœ”ï¸ Entregue</option>
            <option value="cancelado">âŒ Cancelado</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem (Preview)</label>
          <textarea id="msgUpdatePreview" rows="4"
            class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50"></textarea>
        </div>
        <div class="flex gap-2 justify-end mt-4">
          <button type="button" id="closeMsgUpdate"
            class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
          <button type="button" id="confirmMsgUpdate"
            class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700">Enviar e Atualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fees Modal Fast (Admin) -->
  <div id="feesModalFast" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
    onclick="if(event.target===this) closeFeesFastModal();">
    <div class="bg-white rounded-xl p-6 w-full max-w-xl mx-4 max-h-[90vh] overflow-y-auto"
      onclick="event.stopPropagation();">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800">Taxas de Entrega</h3>
        <button type="button" id="closeFeesFast"
          class="text-gray-600 hover:text-gray-800 text-3xl font-bold leading-none">Ã—</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <input type="text" id="feeNeighborhoodFast" class="md:col-span-2 w-full px-3 py-2 border rounded"
          placeholder="Bairro" />
        <input type="number" step="0.01" id="feeValueFast" class="w-full px-3 py-2 border rounded"
          placeholder="Valor (R$)" />
      </div>
      <div class="mb-3 flex gap-2">
        <button type="button" id="addFeeFast"
          class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded">Adicionar/Atualizar</button>
        <button type="button" id="saveAllFeesFast"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Salvar Todas as Taxas</button>
      </div>
      <div id="feesListFast" class="divide-y"></div>
    </div>
  </div>
</body>

</html>